psychosis448 commented on 29 Jul 2019
How to reproduce the behaviour
I got a strange problem when loading a modified model, adding an EnityRuler to the pipeline with the before='ner' flag.
So I create my patterns, add them to my entity_ruler and the ruler to my pipe:
nlp = spacy.load('de_core_news_sm')
ruler = EntityRuler(nlp)
ruler.add_patterns(patterns)
nlp.add_pipe(ruler, before='ner')
Then I check for the dir, create it if necessary and save the model to disk:
output_dir = Path('custom_model')
if not output_dir.exists():
  output_dir.mkdir()
nlp.to_disk(output_dir)
When I now load the model with
spacy.load(Path('custom_model'))
It throws the following error:
ValueError: [E109] Model for component 'ner' not initialized.
Did you forget to load a model, or forget to call begin_training()?
There is no problem doing this without before='ner'...
Extended Error:
Traceback (most recent call last):
  File "/spacy/__init__.py", line 27, in load
    return util.load_model(name, **overrides)
  File "/spacy/util.py", line 135, in load_model
    return load_model_from_path(name, **overrides)
  File "/spacy/util.py", line 173, in load_model_from_path
    return nlp.from_disk(model_path)
  File "/spacy/language.py", line 791, in from_disk
    util.from_disk(path, deserializers, exclude)
  File "/spacy/util.py", line 630, in from_disk
    reader(path / key)
  File "/spacy/language.py", line 787, in <lambda>
    deserializers[name] = lambda p, proc=proc: proc.from_disk(p, exclude=["vocab"])
  File "/spacy/pipeline/entityruler.py", line 183, in from_disk
    self.add_patterns(patterns)
  File "/spacy/pipeline/entityruler.py", line 138, in add_patterns
    self.phrase_patterns[label].append(self.nlp(pattern))
  File "/spacy/language.py", line 390, in __call__
    doc = proc(doc, **component_cfg.get(name, {}))
  File "nn_parser.pyx", line 205, in spacy.syntax.nn_parser.Parser.__call__
  File "nn_parser.pyx", line 238, in spacy.syntax.nn_parser.Parser.predict
  File "nn_parser.pyx", line 235, in spacy.syntax.nn_parser.Parser.require_model
ValueError: [E109] Model for component 'ner' not initialized.
Did you forget to load a model, or forget to call begin_training()?
Your Environment
spaCy version: 2.1.6
Platform: Darwin-18.6.0-x86_64-i386-64bit
Python version: 3.7.3
2