slartibaartfast commented on 13 Oct 2019
How to reproduce the behaviour
Removing phrases from the PhraseMatcher causes an error when one of the phrases exists as part of another phrase. Sometimes, with long lists of phrases, it causes a segmentation fault. This snippet might reproduce the error (it does for me):
import spacy
from spacy.matcher import PhraseMatcher, Matcher

nlp = spacy.load("en_core_web_lg")
phrase_matcher = PhraseMatcher(nlp.vocab)
phrases = ["this is a pig", "this is a sheep", "this is a", "this is a dog"]
patterns = [nlp(phrase) for phrase in phrases]
phrase_matcher.add("animals", None, *patterns)
print("removing animals")
phrase_matcher.remove("animals")
will throw this error:
removing animals
Traceback (most recent call last):
  File "spacytest.py", line 10, in <module>
    phrase_matcher.remove("animals")
  File "phrasematcher.pyx", line 136, in spacy.matcher.phrasematcher.PhraseMatcher.remove
  File "cymem.pyx", line 102, in cymem.cymem.Pool.free
KeyError: 140393018962904
Your Environment
spaCy version: 2.2.1
Platform: Linux-5.0.0-31-generic-x86_64-with-Ubuntu-19.04-disco
Python version: 3.7.3
1