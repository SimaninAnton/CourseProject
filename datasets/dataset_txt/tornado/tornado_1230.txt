Contributor
amorton commented on 28 Oct 2010
I think there is a small bug in the RequestHandler.
I'm running Varnish > Nginx > Tornado and was getting occasional 503 errors from varnish. Which I tracked down to Tornado returning HTTP 304 with an empty response body but with Content-Length set to a non zero value.
It happens when the client makes a request for a static file with both If-Modified-Since and If-None-Match where the static file has a new modified date, but has not changed. The StaticFileHandler will notice the file has changed and stream it into the response, together with the Content-Length.
RequestHandler.finish() will then look at the etag for the response, notice it's the same and clear the response without reseting the Content-Length. The following code in finish() only sets the Content-Length if it is not present.
I was able to fix it by setting the Content-Length to 0 when finish() clears the response.
Cheers