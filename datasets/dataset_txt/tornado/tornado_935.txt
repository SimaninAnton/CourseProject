jegoruglov commented on 27 Jun 2013
Hi,
The code sample in new Google auth doc uses @tornado.gen.coroutine decorator, and it yields self.authenticate_redirect() - https://github.com/facebook/tornado/blob/stable/tornado/auth.py#L46
This results in following error, which does not interrupt the app, but still throws exception to stdout:
ERROR:tornado.application:Uncaught exception GET /login?next=%2F (127.0.0.1)
HTTPRequest(protocol='http', host='localhost:9997', method='GET', uri='/login?next=%2F', version='HTTP/1.1', remote_ip='127.0.0.1', body='', headers={'Connection': 'keep-alive', 'Accept-Language': 'en-US,en;q=0.8', 'Accept-Encoding': 'gzip,deflate,sdch', 'Host': 'localhost:9997', 'Accept': 'text/html,application/xhtml+xml,application/xml;q=0.9,/;q=0.8', 'User-Agent': 'Mozilla/5.0 (X11; Linux i686) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/28.0.1500.52 Safari/537.36'})
Traceback (most recent call last):
File "/home/jegor/projects/tornado/tornado/web.py", line 1077, in _stack_context_handle_exception
raise_exc_info((type, value, traceback))
File "/home/jegor/projects/tornado/tornado/stack_context.py", line 258, in wrapped
fn(_args, *_kwargs)
File "/home/jegor/projects/tornado/tornado/web.py", line 1229, in future_complete
f.result()
File "/home/jegor/projects/tornado/tornado/concurrent.py", line 129, in result
raise_exc_info(self.__exc_info)
File "/home/jegor/projects/tornado/tornado/gen.py", line 224, in wrapper
runner.run()
File "/home/jegor/projects/tornado/tornado/gen.py", line 508, in run
yielded = self.gen.send(next)
File "main.py", line 42, in get
yield self.authenticate_redirect()
File "/home/jegor/projects/tornado/tornado/auth.py", line 136, in authenticate_redirect
self.redirect(self._OPENID_ENDPOINT + "?" + urllib_parse.urlencode(args))
File "/home/jegor/projects/tornado/tornado/web.py", line 504, in redirect
raise Exception("Cannot redirect after headers have been written")
Exception: Cannot redirect after headers have been written
ERROR:tornado.general:Cannot send error response after headers written
I fixed it by removing yield from https://github.com/facebook/tornado/blob/stable/tornado/auth.py#L46
Why should it be yielded?