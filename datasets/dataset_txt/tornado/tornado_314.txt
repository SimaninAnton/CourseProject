oprietop commented on 10 Jul 2017
The startransfer timing is giving me wrong values under pycurl+tornado:
Code example:
import tornado, pycurl, subprocess                                                                                                                                                                                               
from tornado import httpclient, gen, ioloop                                                                                                                                                                                      
                                                                                                                                                                                                                                 
@tornado.gen.coroutine                                                                                                                                                                                                           
def main():                                                                                                                                                                                                                      
    tornado.httpclient.AsyncHTTPClient.configure( "tornado.curl_httpclient.CurlAsyncHTTPClient")                                                                                                                                 
    http_client = tornado.httpclient.AsyncHTTPClient()                                                                                                                                                                           
                                                                                                                                                                                                                                 
    url = {'url':'http://httpbin.org/post','method':'POST','body':'ONE=1&TWO=2'}                                                                                                                                                 
                                                                                                                                                                                                                                 
    http_request = tornado.httpclient.HTTPRequest( **url )                                                                                                                                                                       
    response = yield http_client.fetch(http_request)                                                                                                                                                                             
                                                                                                                                                                                                                                 
    print('startransfer: ', response.time_info['starttransfer'])                                                                                                                                                                 
                                                                                                                                                                                                                                 
if __name__ == '__main__':                                                                                                                                                                                                       
    print("# Tornado with Pycurl")                                                                                                                                                                                               
    for _ in range (10):                                                                                                                                                                                                         
        tornado.ioloop.IOLoop.instance().run_sync(main)                                                                                                                                                                          
                                                                                                                                                                                                                                 
    print("# Curl Binary")                                                                                                                                                                                                       
    cmd = [ 'curl', '-vo', '/dev/null', 'http://httpbin.org/post', '--data', 'ONE=1&TWO=2',  '-w',  'startransfer: %{time_starttransfer}' ]                                                                                      
    for _ in range (10):                                                                                                                                                                                                         
        p = subprocess.Popen(cmd, stdout=subprocess.PIPE, stderr=subprocess.PIPE)                                                                                                                                                
        out, err = p.communicate()                                                                                                                                                                                               
        print(out.decode())
Result:
# Tornado with Pycurl                                                                                                                                                                                                            
startransfer:  0.080873                                                                                                                                                                                                          
startransfer:  0.0001                                                                                                                                                                                                            
startransfer:  0.000104                                                                                                                                                                                                          
startransfer:  0.00012                                                                                                                                                                                                           
startransfer:  0.00013                                                                                                                                                                                                           
startransfer:  0.000109                                                                                                                                                                                                          
startransfer:  8.8e-05                                                                                                                                                                                                           
startransfer:  0.000187                                                                                                                                                                                                          
startransfer:  8.8e-05                                                                                                                                                                                                           
startransfer:  0.000117                                                                                                                                                                                                          
# Curl Binary                                                                                                                                                                                                                    
startransfer: 0.161381                                                                                                                                                                                                           
startransfer: 0.160101                                                                                                                                                                                                           
startransfer: 0.161324                                                                                                                                                                                                           
startransfer: 0.170570                                                                                                                                                                                                           
startransfer: 0.170397                                                                                                                                                                                                           
startransfer: 0.165819                                                                                                                                                                                                           
startransfer: 0.168934                                                                                                                                                                                                           
startransfer: 0.165027                                                                                                                                                                                                           
startransfer: 0.154728                                                                                                                                                                                                           
startransfer: 0.164264´
Is there anything i'm missing? Timings using pycurl only are also fine.
More info:
# curl -V                                                                                                                                                                                                  
curl 7.54.1 (x86_64-pc-linux-gnu) libcurl/7.54.1 OpenSSL/1.1.0f zlib/1.2.11 libpsl/0.17.0 (+libicu/59.1) libssh2/1.8.0 nghttp2/1.23.1                                                                                            
Release-Date: 2017-06-14                                                                                                                                                                                                         
Protocols: dict file ftp ftps gopher http https imap imaps pop3 pop3s rtsp scp sftp smb smbs smtp smtps telnet tftp                                                                                                              
Features: AsynchDNS IPv6 Largefile GSS-API Kerberos SPNEGO NTLM NTLM_WB SSL libz TLS-SRP HTTP2 UnixSockets HTTPS-proxy PSL                                                                                                       
# python -V                                                                                                                                                                                                
Python 3.6.1                                                                                                                                                                                                                     
[root@li579-34 python]# pip list | grep pycurl                                                                                                                                                                                   
pycurl (7.43.0)                                                                                                                                                                                                                  
# pip list | grep tornado                                                                                                                                                                                               
tornado (4.5.1) 