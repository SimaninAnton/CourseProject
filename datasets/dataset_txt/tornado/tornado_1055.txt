ilfirin-ms commented on 17 Aug 2012
When I connect to ssl server [netutil.TCPServer] with SSLIOStream (client), I have to sleep some time after connect, or
exception is raised when tried to send data:
Traceback (most recent call last):
  File "./test_server_gui.py", line 103, in test_accept_connection_and_data_with_stream
    stream.write(b'test')
  File "/usr/local/lib/python3.2/dist-packages/tornado/iostream.py", line 210, in write
    self._handle_write()
  File "/usr/local/lib/python3.2/dist-packages/tornado/iostream.py", line 671, in _handle_write
    self._do_ssl_handshake()
  File "/usr/local/lib/python3.2/dist-packages/tornado/iostream.py", line 641, in _do_ssl_handshake
    self.socket.do_handshake()
AttributeError: 'socket' object has no attribute 'do_handshake'
example code:
def test_accept_connection_and_data_with_stream(WORKAROUND=0):
    "Test if server is listening and accepting data with SSLIOStream"

    s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
    stream = SSLIOStream(s,
                         ssl_options={
                             'ca_certs': 'fake_certificate_autority',
                             'cert_reqs' : ssl.CERT_REQUIRED
                         })

    stream.connect((server_ip, server_port))

    if WORKAROUND:
        time.sleep(0.1)

    # test write
    stream.write(b'test')

    # test reply, not part of example
    time.sleep(0.1)
    data = b''.join(stream._read_buffer)
    assert(data == b'got test')

    stream.close()
I have also tried to run test in another IOLoop but same behaviour.
Test with pure socket example from Python docs works.