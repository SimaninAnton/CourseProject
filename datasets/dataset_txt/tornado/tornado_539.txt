dave-shawley commented on 7 Mar 2016
I'm not completely sure how this is happening but I noticed that we are getting a TypeError raised from within Future._set_done. I believe that this is caused by calling one of the set functions more than once. Yes, I know that this is "undefined" behavior and I am not completely sure this is how it is happening. What I am sure of is that the implementation of Future._set_done is pretty fragile:
def _set_done(self):
    self._done = True
    for cb in self._callbacks:
        try:
            cb(self)
        exception Exception:
            app_log.exception('Exception in callback %r for %r',
                              cb, self)
    self._callbacks = None
The last line is the problematic one. Is there any reason for not simply doing del self._callbacks[:] or self._callbacks = []? This would avoid the possibility of raising a TypeError here.