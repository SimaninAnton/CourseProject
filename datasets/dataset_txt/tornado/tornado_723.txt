hackrole commented on 17 Nov 2014
I was write a application with tornado and mongodb(using motor).
I setup and teardown the unittest case like below::
class BaseTestCase(AsyncHTTPTestCase):
def setUp(self):
super(BaseTestCase, self).setUp()
self.ioloop.run_sysnc(self.drop_db)
self.ioloop.run_sync(self.fixture_setup)
@gen.coroutine
def fixture_setup(self):
       yield motorclient.db.collection.insert({})
       ......

def tearDown(self)
      self.ioloop.run_sync(self.drop_db)
@gen.coroutine
def drop_db(self):
yield motorclient.drop_database(dbname)
the subclass will run ok, it I not use gen_test like this;
class SubTestCase(BaseTestCase):
  def test_ok(self):
         response = self.fetch('/')
        self.assertEquals(response.code, 200)
but not work like this.
    @gen_test
   def test_ok(self):
          user = yield motorclient,db.collections.find_one({'mobile': mobile})
then all the testcase(I mean all, not only this one) wil fail and raise Timeout Exception.
the exception may seems like that:
ERROR: test_get_without_uid_return_html (tests.test_view_register.RegisterMsgTest)
Traceback (most recent call last):
File "/home/daipeng/projects/next_chat/nchat/tests/base.py", line 23, in setUp
self.io_loop.run_sync(self.drop_database)
File "/usr/local/lib/python2.7/dist-packages/tornado/ioloop.py", line 417, in run_sync
raise TimeoutError('Operation timed out after %s seconds' % timeout)
TimeoutError: Operation timed out after None seconds
so how can I use motor for insert/update/delete/find in the test method??