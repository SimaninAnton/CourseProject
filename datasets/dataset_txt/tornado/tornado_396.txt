avayayu commented on 21 Jan 2017 •
edited by ajdavis
my code is：
def handle_response(response):
    if response.error:
        print("Error: " + str(response))
    else:

        print(response.body)

        con = db.getConnection()
        df = pd.read_sql(
            'select max(tradingdate) as begindate from tradingdate_sina', con=con)

        tradingdate = str(df.begindate[0])

        

        if response.body != "":
            print('no error')
            result = response.text.split(",")[-3]
            if result != tradingdate:
                cursor = con.cursor()
                cursor.execute(
                    'insert into tradingdate_sina values (\'' + result + '\')')
                con.commit()
        con.close()


def crawl_tradingdate():
    print("in crawl_tradingdate()")
    http_client = CurlAsyncHTTPClient()
    request = HTTPRequest(
        'http://hq.sinajs.cn/list=sh000001')
    try:
        http_client.fetch(request, handle_response)
    except CurlError:
        print(CurlError.msg)

    print('crawl_tradingdate finished')

if __name__ == "__main__":
    application.listen(8222)

    scheduler = myScheduler.init()
    scheduler.start()

    try:
        IOLoop.instance().start()
    except (KeyboardInterrupt, SystemExit):
        pass
scheduler work well. But IOLoop always exits when cral_traidingdate runs. But there is no error no except.What's wrong?
PS. this is based on windows py3.5,tornado4.3.,and pycurl works well.