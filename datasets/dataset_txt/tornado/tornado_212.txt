fabiant7t commented on 23 Mar 2018 â€¢
edited
Using Tornado as a proxy, I noticed that its memory usage increases.
AsyncHTTPClient.fetch takes a request object and calls its URL. If the response is successful (2xx) or a redirection (3xx), this request object gets properly deleted/garbage collected.
However, if the response is a client (4xx) or server error (5xx), the request is not being deleted and lives forever, eating RAM.
To reproduce in Python 3, spin up tornado_test.py and call
http://localhost:8888/200
-> You'll see 'Request object deleted' being printed to stdout right away
http://localhost:8888/400
-> You don't see 'Request object deleted' being printed to stdout. But you will after exiting the whole program with <Ctrl+C>.
Python2 shows the same problem (see comment below).
#!/usr/bin/python3
import weakref                                                                                                                                                                                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                                                                                                                                                                          
import tornado.httpclient                                                                                                                                                                                                                                                                                                                                                                                                                 
import tornado.ioloop                                                                                                                                                                                                                                                                                                                                                                                                                     
import tornado.gen                                                                                                                                                                                                                                                                                                                                                                                                                        
import tornado.web                                                                                                                                                                                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                                                                                                                                                                                                          
                                                                                                                                                                                                                                                                                                                                                                                                                                          
class MainHandler(tornado.web.RequestHandler):                                                                                                                                                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                                                                                                                                                                          
    @tornado.gen.coroutine                                                                                                                                                                                                                                                                                                                                                                                                                
    def get(self, status):                                                                                                                                                                                                                                                                                                                                                                                                                
        request = tornado.httpclient.HTTPRequest(                                                                                                                                                                                                                                                                                                                                                                                         
            url='https://httpstat.us/{}'.format(status)                                                                                                                                                                                                                                                                                                                                                                                   
        )                                                                                                                                                                                                                                                                                                                                                                                                                                 
        weakref.finalize(request, lambda: print('Request object deleted'))                                                                                                                                                                                                                                                                                                                                                                          
                                                                                                                                                                                                                                                                                                                                                                                                                                          
        client = tornado.httpclient.AsyncHTTPClient()                                                                                                                                                                                                                                                                                                                                                                                     
        response = yield client.fetch(request, raise_error=False)                                                                                                                                                                                                                                                                                                                                                                         
        # client.close()                                                                                                                                                                                                                                                                                                                                                                                                                  
        self.set_status(response.code)                                                                                                                                                                                                                                                                                                                                                                                                    
        self.write('Status %d' % response.code)                                                                                                                                                                                                                                                                                                                                                                                           
        self.finish()                                                                                                                                                                                                                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                                                                                                                                                                                                          
                                                                                                                                                                                                                                                                                                                                                                                                                                          
def make_app():                                                                                                                                                                                                                                                                                                                                                                                                                           
    return tornado.web.Application([                                                                                                                                                                                                                                                                                                                                                                                                      
        (r"/(?P<status>\d{3})", MainHandler),                                                                                                                                                                                                                                                                                                                                                                                               
    ])                                                                                                                                                                                                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                                                                                                                                                                                          
                                                                                                                                                                                                                                                                                                                                                                                                                                          
if __name__ == "__main__":                                                                                                                                                                                                                                                                                                                                                                                                                
    app = make_app()                                                                                                                                                                                                                                                                                                                                                                                                                      
    app.listen(8888)                                                                                                                                                                                                                                                                                                                                                                                                                      
    tornado.ioloop.IOLoop.current().start()