krkd commented on 30 Dec 2014
I experienced problem with "Malformed HTTP headers" when cookie was encoded with utf8.
Let assume that data passed to HTTPConnection._on_headers have "COOKIE" header which contains cookie with value
"\xd0\x9a\xd1\x83\xd1\x85\xd0\xbd\xd0\xb8"  
after decoding with latin1 cookie was like
'Ð\x9aÑ\x83Ñ\x85Ð½Ð¸' 
which contains \x85 unicode newline character.
httputil.HTTPHeaders.parse use builtin method splitlines which recognize \x85 character as newline and splits string by this character. In summary ValueError will be raised because
strig after \x85 does not start with whitespace
line after \x85 does not contain ":" character.
In my project i use spit("\r\n") instead of splitlines in httputil.HTTPHeaders.parse.