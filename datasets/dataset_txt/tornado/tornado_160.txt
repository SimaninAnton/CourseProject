bugy commented on 19 Jul 2018
Hi, I'm using tornado websockets with periodic pings (#1640).
When sending large amount of data before closing the socket from server-side, I noticed the error on client side in Chrome: Ping received after close.
As far as I understood, the error happens, when client receives the frames in the following order:
data1, data2, ..., dataN, close, ping
The problem here is that periodic ping can be sent even after calling socket.close(): this method is only about sending a close frame. However periodic pings check real connection state, which will be closed only after client confirms the socket close frame.
I guess, periodic ping should be stopped immediately on socket.close() or at least check for socket state, instead of real connection.
As I local workaround I added a call web_socket.ws_connection.connection.ping_callback.stop() before close and don't get this error anymore
Attached is a sample tornado server with "overloaded" websocket and an html page for connecting to the socket. This can be not 100% reproducible, depending on ping occurences.
ping_bug.zip
Tornado version: 5, but I believe it applies to other versions as well