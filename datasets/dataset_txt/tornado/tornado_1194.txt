Contributor
rickardb commented on 21 Feb 2011
In a kqueue based environment, iostream's connect callback is called even when the connection is refused. Some investigation shows that this is due to the fact that iostream's _hande_events gets a WRITE event for the given file descriptor.
Simple example: https://gist.github.com/837089
Adding some output to IOStream._handle_events shows the following log for kqueue:
[I 110221 15:04:11 iostream:192] _handle_events, fd: 6  events: 0x4
[I 110221 15:04:11 app:19] on_connect
[I 110221 15:04:11 iostream:192] _handle_events, fd: 6  events: 0x1
[W 110221 15:04:11 iostream:290] Read error on 6: [Errno 61] Connection refused
[I 110221 15:04:11 app:22] on_closed
Select gives the following log:
[I 110221 15:23:37 iostream:192] _handle_events, fd: 5  events: 0x5
[W 110221 15:23:37 iostream:290] Read error on 5: [Errno 61] Connection refused
[I 110221 15:23:37 app:22] on_closed
And epoll gives the following:
[I 110221 15:25:19 iostream:192] _handle_events, fd: 3  events: 0x2018
[I 110221 15:25:19 app:22] on_closed