canoon commented on 9 May 2018 â€¢
edited
Using this test code
import tornado.gen
import tornado.ioloop
import tornado.stack_context

ioloop = tornado.ioloop.IOLoop.current()


class TestContext:
    def __enter__(self):
        print("__enter__")

    def __exit__(self, exc_type, exc_value, exc_tb):
        print("__exit__")


async def async_method():
    print("async_method")


@tornado.gen.coroutine
def test_method():
    print("test_method")
    yield async_method()
    print("test_method")


@tornado.gen.coroutine
def wrapper_method():
    yield tornado.stack_context.run_with_stack_context(tornado.stack_context.StackContext(TestContext), test_method)

ioloop.run_sync(wrapper_method)
Which on tornado 5.0.2 outputs
-> % pip install tornado==5.0.2
Collecting tornado==5.0.2
Installing collected packages: tornado
  Found existing installation: tornado 4.5.2
    Uninstalling tornado-4.5.2:
      Successfully uninstalled tornado-4.5.2
Successfully installed tornado-5.0.2
You are using pip version 9.0.3, however version 10.0.1 is available.
You should consider upgrading via the 'pip install --upgrade pip' command.
-> % python test_stack_context.py
__enter__
test_method
__exit__
async_method
__enter__
test_method
__exit__
While on 4.5.2
-> % pip install tornado==4.5.2
Collecting tornado==4.5.2
Installing collected packages: tornado
  Found existing installation: tornado 5.0.2
    Uninstalling tornado-5.0.2:
      Successfully uninstalled tornado-5.0.2
Successfully installed tornado-4.5.2
You are using pip version 9.0.3, however version 10.0.1 is available.
You should consider upgrading via the 'pip install --upgrade pip' command.
-> % python test_stack_context.py
__enter__
test_method
async_method
test_method
__exit__
Note that the async_method is no longer executed inside the stack context.
I'm on Python 3.5.1 if that matters.