add_callback() not entirely thread-safe