UnboundLocalError: local variable 'current_state' referenced before assignment