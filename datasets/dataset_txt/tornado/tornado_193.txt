cleverbao commented on 24 Apr 2018
About tornado error: RuntimeError: There is no current event loop in thread 'Thread-2'.
Using threads to call websocket.write_message() function in the program, an error occurs.
this my code:
class SocketHandler(tornado.websocket.WebSocketHandler):
waiters = set()
def init(self, application, request):
super(SocketHandler, self).init(application, request)
threading.Thread(target = self.__send_messages, args = (que,)).start()
def allow_draft76(self):
# for iOS 5.0 Safari
return True
def check_origin(self, origin):
# set open must with Browser
return True
def open(self):
username = self.get_secure_cookie('cookie_user')
if not username:
return
SocketHandler.waiters.add(self)
def on_close(self):
SocketHandler.waiters.remove(self)
def on_message(self, message):
@classmethod
def __send_messages(cls, que):
while 1:
status = json.dumps(que.get())
for waiters in cls.waiters:
try:
waiters.write_message(status)
except Exception as e:
continue
que.queue.clear()
I searched for some issues and said that it is asyncio and threading problems.
Here is the sample code:
Import asyncio
Import time, threading
Def loop():
    Print('thread %s is running...' % threading.current_thread().name)
    Loop = asyncio.get_event_loop()
    Time.sleep(1)
    Print('thread %s ended.' % threading.current_thread().name)
If name == 'main':
    Print('thread %s is running...' % threading.current_thread().name)
    t = threading.Thread(target=loop, name='LoopThread')
    T.start()
    T.join()
    Print('thread %s ended.' % threading.current_thread().name)
Error message:
RuntimeError: There is no current event loop in thread 'LoopThread'.
His solution:
Def loop():
    Print('thread %s is running...' % threading.current_thread().name)
    New_loop = asyncio.new_event_loop()
    Asyncio.set_event_loop(new_loop)
    Loop = asyncio.get_event_loop()
    Time.sleep(1)
    Print('thread %s ended.' % threading.current_thread().name)
However, I am getting an error when modifying the tornado source code.