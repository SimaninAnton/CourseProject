Contributor
ei-grad commented on 28 Oct 2011
Hi.
In [1]: from tornado.httpclient import HTTPClient

In [2]: client = HTTPClient()

In [3]: client.fetch('https://mail.google.com/', method='POST')
WARNING:root:uncaught exception
Traceback (most recent call last):
  File "/usr/lib/python2.6/dist-packages/tornado/simple_httpclient.py", line 289, in cleanup
    yield
  File "/usr/lib/python2.6/dist-packages/tornado/stack_context.py", line 183, in wrapped
    callback(*args, **kwargs)
  File "/usr/lib/python2.6/dist-packages/tornado/simple_httpclient.py", line 248, in _on_connect
    assert self.request.body is not None
AssertionError
---------------------------------------------------------------------------
AssertionError                            Traceback (most recent call last)
/etc/wolke/<ipython-input-3-173e17e17348> in <module>()
----> 1 client.fetch('https://mail.google.com/', method='POST')

/usr/lib/python2.6/dist-packages/tornado/httpclient.pyc in fetch(self, request, **kwargs)
     84         response = self._response
     85         self._response = None
---> 86         response.rethrow()
     87         return response
     88 

/usr/lib/python2.6/dist-packages/tornado/httpclient.pyc in rethrow(self)
    356         """If there was an error on the request, raise an `HTTPError`."""
    357         if self.error:
--> 358             raise self.error
    359 
    360     def __repr__(self):

AssertionError: 

In [4]: client.fetch('https://mail.google.com/', method='POST', body='asd')
Out[4]: HTTPResponse(code=200,request_time=0.51736593246459961,buffer=<io.BytesIO object at 0x1db7590>,_body=None,time_info={},request=<tornado.httpclient.HTTPRequest object at 0x1db4a10>,effective_url='https://accounts.google.com/ServiceLogin?service=mail&passive=true&rm=false&continue=https://mail.google.com/mail/&ss=1&scc=1&ltmpl=default&ltmplcache=2',headers={'Expires': 'Mon, 01-Jan-1990 00:00:00 GMT', 'X-Content-Type-Options': 'nosniff', 'Transfer-Encoding': 'chunked', 'Set-Cookie': 'GAPS=1:EwGEAt7e8BZwiyVBaQcLA12vqRsmaQ:ndQYan2zjq2chYsy;Path=/;Expires=Sat, 26-Oct-2013 18:43:22 GMT;Secure;HttpOnly,GALX=m2x1X4J_8I4;Path=/;Secure', 'Strict-Transport-Security': 'max-age=2592000; includeSubDomains', 'X-Auto-Login': 'realm=com.google&args=service%3Dmail%26continue%3Dhttps%253A%252F%252Fmail.google.com%252Fmail%252F', 'Server': 'GSE', 'X-Xss-Protection': '1; mode=block', 'Pragma': 'no-cache', 'Cache-Control': 'no-cache, no-store', 'Date': 'Thu, 27 Oct 2011 18:43:22 GMT', 'X-Frame-Options': 'Deny', 'Content-Type': 'text/html; charset=UTF-8'},error=None)

In [5]: client.fetch('https://mail.google.com/', method='POST', body='')
WARNING:root:Write error on 6: [Errno 8] _ssl.c:1209: EOF occurred in violation of protocol
WARNING:root:uncaught exception
Traceback (most recent call last):
  File "/usr/lib/python2.6/dist-packages/tornado/simple_httpclient.py", line 289, in cleanup
    yield
  File "/usr/lib/python2.6/dist-packages/tornado/stack_context.py", line 183, in wrapped
    callback(*args, **kwargs)
  File "/usr/lib/python2.6/dist-packages/tornado/simple_httpclient.py", line 271, in _on_connect
    self.stream.read_until_regex(b("\r?\n\r?\n"), self._on_headers)
  File "/usr/lib/python2.6/dist-packages/tornado/iostream.py", line 146, in read_until_regex
    self._check_closed()
  File "/usr/lib/python2.6/dist-packages/tornado/iostream.py", line 504, in _check_closed
    raise IOError("Stream is closed")
IOError: Stream is closed
---------------------------------------------------------------------------
IOError                                   Traceback (most recent call last)
/etc/wolke/<ipython-input-5-27e1d9dc9a1a> in <module>()
----> 1 client.fetch('https://mail.google.com/', method='POST', body='')

/usr/lib/python2.6/dist-packages/tornado/httpclient.pyc in fetch(self, request, **kwargs)
     84         response = self._response
     85         self._response = None
---> 86         response.rethrow()
     87         return response
     88 

/usr/lib/python2.6/dist-packages/tornado/httpclient.pyc in rethrow(self)
    356         """If there was an error on the request, raise an `HTTPError`."""
    357         if self.error:
--> 358             raise self.error
    359 
    360     def __repr__(self):

IOError: Stream is closed
Why there is no ability to send POST/PUT request with body=None? Is there any notes in RFC about requests with empty body? And it looks like there is a bug in iostream.py when httpclient sending empty POST requests over SSL...