Contributor
szweep commented on 19 Oct 2015
I received this error while running some specific unit tests against a lighttpd server:
File "/etc/wg/dxcp_test/tornado/http1connection.py", line 601, in data_received
compressed_data, self._chunk_size)
File "/etc/wg/dxcp_test/tornado/util.py", line 68, in decompress
return self.decompressobj.decompress(value, max_length)
error: Error -3 while decompressing: incorrect header check
The error was caused by a non-RFC compliant response from the server in that it contained both a Content-Length header and a Transfer-Encoding: chunked header. While this is not optimal, the tornado client should be able to handle this. According to RFC 2616, 4.4 #3 "If a message is received with both a Transfer-Encoding header field and a Content-Length header field, the latter MUST be ignored".
In this case the Content-Length was not ignored. Though the data was chunked it was interpreted as non-chunked and the decompress failed. I found a simple solution in util.py _read_body() to change the ordering so that the Transfer-Encoding is checked before the content length.
I can generate a pull request with this fix if you'd like.