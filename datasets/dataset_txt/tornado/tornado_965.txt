Member
bdarnell commented on 29 Apr 2013
_handle_read tries to read as much as it can into the buffer before checking to see if its buffered data can satisfy the pending read (this is important for performance; see commit 41463a9). However, on a fast network this can lead to the buffer growing quickly and exceeding max_buffer_size, even if we are going to process it with a series of reads that don't require that much buffered data (we're also missing an opportunity to apply TCP backpressure to the sender).
We should try running read_from_buffer more often to balance buffer growth vs read_until efficiency. It should at least be run before attempting a read_to_buffer that might put the stream over its limit. When the pending read is a read_bytes we can try read_from_buffer every time. We may want to add a size parameter to read_until and read_until_regex (either as a hint or a hard limit).