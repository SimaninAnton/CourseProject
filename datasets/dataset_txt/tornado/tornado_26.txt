lbolla commented on 4 Sep 2019 â€¢
edited
When using AsyncHTTPClient I get the below error (on Tornado 6.0.3).
[E 190904 16:04:29 ioloop:763] Exception in callback functools.partial(<function _HTTPConnection.__init__.<locals>.<lambda> at 0x7f58706627b8>, <Task finished coro=<_HTTPConnection.run() done, defined at /usr/local/lib/python3.6/site-packages/tornado/simple_httpclient.py:289> exception=_QuietException()>)
   Traceback (most recent call last):
      File "/usr/local/lib/python3.6/site-packages/tornado/http1connection.py", line 273, in _read_message
        delegate.finish()
      File "/usr/local/lib/python3.6/site-packages/tornado/http1connection.py", line 756, in finish
        return self._delegate.finish()
      File "/usr/local/lib/python3.6/site-packages/tornado/simple_httpclient.py", line 657, in finish
       fut.add_done_callback(lambda f: final_callback(f.result()))
    AttributeError: 'coroutine' object has no attribute 'add_done_callback'

    During handling of the above exception, another exception occurred:

    Traceback (most recent call last):
      File "/usr/local/lib/python3.6/site-packages/tornado/ioloop.py", line 743, in _run_callback
        ret = callback()
      File "/usr/local/lib/python3.6/site-packages/tornado/simple_httpclient.py", line 286, in <lambda>
        gen.convert_yielded(self.run()), lambda f: f.result()
      File "/usr/local/lib/python3.6/site-packages/tornado/simple_httpclient.py", line 438, in run
        await self._write_body(True)
      File "/usr/local/lib/python3.6/site-packages/tornado/simple_httpclient.py", line 518, in _write_body
        await self.connection.read_response(self)
    File "/usr/local/lib/python3.6/site-packages/tornado/http1connection.py", line 273, in _read_message
        delegate.finish()
     File "/usr/local/lib/python3.6/site-packages/tornado/http1connection.py", line 68, in __exit__
        raise _QuietException
    tornado.http1connection._QuietException
I can't reproduce this error in all my environments: it seems to happen only in certain Docker containers. So, it may be caused a user misconfiguration, but given that it works most of the times, I am inclined to think that the code is right, but a bug in Tornado is revealed in certain (unknown) circumstances.
I am using async/await syntax, not tornado.gen.coroutine, and Python 3.6.9.
Do you know what may be causing this?