mayouf commented on Jul 30, 2016
Hi everybody,
Think we have a bug here.
I am trying to scrape this page (french social and environmental data) :
scrapy shell http://www.kelquartier.com/rhone_alpes_ain_commune_divonne_les_bains_01220-c1143/revenu_moyen.html
I try to pick up the data in this xpath:
In [270]: [i.strip() for i in response.xpath('//tr[@id="carteNum_12"]//td//text()').extract()]
Out[270]: [u'', u'Densit\xe9 de logements', u'', u'1 log./ha', u'', u'', u'']
BUT in the page the data appear we have 3 informations in this xpath:
"densite de logement"
"1 log./ha"
"<1 log./ha"
Then, I noticed this specific character: <
YET, when I check the body text from the response, this character is here....
In [303]: response.body[127220:127251]
Out[303]: '<td class="td_B">1 log./ha</td>'
In [304]: response.body[127725:127757]
Out[304]: '<td class="td_B"><1 log./ha</td>'
When I check the encoding, it is not utf-8 but cp1225.
In    [260]  : response._body_declared_encoding()
Out [260]  : 'cp1252
And when I checked many website that I scraped in past, the response encoding was always utf-8.
When I checked on stackoverflow, I saw many suggestion like:
unicode(response.body.decode(response.encoding)).encode('utf-8')
newresponse = response.replace(encoding='utf-8')
the encoding is always cp1252:
In    [260]  : response._body_declared_encoding()
Out [260]  : 'cp1252
and my xpath still doesn't take the information I need, which is: '<1 log./ha'
So in summary, this is a situation where the data is present in the body but not in its xpath. And it only comes with pages with the following specific character "<".
And trying debugging the situation, I figured out the response encoding is cp1252 and it is impossible to change it.