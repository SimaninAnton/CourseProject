yutiansut commented on Jan 27, 2017 •
edited
Well, I meet some problems, but I don't know how to solve it. It seems that there are something wrong with my request url from the scrapy cmd callback
 raise ValueError('Missing scheme in request url: %s' % self._url)
ValueError: Missing scheme in request url: h
my start url is
start_urls = 'https://xueqiu.com/people'
But i have checked the spider from many times, and still don't know how to solve this
I used the selenium + PhantomJS as the middleware, codes below are my spider's code,could you help me?
IPSpider.py
import scrapy
from scrapy.spiders import Spider  
# from scrapy.http import Request  
from scrapy.selector import Selector  
from influenceSpider.items import InfluencespiderItem
from influenceSpider.middlewares import InfluencespiderSpiderMiddleware
import json
import base64
import requests
from selenium import webdriver  
from selenium.webdriver.common.desired_capabilities import DesiredCapabilities
import getCookies as cok

class IpspiderSpider(Spider):
    #
    name = "IPSpider"
    allowed_domains = ["xueqiu.com"] 
    item = [ ]
    start_urls = 'https://xueqiu.com/people'
    t = cok.getCookies()
    cookies = t.getCookiesFromXueqiu('xueqiu');
    print cookies
    print '===start requests==='
    print start_urls
    def parse(self, response):
        print self.start_urls
        print self.cookies
        spider = Spider(self,name="IPSpider")
        InfluencespiderSpiderMiddleware.process_request(self,self.start_urls,spider,self.cookies)
middleware.py
from selenium import webdriver  
from selenium.webdriver.common.desired_capabilities import DesiredCapabilities
from scrapy.http import HtmlResponse
import time  
import random
import base64

class InfluencespiderSpiderMiddleware(object):
    # Not all methods need to be defined. If a method is not defined,
    # scrapy acts as if the spider middleware does not modify the
    # passed objects.

    def process_request(self, request, spider,cookies):
        print "PhantomJS is starting..."
        dcap = dict(DesiredCapabilities.PHANTOMJS)
        dcap["phantomjs.page.settings.userAgent"] = (
        "Mozilla/5.0 (Macintosh; Intel Mac OS X 10.9; rv:25.0) Gecko/20100101 Firefox/25.0 ")
        driver = webdriver.PhantomJS(executable_path='D:/Projects/Projects/craw/xueqiu/influenceSpider/influenceSpider/phantomjs.exe', desired_capabilities=dcap)
 print 'before get'
        driver.add_cookie(cookies)
        driver.get(request.url)
        print 'after get'
        time.sleep(1)
        js = "var q=document.documentElement.scrollTop=10000"
        driver.execute_script(js) #可执行js，模仿用户操作。此处为将页面拉至最底端。
        time.sleep(3)
        body = driver.page_source
        print("访问"+request.url)
        return HtmlResponse(driver.current_url, body=body, encoding='utf-8', request=request)
thanks anyway