imaxwen commented on Dec 8, 2019 •
edited
Description
Enabled both RetryMiddleware and CookiesMiddleware in my project,
Every time after retried, the cookie not updated
Steps to Reproduce
settings.py
# settings.py
DOWNLOADER_MIDDLEWARES = {
    'scrapy.downloadermiddlewares.retry.RetryMiddleware': None,
    'ToolkitSpiders.middlewares.saicmotor.RetryLoginMiddleware': 543
}

# retry_login_middleware.py
class RetryLoginMiddleware(RetryMiddleware):

    def process_response(self, request, response, spider):
        retry_times = request.meta.get('retry_times', 0)
        if request.meta.get('login_request', False):
            # 登录结果页面校验
            login_errs = ['Code Error', 'Wrong Username/Password']
            match_errs = [err for err in login_errs if err in response.text]
            if len(match_errs) > 0:
                err_msg = match_errs[0]
                return self._retry(request, err_msg, spider)
            else:
                spider.logger.info("login succeed!")

        return response
Do I need to update the cookie manually? or any thing I missed?
Please Help!
Expected behavior: Auto update cookies in cookiejar after request retried.
Reproduces how often: Every time while the RetryMiddleware fired.
Versions
1.8.0
Additional context