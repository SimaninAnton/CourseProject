Support for returning deferreds in middlewares