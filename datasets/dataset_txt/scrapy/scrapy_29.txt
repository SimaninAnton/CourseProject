Jerry007s commented on Nov 13, 2019
Description
I use dynamic proxy, but ip can't change when retry this request.
Steps to Reproduce
I simulated this process. forcibly 200 status_code to retry. e.g.RETRY_HTTP_CODES = [200, 301, 302]. So it will be retry again and again until give up this request.
But even with the proxy can not be changed for each request ip, unless restart or begin another request.
spider.py
    def start_requests(self):
        yield scrapy.Request(url='https://httpbin.org/get')
middlewares.py
class RandomProxyMiddleware(object):
    def __init__(self, proxies):
        self.proxies = proxies

    @classmethod
    def from_crawler(cls, crawler):
        settings = crawler.settings
        return cls(proxies=settings.get('PROXIES'))

    def process_request(self, request, spider):
        request.meta['proxy'] = self.proxies

class TestProxyMiddleware(object):
    def process_response(self, request, response, spider):
        spider.logger.info(response.text)
        return response
Expected behavior: [What you expect to happen]
Please notice origin
2019-11-13 18:41:04 [scrapy.downloadermiddlewares.retry] DEBUG: Retrying <GET https://httpbin.org/get> (failed 1 times): 200 OK
2019-11-13 18:41:05 [broker] INFO: {
  "args": {}, 
  "headers": {
    "Host": "httpbin.org", 
  "origin": "180.109.64.86, 180.109.64.86",
  "url": "https://httpbin.org/get"
}

2019-11-13 18:41:05 [scrapy.downloadermiddlewares.retry] DEBUG: Retrying <GET https://httpbin.org/get> (failed 2 times): 200 OK
2019-11-13 18:41:05 [broker] INFO: {
  "args": {}, 
  "headers": {
    "Host": "httpbin.org", 
  "origin": "89.10.64.6, 89.10.64.6",
  "url": "https://httpbin.org/get"
}
Actual behavior: [What actually happens]
Please notice origin
2019-11-13 18:41:04 [scrapy.downloadermiddlewares.retry] DEBUG: Retrying <GET https://httpbin.org/get> (failed 1 times): 200 OK
2019-11-13 18:41:05 [broker] INFO: {
  "args": {}, 
  "headers": {
    "Host": "httpbin.org", 
  "origin": "180.109.64.86, 180.109.64.86",
  "url": "https://httpbin.org/get"
}

2019-11-13 18:41:05 [scrapy.downloadermiddlewares.retry] DEBUG: Retrying <GET https://httpbin.org/get> (failed 2 times): 200 OK
2019-11-13 18:41:05 [broker] INFO: {
  "args": {}, 
  "headers": {
    "Host": "httpbin.org", 
  "origin": "180.109.64.86, 180.109.64.86",
  "url": "https://httpbin.org/get"
}
Versions
Scrapy       : 1.6.0
lxml         : 4.4.0.0
libxml2      : 2.9.9
cssselect    : 1.0.3
parsel       : 1.5.1
w3lib        : 1.19.0
Twisted      : 17.9.0
Python       : 3.6.4 (v3.6.4:d48ecebad5, Dec 18 2017, 21:07:28) - [GCC 4.2.1 (Apple Inc. build 5666) (dot 3)]
pyOpenSSL    : 17.5.0 (OpenSSL 1.1.0h  27 Mar 2018)
cryptography : 2.2.2
Platform     : Darwin-18.7.0-x86_64-i386-64bit