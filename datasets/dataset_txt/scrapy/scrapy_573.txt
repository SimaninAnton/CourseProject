youleihuang commented on Jul 28, 2017 â€¢
edited by redapple
I want to download some photo from this website, when I get the photo's url I find there are some problems ,some photo can download ,other can not.
#coding:utf-8
from scrapy.spiders import Spider
from scrapy.selector import Selector
from jianshu.items import JianshuItem
import scrapy
from scrapy.crawler  import  CrawlerProcess


class jiansider(Spider):
 name = "jiantu"
 allowed_domains = []
 start_urls= [
 "https://tieba.baidu.com/p/5227563995"
 ]


 def parse(self, response):

  sel = Selector(response)
  sites = sel.xpath('//div/img/@src').extract()
  item = JianshuItem()
  item['image_url'] = response.xpath('//div/img/@src').extract()
  for url in item['image_url']:


  
   list_photo = url.split('.')
   photo_type = list_photo[len(list_photo)-1]
   print photo_type
   if photo_type != 'jpg':
    #print url
    item['image_url'].remove(url)
    #print "delete1"

  
  yield item
  total_page = response.xpath('//span[@class="red"]/text()').extract()
  now_page = response.xpath('//li/span[@class="tP"]/text()').extract()
  tpa=total_page[len(total_page)-1]
  npa=now_page[len(now_page)-1]
  tpage= int(tpa)
  npage= int (npa)
  starturls = 'https://tieba.baidu.com/p/5227563995?pn='
  if npage != tpage:
   npage = npage+1
   new_url = '%s%s'%(starturls,npage)
   print "new_url is ------------"
   print new_url  
  if new_url:
   yield  scrapy.Request(new_url,callback = self.parse)
  2017-07-27 16:39:41 [scrapy.core.scraper] ERROR: Error processing {'image_url': [u'https://imgsa.baidu.com/forum/w%3D580/sign=b78ca5208dd6277fe912323018391f63/80048326cffc1e17ba0fbdaa4090f603728de922.jpg',
               u'https://gsp0.baidu.com/5aAHeD3nKhI2p27j8IqW0jdnxx1xbK/tb/editor/images/client/image_emoticon12.png',
               u'https://gsp0.baidu.com/5aAHeD3nKhI2p27j8IqW0jdnxx1xbK/tb/editor/images/client/image_emoticon1.png',
               u'https://gsp0.baidu.com/5aAHeD3nKhI2p27j8IqW0jdnxx1xbK/tb/editor/images/client/image_emoticon27.png',
               u'https://gsp0.baidu.com/5aAHeD3nKhI2p27j8IqW0jdnxx1xbK/tb/editor/images/client/image_emoticon28.png',
               u'//tb2.bdstatic.com/tb/static-pb/img/loading_69032b0.gif',
               u'//tb2.bdstatic.com/tb/static-pb/img/loading_69032b0.gif',
               u'https://imgsa.baidu.com/forum/w%3D580/sign=57f4bac7865494ee87220f111df5e0e1/faac203fb80e7becf0cd3899252eb9389a506be4.jpg',
               u'https://imgsa.baidu.com/forum/w%3D580/sign=5dbaf84b798da9774e2f86238051f872/41af5bafa40f4bfbecc7a52c094f78f0f63618db.jpg',
               u'//tb2.bdstatic.com/tb/static-pb/img/loading_69032b0.gif',
               u'https://gsp0.baidu.com/5aAHeD3nKhI2p27j8IqW0jdnxx1xbK/tb/editor/images/client/image_emoticon15.png',
               u'//tb2.bdstatic.com/tb/static-pb/img/loading_69032b0.gif',
               u'//tb2.bdstatic.com/tb/static-pb/img/loading_69032b0.gif',
               u'//tb2.bdstatic.com/tb/static-pb/img/loading_69032b0.gif',
               u'https://gsp0.baidu.com/5aAHeD3nKhI2p27j8IqW0jdnxx1xbK/tb/editor/images/client/image_emoticon25.png',
               u'https://imgsa.baidu.com/forum/pic/item/8af90823dd54564e654a0ea2b9de9c82d0584fa8.jpg',
               u'//tb2.bdstatic.com/tb/static-pb/img/loading_69032b0.gif',
               u'//tb1.bdstatic.com/tb/cms/dalibao.png']}
Traceback (most recent call last):
  File "/usr/local/lib/python2.7/site-packages/twisted/internet/defer.py", line 653, in _runCallbacks
    current.result = callback(current.result, *args, **kw)
  File "/Users/youleihuang/pythontestku/jianshu/jianshu/pipelines.py", line 25, in process_item
    conn = urllib.urlopen(image_url)
  File "/usr/local/Cellar/python/2.7.13/Frameworks/Python.framework/Versions/2.7/lib/python2.7/urllib.py", line 87, in urlopen
    return opener.open(url)
  File "/usr/local/Cellar/python/2.7.13/Frameworks/Python.framework/Versions/2.7/lib/python2.7/urllib.py", line 213, in open
    return getattr(self, name)(url)
  File "/usr/local/Cellar/python/2.7.13/Frameworks/Python.framework/Versions/2.7/lib/python2.7/urllib.py", line 467, in open_file
    return self.open_ftp(url)
  File "/usr/local/Cellar/python/2.7.13/Frameworks/Python.framework/Versions/2.7/lib/python2.7/urllib.py", line 550, in open_ftp
    ftpwrapper(user, passwd, host, port, dirs)
  File "/usr/local/Cellar/python/2.7.13/Frameworks/Python.framework/Versions/2.7/lib/python2.7/urllib.py", line 877, in __init__
    self.init()
  File "/usr/local/Cellar/python/2.7.13/Frameworks/Python.framework/Versions/2.7/lib/python2.7/urllib.py", line 886, in init
    self.ftp.connect(self.host, self.port, self.timeout)
  File "/usr/local/Cellar/python/2.7.13/Frameworks/Python.framework/Versions/2.7/lib/python2.7/ftplib.py", line 135, in connect
    self.sock = socket.create_connection((self.host, self.port), self.timeout)
  File "/usr/local/Cellar/python/2.7.13/Frameworks/Python.framework/Versions/2.7/lib/python2.7/socket.py", line 575, in create_connection
    raise err
IOError: [Errno ftp error] [Errno 60] Operation timed out