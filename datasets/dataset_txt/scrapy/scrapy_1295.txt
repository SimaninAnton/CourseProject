Contributor
pawelmhm commented on Feb 6, 2015
I have somewhat unusual bug related to Scrapy Images pipeline, it all happens here https://github.com/scrapy/scrapy/blob/master/scrapy/contrib/pipeline/images.py#L92 in convert_image method.
I have following image with white background: http://images.vitaminimages.com/hb/vf/productimages/HB/370/021837_A.png background is converted to black for some strange reason. This happens because image is .png with mode 'P' and we are not adding background explicitly for this mode even though this is possible.
In [24]: from PIL import Image

In [25]: image = Image.open('021837_A.png')

In [26]: image.mode
Out[26]: 'P'

In [27]: im = image.convert('RGB')

In [28]: im.save('demo', 'JPEG')
# you will get image with black background in 'demo' file
Above code is what Image pipeline is doing. It does this if it detects that image mode is not 'RGBA'. Black background is added by PIL in conversion.
But it seems that there is no problem in just converting image to this 'RGBA' mode and then adding background for it regardless of image mode.
In [54]: background = Image.new('RGBA', image.size, (255,255,255))

In [55]: img = image.convert('RGBA')

In [56]: background.paste(img, img)

In [57]: background.save('demo_other', 'JPEG')
# nice white background as expected 
It would be nice to add white background always when this is possible for .png images. If user is downloading lots of images he prefers to have all of them with some specific background and not other.