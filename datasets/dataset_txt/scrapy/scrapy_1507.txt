Member
dangra commented on Sep 21, 2013
The new HTTP1.1 downloader handler landed into Scrapy 0.18, but it lacks proper support for HTTPS downloads trough proxies, it must use HTTP tunneling trough CONNECT method instead of absolute URI mechanism described by RFC2616
There were previous attempts to bring this support to Scrapy but they were implemented for (deprecated) HTTP1.0 download handler. i.e.: #45 #237 #16
Scrapy is using new Twisted Agents as backend for downloads, proxied requests instsanciate a t.w.c.ProxyAgent in s.c.d.h.http11#L58
Current ProxyAgent implementation by Twisted doesn't support CONNECT mechanism (Twisted ticket #5324).
This ticket is about implementing CONNECT mechanism using Twisted endpoints as described by ProxyAgent.request() comments::
    # To support proxying HTTPS via CONNECT, we will use key
    # ("http-proxy-CONNECT", scheme, host, port), and an endpoint that
    # wraps _proxyEndpoint with an additional callback to do the CONNECT.
    return self._requestWithEndpoint(key, self._proxyEndpoint, method,
                                     _URI.fromBytes(uri), headers,
                                     bodyProducer, uri)