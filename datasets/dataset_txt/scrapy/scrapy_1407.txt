dmoisset commented on May 24, 2014
I'm having an exception when extracting links for a site. It can be reproduced by:
$ scrapy shell 'http://www.cnea.gov.ar/'
>>> from scrapy.contrib.linkextractors import sgml
>>> e = sgml.SgmlLinkExtractor()
>>> e.extract_links(response)
That produces the following traceback:
---------------------------------------------------------------------------
SGMLParseError                            Traceback (most recent call last)
<ipython-input-3-276218303eda> in <module>()
----> 1 e.extract_links(response)

/home/dmoisset/caf/env/local/lib/python2.7/site-packages/scrapy/contrib/linkextractors/sgml.pyc in extract_links(self, response)
    127             body = response.body
    128
--> 129         links = self._extract_links(body, response.url, response.encoding, base_url)
    130         links = self._process_links(links)
    131         return links

/home/dmoisset/caf/env/local/lib/python2.7/site-packages/scrapy/contrib/linkextractors/sgml.pyc in _extract_links(self, response_text, response_url, response_encoding, base_url)
     27         """ Do the real extraction work """
     28         self.reset()
---> 29         self.feed(response_text)
     30         self.close()
     31

/usr/lib/python2.7/sgmllib.pyc in feed(self, data)
    102
    103         self.rawdata = self.rawdata + data
--> 104         self.goahead(0)
    105
    106     def close(self):

/usr/lib/python2.7/sgmllib.pyc in goahead(self, end)
    172                     # deployed," this should only be the document type
    173                     # declaration ("<!DOCTYPE html...>").
--> 174                     k = self.parse_declaration(i)
    175                     if k < 0: break
    176                     i = k

/usr/lib/python2.7/markupbase.pyc in parse_declaration(self, i)
    138             else:
    139                 self.error(
--> 140                     "unexpected %r char in declaration" % rawdata[j])
    141             if j < 0:
    142                 return j

/usr/lib/python2.7/sgmllib.pyc in error(self, message)
    109
    110     def error(self, message):
--> 111         raise SGMLParseError(message)
    112
    113     # Internal -- handle data as far as reasonable.  May leave state

SGMLParseError: unexpected '=' char in declaration
This looks like some kind of problem with the doctype, except that I checked the beginning of response.body and it has a perfectly valid XHTML 1.0 transitional doctype