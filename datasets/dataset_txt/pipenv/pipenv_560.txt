rbricheno commented on 12 Oct 2018 •
edited by uranusjr
Issue description
pipenv install -e git+https://github.com/explosion/spaCy#egg=spacy
fails because of a missing cython requirement, leaving a mostly-empty Pipfile which does not specify any packages.
This issue was identified by the user spbks on stackoverflow:
https://stackoverflow.com/questions/50316275/how-to-use-pipenv-to-install-package-from-github
Expected result
pipenv uses the requirements.txt in the spaCy github repository to install the requirements
Actual result
rob@server:~/spacy-pipenv$ pipenv install -e git+https://github.com/explosion/spaCy#egg=spacy
Installing -e git+https://github.com/explosion/spaCy#egg=spacy…
Obtaining spacy from git+https://github.com/explosion/spaCy#egg=spacy
  Updating /home/rob/.local/share/virtualenvs/spacy-pipenv-0MSJ3ob8/src/spacy clone
    Complete output from command python setup.py egg_info:
    Traceback (most recent call last):
      File "<string>", line 1, in <module>
    ModuleNotFoundError: No module named 'Cython'
    Processing typedefs.pyx
    Traceback (most recent call last):
      File "/home/rob/.local/share/virtualenvs/spacy-pipenv-0MSJ3ob8/src/spacy/bin/cythonize.py", line 59, in process_pyx
        env=os.environ) # See Issue #791
      File "/usr/lib/python3.6/subprocess.py", line 267, in call
        with Popen(*popenargs, **kwargs) as p:
      File "/usr/lib/python3.6/subprocess.py", line 709, in __init__
        restore_signals, start_new_session)
      File "/usr/lib/python3.6/subprocess.py", line 1344, in _execute_child
        raise child_exception_type(errno_num, err_msg, err_filename)
    FileNotFoundError: [Errno 2] No such file or directory: 'cython': 'cython'

    During handling of the above exception, another exception occurred:

    Traceback (most recent call last):
      File "/home/rob/.local/share/virtualenvs/spacy-pipenv-0MSJ3ob8/src/spacy/bin/cythonize.py", line 157, in <module>
        run(args.root)
      File "/home/rob/.local/share/virtualenvs/spacy-pipenv-0MSJ3ob8/src/spacy/bin/cythonize.py", line 148, in run
        process(base, filename, db)
      File "/home/rob/.local/share/virtualenvs/spacy-pipenv-0MSJ3ob8/src/spacy/bin/cythonize.py", line 114, in process
        preserve_cwd(base, process_pyx, root + '.pyx', root + '.cpp')
      File "/home/rob/.local/share/virtualenvs/spacy-pipenv-0MSJ3ob8/src/spacy/bin/cythonize.py", line 79, in preserve_cwd
        func(*args)
      File "/home/rob/.local/share/virtualenvs/spacy-pipenv-0MSJ3ob8/src/spacy/bin/cythonize.py", line 70, in process_pyx
        raise Exception('Cython failed')
    Exception: Cython failed
    Cythonizing sources
    Traceback (most recent call last):
      File "<string>", line 1, in <module>
      File "/home/rob/.local/share/virtualenvs/spacy-pipenv-0MSJ3ob8/src/spacy/setup.py", line 224, in <module>
        setup_package()
      File "/home/rob/.local/share/virtualenvs/spacy-pipenv-0MSJ3ob8/src/spacy/setup.py", line 172, in setup_package
        generate_cython(root, 'spacy')
      File "/home/rob/.local/share/virtualenvs/spacy-pipenv-0MSJ3ob8/src/spacy/setup.py", line 104, in generate_cython
        raise RuntimeError('Running cythonize failed')
    RuntimeError: Running cythonize failed

    ----------------------------------------

Error:  An error occurred while installing -e git+https://github.com/explosion/spaCy#egg=spacy!
Command "python setup.py egg_info" failed with error code 1 in /home/rob/.local/share/virtualenvs/spacy-pipenv-0MSJ3ob8/src/spacy/

This is likely caused by a bug in spacy. Report this to its maintainers.
rob@server:~/spacy-pipenv$ cat Pipfile
[[source]]
url = "https://pypi.org/simple"
verify_ssl = true
name = "pypi"

[packages]

[dev-packages]

[requires]
python_version = "3.6"
rob@server:~/spacy-pipenv$ 
Steps to replicate
Run the command on a server without first installing the requirements.
The problem can be worked around by first installing the reuqirements using
pipenv install -r https://raw.githubusercontent.com/explosion/spaCy/master/requirements.txt
pipenv install -e git+https://github.com/explosion/spaCy#egg=spacy
which results in the following Pipfile:
[[source]]
url = "https://pypi.org/simple"
verify_ssl = true
name = "pypi"

[packages]
numpy = ">=1.15.0"
msgpack-numpy = "<0.4.4.0"
cymem = ">=1.30,<1.32"
preshed = ">=1.0.0,<2.0.0"
thinc = ">=6.10.3,<6.11.0"
murmurhash = ">=0.28,<0.29"
plac = "<1.0.0,>=0.9.6"
ujson = ">=1.35"
dill = "<0.3,>=0.2"
regex = "==2018.01.10"
requests = "<3.0.0,>=2.13.0"
pytest = "<4.0.0,>=3.6.0"
mock = "<3.0.0,>=2.0.0"
pathlib = "==1.0.1"
Cython = ">=0.24,<0.28.0"
spacy = {editable = true, git = "https://github.com/explosion/spaCy"}

[dev-packages]

[requires]
python_version = "3.6"
Unfortunately I didn't run pipenv --support before installing the requirements, so this is the output after I have successfully installed spaCy using the workaround above:
$ pipenv --support