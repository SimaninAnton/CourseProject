drcongo commented on 17 Feb 2018
Trying to install packages via pipenv inside a Python 3.5/3.6 Docker container throws a UnicodeDecodeError.
Note: I'm installing from a specific commit, otherwise it's not finding the correct python binary as mentioned in #1002 - I know this isn't a release version, but figured it best to bring this up just in case that's about to be.
Describe your environment
macOS 10.13.2
Python versions: $ 3.5x or $ 3.6x
Pipenv version: See the commit hash in the Dockerfile
Docker version: 17.12.0-ce-mac49 (21995)
Expected result
Expected some packages to be installed.
Actual result
Failed building wheel for markupsafe
Exception:
Traceback (most recent call last):
  File "/root/.local/share/virtualenvs/app-4PlAip0Q/lib/python3.6/site-packages/pip/compat/__init__.py", line 73, in console_to_str
    return s.decode(sys.__stdout__.encoding)
UnicodeDecodeError: 'utf-8' codec can't decode byte 0xb5 in position 1: invalid start byte

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/root/.local/share/virtualenvs/app-4PlAip0Q/lib/python3.6/site-packages/pip/basecommand.py", line 215, in main
    status = self.run(options, args)
  File "/root/.local/share/virtualenvs/app-4PlAip0Q/lib/python3.6/site-packages/pip/commands/install.py", line 342, in run
    prefix=options.prefix_path,
  File "/root/.local/share/virtualenvs/app-4PlAip0Q/lib/python3.6/site-packages/pip/req/req_set.py", line 784, in install
    **kwargs
  File "/root/.local/share/virtualenvs/app-4PlAip0Q/lib/python3.6/site-packages/pip/req/req_install.py", line 878, in install
    spinner=spinner,
  File "/root/.local/share/virtualenvs/app-4PlAip0Q/lib/python3.6/site-packages/pip/utils/__init__.py", line 676, in call_subprocess
    line = console_to_str(proc.stdout.readline())
  File "/root/.local/share/virtualenvs/app-4PlAip0Q/lib/python3.6/site-packages/pip/compat/__init__.py", line 75, in console_to_str
    return s.decode('utf_8')
UnicodeDecodeError: 'utf-8' codec can't decode byte 0xb5 in position 1: invalid start byte
Steps to replicate
docker build this file
FROM python:3.6 as builder

RUN set -ex && pip install pip git+git://github.com/pypa/pipenv.git@8378a1b104f2d817790a05da370bef0a1b00f452 --upgrade
RUN set -ex && mkdir -p /srv/app
WORKDIR /srv/app
COPY Pipfile Pipfile
RUN set -ex && pipenv install --deploy --system
With this Pipfile
[[source]]

url = "https://pypi.python.org/simple"
verify_ssl = true
name = "pypi"

[dev-packages]

[packages]
wrapt = "*"
markupsafe = "*"
pycrypto = "*"
pyyaml = "*"
simplejson = "*"

[requires]

python_version = "3.6"
Side note, I did try the recommended Dockerfile with the ONBUILD commands in, but nothing got installed at all, it just skipped straight past the pipenv install line. I've also tried explicitly setting various env vars like
ENV LC_ALL C.UTF-8 and ENV LANG C.UTF-8
Apologies if this is either a) a known issue or b) my own stupidity.