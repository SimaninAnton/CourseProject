kierun commented on 17 Oct 2019
Issue description
Pipenv fails to run pytest under the right virtual environment.
Expected result
When runing tox -rve py36, I expect python 3 to run, not python 2.
Actual result
Here is a run:
usignals-OSmrmm7O(python3|+1); tox -rve py36                   
using tox.ini: /home/usr/repos/usignals/tox.ini (pid 13640)
using tox-3.14.0 from /home/usr/.virtualenvs/usignals-OSmrmm7O/lib/python2.7/site-packages/tox/__init__.pyc (pid 13640)
GLOB sdist-make: /home/usr/repos/usignals/setup.py
[13648] /home/usr/repos/usignals$ /home/usr/.virtualenvs/usignals-OSmrmm7O/bin/python2.7 setup.py sdist --formats=zip --dist-dir .tox/dist >.tox/log/GLOB-0.log
package .tmp/package/1/usignals-0.4.0.zip links to dist/usignals-0.4.0.zip (/home/usr/repos/usignals/.tox)
py36 cannot reuse: -r flag
py36 create: /home/usr/repos/usignals/.tox/py36
[13653] /home/usr/repos/usignals/.tox$ /home/usr/.virtualenvs/usignals-OSmrmm7O/bin/python2.7 -m virtualenv --no-download --python /usr/bin/python3.6 py36 >py36/log/py36-0.log
py36 inst: /home/usr/repos/usignals/.tox/.tmp/package/1/usignals-0.4.0.zip
write config to /home/usr/repos/usignals/.tox/py36/.tox-config1 as '66a61f41299ac9c1daf8e4a695b217df37c78ff9bb18610d56471b4e33d5e65f /usr/bin/python3.6\n3.14.0 0 0 0'
[13695] /home/usr/repos/usignals$ /home/usr/repos/usignals/.tox/py36/bin/python -m pip install --exists-action w .tox/.tmp/package/1/usignals-0.4.0.zip >.tox/py36/log/py36-1.log
[13861] /home/usr/repos/usignals$ /home/usr/repos/usignals/.tox/py36/bin/python -m pip freeze >.tox/py36/log/py36-2.log
py36 installed: Click==7.0,click-help-colors==0.6,PyMySQL==0.9.3,usignals==0.4.0
py36 run-test-pre: PYTHONHASHSEED='657242658'
py36 run-test: commands[0] | pipenv --bare install --ignore-pipfile --dev
WARNING: test command found but not installed in testenv
  cmd: /home/usr/.local/bin/pipenv
  env: /home/usr/repos/usignals/.tox/py36
Maybe you forgot to specify a dependency? See also the whitelist_externals envconfig setting.

DEPRECATION WARNING: this will be an error in tox 4 and above!
[13862] /home/usr/repos/usignals$ /home/usr/.local/bin/pipenv --bare install --ignore-pipfile --dev
Installing dependencies from Pipfile.lock (fea64d)â€¦
  ðŸ   â–‰â–‰â–‰â–‰â–‰â–‰â–‰â–‰â–‰â–‰â–‰â–‰â–‰â–‰â–‰â–‰â–‰â–‰â–‰â–‰â–‰â–‰â–‰â–‰â–‰â–‰â–‰â–‰â–‰â–‰â–‰â–‰ 73/73 â€” 00:00:08
To activate this project's virtualenv, run pipenv shell.
Alternatively, run a command inside the virtualenv with pipenv run.
py36 run-test: commands[1] | pipenv --bare run make coverage
WARNING: test command found but not installed in testenv
  cmd: /home/usr/.local/bin/pipenv
  env: /home/usr/repos/usignals/.tox/py36
Maybe you forgot to specify a dependency? See also the whitelist_externals envconfig setting.

DEPRECATION WARNING: this will be an error in tox 4 and above!
[14449] /home/usr/repos/usignals$ /home/usr/.local/bin/pipenv --bare run make coverage
coverage run --source usignals -m pytest
============================= test session starts ==============================
platform linux2 -- Python 2.7.16, pytest-4.6.6, py-1.8.0, pluggy-0.13.0
cachedir: .tox/py36/.pytest_cache
rootdir: /home/usr/repos/usignals, inifile: setup.cfg
plugins: colordots-1.1, xdist-1.30.0, forked-1.1.1
collected 6 items                                                              
run-last-failure: no previously failed tests, not deselecting items.

tests/test_create_alarms.py ....
tests/test_psu.py ..

--------- generated xml file: /home/usr/repos/usignals/unit_tests.xml ---------
=========================== 6 passed in 0.10 seconds ===========================
coverage report -m
Name                        Stmts   Miss Branch BrPart    Cover   Missing
-------------------------------------------------------------------------
usignals/create_alarms.py      66      0     10      0   100.0%
usignals/psu.py                22      0      4      0   100.0%
-------------------------------------------------------------------------
TOTAL                          88      0     14      0   100.0%
coverage html
python -c "$BROWSER_PYSCRIPT" htmlcov/index.html
___________________________________ summary ____________________________________
  py36: commands succeeded
  congratulations :)

usignals-OSmrmm7O(python3|+1); source .tox/py36/bin/activate
py36(python3|+1); python                 
Python 3.6.8 (default, Aug  7 2019, 17:28:10) 
[GCC 4.8.5 20150623 (Red Hat 4.8.5-39)] on linux
Type "help", "copyright", "credits" or "license" for more information.
>>> 
py36(python3|+1); which pytest  
~/.virtualenvs/usignals-OSmrmm7O/bin/pytest
py36(python3|+1); pipenv --bare run which pytest 
/home/usr/.local/share/virtualenvs/usignals-OSmrmm7O/bin/pytest
Steps to replicate
My tox.ini file:
[tox]
envlist = py36, py27

[testenv]
setenv = 
    PYTHONPATH = {toxinidir}
    PIPENV_IGNORE_VIRTUALENVS=1
commands =
    pipenv --bare install --ignore-pipfile --dev
    pipenv --bare run make coverage
Where make coverage is:
coverage: ## check code coverage quickly with the default Python
 coverage run --source usignals -m pytest
 coverage report -m
 coverage html
 $(BROWSER) htmlcov/index.html
Please run $ pipenv --support, and paste the results here. Don't put backticks (`) around it! The output already contains Markdown formatting.
$ pipenv --support