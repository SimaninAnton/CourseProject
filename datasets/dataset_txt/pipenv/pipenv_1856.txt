Contributor
sersorrel commented on 2 Nov 2017 •
edited
When the network is very slow, Pipenv takes an extremely long time to exit after doing almost anything (e.g. pipenv will print the usage message, and then block for a while – but pipenv --help will behave as normal).
Describe your environment
OS Type: Ubuntu 16.04
Python version: 3.6.3
Pipenv version: 8.3.1, installed via pipsi
Here is the result of pip list in the virtualenv that Pipenv is installed in:
Package          Version    
---------------- -----------
certifi          2017.7.27.1
chardet          3.0.4      
flake8           3.5.0      
idna             2.6        
mccabe           0.6.1      
pew              1.1.0      
pip              9.0.1      
pipenv           8.3.1      
pycodestyle      2.3.1      
pyflakes         1.6.0      
requests         2.18.4     
setuptools       36.6.0     
urllib3          1.22       
virtualenv       15.1.0     
virtualenv-clone 0.2.6      
wheel            0.30.0
Expected result
Pipenv shouldn't suddenly take longer to exit because the network is behaving strangely.
Actual result
If the network is slow, it takes almost exactly 21 seconds to run many Pipenv commands, including:
pipenv
pipenv --completion
but not pipenv --help (finishes in about 1 second, regardless of network state AFAICT).
If I press ctrl-C after running pipenv, when it has printed the usage message but not yet exited, I get a traceback like this:
Error in atexit._run_exitfuncs:
Traceback (most recent call last):
  File "/usr/lib/python3.6/concurrent/futures/thread.py", line 40, in _python_exit
    t.join()
  File "/usr/lib/python3.6/threading.py", line 1056, in join
    self._wait_for_tstate_lock()
  File "/usr/lib/python3.6/threading.py", line 1072, in _wait_for_tstate_lock
    elif lock.acquire(block, timeout):
KeyboardInterrupt
Exception ignored in: <function ThreadPoolExecutor._adjust_thread_count.<locals>.weakref_cb at 0x7fce19f11a60>
Traceback (most recent call last):
  File "/usr/lib/python3.6/concurrent/futures/thread.py", line 131, in weakref_cb
  File "/usr/lib/python3.6/queue.py", line 145, in put
  File "/usr/lib/python3.6/threading.py", line 347, in notify
TypeError: 'NoneType' object is not callable
Steps to replicate
Have a WiFi card that randomly decides to stop working Run sudo tc qdisc add dev INTERFACE root netem delay 10s (where INTERFACE might be something like wlp2s0 – obtain it from either ip link or ifconfig) to add a 10s delay to all your traffic, then run pipenv.
The delay can then be removed with sudo tc qdisc del dev INTERFACE root netem.
Source for these commands