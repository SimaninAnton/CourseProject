shaded-enmity commented on 31 Mar 2017
I'm seeing a deadlock when executing pipenv install (full report oamg/leapp#15 (comment))
Symptoms:
Executing pipenv install never returns.
Cause:
pipenv executes pip via the subprocess module, but doesn't consume the captured output on stdout+stderr:
root     20069  0.4  2.2 309120 23044 pts/0    Sl+  14:32   0:00  |                       \_ /root/.local/venvs/pipenv/bin/python3 /root/.local/bin/pipenv install --ignore-hashes
root     20076  0.6  3.2 253584 32636 pts/0    S+   14:32   0:00  |                           \_ /root/.local/share/virtualenvs/le-app-xOFUapXL/bin/python3 /root/.local/share/virtualenvs/le-app-xOFUapXL/bin/pip install -r /tmp/tmpuamy4fy2-requirements.txt -i https://pypi.python.org/simple


[root@centos7-ci vagrant]# strace -p 20069
Process 20069 attached
wait4(20076, 

---

[root@centos7-ci vagrant]# strace -p 20076 -s 1024
Process 20076 attached
write(1, "    Skipping link https://pypi.python.org/packages/bd/bc/d754e01270adc77eb0c645078f90a654030ccd87d7433d62298ec2bf5632/pyasn1-0.1.5-py2.4.egg#md5=9801921c021171460260886117abcd30 (from https://pypi.python.org/simple/pyasn
Notice how the pipenv process is waiting on the child pip process while the child pip process is waiting for the parent to consume it's stdout (since the PIPE buffer has filled).
Temporary workaround is patching cli.py and vendor/delegator.py:
https://github.com/leapp-to/prototype/blob/54144592cf7ca6a88eaf8c08946a2ef2aa17864b/ansible/centos-ci/patches/delegator.patch
https://github.com/leapp-to/prototype/blob/54144592cf7ca6a88eaf8c08946a2ef2aa17864b/ansible/centos-ci/patches/cli.patch
I could submit a PR with required changes, but first it'd be good to agree on the overall strategy how to handle this scenario (since the workaround suppresses the output of pip) - I'd probably launch a second thread per each delegator.run invocation which would act as stdout/err collector on behalf of the caller.
2