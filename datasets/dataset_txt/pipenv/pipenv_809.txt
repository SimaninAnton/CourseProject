pecigonzalo commented on 23 Jul 2018 •
edited
Issue description
When installing botocore==1.10.62 some comments on the setup.cfg make the parser fail.
https://github.com/boto/botocore/blob/2565d7912c05eadeae9f9f8ff77c18846c8cae34/setup.cfg
This seems to have been introduced after: 2018.6.25
Expected result
Installing correctly ignoring the comment
Actual result
❯ pipenv lock -v             
Locking [dev-packages] dependencies...
Locking [packages] dependencies...
using sources: [{'url': 'https://pypi.org/simple', 'verify_ssl': True, 'name': 'pypi'}]
Using pip: -i https://pypi.org/simple

                          ROUND 1                           
Current constraints:
  botocore==1.10.62 (from -r /tmp/pipenv-txc6yae0-requirements/pipenv-e3op5ly4-constraints.txt (line 2))

Finding the best candidates:
  found candidate botocore==1.10.62 (constraint was ==1.10.62)

Finding secondary dependencies:
  botocore==1.10.62         requires docutils>=0.10, jmespath<1.0.0,>=0.7.1, python-dateutil<3.0.0,>=2.1; python_version >= "2.7"; python_version >= "2.7"

Traceback (most recent call last):
  File "/home/gonzalo.peci/.local/venvs/pipenv/lib/python3.6/site-packages/pipenv/patched/notpip/_vendor/packaging/markers.py", line 276, in __init__
    self._markers = _coerce_parse_result(MARKER.parseString(marker))
  File "/home/gonzalo.peci/.local/venvs/pipenv/lib/python3.6/site-packages/pipenv/patched/notpip/_vendor/pyparsing.py", line 1632, in parseString
    raise exc
  File "/home/gonzalo.peci/.local/venvs/pipenv/lib/python3.6/site-packages/pipenv/patched/notpip/_vendor/pyparsing.py", line 1622, in parseString
    loc, tokens = self._parse( instring, 0 )
  File "/home/gonzalo.peci/.local/venvs/pipenv/lib/python3.6/site-packages/pipenv/patched/notpip/_vendor/pyparsing.py", line 1379, in _parseNoCache
    loc,tokens = self.parseImpl( instring, preloc, doActions )
  File "/home/gonzalo.peci/.local/venvs/pipenv/lib/python3.6/site-packages/pipenv/patched/notpip/_vendor/pyparsing.py", line 3395, in parseImpl
    loc, exprtokens = e._parse( instring, loc, doActions )
  File "/home/gonzalo.peci/.local/venvs/pipenv/lib/python3.6/site-packages/pipenv/patched/notpip/_vendor/pyparsing.py", line 1383, in _parseNoCache
    loc,tokens = self.parseImpl( instring, preloc, doActions )
  File "/home/gonzalo.peci/.local/venvs/pipenv/lib/python3.6/site-packages/pipenv/patched/notpip/_vendor/pyparsing.py", line 3183, in parseImpl
    raise ParseException(instring, loc, self.errmsg, self)
pipenv.patched.notpip._vendor.pyparsing.ParseException: Expected stringEnd (at char 23), (line:1, col:24)

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/home/gonzalo.peci/.local/venvs/pipenv/lib/python3.6/site-packages/pipenv/resolver.py", line 87, in <module>
    main()
  File "/home/gonzalo.peci/.local/venvs/pipenv/lib/python3.6/site-packages/pipenv/resolver.py", line 76, in main
    system=system,
  File "/home/gonzalo.peci/.local/venvs/pipenv/lib/python3.6/site-packages/pipenv/resolver.py", line 63, in resolve
    allow_global=system,
  File "/home/gonzalo.peci/.local/venvs/pipenv/lib/python3.6/site-packages/pipenv/utils.py", line 402, in resolve_deps
    req_dir=req_dir
  File "/home/gonzalo.peci/.local/venvs/pipenv/lib/python3.6/site-packages/pipenv/utils.py", line 293, in actually_resolve_deps
    results = resolver.resolve(max_rounds=PIPENV_MAX_ROUNDS)
  File "/home/gonzalo.peci/.local/venvs/pipenv/lib/python3.6/site-packages/pipenv/patched/piptools/resolver.py", line 104, in resolve
    has_changed, best_matches = self._resolve_one_round()
  File "/home/gonzalo.peci/.local/venvs/pipenv/lib/python3.6/site-packages/pipenv/patched/piptools/resolver.py", line 209, in _resolve_one_round
    for dep in self._iter_dependencies(best_match):
  File "/home/gonzalo.peci/.local/venvs/pipenv/lib/python3.6/site-packages/pipenv/patched/piptools/resolver.py", line 311, in _iter_dependencies
    yield InstallRequirement.from_line(dependency_string, constraint=ireq.constraint)
  File "/home/gonzalo.peci/.local/venvs/pipenv/lib/python3.6/site-packages/pipenv/patched/notpip/_internal/req/req_install.py", line 193, in from_line
    markers = Marker(markers)
  File "/home/gonzalo.peci/.local/venvs/pipenv/lib/python3.6/site-packages/pipenv/patched/notpip/_vendor/packaging/markers.py", line 280, in __init__
    raise InvalidMarker(err_str)
pipenv.patched.notpip._vendor.packaging.markers.InvalidMarker: Invalid marker: 'python_version >= "2.7"; python_version >= "2.7"', parse error at '; python'
Steps to replicate
❯ cd $(mktemp -d)
[...]
❯ pipenv install --three
[...]
❯ pipenv install botocore==1.10.62
Installing botocore==1.10.62...
Requirement already satisfied: botocore==1.10.62 in ./.venv/lib/python3.6/site-packages (1.10.62)
Requirement already satisfied: jmespath<1.0.0,>=0.7.1 in ./.venv/lib/python3.6/site-packages (from botocore==1.10.62) (0.9.3)
Requirement already satisfied: python-dateutil<3.0.0,>=2.1; python_version >= "2.7" in ./.venv/lib/python3.6/site-packages (from botocore==1.10.62) (2.7.3)
Requirement already satisfied: docutils>=0.10 in ./.venv/lib/python3.6/site-packages (from botocore==1.10.62) (0.14)
Requirement already satisfied: six>=1.5 in ./.venv/lib/python3.6/site-packages (from python-dateutil<3.0.0,>=2.1; python_version >= "2.7"->botocore==1.10.62) (1.11.0)

Adding botocore==1.10.62 to Pipfile's [packages]...
Pipfile.lock (ca72e7) out of date, updating to (a22c5c)...
Locking [dev-packages] dependencies...
Locking [packages] dependencies...
ule>
    main()
  File "/home/gonzalo.peci/.local/venvs/pipenv/lib/python3.6/site-packages/pipenv/resolver.py", line 76, in main
    system=system,
  File "/home/gonzalo.peci/.local/venvs/pipenv/lib/python3.6/site-packages/pipenv/resolver.py", line 63, in resolve
    allow_global=system,
  File "/home/gonzalo.peci/.local/venvs/pipenv/lib/python3.6/site-packages/pipenv/utils.py", line 402, in resolve_deps
    req_dir=req_dir
  File "/home/gonzalo.peci/.local/venvs/pipenv/lib/python3.6/site-packages/pipenv/utils.py", line 293, in actually_resolve_deps
    results = resolver.resolve(max_rounds=PIPENV_MAX_ROUNDS)
  File "/home/gonzalo.peci/.local/venvs/pipenv/lib/python3.6/site-packages/pipenv/patched/piptools/resolver.py", line 104, in resolve
    has_changed, best_matches = self._resolve_one_round()
  File "/home/gonzalo.peci/.local/venvs/pipenv/lib/python3.6/site-packages/pipenv/patched/piptools/resolver.py", line 209, in _resolve_one_round
    for dep in self._iter_dependencies(best_match):
  File "/home/gonzalo.peci/.local/venvs/pipenv/lib/python3.6/site-packages/pipenv/patched/piptools/resolver.py", line 311, in _iter_dependencies
    yield InstallRequirement.from_line(dependency_string, constraint=ireq.constraint)
  File "/home/gonzalo.peci/.local/venvs/pipenv/lib/python3.6/site-packages/pipenv/patched/notpip/_internal/req/req_install.py", line 193, in from_line
    markers = Marker(markers)
  File "/home/gonzalo.peci/.local/venvs/pipenv/lib/python3.6/site-packages/pipenv/patched/notpip/_vendor/packaging/markers.py", line 280, in __init__
    raise InvalidMarker(err_str)
pipenv.patched.notpip._vendor.packaging.markers.InvalidMarker: Invalid marker: 'python_version >= "2.7"; python_version >= "2.7"', parse error at '; python'
$ pipenv --support