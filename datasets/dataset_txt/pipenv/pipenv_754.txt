kalekseev commented on 9 Aug 2018 â€¢
edited
pipenv lock with devpi as a mirror fails while works with pypi.
It seems like pipenv installs Django-2.1 (python3 only) even though it runs in python2 venv.
Steps to reproduce:
run local devpi server
create python2 venv virtualenv venv2 && source venv2/bin/activate
create Pipfile (see support information)
try to run pipenv lock
In devpi I see output:
2018-08-09 16:49:45,825 INFO  [req231] GET /root/pypi/+simple/django-celery-email/
2018-08-09 16:49:45,904 INFO  [req232] GET /root/pypi/+simple/django-celery-email/
2018-08-09 16:49:45,944 INFO  [req233] GET /root/pypi/+f/298/94330d621a079/django_celery_email-2.0.0-py2.py3-none-any.whl
2018-08-09 16:49:45,982 INFO  [req234] GET /root/pypi/+simple/django/
2018-08-09 16:49:46,175 INFO  [req235] GET /root/pypi/+f/7f2/46078d5a546f6/Django-2.1.tar.gz
$ pipenv lock --clear --verbose
Courtesy Notice: Pipenv found itself running within a virtual environment, so it will automatically use that environment, instead of creating its own for any project. You can set PIPENV_IGNORE_VIRTUALENVS=1 to force pipenv to ignore that environment and create its own instead.
Locking [dev-packages] dependencies...
Locking [packages] dependencies...
using sources: [{u'url': u'http://localhost:3141/root/pypi/+simple/', u'verify_ssl': True, u'name': u'pypi'}]
Using pip: -i http://localhost:3141/root/pypi/+simple/

                          ROUND 1
Current constraints:
  django-celery-email (from -r /var/folders/9d/ymk7h3g533nfcj7rm966d5fc0000gn/T/pipenv-SnKCsr-requirements/pipenv-jZiemI-constraints.txt (line 2))

Finding the best candidates:
  found candidate django-celery-email==2.0.0 (constraint was <any>)

Finding secondary dependencies:
  django-celery-email==2.0.0 not in cache, need to check index

Traceback (most recent call last):
  File "/Users/wtf/.local/venvs/pipenv/lib/python3.6/site-packages/pipenv/resolver.py", line 87, in <module>
    main()
  File "/Users/wtf/.local/venvs/pipenv/lib/python3.6/site-packages/pipenv/resolver.py", line 76, in main
    system=system,
  File "/Users/wtf/.local/venvs/pipenv/lib/python3.6/site-packages/pipenv/resolver.py", line 63, in resolve
    allow_global=system,
  File "/Users/wtf/.local/venvs/pipenv/lib/python3.6/site-packages/pipenv/utils.py", line 402, in resolve_deps
    req_dir=req_dir
  File "/Users/wtf/.local/venvs/pipenv/lib/python3.6/site-packages/pipenv/utils.py", line 293, in actually_resolve_deps
    results = resolver.resolve(max_rounds=PIPENV_MAX_ROUNDS)
  File "/Users/wtf/.local/venvs/pipenv/lib/python3.6/site-packages/pipenv/patched/piptools/resolver.py", line 104, in resolve
    has_changed, best_matches = self._resolve_one_round()
  File "/Users/wtf/.local/venvs/pipenv/lib/python3.6/site-packages/pipenv/patched/piptools/resolver.py", line 209, in _resolve_one_round
    for dep in self._iter_dependencies(best_match):
  File "/Users/wtf/.local/venvs/pipenv/lib/python3.6/site-packages/pipenv/patched/piptools/resolver.py", line 303, in _iter_dependencies
    dependencies = self.repository.get_dependencies(ireq)
  File "/Users/wtf/.local/venvs/pipenv/lib/python3.6/site-packages/pipenv/patched/piptools/repositories/pypi.py", line 243, in get_dependencies
    legacy_results = self.get_legacy_dependencies(ireq)
  File "/Users/wtf/.local/venvs/pipenv/lib/python3.6/site-packages/pipenv/patched/piptools/repositories/pypi.py", line 335, in get_legacy_dependencies
    self.resolver.resolve(reqset)
  File "/Users/wtf/.local/venvs/pipenv/lib/python3.6/site-packages/pipenv/patched/notpip/_internal/resolve.py", line 107, in resolve
    self._resolve_one(requirement_set, req)
  File "/Users/wtf/.local/venvs/pipenv/lib/python3.6/site-packages/pipenv/patched/notpip/_internal/resolve.py", line 264, in _resolve_one
    abstract_dist = self._get_abstract_dist_for(req_to_install)
  File "/Users/wtf/.local/venvs/pipenv/lib/python3.6/site-packages/pipenv/patched/notpip/_internal/resolve.py", line 214, in _get_abstract_dist_for
    self.require_hashes
  File "/Users/wtf/.local/venvs/pipenv/lib/python3.6/site-packages/pipenv/patched/notpip/_internal/operations/prepare.py", line 328, in prepare_linked_requirement
    abstract_dist.prep_for_dist(finder, self.build_isolation)
  File "/Users/wtf/.local/venvs/pipenv/lib/python3.6/site-packages/pipenv/patched/notpip/_internal/operations/prepare.py", line 155, in prep_for_dist
    self.req.run_egg_info()
  File "/Users/wtf/.local/venvs/pipenv/lib/python3.6/site-packages/pipenv/patched/notpip/_internal/req/req_install.py", line 486, in run_egg_info
    command_desc='python setup.py egg_info')
  File "/Users/wtf/.local/venvs/pipenv/lib/python3.6/site-packages/pipenv/patched/notpip/_internal/utils/misc.py", line 698, in call_subprocess
    % (command_desc, proc.returncode, cwd))
pipenv.patched.notpip._internal.exceptions.InstallationError: Command "python setup.py egg_info" failed with error code 1 in /var/folders/9d/ymk7h3g533nfcj7rm966d5fc0000gn/T/tmpluss5Bbuild/django/
/Users/wtf/.local/venvs/pipenv/lib/python3.6/site-packages/pipenv/_compat.py:113: ResourceWarning: Implicitly cleaning up <TemporaryDirectory '/var/folders/9d/ymk7h3g533nfcj7rm966d5fc0000gn/T/pipenv-SnKCsr-requirements'>
  warnings.warn(warn_message, ResourceWarning)
With standard pypi index pipenv works without problem.
$ pipenv --support
1