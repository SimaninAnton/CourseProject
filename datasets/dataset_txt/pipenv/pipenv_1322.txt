panzerballett commented on 19 Mar 2018 •
edited
(Repeatability: offline mirror #1731 is also about offline mirrors but does not cover the issue described here.)
i am working in an environment without internet access. i do have a complete pypi mirror on a server (no SSL/TLS). i manage to use pip (by specifying the server in ~/.config/pip/pip.conf).
i am not able to run pipenv without errors in that environment. while installing usually works (with an error message: pipenv wants to connect to https://pypi.org/pypi/imagesize/json) pipenv lock fails (the lock file is never written because of that error).
this is the output of $ python -m pipenv.help:
$ python -m pipenv.help output
Pipenv version: `'11.8.0'`
Expected result
$ pipenv lock should create Pipfile.lock but that file is never written - due to the failed connection to https://pypi.org/pypi/imagesize/json i suppose.
i'd expect pipenv to connect to my local mirror only. i admit that i do not currently mirror https://pypi.org/pypi/imagesize/json (i'd do that presto if i knew how configure pipenv to check that url only).
Actual result
and here is what happens when i run $ pipenv lock:
$ pipenv lock
Locking [dev-packages] dependencies…
Locking [packages] dependencies…
()[2])
  File "/home/user/.local/lib/python3.5/site-packages/pipenv/../pipenv/../urllib3/util/retry.py", line 388, in increment
    raise MaxRetryError(_pool, url, error or ResponseError(cause))
urllib3.exceptions.MaxRetryError: HTTPSConnectionPool(host='pypi.org', port=443): Max retries exceeded with url: /pypi/imagesize/json (Caused by NewConnectionError('<urllib3.connection.VerifiedHTTPSConnection object at 0x7feb478d82e8>: Failed to establish a new connection: [Errno -3] Temporary failure in name resolution',))

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/home/user/.local/lib/python3.5/site-packages/pipenv/resolver.py", line 75, in <module>
    main()
  File "/home/user/.local/lib/python3.5/site-packages/pipenv/resolver.py", line 65, in main
    clear=do_clear,
  File "/home/user/.local/lib/python3.5/site-packages/pipenv/resolver.py", line 57, in resolve
    verbose=verbose,
  File "/home/user/.local/lib/python3.5/site-packages/pipenv/../pipenv/utils.py", line 452, in resolve_deps
    'https://pypi.org/pypi/{0}/json'.format(name), timeout=10
  File "/home/user/.local/lib/python3.5/site-packages/pipenv/../pipenv/../requests/sessions.py", line 521, in get
    return self.request('GET', url, **kwargs)
  File "/home/user/.local/lib/python3.5/site-packages/pipenv/../pipenv/../requests/sessions.py", line 508, in request
    resp = self.send(prep, **send_kwargs)
  File "/home/user/.local/lib/python3.5/site-packages/pipenv/../pipenv/../requests/sessions.py", line 618, in send
    r = adapter.send(request, **kwargs)
  File "/home/user/.local/lib/python3.5/site-packages/pipenv/../pipenv/../requests/adapters.py", line 508, in send
    raise ConnectionError(e, request=request)
requests.exceptions.ConnectionError: HTTPSConnectionPool(host='pypi.org', port=443): Max retries exceeded with url: /pypi/imagesize/json (Caused by NewConnectionError('<urllib3.connection.VerifiedHTTPSConnection object at 0x7feb478d82e8>: Failed to establish a new connection: [Errno -3] Temporary failure in name resolution',))
Steps to replicate
setup a (partial) pypi mirror
make sure there is a connection to the server where the mirror is on but no internet connection
setup a pipenv
remove Pipenv.lock
run $ pipenv lock