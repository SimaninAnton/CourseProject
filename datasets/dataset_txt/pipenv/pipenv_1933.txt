feigaoxyz commented on 13 Oct 2017 •
edited
pipenv does not respect fish shell's universal variables [^1] of LC_ALL and LANG values.
Describe you environment
OS Type: macOS 10.13
Python version: $ python -V 3.6.3
Pipenv version: $ pipenv --version 8.2.7
Expected result
pipenv should respect the LANG and LC_ALL values set by set -U as universal variables so not to complain ValueError: unknown locale: UTF-8
Actual result
When the locale (i.e. "en_US.UTF-8") is set by set -U as universal variables, pipenv can not extract the values when creating virtualenv (e.g. pipenv shell), and complaining ValueError: unknown locale: UTF-8.
Only if the same values were set inside config.fish by set -gx that the pipenv can recognise correctly.
Steps to replicate
Failure case (that should work)
$ set -U LANG "en_US.UTF-8"
$ set -U LC_ALL "en_US.UTF-8"
(re/start a new fish shell)
$ echo $LANG
en_GB.UTF-8
$ pipenv shell

Warning: the environment variable LANG is not set!
We recommend setting this in ~/.profile (or equivalent) for proper expected behavior.
Creating a virtualenv for this project…
⠋Traceback (most recent call last):
  File "/usr/local/bin/pew", line 7, in <module>
    from pew.pew import pew
  File "/usr/local/lib/python3.6/site-packages/pew/__init__.py", line 11, in <module>
    from . import pew
  File "/usr/local/lib/python3.6/site-packages/pew/pew.py", line 42, in <module>
    from pew._utils import (check_call, invoke, expandpath, own, env_bin_dir,
  File "/usr/local/lib/python3.6/site-packages/pew/_utils.py", line 22, in <module>
    encoding = locale.getlocale()[1] or 'ascii'
  File "/usr/local/Cellar/python3/3.6.3/Frameworks/Python.framework/Versions/3.6/lib/python3.6/locale.py", line 581, in getlocale
    return _parse_localename(localename)
  File "/usr/local/Cellar/python3/3.6.3/Frameworks/Python.framework/Versions/3.6/lib/python3.6/locale.py", line 490, in _parse_localename
    raise ValueError('unknown locale: %s' % localename)
ValueError: unknown locale: UTF-8

$ echo $LANG
en_GB.UTF-8
[^1] https://fishshell.com/docs/current/index.html#variables-universal
2