michael-k commented on 24 Apr 2018
If there's no or an outdated Pipfile.lock pipenv install --system fails during docker build with a TypeError.
$ python -m pipenv.help output
Expected result
pipenv install --system installs packages.
Actual result
pipenv install --system fails with a TypeError:
Pipfile.lock not found, creating…
Locking [dev-packages] dependencies…
Traceback (most recent call last):
  File "/usr/local/bin/pipenv", line 11, in <module>
    sys.exit(cli())
  File "/usr/local/lib/python3.6/site-packages/pipenv/vendor/click/core.py", line 722, in __call__
    return self.main(*args, **kwargs)
  File "/usr/local/lib/python3.6/site-packages/pipenv/vendor/click/core.py", line 697, in main
    rv = self.invoke(ctx)
  File "/usr/local/lib/python3.6/site-packages/pipenv/vendor/click/core.py", line 1066, in invoke
    return _process_result(sub_ctx.command.invoke(sub_ctx))
  File "/usr/local/lib/python3.6/site-packages/pipenv/vendor/click/core.py", line 895, in invoke
    return ctx.invoke(self.callback, **ctx.params)
  File "/usr/local/lib/python3.6/site-packages/pipenv/vendor/click/core.py", line 535, in invoke
    return callback(*args, **kwargs)
  File "/usr/local/lib/python3.6/site-packages/pipenv/cli.py", line 402, in install
    selective_upgrade=selective_upgrade,
  File "/usr/local/lib/python3.6/site-packages/pipenv/core.py", line 1902, in do_install
    requirements_dir=requirements_directory,
  File "/usr/local/lib/python3.6/site-packages/pipenv/core.py", line 1340, in do_init
    verbose=verbose,
  File "/usr/local/lib/python3.6/site-packages/pipenv/core.py", line 1038, in do_lock
    allow_global=system,
  File "/usr/local/lib/python3.6/site-packages/pipenv/utils.py", line 408, in venv_resolve_deps
    escape_grouped_arguments(which('python')),
  File "/usr/local/lib/python3.6/site-packages/pipenv/core.py", line 126, in which
    p = os.sep.join([location] + ['bin/{0}'.format(command)])
TypeError: sequence item 0: expected str instance, NoneType found
Same happens if a Pipfile.lock exists:
Pipfile.lock (b6f97a) out of date, updating to (8e0064)…
Locking [dev-packages] dependencies…
Traceback (most recent call last):
  File "/usr/local/bin/pipenv", line 11, in <module>
    sys.exit(cli())
  File "/usr/local/lib/python3.6/site-packages/pipenv/vendor/click/core.py", line 722, in __call__
    return self.main(*args, **kwargs)
  File "/usr/local/lib/python3.6/site-packages/pipenv/vendor/click/core.py", line 697, in main
    rv = self.invoke(ctx)
  File "/usr/local/lib/python3.6/site-packages/pipenv/vendor/click/core.py", line 1066, in invoke
    return _process_result(sub_ctx.command.invoke(sub_ctx))
  File "/usr/local/lib/python3.6/site-packages/pipenv/vendor/click/core.py", line 895, in invoke
    return ctx.invoke(self.callback, **ctx.params)
  File "/usr/local/lib/python3.6/site-packages/pipenv/vendor/click/core.py", line 535, in invoke
    return callback(*args, **kwargs)
  File "/usr/local/lib/python3.6/site-packages/pipenv/cli.py", line 402, in install
    selective_upgrade=selective_upgrade,
  File "/usr/local/lib/python3.6/site-packages/pipenv/core.py", line 1902, in do_install
    requirements_dir=requirements_directory,
  File "/usr/local/lib/python3.6/site-packages/pipenv/core.py", line 1329, in do_init
    do_lock(system=system, pre=pre, keep_outdated=keep_outdated)
  File "/usr/local/lib/python3.6/site-packages/pipenv/core.py", line 1038, in do_lock
    allow_global=system,
  File "/usr/local/lib/python3.6/site-packages/pipenv/utils.py", line 408, in venv_resolve_deps
    escape_grouped_arguments(which('python')),
  File "/usr/local/lib/python3.6/site-packages/pipenv/core.py", line 126, in which
    p = os.sep.join([location] + ['bin/{0}'.format(command)])
TypeError: sequence item 0: expected str instance, NoneType found
Steps to replicate
Create a Dockerfile and a Pipfile in a new directory with the following content:
FROM python:3.6-stretch
ARG PIPENV_VERSION
RUN mkdir -p /code

RUN pip install "pipenv==${PIPENV_VERSION}"
# RUN pip install "git+https://github.com/pypa/pipenv.git@master#egg=pipenv"

WORKDIR /code
COPY Pipfile* /code/
RUN python -m pipenv.help && ls -l && pipenv install --system --verbose
[[source]]
url = "https://pypi.python.org/simple"
verify_ssl = true
name = "pypi"


[packages]
requests = "*"


[dev-packages]
pytest = "*"


[requires]
python_version = "3.6"
Run docker build --build-arg PIPENV_VERSION="v11.10.1.dev4" . (Same for dev1, dev2, and dev3).
To try it with the latest commit in pypa/pipenv@master, use the commented out line in the Dockerfile instead.
To try it with a Pipfile.lock you can use the one from the documentation.
2