maciejgryka commented on 19 Mar 2018
celery 3.1.25 has a dependency on kombu 3.0.37. When installing it using pip install (or pipenv install --skip-lock) the right version of kombu is installed. However, locking the deps results in having kombu 4.1.0.
maciej@vimes:~/dev/test
$ pipenv --python python2
Creating a virtualenv for this project‚Ä¶
Using /usr/local/bin/python2 (2.7.14) to create virtualenv‚Ä¶
‚†ãRunning virtualenv with interpreter /usr/local/bin/python2
New python executable in /Users/maciej/.local/share/virtualenvs/test-1v-QfvO_/bin/python2.7
Also creating executable in /Users/maciej/.local/share/virtualenvs/test-1v-QfvO_/bin/python
Installing setuptools, pip, wheel...done.

Virtualenv location: /Users/maciej/.local/share/virtualenvs/test-1v-QfvO_
Creating a Pipfile for this project‚Ä¶
maciej@vimes:~/dev/test
$ pipenv install celery==3.1.25
Installing celery==3.1.25‚Ä¶
Collecting celery==3.1.25
  Using cached celery-3.1.25-py2.py3-none-any.whl
Collecting billiard<3.4,>=3.3.0.23 (from celery==3.1.25)
  Using cached billiard-3.3.0.23-cp27-none-macosx_10_6_intel.whl
Collecting pytz>dev (from celery==3.1.25)
  Using cached pytz-2018.3-py2.py3-none-any.whl
Collecting kombu<3.1,>=3.0.37 (from celery==3.1.25)
  Using cached kombu-3.0.37-py2.py3-none-any.whl
Collecting anyjson>=0.3.3 (from kombu<3.1,>=3.0.37->celery==3.1.25)
Collecting amqp<2.0,>=1.4.9 (from kombu<3.1,>=3.0.37->celery==3.1.25)
  Using cached amqp-1.4.9-py2.py3-none-any.whl
Installing collected packages: billiard, pytz, anyjson, amqp, kombu, celery
Successfully installed amqp-1.4.9 anyjson-0.3.3 billiard-3.3.0.23 celery-3.1.25 kombu-3.0.37 pytz-2018.3

Adding celery==3.1.25 to Pipfile's [packages]‚Ä¶
Pipfile.lock not found, creating‚Ä¶
Locking [dev-packages] dependencies‚Ä¶
Locking [packages] dependencies‚Ä¶
Updated Pipfile.lock (c71a89)!
Installing dependencies from Pipfile.lock (c71a89)‚Ä¶
  üêç   ‚ñâ‚ñâ‚ñâ‚ñâ‚ñâ‚ñâ‚ñâ‚ñâ‚ñâ‚ñâ‚ñâ‚ñâ‚ñâ‚ñâ‚ñâ‚ñâ‚ñâ‚ñâ‚ñâ‚ñâ‚ñâ‚ñâ‚ñâ‚ñâ‚ñâ‚ñâ‚ñâ‚ñâ‚ñâ‚ñâ‚ñâ‚ñâ 6/6 ‚Äî 00:00:02
To activate this project's virtualenv, run the following:
 $ pipenv shell
maciej@vimes:~/dev/test
$ pipenv run "pip list"
DEPRECATION: The default format will switch to columns in the future. You can use --format=(legacy|columns) (or define a format=(legacy|columns) in your pip.conf under the [list] section) to disable this warning.
amqp (2.2.2)
anyjson (0.3.3)
billiard (3.5.0.3)
celery (3.1.25)
kombu (4.1.0)
pip (9.0.2)
pytz (2018.3)
setuptools (39.0.1)
vine (1.1.4)
wheel (0.30.0)
The problem as I see it (see the output of pipenv lock -v below) is this during locking:
Finding secondary dependencies:
  celery==3.1.25            requires billiard<3.6.0,>=3.5.0.2, kombu<5.0,>=4.0.2, pytz>dev
I'm not sure why kombu<5.0,>=4.0.2 is specified here - celery 3.1.25 was released on 2016-10-10, while kombu 4.0.2 only later on 2016-12-15, so the dep seems wrong.
$ pipenv lock -v
Locking [dev-packages] dependencies‚Ä¶
Using pip: -i https://pypi.python.org/simple

                          ROUND 1                           
Current constraints:

Finding the best candidates:

Finding secondary dependencies:
------------------------------------------------------------
Result of round 1: stable, done

Locking [packages] dependencies‚Ä¶
Using pip: -i https://pypi.python.org/simple

                          ROUND 1                           
Current constraints:
  celery==3.1.25

Finding the best candidates:
  found candidate celery==3.1.25 (constraint was ==3.1.25)

Finding secondary dependencies:
  celery==3.1.25            requires billiard<3.6.0,>=3.5.0.2, kombu<5.0,>=4.0.2, pytz>dev

New dependencies found in this round:
  adding [u'billiard', '<3.6.0,>=3.5.0.2', '[]']
  adding [u'kombu', '<5.0,>=4.0.2', '[]']
  adding [u'pytz', '>dev', '[]']
Removed dependencies in this round:
Unsafe dependencies in this round:
------------------------------------------------------------
Result of round 1: not stable

                          ROUND 2                           
Current constraints:
  billiard<3.6.0,>=3.5.0.2
  celery==3.1.25
  kombu<5.0,>=4.0.2
  pytz>dev

Finding the best candidates:
  found candidate billiard==3.5.0.3 (constraint was >=3.5.0.2,<3.6.0)
  found candidate celery==3.1.25 (constraint was ==3.1.25)
  found candidate kombu==4.1.0 (constraint was >=4.0.2,<5.0)
  found candidate pytz==2018.3 (constraint was >dev)

Finding secondary dependencies:
  billiard==3.5.0.3         requires -
  pytz==2018.3              requires -
  celery==3.1.25            requires billiard<3.6.0,>=3.5.0.2, kombu<5.0,>=4.0.2, pytz>dev
  kombu==4.1.0              requires amqp<3.0,>=2.1.4

New dependencies found in this round:
  adding [u'amqp', '<3.0,>=2.1.4', '[]']
Removed dependencies in this round:
Unsafe dependencies in this round:
------------------------------------------------------------
Result of round 2: not stable

                          ROUND 3                           
Current constraints:
  amqp<3.0,>=2.1.4
  billiard<3.6.0,>=3.5.0.2
  celery==3.1.25
  kombu<5.0,>=4.0.2
  pytz>dev

Finding the best candidates:
  found candidate amqp==2.2.2 (constraint was >=2.1.4,<3.0)
  found candidate billiard==3.5.0.3 (constraint was >=3.5.0.2,<3.6.0)
  found candidate celery==3.1.25 (constraint was ==3.1.25)
  found candidate kombu==4.1.0 (constraint was >=4.0.2,<5.0)
  found candidate pytz==2018.3 (constraint was >dev)

Finding secondary dependencies:
  kombu==4.1.0              requires amqp<3.0,>=2.1.4
  amqp==2.2.2               requires vine>=1.1.3
  billiard==3.5.0.3         requires -
  pytz==2018.3              requires -
  celery==3.1.25            requires billiard<3.6.0,>=3.5.0.2, kombu<5.0,>=4.0.2, pytz>dev

New dependencies found in this round:
  adding [u'vine', '>=1.1.3', '[]']
Removed dependencies in this round:
Unsafe dependencies in this round:
------------------------------------------------------------
Result of round 3: not stable

                          ROUND 4                           
Current constraints:
  amqp<3.0,>=2.1.4
  billiard<3.6.0,>=3.5.0.2
  celery==3.1.25
  kombu<5.0,>=4.0.2
  pytz>dev
  vine>=1.1.3

Finding the best candidates:
  found candidate amqp==2.2.2 (constraint was >=2.1.4,<3.0)
  found candidate billiard==3.5.0.3 (constraint was >=3.5.0.2,<3.6.0)
  found candidate celery==3.1.25 (constraint was ==3.1.25)
  found candidate kombu==4.1.0 (constraint was >=4.0.2,<5.0)
  found candidate pytz==2018.3 (constraint was >dev)
  found candidate vine==1.1.4 (constraint was >=1.1.3)

Finding secondary dependencies:
  amqp==2.2.2               requires vine>=1.1.3
  celery==3.1.25            requires billiard<3.6.0,>=3.5.0.2, kombu<5.0,>=4.0.2, pytz>dev
  billiard==3.5.0.3         requires -
  kombu==4.1.0              requires amqp<3.0,>=2.1.4
  vine==1.1.4               requires -
  pytz==2018.3              requires -
------------------------------------------------------------
Result of round 4: stable, done