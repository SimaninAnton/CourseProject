gh640 commented on 3 Jul 2018
Issue description
When I tried to update a package maintained with pipenv after update pipenv to 2018.7.1, I met the following error and couldn't update it.
$ pipenv update django

...

pipenv.patched.notpip._vendor.packaging.markers.InvalidMarker: Invalid marker: 'platform_python_implementation != "PyPy"; platform_python_implementation != "PyPy"', parse error at '; platfo'
I investigated and found that it is caused by fabric3 package in my case. I could reproduce the error with the following command in a clean project.
$ pipenv --version
pipenv, version 2018.7.1
$ pipenv install fabric3
Installing fabric3...
Looking in indexes: https://pypi.python.org/simple
Requirement already satisfied: fabric3 in /path/share/virtualenvs/venvname-CSo2ZBZk/lib/python3.6/site-packages (1.14.post1)
Requirement already satisfied: six>=1.10.0 in /path/share/virtualenvs/venvname-CSo2ZBZk/lib/python3.6/site-packages (from fabric3) (1.11.0)
Requirement already satisfied: paramiko<3.0,>=2.0 in /path/share/virtualenvs/venvname-CSo2ZBZk/lib/python3.6/site-packages (from fabric3) (2.4.1)
Requirement already satisfied: bcrypt>=3.1.3 in /path/share/virtualenvs/venvname-CSo2ZBZk/lib/python3.6/site-packages (from paramiko<3.0,>=2.0->fabric3) (3.1.4)
Requirement already satisfied: cryptography>=1.5 in /path/share/virtualenvs/venvname-CSo2ZBZk/lib/python3.6/site-packages (from paramiko<3.0,>=2.0->fabric3) (2.2.2)
Requirement already satisfied: pynacl>=1.0.1 in /path/share/virtualenvs/venvname-CSo2ZBZk/lib/python3.6/site-packages (from paramiko<3.0,>=2.0->fabric3) (1.2.1)
Requirement already satisfied: pyasn1>=0.1.7 in /path/share/virtualenvs/venvname-CSo2ZBZk/lib/python3.6/site-packages (from paramiko<3.0,>=2.0->fabric3) (0.4.3)
Requirement already satisfied: cffi>=1.1 in /path/share/virtualenvs/venvname-CSo2ZBZk/lib/python3.6/site-packages (from bcrypt>=3.1.3->paramiko<3.0,>=2.0->fabric3) (1.11.5)
Requirement already satisfied: asn1crypto>=0.21.0 in /path/share/virtualenvs/venvname-CSo2ZBZk/lib/python3.6/site-packages (from cryptography>=1.5->paramiko<3.0,>=2.0->fabric3) (0.24.0)
Requirement already satisfied: idna>=2.1 in /path/share/virtualenvs/venvname-CSo2ZBZk/lib/python3.6/site-packages (from cryptography>=1.5->paramiko<3.0,>=2.0->fabric3) (2.7)
Requirement already satisfied: pycparser in /path/share/virtualenvs/venvname-CSo2ZBZk/lib/python3.6/site-packages (from cffi>=1.1->bcrypt>=3.1.3->paramiko<3.0,>=2.0->fabric3) (2.18)

Adding fabric3 to Pipfile's [dev-packages]...
Pipfile.lock (43168b) out of date, updating to (8f29af)...
Locking [dev-packages] dependencies...
path/py3/lib/python3.6/site-packages/pipenv/resolver.py", line 76, in main
    system=system,
  File "/path/py3/lib/python3.6/site-packages/pipenv/resolver.py", line 63, in resolve
    allow_global=system,
  File "/path/py3/lib/python3.6/site-packages/pipenv/utils.py", line 402, in resolve_deps
    req_dir=req_dir
  File "/path/py3/lib/python3.6/site-packages/pipenv/utils.py", line 293, in actually_resolve_deps
    results = resolver.resolve(max_rounds=PIPENV_MAX_ROUNDS)
  File "/path/py3/lib/python3.6/site-packages/pipenv/patched/piptools/resolver.py", line 104, in resolve
    has_changed, best_matches = self._resolve_one_round()
  File "/path/py3/lib/python3.6/site-packages/pipenv/patched/piptools/resolver.py", line 209, in _resolve_one_round
    for dep in self._iter_dependencies(best_match):
  File "/path/py3/lib/python3.6/site-packages/pipenv/patched/piptools/resolver.py", line 311, in _iter_dependencies
    yield InstallRequirement.from_line(dependency_string, constraint=ireq.constraint)
  File "/path/py3/lib/python3.6/site-packages/pipenv/patched/notpip/_internal/req/req_install.py", line 193, in from_line
    markers = Marker(markers)
  File "/path/py3/lib/python3.6/site-packages/pipenv/patched/notpip/_vendor/packaging/markers.py", line 281, in __init__
    raise InvalidMarker(err_str)
pipenv.patched.notpip._vendor.packaging.markers.InvalidMarker: Invalid marker: 'platform_python_implementation != "PyPy"; platform_python_implementation != "PyPy"', parse error at '; platfo'
Expected result
The installation command pipenv install works.
Actual result
The above error occurs and the installation process fails.
Steps to replicate
$ pip install pipenv==2018.7.1
$ pipenv --version
pipenv, version 2018.7.1
$ pipenv install fabric3
If I miss anything important to share, please let me know. Thank you in advance.
(I believe pasting the result of pipenv --support is not necessary in this case. If it's necessary, please let me know.)
1