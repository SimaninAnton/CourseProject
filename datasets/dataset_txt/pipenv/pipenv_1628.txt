Code0x58 commented on 20 Jan 2018 â€¢
edited
Using pipenv 9.0.3 on python 3.6.4 the following failed:
$ pipenv --three install "enum==0.4.6; python_version < '3.4'"
â€¦
Creating a Pipfile for this projectâ€¦
Installing enum==0.4.6; python_version < '3.4'â€¦
â §
Adding enum==0.4.6; python_version < '3.4' to Pipfile's [packages]â€¦
Locking [dev-packages] dependenciesâ€¦
Locking [packages] dependenciesâ€¦
Traceback (most recent call last):
  File "/bin/pipenv", line 11, in <module>
    sys.exit(cli())
  File "/venvs/pipenv/lib/python3.6/site-packages/pipenv/vendor/click/core.py", line 722, in __call__
    return self.main(*args, **kwargs)
  File "/venvs/pipenv/lib/python3.6/site-packages/pipenv/vendor/click/core.py", line 697, in main
    rv = self.invoke(ctx)
  File "/venvs/pipenv/lib/python3.6/site-packages/pipenv/vendor/click/core.py", line 1066, in invoke
    return _process_result(sub_ctx.command.invoke(sub_ctx))
  File "/venvs/pipenv/lib/python3.6/site-packages/pipenv/vendor/click/core.py", line 895, in invoke
    return ctx.invoke(self.callback, **ctx.params)
  File "/venvs/pipenv/lib/python3.6/site-packages/pipenv/vendor/click/core.py", line 535, in invoke
    return callback(*args, **kwargs)
  File "/venvs/pipenv/lib/python3.6/site-packages/pipenv/cli.py", line 1934, in install
    do_lock(system=system, pre=pre)
  File "/venvs/pipenv/lib/python3.6/site-packages/pipenv/cli.py", line 1093, in do_lock
    deps = convert_deps_to_pip(project.packages, project, r=False, include_index=True)
  File "/venvs/pipenv/lib/python3.6/site-packages/pipenv/utils.py", line 742, in convert_deps_to_pip
    if not deps[dep]['version'] == '*':
TypeError: string indices must be integers
This leads to enum = "==0.4.6; python-version < '3.4'" being in the Pipfile's packages section although I think it should be enum = {version = "==0.4.6", python_version = "< '3.4'"}. There is same outcome when using --two.
I also tried using a requirements file instead, the attempt at dependency resolution highlighted that the enum isn't intended for compatibility (I should have used enum-compat):
$ pipenv --three install --requirements requirements.txt
â€¦
Creating a Pipfile for this projectâ€¦
Requirements file provided! Importing into Pipfileâ€¦
Pipfile.lock not found, creatingâ€¦
Locking [dev-packages] dependenciesâ€¦
Locking [packages] dependenciesâ€¦
Updated Pipfile.lock (2c7e63)!
Installing dependencies from Pipfile.lock (2c7e63)â€¦
An error occurred while installing enum==0.4.6! Will try again.
  ðŸ   â–‰â–‰â–‰â–‰â–‰â–‰â–‰â–‰â–‰â–‰â–‰â–‰â–‰â–‰â–‰â–‰â–‰â–‰â–‰â–‰â–‰â–‰â–‰â–‰â–‰â–‰â–‰â–‰â–‰â–‰â–‰â–‰ 1/1 â€” 00:00:00
Installing initiallyâ€“failed dependenciesâ€¦
Collecting enum==0.4.6 â–‰â–‰â–‰â–‰â–‰â–‰â–‰â–‰â–‰â–‰â–‰â–‰â–‰â–‰ 0/1 â€” 00:00:00
  Using cached enum-0.4.6.tar.gz
    Complete output from command python setup.py egg_info:
    Traceback (most recent call last):
      File "<string>", line 1, in <module>
      File "/share/virtualenvs/test-hxkKlP5o/lib/python3.6/site-packages/setuptools/__init__.py", line 5, in <module>
        import distutils.core
      File "/share/virtualenvs/test-hxkKlP5o/lib/python3.6/distutils/__init__.py", line 4, in <module>
        import imp
      File "/share/virtualenvs/test-hxkKlP5o/lib/python3.6/imp.py", line 27, in <module>
        import tokenize
      File "/share/virtualenvs/test-hxkKlP5o/lib/python3.6/tokenize.py", line 33, in <module>
        import re
      File "/share/virtualenvs/test-hxkKlP5o/lib/python3.6/re.py", line 142, in <module>
        class RegexFlag(enum.IntFlag):
    AttributeError: module 'enum' has no attribute 'IntFlag'
    
    ----------------------------------------

Command "python setup.py egg_info" failed with error code 1 in /tmp/pip-build-0uqv6ezh/enum/

  â˜¤  â–‰â–‰â–‰â–‰â–‰â–‰â–‰â–‰â–‰â–‰â–‰â–‰â–‰â–‰â–‰â–‰â–‰â–‰â–‰â–‰â–‰â–‰â–‰â–‰â–‰â–‰â–‰â–‰â–‰â–‰â–‰â–‰ 0/1 â€” 00:00:00
This leads to enum = "==0.4.6" ending up in the Pipfile's (same with --two but it installs).
It seems like the issues are:
--requirements isn't pick picking up marker requirements
requirements added as args aren't parsed correctly