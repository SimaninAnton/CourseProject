dstuebe commented 9 days ago
Issue description
We observe transient failures during automated deploys that use pipenv to install packages and there is insufficient information in the traceback to understand the issue.
I have looked for similar issues but don't see any - I apologize if I missed it!
Expected result
Deploy and pipenv install fail always or never, not sometimes.
If it fails sometimes, it is really clear why.
Actual result
[2020-01-21 UTC 19:05:35.173] D 6019480 2020-01-21T14:05:35-05:00 [docker] [build] Installing initially failed dependenciesâ€¦ [2020-01-21 UTC 19:05:44.479] D 6019480 2020-01-21T14:05:44-05:00 [docker] [build] [pipenv.exceptions.InstallError]: File "/usr/local/lib/python3.7/dist-packages/pipenv/cli/command.py", line 254, in install [2020-01-21 UTC 19:05:44.479] D 6019480 2020-01-21T14:05:44-05:00 [docker] [build] [pipenv.exceptions.InstallError]: editable_packages=state.installstate.editables, [2020-01-21 UTC 19:05:44.479] D 6019480 2020-01-21T14:05:44-05:00 [docker] [build] [pipenv.exceptions.InstallError]: File "/usr/local/lib/python3.7/dist-packages/pipenv/core.py", line 1874, in do_install [2020-01-21 UTC 19:05:44.479] D 6019480 2020-01-21T14:05:44-05:00 [docker] [build] [2020-01-21 UTC 19:05:44.480] D 6019480 2020-01-21T14:05:44-05:00 [docker] [build] [pipenv.exceptions.InstallError]: keep_outdated=keep_outdated [2020-01-21 UTC 19:05:44.480] D 6019480 2020-01-21T14:05:44-05:00 [docker] [build] [2020-01-21 UTC 19:05:44.481] D 6019480 2020-01-21T14:05:44-05:00 [docker] [build] [pipenv.exceptions.InstallError]: File "/usr/local/lib/python3.7/dist-packages/pipenv/core.py", line 1253, in do_init [2020-01-21 UTC 19:05:44.481] D 6019480 2020-01-21T14:05:44-05:00 [docker] [build] [pipenv.exceptions.InstallError]: pypi_mirror=pypi_mirror, [2020-01-21 UTC 19:05:44.481] D 6019480 2020-01-21T14:05:44-05:00 [docker] [build] [2020-01-21 UTC 19:05:44.481] D 6019480 2020-01-21T14:05:44-05:00 [docker] [build] [pipenv.exceptions.InstallError]: File "/usr/local/lib/python3.7/dist-packages/pipenv/core.py", line 862, in do_install_dependencies [2020-01-21 UTC 19:05:44.481] D 6019480 2020-01-21T14:05:44-05:00 [docker] [build] [2020-01-21 UTC 19:05:44.482] D 6019480 2020-01-21T14:05:44-05:00 [docker] [build] [pipenv.exceptions.InstallError]: _cleanup_procs(procs, False, failed_deps_queue, retry=False) [2020-01-21 UTC 19:05:44.482] D 6019480 2020-01-21T14:05:44-05:00 [docker] [build] [2020-01-21 UTC 19:05:44.483] D 6019480 2020-01-21T14:05:44-05:00 [docker] [build] [pipenv.exceptions.InstallError]: File "/usr/local/lib/python3.7/dist-packages/pipenv/core.py", line 681, in _cleanup_procs [2020-01-21 UTC 19:05:44.483] D 6019480 2020-01-21T14:05:44-05:00 [docker] [build] [2020-01-21 UTC 19:05:44.483] D 6019480 2020-01-21T14:05:44-05:00 [docker] [build] [pipenv.exceptions.InstallError]: raise exceptions.InstallError(c.dep.name, extra=err_lines) [2020-01-21 UTC 19:05:44.483] D 6019480 2020-01-21T14:05:44-05:00 [docker] [build] [2020-01-21 UTC 19:05:44.484] D 6019480 2020-01-21T14:05:44-05:00 [docker] [build] [pipenv.exceptions.InstallError]: ['Looking in indexes: https://pypi.org/simple, https://ITS_A_SECRET:****@'] [2020-01-21 UTC 19:05:44.484] D 6019480 2020-01-21T14:05:44-05:00 [docker] [build] [2020-01-21 UTC 19:05:44.484] D 6019480 2020-01-21T14:05:44-05:00 [docker] [build] [pipenv.exceptions.InstallError]: ["ERROR: Could not install packages due to an EnvironmentError: Invalid URL 'https://ITS_A_SECRET:@/backoff/': No host supplied"] [2020-01-21 UTC 19:05:44.484] D 6019480 2020-01-21T14:05:44-05:00 [docker] [build] [2020-01-21 UTC 19:05:44.485] D 6019480 2020-01-21T14:05:44-05:00 [docker] [build] ERROR: ERROR: Package installation failed... [2020-01-21 UTC 19:05:44.485] D 6019480 2020-01-21T14:05:44-05:00 [docker] [build]
Steps to replicate
Using both pypi and a private package server (GemFury). Not sure what else to do to replicate. The exception seems to indicate that the hostname is missing or malformed, but that does not make sense since the error is transient. Is there something different that happens in generating/parsing the hostname for a retry? Could this error occur for any non 200 result like a 429? Gemfury does not document rate limits that I can find but I am sure there is one though I don't think we are exceeding it.
$ pipenv --support