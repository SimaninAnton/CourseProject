ksze commented on 4 Jul 2018
Issue description
pipenv 2018.7.1 is unable to update the Pipfile.lock file when a package contains the platform_python_implementation maker (e.g. cryptography)
pipenv 2018.6.25 didn't have this problem.
Expected result
pipenv lock successfully updates the Pipfile.lock file.
Actual result
$ pipenv lock --verbose
Locking [dev-packages] dependencies...
Locking [packages] dependencies...
using sources: [{'url': 'https://pypi.python.org/simple', 'verify_ssl': True, 'name': 'pypi'}]
Using pip: -i https://pypi.python.org/simple

                          ROUND 1
Current constraints:
  certifi==2018.4.16 (from -r /tmp/pipenv-3zgcv41l-requirements/pipenv-bnmtopkf-constraints.txt (line 2))
  cffi==1.11.5 (from -r /tmp/pipenv-3zgcv41l-requirements/pipenv-bnmtopkf-constraints.txt (line 3))
  coreapi (from -r /tmp/pipenv-3zgcv41l-requirements/pipenv-bnmtopkf-constraints.txt (line 4))
  cryptography==2.2.2 (from -r /tmp/pipenv-3zgcv41l-requirements/pipenv-bnmtopkf-constraints.txt (line 5))
  decorator==4.3.0 (from -r /tmp/pipenv-3zgcv41l-requirements/pipenv-bnmtopkf-constraints.txt (line 6))
  dj-inmemorystorage (from -r /tmp/pipenv-3zgcv41l-requirements/pipenv-bnmtopkf-constraints.txt (line 7))
  Django==2.0.7 (from -r /tmp/pipenv-3zgcv41l-requirements/pipenv-bnmtopkf-constraints.txt (line 8))
  django-cors-headers==2.3.0 (from -r /tmp/pipenv-3zgcv41l-requirements/pipenv-bnmtopkf-constraints.txt (line 9))
  django-filter (from -r /tmp/pipenv-3zgcv41l-requirements/pipenv-bnmtopkf-constraints.txt (line 10))
  django-model-utils (from -r /tmp/pipenv-3zgcv41l-requirements/pipenv-bnmtopkf-constraints.txt (line 11))
  django_polymorphic (from -r /tmp/pipenv-3zgcv41l-requirements/pipenv-bnmtopkf-constraints.txt (line 12))
  django-rest-polymorphic==0.1.7 (from -r /tmp/pipenv-3zgcv41l-requirements/pipenv-bnmtopkf-constraints.txt (line 13))
  django-s3-storage (from -r /tmp/pipenv-3zgcv41l-requirements/pipenv-bnmtopkf-constraints.txt (line 34))
  django-ses (from -r /tmp/pipenv-3zgcv41l-requirements/pipenv-bnmtopkf-constraints.txt (line 30))
  djangorestframework (from -r /tmp/pipenv-3zgcv41l-requirements/pipenv-bnmtopkf-constraints.txt (line 29))
  factory_boy (from -r /tmp/pipenv-3zgcv41l-requirements/pipenv-bnmtopkf-constraints.txt (line 14))
  Faker==0.8.16 (from -r /tmp/pipenv-3zgcv41l-requirements/pipenv-bnmtopkf-constraints.txt (line 15))
  ipython==6.4.0 (from -r /tmp/pipenv-3zgcv41l-requirements/pipenv-bnmtopkf-constraints.txt (line 16))
  jedi==0.12.1 (from -r /tmp/pipenv-3zgcv41l-requirements/pipenv-bnmtopkf-constraints.txt (line 31))
  parso==0.3.0 (from -r /tmp/pipenv-3zgcv41l-requirements/pipenv-bnmtopkf-constraints.txt (line 32))
  pbr==4.0.4 (from -r /tmp/pipenv-3zgcv41l-requirements/pipenv-bnmtopkf-constraints.txt (line 17))
  pexpect==4.6.0 (from -r /tmp/pipenv-3zgcv41l-requirements/pipenv-bnmtopkf-constraints.txt (line 18))
  Pillow==5.2.0 (from -r /tmp/pipenv-3zgcv41l-requirements/pipenv-bnmtopkf-constraints.txt (line 19))
  psycopg2-binary (from -r /tmp/pipenv-3zgcv41l-requirements/pipenv-bnmtopkf-constraints.txt (line 21))
  ptyprocess==0.6.0 (from -r /tmp/pipenv-3zgcv41l-requirements/pipenv-bnmtopkf-constraints.txt (line 33))
  python-dateutil==2.7.3 (from -r /tmp/pipenv-3zgcv41l-requirements/pipenv-bnmtopkf-constraints.txt (line 22))
  pytz==2018.5 (from -r /tmp/pipenv-3zgcv41l-requirements/pipenv-bnmtopkf-constraints.txt (line 23))
  text-unidecode==1.2 (from -r /tmp/pipenv-3zgcv41l-requirements/pipenv-bnmtopkf-constraints.txt (line 25))
  uWSGI==2.0.17 (from -r /tmp/pipenv-3zgcv41l-requirements/pipenv-bnmtopkf-constraints.txt (line 26))
  wheel==0.31.1 (from -r /tmp/pipenv-3zgcv41l-requirements/pipenv-bnmtopkf-constraints.txt (line 27))
  XlsxWriter (from -r /tmp/pipenv-3zgcv41l-requirements/pipenv-bnmtopkf-constraints.txt (line 28))

Finding the best candidates:
  found candidate certifi==2018.4.16 (constraint was ==2018.4.16)
  found candidate cffi==1.11.5 (constraint was ==1.11.5)
  found candidate coreapi==2.3.3 (constraint was <any>)
  found candidate cryptography==2.2.2 (constraint was ==2.2.2)
  found candidate decorator==4.3.0 (constraint was ==4.3.0)
  found candidate dj-inmemorystorage==1.4.1 (constraint was <any>)
  found candidate django==2.0.7 (constraint was ==2.0.7)
  found candidate django-cors-headers==2.3.0 (constraint was ==2.3.0)
  found candidate django-filter==1.1.0 (constraint was <any>)
  found candidate django-model-utils==3.1.2 (constraint was <any>)
  found candidate django-polymorphic==2.0.2 (constraint was <any>)
  found candidate django-rest-polymorphic==0.1.7 (constraint was ==0.1.7)
  found candidate django-s3-storage==0.12.4 (constraint was <any>)
  found candidate django-ses==0.8.5 (constraint was <any>)
  found candidate djangorestframework==3.8.2 (constraint was <any>)
  found candidate factory-boy==2.11.1 (constraint was <any>)
  found candidate faker==0.8.16 (constraint was ==0.8.16)
  found candidate ipython==6.4.0 (constraint was ==6.4.0)
  found candidate jedi==0.12.1 (constraint was ==0.12.1)
  found candidate parso==0.3.0 (constraint was ==0.3.0)
  found candidate pbr==4.0.4 (constraint was ==4.0.4)
  found candidate pexpect==4.6.0 (constraint was ==4.6.0)
  found candidate pillow==5.2.0 (constraint was ==5.2.0)
  found candidate psycopg2-binary==2.7.5 (constraint was <any>)
  found candidate ptyprocess==0.6.0 (constraint was ==0.6.0)
  found candidate python-dateutil==2.7.3 (constraint was ==2.7.3)
  found candidate pytz==2018.5 (constraint was ==2018.5)
  found candidate text-unidecode==1.2 (constraint was ==1.2)
  found candidate uwsgi==2.0.17 (constraint was ==2.0.17)
  found candidate wheel==0.31.1 (constraint was ==0.31.1)
  found candidate xlsxwriter==1.0.5 (constraint was <any>)

Finding secondary dependencies:
  wheel==0.31.1             requires -
  django-s3-storage==0.12.4 requires boto3<2,>=1.4.4, botocore<1.11.0,>=1.10.50, django-s3-storage==0.12.4, django>=1.7, docutils>=0.10, jmespath<1.0.0,>=0.7.1, python-dateutil<3.0.0,>=2.1; python_version >= "2.7", pytz, s3transfer<0.2.0,>=0.1.10, six>=1.5
  uwsgi==2.0.17             requires -
  certifi==2018.4.16        requires -
  cryptography==2.2.2       requires asn1crypto>=0.21.0, cffi>=1.7; platform_python_implementation != "PyPy"; platform_python_implementation != "PyPy", idna>=2.1, six>=1.4.1

Traceback (most recent call last):
  File "/home/kal/.pyenv/versions/3.6.6/lib/python3.6/site-packages/pipenv/patched/notpip/_vendor/packaging/markers.py", line 276, in __init__
    self._markers = _coerce_parse_result(MARKER.parseString(marker))
  File "/home/kal/.pyenv/versions/3.6.6/lib/python3.6/site-packages/pipenv/patched/notpip/_vendor/pyparsing.py", line 1632, in parseString
    raise exc
  File "/home/kal/.pyenv/versions/3.6.6/lib/python3.6/site-packages/pipenv/patched/notpip/_vendor/pyparsing.py", line 1622, in parseString
    loc, tokens = self._parse( instring, 0 )
  File "/home/kal/.pyenv/versions/3.6.6/lib/python3.6/site-packages/pipenv/patched/notpip/_vendor/pyparsing.py", line 1379, in _parseNoCache
    loc,tokens = self.parseImpl( instring, preloc, doActions )
  File "/home/kal/.pyenv/versions/3.6.6/lib/python3.6/site-packages/pipenv/patched/notpip/_vendor/pyparsing.py", line 3395, in parseImpl
    loc, exprtokens = e._parse( instring, loc, doActions )
  File "/home/kal/.pyenv/versions/3.6.6/lib/python3.6/site-packages/pipenv/patched/notpip/_vendor/pyparsing.py", line 1383, in _parseNoCache
    loc,tokens = self.parseImpl( instring, preloc, doActions )
  File "/home/kal/.pyenv/versions/3.6.6/lib/python3.6/site-packages/pipenv/patched/notpip/_vendor/pyparsing.py", line 3183, in parseImpl
    raise ParseException(instring, loc, self.errmsg, self)
pipenv.patched.notpip._vendor.pyparsing.ParseException: Expected stringEnd (at char 40), (line:1, col:41)

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/home/kal/.pyenv/versions/3.6.6/lib/python3.6/site-packages/pipenv/resolver.py", line 87, in <module>
    main()
  File "/home/kal/.pyenv/versions/3.6.6/lib/python3.6/site-packages/pipenv/resolver.py", line 76, in main
    system=system,
  File "/home/kal/.pyenv/versions/3.6.6/lib/python3.6/site-packages/pipenv/resolver.py", line 63, in resolve
    allow_global=system,
  File "/home/kal/.pyenv/versions/3.6.6/lib/python3.6/site-packages/pipenv/utils.py", line 402, in resolve_deps
    req_dir=req_dir
  File "/home/kal/.pyenv/versions/3.6.6/lib/python3.6/site-packages/pipenv/utils.py", line 293, in actually_resolve_deps
    results = resolver.resolve(max_rounds=PIPENV_MAX_ROUNDS)
  File "/home/kal/.pyenv/versions/3.6.6/lib/python3.6/site-packages/pipenv/patched/piptools/resolver.py", line 104, in resolve
    has_changed, best_matches = self._resolve_one_round()
  File "/home/kal/.pyenv/versions/3.6.6/lib/python3.6/site-packages/pipenv/patched/piptools/resolver.py", line 209, in _resolve_one_round
    for dep in self._iter_dependencies(best_match):
  File "/home/kal/.pyenv/versions/3.6.6/lib/python3.6/site-packages/pipenv/patched/piptools/resolver.py", line 311, in _iter_dependencies
    yield InstallRequirement.from_line(dependency_string, constraint=ireq.constraint)
  File "/home/kal/.pyenv/versions/3.6.6/lib/python3.6/site-packages/pipenv/patched/notpip/_internal/req/req_install.py", line 193, in from_line
    markers = Marker(markers)
  File "/home/kal/.pyenv/versions/3.6.6/lib/python3.6/site-packages/pipenv/patched/notpip/_vendor/packaging/markers.py", line 280, in __init__
    raise InvalidMarker(err_str)
pipenv.patched.notpip._vendor.packaging.markers.InvalidMarker: Invalid marker: 'platform_python_implementation != "PyPy"; platform_python_implementation != "PyPy"', parse error at '; platfo'
Steps to replicate
Install pipenv 2018.7.1
Install this Pipfile:
[[source]]
url = "https://pypi.python.org/simple"
verify_ssl = true
name = "pypi"

[requires]
python_version = "3.6"

[packages]
certifi = "==2018.4.16"
cffi = "==1.11.5"
coreapi = "*"
cryptography = "==2.2.2"
decorator = "==4.3.0"
dj-inmemorystorage = "*"
Django = "==2.0.7"
django-cors-headers = "==2.3.0"
django-filter = "*"
django-model-utils = "*"
django_polymorphic = "*"
django-rest-polymorphic = "==0.1.7"
factory_boy = "*"
Faker = "==0.8.16"
ipython = "==6.4.0"
pbr = "==4.0.4"
pexpect = "==4.6.0"
Pillow = "==5.2.0"
pip = "==10.0.1"
"psycopg2-binary" = "*"
python-dateutil = "==2.7.3"
pytz = "==2018.5"
setuptools = "==39.2.0"
text-unidecode = "==1.2"
uWSGI = "==2.0.17"
wheel = "==0.31.1"
XlsxWriter = "*"
djangorestframework = "*"
django-ses = "*"
jedi = "==0.12.1"
parso = "==0.3.0"
ptyprocess = "==0.6.0"
"django-s3-storage" = "*"

[dev-packages]
$ pipenv --support