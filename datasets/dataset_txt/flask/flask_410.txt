santhoshdc1590 commented on 13 Apr 2018
Can anyone help fix this issue?
Expected Behavior
I'm running cloud-function-python using flask.
Error is being pointed to a file called flask-handler.py
Code of flask-handler.py link
import json
import sys
from io import StringIO

import six
from six.moves.urllib_parse import urlparse
from werkzeug.datastructures import Headers

# from .wsgi_util import wsgi


def handle_http_event(app):
    req_json = json.loads(sys.stdin.read())
    c = urlparse(req_json['url'])
    path = c.path
    if path == '':
        path = '/'

    body = StringIO(req_json.get('body', u''))

    req_headers = req_json.get('headers', None)
    h = Headers()
    if req_headers is not None:
        for key, value in six.iteritems(req_headers):
            h.add(key, value)

    with app.test_request_context(
            path=path,
            input_stream=body,
            method=req_json.get('method', 'GET'),
            headers=h,
            query_string=c.query):
        resp = app.full_dispatch_request()
        body = resp.get_data()
        try:
            body = json.loads(body)
        except:
            pass

        headers = {}
        for header in resp.headers:
            if header[0] in headers:
                headers[header[0]] += ', ' + header[1]
            else:
                headers[header[0]] = header[1]

        sys.stdout.write(json.dumps({
            'body': body,
            'status_code': resp.status_code,
            'headers': headers,
        }))
Actual Behavior
I'm getting back this error
line 50 this code resides
        sys.stdout.write(json.dumps({
            'body': body,
            'status_code': resp.status_code,
            'headers': headers,
        }))
I tried json.dump instead of json.dumps but still I'm getting the same error
Failed to execute script function Traceback (most recent call last): 
File "function.py", line 33, in <module> File "site-packages/cloudfn/flask_handler.py", 
line 50, in handle_http_event File "json/__init__.py", 
line 230, in dumps File "json/encoder.py", 
line 198, in encode File "json/encoder.py", 
line 256, in iterencode File "json/encoder.py", 
line 179, in default TypeError: b'{\n "json": {\n "empID": "I123", \n "image": "http://image", \n "refID": "69", \n "refTable": "123456"\n }, \n "message": "Hello world!"\n}\n' is not JSON serializable
I even raised an issue in cloud-function-python but still haven't received any response.
Environment
Python version: 3.5
Flask version: 0.12.2
flack-Cors: 3.0.3
Werkzeug version: 0.12