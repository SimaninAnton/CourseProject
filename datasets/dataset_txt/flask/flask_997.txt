WeirdCarrotMonster commented on 12 Jul 2015
RequestContext push is called in wsgi_app method, outside try..finally block. In push() method application's open_session call takes place, which can possibly lead to exception. But, since original call is not in try..finally block, removal of stack top never takes place. This leads to following problems:
1. Application context stack never updates again
RequestContext.push() only checks that application context exists or belongs to current application, but same rules apply to previous context.
2. Request context stack grows
Again, request context stack is pushed, but never removed. Actually just a memory leak :)
3. Misleading code comment about open_session usage
Inspired by this comment, i started to develop multi-tenant application, and found nothing but disappointment. You can't actually access request_context before open_session interface call. This means, you can't configure which database to use before opening a session.
My proposition.
Move open_session call to full_dispatch_request, and add interfaces and methods, similar to before_request - before_open_session, or call before_request before opening session (may break code that depends on session interface)