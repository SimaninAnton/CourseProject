MaxNoe commented on 16 Apr 2018 â€¢
edited
For things like server sent events, it would be really great to have an easy option to check if the client connection of a streamed request is still open.
Something like this:
from flask import Flask, Response, client, stream_with_context

app = Flask('sse')

@app.route('/stream')
def sse():
    def gen_sse():
        with open('log.txt') as f:
            while client.is_connected(): 
                lines = f.read()
                if lines:
                    yield build_sse(lines)
                time.sleep(1)

    return Response(
        stream_with_context(gen_sse()),
        mimetype='text/event-stream',
    )

def build_sse(message, id_=None):
    sse = ''
    if id_ is not None:
        sse += f'id: {id_}\n'
    sse += 'data: ' + '\ndata:'.join(message.splitlines())
    sse += '\n\n'
    return sse
2