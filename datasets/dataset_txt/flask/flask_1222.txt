peter-conalgo commented on 12 Jul 2014
In https://github.com/mitsuhiko/flask/blob/master/flask/helpers.py#L401:
_request_ctx_stack.top.flashes = flashes = session.pop('_flashes') \
      if '_flashes' in session else []
This check for the key existence, and then a pop causes a race condition in my system because it is possible for the _flashes key to disappear between the check and the pop, leading to a KeyError. (I saw it happen under load.)
The fix is easy: use the "default" argument to the pop. That path is implemented in an atomic manner in my session code already.