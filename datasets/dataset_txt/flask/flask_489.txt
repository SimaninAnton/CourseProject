iScrE4m commented on 19 Dec 2017
Expected Behavior
Given we have an app with a teardown_request and a route that always raises exception, when the app is first launched either with debug=True or through uWSGI, the teardown request should execute.
from flask import Flask

app = Flask(__name__)


@app.teardown_request
def teardown(exc):
    print('Teardown request executed')

@app.route('/')
def error_route():
    e = 3 / 0

if __name__ == '__main__':
    app.run(debug=True)
Actual Behavior
Instead for the first request (in uWSGI case, for each worker's first request), the teardown does not execute. After few hours debugging with PyCharm the best information we can share (I hope it's actually useful) is that in flask.ctx.RequestContext.push() the _request_ctx_stack.top is None.
Environment
Python version: 3.5
Flask version: 0.12.2
Werkzeug version: 0.13