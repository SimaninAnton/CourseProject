SharkyRawr commented on 16 Jun 2017
I wrote some code for on-demand thumbnail generation but ran in to some weirdness with send_from_directory:
# Just a relative directory called "thumbs" that's supposed to hold a replica directory tree, only with thumbnails
thumbcache = 'thumbs'

# ...

@app.route('/thumb/<path:path>')
def thumbnail(path):
    
    # Simple True/False return for success/failure.
    success = cache_thumbnail(path)
    if not success:
        raise Exception("Thumbnail generation failed!")

    # All thumbnails are jpg so I need to replace the file extension:
    thumbpath, _ = os.path.splitext(path)
    thumbpath += ".jpg"

    ## thumbpath = thumbpath.replace('\\', '/')

    #return send_file(thumbcache + '/' + thumbpath)
    return send_from_directory(thumbcache, thumbpath)
The '/thumb/<path:path> URL is being generated by:
<img id="{{loop.index}}" src="{{ url_for('thumbnail', path=file) }}">
The requests look like: "GET /thumb/gw%5Calpha%5C1430f690aa3fcfda5c10beceb9c120ea.jpg HTTP/1.1"
Actual Behavior
The code above, as is, results in a 404 - File not found error. No exception.
Expected Behavior
The file should be served.
If I uncomment the line return send_file(thumbcache + '/' + thumbpath) and thereby bypassing any security, it works but that's an undesirable workaround.
If I uncomment the line thumbpath = thumbpath.replace('\\', '/') to replace all backslashes with forward slashes, it works fine.
I don't know why url_for generated backslashes in the first place. Maybe an artifact because I am running this code on a Windows machine?
Environment
Python version: Python 3.5.2 (v3.5.2:4def2a2901a5, Jun 25 2016, 22:18:55) [MSC v.1900 64 bit (AMD64)] on win32
Flask version: 0.12.2
Werkzeug version: 0.12.2