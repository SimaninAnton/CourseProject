bpaterni commented on 2 Sep 2017 â€¢
edited
Expected Behavior
Flask apps run in debug mode (importing grequests) should reload when filesystem changes are detected.
Actual Behavior
Instead, the following app crashes as changes are introduced and an app reload is attempted. Oddly enough, if the app is started with grequests commented out, and then uncommented, reloads process successfully.
import flask              

import grequests          
import sys                

app = flask.Flask(__name__)                          
app.debug = True          

@app.route('/syspath')    
def syspath():            
    return '\n'.join(sys.path) + '\n'       
$ FLASK_APP=demo.py FLASK_DEBUG=1 flask run --host=0.0.0.0
 * Serving Flask app "demo"                          
 * Forcing debug mode on                             
 * Running on http://0.0.0.0:5000/ (Press CTRL+C to quit)                                                 
 * Restarting with stat                              
 * Debugger is active!                               
 * Debugger PIN: 313-109-065                         
 * Detected change in '/home/bpaterni/usr/local/src/python/flask-app-restart-demo/demo.py', reloading     
 * Restarting with stat                              
Traceback (most recent call last):                   
  File "/home/bpaterni/usr/local/src/python/venvs/venv-01/bin/flask", line 11, in <module>                
    sys.exit(main())                                 
  File "/home/bpaterni/usr/local/src/python/venvs/venv-01/lib/python3.5/site-packages/flask/cli.py", line 513, in main                                                                                              
    cli.main(args=args, prog_name=name)              
  File "/home/bpaterni/usr/local/src/python/venvs/venv-01/lib/python3.5/site-packages/flask/cli.py", line 380, in main                                                                                              
    return AppGroup.main(self, *args, **kwargs)      
  File "/home/bpaterni/usr/local/src/python/venvs/venv-01/lib/python3.5/site-packages/click/core.py", line 697, in main                                                                                             
    rv = self.invoke(ctx)                            
  File "/home/bpaterni/usr/local/src/python/venvs/venv-01/lib/python3.5/site-packages/click/core.py", line 1066, in invoke                                                                                          
    return _process_result(sub_ctx.command.invoke(sub_ctx))                                               
  File "/home/bpaterni/usr/local/src/python/venvs/venv-01/lib/python3.5/site-packages/click/core.py", line 895, in invoke                                                                                           
    return ctx.invoke(self.callback, **ctx.params)   
  File "/home/bpaterni/usr/local/src/python/venvs/venv-01/lib/python3.5/site-packages/click/core.py", line 535, in invoke                                                                                           
    return callback(*args, **kwargs)                 
  File "/home/bpaterni/usr/local/src/python/venvs/venv-01/lib/python3.5/site-packages/click/decorators.py", line 64, in new_func                                                                                    
    return ctx.invoke(f, obj, *args[1:], **kwargs)   
  File "/home/bpaterni/usr/local/src/python/venvs/venv-01/lib/python3.5/site-packages/click/core.py", line 535, in invoke                                                                                           
    return callback(*args, **kwargs)                 
  File "/home/bpaterni/usr/local/src/python/venvs/venv-01/lib/python3.5/site-packages/flask/cli.py", line 438, in run_command                                                                                       
    use_debugger=debugger, threaded=with_threads)    
  File "/home/bpaterni/usr/local/src/python/venvs/venv-01/lib/python3.5/site-packages/werkzeug/serving.py", line 737, in run_simple                                                                                 
    reloader_type)                                   
  File "/home/bpaterni/usr/local/src/python/venvs/venv-01/lib/python3.5/site-packages/werkzeug/_reloader.py", line 265, in run_with_reloader                                                                        
    sys.exit(reloader.restart_with_reloader())       
  File "/home/bpaterni/usr/local/src/python/venvs/venv-01/lib/python3.5/site-packages/werkzeug/_reloader.py", line 124, in restart_with_reloader                                                                    
    close_fds=False)                                 
  File "/home/bpaterni/usr/local/src/python/venvs/venv-01/lib/python3.5/site-packages/gevent/subprocess.py", line 234, in call                                                                                      
    with Popen(*popenargs, **kwargs) as p:           
  File "/home/bpaterni/usr/local/src/python/venvs/venv-01/lib/python3.5/site-packages/gevent/subprocess.py", line 554, in __init__                                                                                  
    restore_signals, start_new_session)              
  File "/home/bpaterni/usr/local/src/python/venvs/venv-01/lib/python3.5/site-packages/gevent/subprocess.py", line 1160, in _execute_child                                                                           
    self.pid = fork_and_watch(self._on_child, self._loop, True, fork)                                     
  File "/home/bpaterni/usr/local/src/python/venvs/venv-01/lib/python3.5/site-packages/gevent/os.py", line 375, in fork_and_watch                                                                                    
    watcher = loop.child(pid, ref=ref)               
  File "gevent.libev.corecext.pyx", line 518, in gevent.libev.corecext.loop.child (src/gevent/libev/gevent.corecext.c:7601)                                                                                         
  File "gevent.libev.corecext.pyx", line 1886, in gevent.libev.corecext.child.__init__ (src/gevent/libev/gevent.corecext.c:21676)                                                                                   
TypeError: child watchers are only available on the default loop
Environment
Python version: 3.5.4
Flask version: 0.12.2
Werkzeug version: 0.12.2
grequests: 0.3.0
gevent version: 1.2.2
Click version: 6.7