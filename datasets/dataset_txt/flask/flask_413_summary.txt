Backport #2691 detect JSON encoding