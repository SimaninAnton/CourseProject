seikojin commented on 30 Dec 2016
Setup:
Remote linux server with mitimproxy 0.18.2 installed
Machines using ssh to remotely connect and start sessions. Usually 7-10 sessions at the same time.
Multiple devices connected to each proxy
I replaced some items with and for what I was filtering against and my install paths (which should be irrelevant).
Steps to reproduce the problem:
Ssh to your remote monitor
Start 7 sessions and connect 8 devices (2 of them to 1 session that did not crash)
Let monitor for 72 hours
Sessions 4 and 5 crashed with the same error below. Those 2 sessions had single devices connected.
Traceback (most recent call last):0.0.0.0:8084):
  File "<userpath>/.local/lib/python2.7/site-packages/mitmproxy/proxy/server.py", line 120, in handle
    root_layer()/python2.7/threading.py", line 801, in __bootstrap_inner
[0/767]  [f:<filter>]                                                                                                                                                                                                                                                                                                                        ?:help [*:8084]
Error: 10.0.2.245:43899: Traceback (most recent call last):
  File "<userpath>/.local/lib/python2.7/site-packages/mitmproxy/protocol/tls.py", line 391, in __call__
    layer()r/lib/python2.7/socket.py", line 206, in accept
  File "<userpath>/.local/lib/python2.7/site-packages/mitmproxy/protocol/http1.py", line 74, in __call____call__
    layer()
  File "<userpath>/.local/lib/python2.7/site-packages/mitmproxy/protocol/http.py", line 184, in __call__
    self.handle_regular_mode_connect(request)
  File "<userpath>/.local/lib/python2.7/site-packages/mitmproxy/protocol/http.py", line 283, in handle_regular_mode_connect
    layer()
  File "<userpath>/.local/lib/python2.7/site-packages/mitmproxy/protocol/tls.py", line 384, in __call___
    self._establish_tls_with_client_and_server()
  File "<userpath>/.local/lib/python2.7/site-packages/mitmproxy/protocol/tls.py", line 470, in _establish_tls_with_client_and_server
    six.reraise(*sys.exc_info())
  File "<userpath>/.local/lib/python2.7/site-packages/mitmproxy/protocol/tls.py", line 467, in _establish_tls_with_client_and_server
    self._establish_tls_with_client()nd_server()
  File "<userpath>/.local/lib/python2.7/site-packages/mitmproxy/protocol/tls.py", line 492, in _establish_tls_with_client_and_server
    extra_chain_certs=extra_certs,
  File "<userpath>/.local/lib/python2.7/site-packages/mitmproxy/models/connections.py", line 99, in convert_to_ssl_client_and_server
    super(ClientConnection, self).convert_to_ssl(*args, **kwargs)
  File "<userpath>/.local/lib/python2.7/site-packages/netlib/tcp.py", line 857, in convert_to_sslstablish_tls_with_client
    **sslctx_kwargs)s=extra_certs,
  File "<userpath>/.local/lib/python2.7/site-packages/netlib/tcp.py", line 820, in create_ssl_contextonvert_to_ssl
    context = self._create_ssl_context(ca_pemfile=chain_file, **sslctx_kwargs)
  File "<userpath>/.local/lib/python2.7/site-packages/netlib/tcp.py", line 544, in _create_ssl_context
    context.load_verify_locations(ca_pemfile, ca_path)
  File "<userpath>/.local/lib/python2.7/site-packages/OpenSSL/SSL.py", line 525, in load_verify_locations
    _raise_current_error()_ssl_context(ca_pemfile=chain_file, **sslctx_kwargs)
  File "<userpath>/.local/lib/python2.7/site-packages/OpenSSL/_util.py", line 48, in exception_from_error_queue
    raise exception_type(errors)s(ca_pemfile, ca_path)
Error: [('system library', 'fopen', 'Too many open files'), ('BIO routines', 'BIO_new_file', 'system lib'), ('x509 certificate routines', 'X509_load_cert_crl_file', 'system lib')]
    _raise_current_error()
mitmproxy has crashed!local/lib/python2.7/site-packages/OpenSSL/_util.py", line 48, in exception_from_error_queue
Please lodge a bug report at: https://github.com/mitmproxy/mitmproxy
Error: [('system library', 'fopen', 'Too many open files'), ('BIO routines', 'BIO_new_file', 'system lib'), ('x509 certificate routines', 'X509_load_cert_crl_file', 'system lib')]
Any other comments? What have you tried so far?
Using ctrl+C killed the proxy session and I was able to restart.
System information