Member
mhils commented on 24 Jul 2012
As already discussed yesterday, employing the decoded decorator in handle_response breaks some responses. I have not found a page where this is always reproducible, but it occasionally happens to me on www.spiegel.de
Here is a mitmproxy dump containing two requests to the same resource of which the first one fails. These dumps were produced before applying decorated to the response:
            if self.o.wfile:
                self.fwriter.add(flow)
            with decoded(flow.response):
                pass
            if self.o.wfile2:
                self.fwriter2.add(flow)
This file contains the same request after the decoded decorator has been applied. One possible solution might be caching the encoded version in HTTPMsg.decode. While this is definitely not a very nice and clean solution, it would guarantee that every flow get passed as-is.