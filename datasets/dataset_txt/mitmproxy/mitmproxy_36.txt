tomlabaude commented on 26 Nov 2019
Embedding mitmdump binary in a macOS app requires it to be signed with command:
codesign -s "Developer ID Application" mitmdump_ok

codesign --display -v mitmdump_ok
Executable=mitmproxy/release/build/binaries/osx/mitmdump_ok
Identifier=mitmdump_ok
Format=Mach-O thin (x86_64)
CodeDirectory v=20200 size=117387 flags=0x0(none) hashes=3664+2 location=embedded
Signature size=9051
Timestamp=25 Nov 2019 at 22:52:07
Info.plist=not bound
TeamIdentifier=AATLWWB4MZ
Sealed Resources=none
Internal requirements count=1 size=172

./mitmdump_ok --version
Mitmproxy: 5.0.0.dev binary
Python:    3.7.3
OpenSSL:   OpenSSL 1.1.0j  20 Nov 2018
Platform:  Darwin-18.7.0-x86_64-i386-64bit
Apple Notarization of an app now requires to enable Hardened Runtime entitlement and a flag 'runtime' during codesigning:
https://developer.apple.com/documentation/xcode/notarizing_macos_software_before_distribution/resolving_common_notarization_issues
codesign -o runtime -s "Developer ID Application" mitmdump_err

codesign --display -v mitmdump_err
Executable=mitmproxy/release/build/binaries/osx/mitmdump_err
Identifier=mitmdump_err
Format=Mach-O thin (x86_64)
CodeDirectory v=20500 size=117432 flags=0x10000(runtime) hashes=3664+2 location=embedded
Signature size=9051
Timestamp=25 Nov 2019 at 22:58:33
Info.plist=not bound
TeamIdentifier=AATLWWB4MZ
Runtime Version=10.11.0
Sealed Resources=none
Internal requirements count=1 size=172

./mitmdump_err
[33886] Error loading Python lib '/var/folders/xd/spqtylb911ncthxhqzlxy7d80000gn/T/_MEI4lZWPI/Python': dlopen: dlopen(/var/folders/xd/spqtylb911ncthxhqzlxy7d80000gn/T/_MEI4lZWPI/Python, 10): no suitable image found.  Did find:
 /var/folders/xd/spqtylb911ncthxhqzlxy7d80000gn/T/_MEI4lZWPI/Python: code signature in (/var/folders/xd/spqtylb911ncthxhqzlxy7d80000gn/T/_MEI4lZWPI/Python) not valid for use in process using Library Validation: mapped file has no cdhash, completely unsigned? Code has to be at least ad-hoc signed.
I tried unsuccessfully this fork of pyinstaller which signs all embedded binaries
https://github.com/cculianu/pyinstaller/releases/tag/3.4AppleEventsCodeSign
-> It failed, according to dev "You can't use the -o runtime option with Pyinstaller because it does evil crap like create a binary from its internal archive and fork() then execute() it. -o runtime disallows this."