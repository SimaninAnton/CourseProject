flarno11 commented on 1 Sep 2015
I get an error when I try to connect to a ssl server that requires the sni extension:
ProxyError('NetLibError("SSL handshake error: Error([('SSL routines', 'SSL23_GET_SERVER_HELLO', 'tlsv1 alert internal error')],)",)',)
However, when I change the code the following, it works:
In protocol/http.py HTTPHandler.process_connect_request(self, address):
Without SNI:
self.c.establish_ssl(server=True, client=True)
With SNI:
self.c.establish_ssl(server=True, client=True, sni=address.host)
Without SNI:
2015-09-01 09:19:55 aquarium MainThread INFO Connecting to database at localhost:27017...
2015-09-01 09:19:55 aquarium MainThread INFO Ready
2015-09-01 09:20:01 aquarium MainThread INFO 127.0.0.1:55540: clientconnect
2015-09-01 09:20:01 aquarium MainThread INFO 127.0.0.1:55540: request
-> CONNECT enc.com.au:443 HTTP/1.1
2015-09-01 09:20:01 aquarium MainThread INFO 127.0.0.1:55540: Set new server address: enc.com.au:443
2015-09-01 09:20:01 aquarium MainThread INFO 127.0.0.1:55540: serverconnect
-> enc.com.au:443
2015-09-01 09:20:01 aquarium MainThread INFO 127.0.0.1:55540: Received CONNECT request to SSL port. Upgrading to SSL...
2015-09-01 09:20:01 aquarium MainThread INFO 127.0.0.1:55540: Establish SSL
-> with client
-> with server (sni: None)
2015-09-01 09:20:01 aquarium MainThread INFO 127.0.0.1:55540: SSL handshake error: The client may not trust the proxy's certificate.
2015-09-01 09:20:01 aquarium MainThread INFO 127.0.0.1:55540: ProxyError('NetLibError("SSL handshake error: Error([('SSL routines', 'SSL23_GET_SERVER_HELLO', 'tlsv1 alert internal error')],)",)',)
2015-09-01 09:20:01 aquarium MainThread INFO 127.0.0.1:55540: clientdisconnect
2015-09-01 09:20:01 aquarium MainThread INFO 127.0.0.1:55540: serverdisconnect
-> enc.com.au:443
With SNI:
2015-09-01 09:19:20 aquarium MainThread INFO 127.0.0.1:55528: clientconnect
2015-09-01 09:19:20 aquarium MainThread INFO 127.0.0.1:55528: request
-> CONNECT enc.com.au:443 HTTP/1.1
2015-09-01 09:19:20 aquarium MainThread INFO 127.0.0.1:55528: Set new server address: enc.com.au:443
2015-09-01 09:19:20 aquarium MainThread INFO 127.0.0.1:55528: serverconnect
-> enc.com.au:443
2015-09-01 09:19:20 aquarium MainThread INFO 127.0.0.1:55528: Received CONNECT request to SSL port. Upgrading to SSL...
2015-09-01 09:19:20 aquarium MainThread INFO 127.0.0.1:55528: Establish SSL
-> with client
-> with server (sni: enc.com.au)
2015-09-01 09:19:21 aquarium MainThread INFO 127.0.0.1:55528: Upgrade to SSL completed.
2015-09-01 09:19:21 aquarium MainThread INFO 127.0.0.1:55528: request
-> GET /2015/06/08/checking-cloudflare-ssl/ HTTP/1.1
2015-09-01 09:19:25 aquarium MainThread INFO 127.0.0.1:55528: response
-> HTTP/1.1 200 OK
2015-09-01 09:19:25 aquarium MainThread INFO 127.0.0.1:55528: clientdisconnect
2015-09-01 09:19:25 aquarium MainThread INFO 127.0.0.1:55528: serverdisconnect
-> enc.com.au:443
mitmproxy versions: 11.4, 13.0
Operating Systems: Mac OS X 10.10.5, Ubuntu 14.04
OpenSSL: 1.0.2d 9 Jul 2015, 1.0.1f 6 Jan 2014