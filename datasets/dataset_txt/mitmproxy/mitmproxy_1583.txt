Contributor
onlywade commented on 1 Nov 2014
For OPTIONS requests where the outgoing form should be relative (i.e. we're not using an upstream proxy), the original path is replaced with a single '*' (asterisk) character. This causes CORS scenarios to fail when the server doesn't support wildcard preflight requests.
This substitution looks to be done deliberately with the intention of supporting "asterisk form" requests -- See 3032672. I don't think it's necessary, since asterisk form requests can be handled in the same way as any other relative request, though I could be missing something.
Steps to reproduce the problem:
Run mitmproxy without supplying any CLI args
Make a proxied OPTIONS request for a specific resource, e.g. curl -i https://api.github.com/orgs/mitmproxy/repos -X OPTIONS -x 127.0.0.1:8080
Expected results:
Server receives request with the original path intact, returns 204 No Content response along with relevant Access-Control headers.
Actual results:
Server receives request with * in place of original path, returns 502 Bad Gateway response.
Suggested fix: modify protocol.http.HTTPRequest._assemble_first_line(), removing the special treatment for OPTIONS requests. For good measure, add a test to cover this fairly common scenario.