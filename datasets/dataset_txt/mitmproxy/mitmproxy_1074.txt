Member
Kriechi commented on 4 Jun 2016
Python 2 on Travis just gave me this failure:
https://travis-ci.org/mitmproxy/mitmproxy/jobs/135222429
___________________________ TestApp.test_log_binary ____________________________
self = <test_app.TestApp object at 0x7f54533baad0>
    def test_log_binary(self):
>       assert self.get("200:h@10b=@10b:da")
test/pathod/test_app.py:36: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
test/pathod/tutils.py:105: in get
    resp = c.request("get:/p/%s" % urllib.quote(spec).encode("string_escape"))
pathod/pathoc.py:456: in request
    return self.http(r)
pathod/pathoc.py:430: in http
    if resp:
pathod/log.py:56: in __exit__
    six.reraise(exc_type, exc_value, traceback)
pathod/pathoc.py:418: in http
    resp = self.protocol.read_response(self.rfile, treq(method=req["method"].encode()))
netlib/http/http1/read.py:66: in read_response
    response = read_response_head(rfile)
netlib/http/http1/read.py:94: in read_response_head
    headers = _read_headers(rfile)
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
rfile = <netlib.tcp.Reader object at 0x7f54533b7450>
    def _read_headers(rfile):
        """
            Read a set of headers.
            Stop once a blank line is reached.

            Returns:
                A headers object

            Raises:
                exceptions.HttpSyntaxException
        """
        ret = []
        while True:
            line = rfile.readline()
            if not line or line == b"\r\n" or line == b"\n":
                break
            if line[0] in b" \t":
                if not ret:
                    raise exceptions.HttpSyntaxException("Invalid headers")
                # continued header
                ret[-1] = (ret[-1][0], ret[-1][1] + b'\r\n ' + line.strip())
            else:
                try:
                    name, value = line.split(b":", 1)
                    value = value.strip()
                    if not name:
                        raise ValueError()
                    ret.append((name, value))
                except ValueError:
>                   raise exceptions.HttpSyntaxException("Invalid headers")
E                   HttpSyntaxException: Invalid headers
netlib/http/http1/read.py:343: HttpSyntaxException
/cc @cortesi