Sfinx commented on 16 Jun 2018 â€¢
edited
Steps to reproduce the problem:
setup two socks5 proxies (srelay & mitmproxy)
install stock ubuntu tsocks app
use simple /etc/tsocks.conf:
server = srelay_host
# Server type defaults to 4 so we need to specify it as 5 for this one
server_type = 5
# The port defaults to 1080 but I've stated it here for clarity
server_port = 8080
check some connection : tsocks telnet some_host 22
Trying xxxxx...
Connected to xxxxxx.
Escape character is '^]'.
SSH-2.0-OpenSSH_7.2p2 Ubuntu-4ubuntu2.4
All is working as expected.
Then check the same with mitmproxy -m socks5 :
# must be at the same NAT network as your test box because of next bug (see second bug report)
server = mitmproxy_host
# Server type defaults to 4 so we need to specify it as 5 for this one
server_type = 5
# The port defaults to 1080 but I've stated it here for clarity
server_port = 8080
Trying xxxx...
Connected to xxxx.
Escape character is '^]'.

[Silence here, press Enter twice]

HTTP/1.1 400 Bad Request
Server: mitmproxy 4.0.3
Connection: close
Content-Length: 274
Content-Type: text/html

<html>
            <head>
                <title>400 Bad Request</title>
            </head>
            <body>
            <h1>400 Bad Request</h1>
            <p>HttpSyntaxException(&quot;Bad HTTP request line: b&#x27;&#x27;&quot;,)</p>
            </body>
        </html>HTTP/1.1 502 Bad Gateway
Server: mitmproxy 4.0.3
Connection: close
Content-Length: 311
Content-Type: text/html

<html>
            <head>
                <title>502 Bad Gateway</title>
            </head>
            <body>
            <h1>502 Bad Gateway</h1>
            <p>ProtocolException(&quot;HTTP protocol error in client request: Bad HTTP request line: b&#x27;&#x27;&quot;,)</p>
            </body>
        </html>Connection closed by foreign host.
Stock Ubuntu 18.04 & 4.0.3 mitmproxy