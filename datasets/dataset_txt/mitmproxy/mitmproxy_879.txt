Contributor
fotinakis commented on 18 Nov 2016 â€¢
edited
Env: mitmdump 0.18.2 (trying to migrate a script from 0.16)
Hello!
I'm trying to understand how I might use replay_request or something else to add proxy-level retries on certain errors, such as when a flaky backend throws a 503 error.
I've tried this:
$ mitmdump -p 8080 --no-http2 -s myscript.py
myscript.py:
from mitmproxy import ctx

def response(flow):
    # Retry once if the backend responded with 503:
    if flow.response.status_code == 503:
        f = ctx.master.duplicate_flow(flow)
        ctx.master.replay_request(f, block=True)
...but this seems to deadlock, I think because I don't understand the way the main thread processes flows (or how exactly to replace the current flow.response).
Can you point me in the right direction here?