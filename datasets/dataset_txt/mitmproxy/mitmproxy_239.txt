SgrAlpha commented on 27 Jul 2018
I git a weird SSL_PROTOCOL_ERROR on iOS / macOS devices when playing with transparent mode.
The deployment topology is my clients will connect to my VPS server using shadowsocks proxy, mitmproxy is enabled on the VPS and running in transparent mode to capture the communications to one specific site.
All Android devices work perfectly without error, but on all iOS / macOS devices, will hit SSL_PROTOCOL_ERROR when trying to browse HTTPS site.
Usually that's due to wrong CA, but I confirm the root CA has been installed to all iOS devices, and enabled in General -> About -> Certificate Trust Settings.
Steps to reproduce the problem:
Build a new Ubuntu 18.04 VPS
Setup shadowsocks-libev server listen to port 8989 for example.
Enable UFW and allow 8989 and 5800
Update /etc/ufw/before.rules, append following after the last commit:
*nat
:PREROUTING ACCEPT [0:0]
:POSTROUTING ACCEPT [0:0]
:OUTPUT ACCEPT [0:0]
-A OUTPUT -p tcp -m owner --uid-owner nobody --dport 80 -j REDIRECT --to-port 8080
-A OUTPUT -p tcp -m owner --uid-owner nobody --dport 443 -j REDIRECT --to-port 8080
COMMIT
Install mitmproxy and start with: mitmdump --mode transparent --ignore-hosts <rules> --script /capture.py
Let clients connect to the VPS via shadowsocks client.
Open Safari / Chrome and visite https://www.google.com
Any other comments? What have you tried so far?
Android devices work perfectly. If I remove the changes in /etc/ufw/before.rules, switch to regular mode and let clients connect as a HTTP proxy, both Android and iOS work.
System information
Mitmproxy: 4.0.3
Python: 3.6.5
OpenSSL: OpenSSL 1.1.0h 27 Mar 2018
Platform: Linux-4.15.0-29-generic-x86_64-with-Ubuntu-18.04-bionic