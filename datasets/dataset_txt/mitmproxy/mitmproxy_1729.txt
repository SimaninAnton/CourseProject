lddubeau commented on 8 Feb 2014
Summary
mitmdump -S ... raises AttributeError: 'NoneType' object has no attribute '_assemble'
Versions
OS: Debian testing (up to date as of 2014-02-07)
mitmproxy: 0.10.0
How to Reproduce
Issue:
$ mitmdump -e -a -F http://www.gnome.org -p 3333 -w test
# Switch terminal...
$ curl -k -x "https://localhost:3333" 'http://www.gnome.org/'
$ curl -k -x "https://localhost:3333" 'http://www.gnome.org/about/'
mitmdump's output will look like this:
127.0.0.1:54820: connect
127.0.0.1 GET http://www.gnome.org/
 << 200 OK 17.64kB
127.0.0.1:54820: disconnect
  -> handled 1 requests
127.0.0.1:54824: connect
127.0.0.1 GET http://www.gnome.org/about/
 << 200 OK 15.66kB
127.0.0.1:54824: disconnect
  -> handled 1 requests
Kill mitmdump.
Issue:
$ mitmdump -e -a -F http://www.gnome.org -p 3333 -S test
# Switch terminal...
$ curl -k -x "https://localhost:3333" 'http://www.gnome.org/'
$ curl -k -x "https://localhost:3333" 'http://www.gnome.org/about/'
mitmdump's output will look like this:
127.0.0.1:54832: connect
127.0.0.1 GET http://www.gnome.org/
 << [replay] 200 OK 17.64kB
127.0.0.1:54832: disconnect
  -> handled 1 requests
127.0.0.1:54834: connect
----------------------------------------
Error in processing of request from 127.0.0.1:54834
Traceback (most recent call last):
  File "/usr/local/lib/python2.7/dist-packages/netlib/tcp.py", line 376, in request_thread
    self.handle_connection(request, client_address)
  File "/usr/local/lib/python2.7/dist-packages/libmproxy/proxy.py", line 545, in handle_connection
    h.handle()
  File "/usr/local/lib/python2.7/dist-packages/libmproxy/proxy.py", line 192, in handle
    while self.handle_request(cc) and not cc.close:
  File "/usr/local/lib/python2.7/dist-packages/libmproxy/proxy.py", line 274, in handle_request
    self.send_response(response)
  File "/usr/local/lib/python2.7/dist-packages/libmproxy/proxy.py", line 493, in send_response
    d = response._assemble()
AttributeError: 'NoneType' object has no attribute '_assemble'

----------------------------------------
127.0.0.1 GET http://www.gnome.org/about/
 << [replay] 200 OK 15.66kB
curl's output:
curl: (52) Empty reply from server
Actual Results
mitmdump crashes while serving the second request.
Expected Results
No crash, and the second request served successfully.
Observations
At the step of replaying server responses, starting mitmproxy with the same parameters as given to mitmdump above WORKS!
If mitmdump is started with `--no-pop``, it WORKS!
I'm able to reproduce the behavior with versions 0.10.0 and 0.9.2.
I've reproduced this behavior with api.zotero.org and www.eff.org (which both use SSL). So it is not a problem with www.gnome.org
I'm able to reproduce the behavior by connecting to the proxy with Python's urllib2, so curl is not the problem.