Gigiarum commented on 8 Mar 2018
Steps to reproduce the problem:
Start mitmdump with this script
import base64

from mitmproxy import ctx
from mitmproxy.utils import strutils


def response(flow):
    ctx.log.info("url=[{}].".format(flow.request.url))

    mimeType = flow.response.headers.get('Content-Type', '')
    ctx.log.info("mimeType=[{}]".format(mimeType))

    if strutils.is_mostly_bin(flow.response.content):
        ctx.log.info("encoding=[base64]")
        text = base64.b64encode(flow.response.content).decode() # Store binary data as base64
    else:
        text = flow.response.get_text(strict=False)
    ctx.log.info("text=[{}]".format(text))
Connect to this url
This exception will throw when the script tries to print text to log
Addon error: Traceback (most recent call last):
  File "/root/.pyenv/versions/3.6.3/lib/python3.6/site-packages/mitmproxy/addons/termlog.py", line 37, in log
    err=(e.level == "error")
  File "/root/.pyenv/versions/3.6.3/lib/python3.6/site-packages/click/termui.py", line 420, in secho
    return echo(style(text, **styles), file=file, nl=nl, err=err, color=color)
  File "/root/.pyenv/versions/3.6.3/lib/python3.6/site-packages/click/utils.py", line 259, in echo
    file.write(message)
UnicodeEncodeError: 'ascii' codec can't encode characters in position 37-40: ordinal not in range(128)
Any other comments? What have you tried so far?
It seems the problem is in the get_text function of Message class.
Same exception when you point to a url returned with mimeType "text/html; charset=ISO-8859-1".
System information
Mitmproxy: 3.0.3
Python: 3.6.3
OpenSSL: OpenSSL 1.1.0g 2 Nov 2017
Platform: Linux-3.16.0-5-amd64-x86_64-with-debian-8.9
I described partially the problem here.