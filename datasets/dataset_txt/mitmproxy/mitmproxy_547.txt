seannexmo commented on 28 Sep 2017
Steps to reproduce the problem:
Start mitmproxy in normal mode using official docker container. Loaded one script, insecure mode, docker host networking, port 5050
Configure software under test to connect to proxy located at localhost 5050
Trigger a request to fetch an XML file from github
Connection fails with the following error:
            <head>
                <title>400 Bad Request</title>
            </head>
            <body>
            <h1>400 Bad Request</h1>
            <p>HttpSyntaxException(&quot;Bad HTTP request line: b&#x27;\\x80A\\x01\\x03\\x01\\x00\\x18\\x00\\x00\\x00 \\x00\\x00\\x13\\x00\\x00\\x16\\x00\\x00&#x27;&quot;,)</p>
            </body>
        </html>
Tracing reveals the following:
T 2017/09/27 16:38:35.225917 127.0.0.1:59624 -> 127.0.0.1:5050 [AP]
CONNECT gist.githubusercontent.com:443 HTTP/1.1.
User-Agent: OaklandSoftware/2.7.0.
Host: gist.githubusercontent.com.
.


T 2017/09/27 16:38:35.267952 127.0.0.1:5050 -> 127.0.0.1:59624 [AP]
HTTP/1.1 200 Connection established.
.


T 2017/09/27 16:38:35.271064 127.0.0.1:59624 -> 127.0.0.1:5050 [AP]
.A........ ........
........2..3../Y.....AY(s.WGN..t}G..O.6w$.\..v.

T 2017/09/27 16:38:35.288685 127.0.0.1:5050 -> 127.0.0.1:59624 [AP]
HTTP/1.1 400 Bad Request.
Connection: close.
Server: mitmproxy 2.0.2.
Content-Type: text/html.
Content-Length: 361.
.


T 2017/09/27 16:38:35.288846 127.0.0.1:59624 -> 127.0.0.1:5050 [AP]
......


T 2017/09/27 16:38:35.288855 127.0.0.1:5050 -> 127.0.0.1:59624 [AP]
<html>
            <head>
                <title>400 Bad Request</title>
            </head>
            <body>
            <h1>400 Bad Request</h1>
            <p>HttpSyntaxException(&quot;Bad HTTP request line: b&#x27;\\x80A\\x01\\x03\\x01\\x00\\x18\\x00\\x00\\x00 \\x00\\x00\\x13\\x00\\x00\\x16\\x00\\x00&#x27;&quot;,)</p>
            </body>
        </html>
Any other comments? What have you tried so far?
We have tried running mitmproxy on docker in transparent mode, using instructions here:
http://docs.mitmproxy.org/en/stable/transparent.html
We ensured iptables and route tables were updated to route port 80/443 traffic to 5050 via network layer. We disabled proxy settings on the software and attempted to repeat the exercise. When the proxy was restarted, the event log was full of the following messages during connection attempts:
Transparent mode failure: FileNotFoundError(2, 'No such file or directory')
System information
Python version: 3.5.2
Platform: Linux-2.6.32-696.el6.x86_64-x86_64-with
SSL version: OpenSSL 1.0.2k  26 Jan 2017