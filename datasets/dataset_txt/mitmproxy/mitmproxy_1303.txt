milesrichardson commented on 2 Oct 2015
Version:
$ mitmproxy --version mitmproxy 0.12.1
(old version because I ran into some issues with upstream proxy support + SSL in newer versions... don't recall exactly what they were at the moment)
Setup:
iOS connected to wifi router with default route through VPN tunnel (10.0.0.1)
iOS configured wifi to use HTTP proxy on internal VPN IP (10.0.0.100)
mitmproxy launch args:
mitmproxy -U http://111.111.111.111:1234 -B 10.0.0.100
where 111.111.111.111:1234 is a publicly reachable upstream proxy IP and 10.0.0.100 is the internal VPN IP of mitmproxy that iOS is configured to connect to.
Problem:
Seemingly randomly, mitmproxy will replace the host portion of the URL with the IP of the upstream proxy.
For example if I am connecting to https://www.google.com/some_endpoint then mitmproxy will transform the URL into http://111.111.111.111:1234/some_endpoint. i.e., the hostname will include the full IP and port of the upstream proxy. It seems like this happens when the request should be over an HTTPS connection.
My anecdotal observation is that this happens after the upstream proxy responds to a CONNECT request with a 403 error (the upstream proxy may be misconfigured). i.e. if the CONNECT request to www.google.com returns a 403 error, then the next request to https://www.google.com/some_endpoint will be replaced with http://111.111.111.111:1234/some_endpoint
Is this expected behavior, or a bug?