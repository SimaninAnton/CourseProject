mehdilauters commented on 6 Jan 2016
Stream and replace option not compatible
Steps to reproduce the problem:
./mitmproxy -T --stream 10m --replace ":~t 'text/html':[cC]hristmas:MIAOUUUUUU"
connect with a browser for example to http://hackaday.com/
What is the expected behavior?
What went wrong?
(venv.mitmproxy)mehdi@lea mitmproxy/mitmproxy (master)$ ./mitmproxy -T --stream 10m --replace ":~t 'text/html':[cC]hristmas:MIAOUUUUUU"
Traceback (most recent call last):
  File "mitmproxy/mitmproxy/libmproxy/console/__init__.py", line 500, in run
    self.loop.run()
  File "mitmproxy/venv.mitmproxy/lib/python2.7/site-packages/urwid/main_loop.py", line 278, in run
    self._run()
  File "mitmproxy/venv.mitmproxy/lib/python2.7/site-packages/urwid/main_loop.py", line 376, in _run
    self.event_loop.run()
  File "mitmproxy/venv.mitmproxy/lib/python2.7/site-packages/urwid/main_loop.py", line 682, in run
    self._loop()
  File "mitmproxy/venv.mitmproxy/lib/python2.7/site-packages/urwid/main_loop.py", line 715, in _loop
    alarm_callback()
  File "mitmproxy/venv.mitmproxy/lib/python2.7/site-packages/urwid/main_loop.py", line 164, in cb
    callback(self, user_data)
  File "mitmproxy/mitmproxy/libmproxy/console/__init__.py", line 451, in ticker
    changed = self.tick(self.masterq, timeout=0)
  File "mitmproxy/mitmproxy/libmproxy/flow.py", line 809, in tick
    return super(FlowMaster, self).tick(q, timeout)
  File "mitmproxy/mitmproxy/libmproxy/controller.py", line 108, in tick
    self.handle(*msg)
  File "mitmproxy/mitmproxy/libmproxy/controller.py", line 130, in handle
    m(obj)
  File "mitmproxy/mitmproxy/libmproxy/console/__init__.py", line 730, in handle_response
    f = flow.FlowMaster.handle_response(self, f)
  File "mitmproxy/mitmproxy/libmproxy/flow.py", line 1009, in handle_response
    self.replacehooks.run(f)
  File "mitmproxy/mitmproxy/libmproxy/flow.py", line 95, in run
    f.response.replace(rex, s)
  File "mitmproxy/mitmproxy/libmproxy/models/http.py", line 91, in replace
    pattern, repl, self.content, *args, **kwargs
  File "mitmproxy/mitmproxy/libmproxy/utils.py", line 173, in safe_subn
    return re.subn(str(pattern), str(repl), target, *args, **kwargs)
  File "mitmproxy/venv.mitmproxy/lib/python2.7/re.py", line 166, in subn
    return _compile(pattern, flags).subn(repl, string, count)
TypeError: expected string or buffer

mitmproxy has crashed!
Please lodge a bug report at:
    https://github.com/mitmproxy/mitmproxy
Shutting down...
Any other comments?
mitmproxy version: 11215e4
Operating System: Linux lea 4.2.0-16-generic #19-Ubuntu SMP Thu Oct 8 15:35:06 UTC 2015 x86_64 x86_64 x86_64 GNU/Linux