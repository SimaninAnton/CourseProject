alekseynp commented on 20 Mar 2018 â€¢
edited by mhils
Problem
I'm having trouble with HTTPS only partially working with Chrome.
My log is littered with:
::1:59896: Failed to send error response to client: ClientHandshakeException('Cannot establish TLS with client (sni: mtalk.google.com): TlsException("(-1, \'Unexpected EOF\')",)',)
and alternatively:
::1:60456: Failed to send error response to client: ClientHandshakeException('Cannot establish TLS with client (sni: translate.googleapis.com): TlsException("(104, \'ECONNRESET\')",)',)
This is definitely a problem. For one it means a lot of pages I bring up are 502 Bad Gateway.
No one domain is consistently good or bad.
Typical examples:
[::1]:60452: clientconnect
::1:60452: Set new server address: mtalk.google.com:5228
::1:60452: Establish TLS with client
::1:60452: Failed to send error response to client: ClientHandshakeException('Cannot establish TLS with client (sni: mtalk.google.com): TlsException("(-1, \'Unexpected EOF\')",)',)
[::1]:60452: CONNECT mtalk.google.com:5228
    Host: mtalk.google.com:5228
    Proxy-Connection: keep-alive
 << Cannot establish TLS with client (sni: mtalk.google.com): TlsException("(-1, 'Unexpected EOF')",)
And
::1:60456: serverconnect
  -> ('translate.googleapis.com', 443)
::1:60456: Establish TLS with server
::1:60456: ALPN selected by server: h2
::1:60456: Establish TLS with client
::1:60456: ALPN for client: b'h2'
::1:60456: Failed to send error response to client: ClientHandshakeException('Cannot establish TLS with client (sni: translate.googleapis.com): TlsException("(104, \'ECONNRESET\')",)',)
[::1]:60456: CONNECT translate.googleapis.com:443
    Host: translate.googleapis.com:443
    Proxy-Connection: keep-alive
    User-Agent: Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/65.0.3325.162 Safari/537.36
 << Cannot establish TLS with client (sni: translate.googleapis.com): TlsException("(104, 'ECONNRESET')",)
But there are successes!
::1:60464: serverconnect
  -> ('translate.googleapis.com', 443)
::1:60464: Establish TLS with server
::1:60464: ALPN selected by server: h2
::1:60464: Establish TLS with client
::1:60464: ALPN for client: b'h2'
::1:60464: HTTP2 Event from client
  -> <RemoteSettingsChanged changed_settings:{ChangedSetting(setting=SettingCodes.HEADER_TABLE_SIZE, original_value=4096, new_value=65536), ChangedSetting(setting=SettingCodes.MAX_CONCURRENT_STREAMS, original_value=None, new_value=1000), ChangedSetting(setting=SettingCodes.INITIAL_WINDOW_SIZE, original_value=65535, new_value=6291456)}>
::1:60464: HTTP2 Event from client
  -> <WindowUpdated stream_id:0, delta:15663105>
::1:60464: HTTP2 Event from client
  -> <RequestReceived stream_id:1, headers:[(b':method', b'GET'), (b':authority', b'translate.googleapis.com'), (b':scheme', b'https'), (b':path', b'/translate_a/l?client=chrome&hl=en&key=AIzaSyBOti4mM-6x9WDnZIjIeyEU21OpBXqWBgw'), (b'user-agent', b'Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/65.0.3325.162 Safari/537.36'), (b'accept-encoding', b'gzip, deflate, br')]>
::1:60464: HTTP2 Event from client
  -> <StreamEnded stream_id:1>
::1:60464: HTTP2 Event from client
  -> <PriorityUpdated stream_id:1, weight:147, depends_on:0, exclusive:True>
::1:60464: HTTP/2 PRIORITY frame surpressed. Use --http2-priority to enable forwarding.
::1:60464: HTTP2 Event from server
  -> <RemoteSettingsChanged changed_settings:{ChangedSetting(setting=SettingCodes.MAX_CONCURRENT_STREAMS, original_value=None, new_value=100), ChangedSetting(setting=SettingCodes.INITIAL_WINDOW_SIZE, original_value=65535, new_value=1048576), ChangedSetting(setting=SettingCodes.MAX_HEADER_LIST_SIZE, original_value=None, new_value=16384)}>
::1:60464: HTTP2 Event from server
  -> <WindowUpdated stream_id:0, delta:983041>
::1:60464: HTTP2 Event from client
  -> <SettingsAcknowledged changed_settings:{ChangedSetting(setting=SettingCodes.INITIAL_WINDOW_SIZE, original_value=65535, new_value=1048576), ChangedSetting(setting=SettingCodes.MAX_CONCURRENT_STREAMS, original_value=100, new_value=100), ChangedSetting(setting=SettingCodes.MAX_HEADER_LIST_SIZE, original_value=65536, new_value=16384)}>
::1:60464: HTTP2 Event from server
  -> <SettingsAcknowledged changed_settings:{ChangedSetting(setting=SettingCodes.HEADER_TABLE_SIZE, original_value=4096, new_value=65536), ChangedSetting(setting=SettingCodes.INITIAL_WINDOW_SIZE, original_value=65535, new_value=6291456), ChangedSetting(setting=SettingCodes.MAX_CONCURRENT_STREAMS, original_value=100, new_value=1000)}>
::1:60464: HTTP2 Event from server
  -> <SettingsAcknowledged changed_settings:{}>
::1:60464: HTTP2 Event from client
  -> <SettingsAcknowledged changed_settings:{}>
::1:60464: request
  -> Request(GET translate.googleapis.com:443/translate_a/l?client=chrome&hl=en&key=AIzaSyBOti4mM-6x9WDnZIjIeyEU21OpBXqWBgw)
::1:60464: HTTP/2 PRIORITY information in HEADERS frame surpressed. Use --http2-priority to enable forwarding.
::1:60464: HTTP2 Event from server
  -> <ResponseReceived stream_id:1, headers:[(b':status', b'200'), (b'date', b'Tue, 20 Mar 2018 05:33:04 GMT'), (b'expires', b'Tue, 20 Mar 2018 05:33:04 GMT'), (b'cache-control', b'private, max-age=86400'), (b'content-type', b'application/json; charset=UTF-8'), (b'content-language', b'en'), (b'x-content-type-options', b'nosniff'), (b'content-disposition', b'attachment; filename="f.txt"'), (b'content-encoding', b'gzip'), (b'server', b'HTTP server (unknown)'), (b'content-length', b'880'), (b'x-xss-protection', b'1; mode=block'), (b'alt-svc', b'hq=":443"; ma=2592000; quic=51303431; quic=51303339; quic=51303335,quic=":443"; ma=2592000; v="41,39,35"')]>
::1:60464: HTTP2 Event from server
  -> <DataReceived stream_id:1, flow_controlled_length:886, data:1f8b08000000000002ffed95db72db3610865f45>
::1:60464: HTTP2 Event from server
  -> <DataReceived stream_id:1, flow_controlled_length:49, data:>
::1:60464: HTTP2 Event from server
  -> <StreamEnded stream_id:1>
::1:60464: response
  -> Response(200 , application/json; charset=UTF-8, 880b)
[::1]:60464: GET https://translate.googleapis.com/translate_a/l?client=chrome&hl=en&key=AIzaSyBOti4mM-6x9WDnZIjIeyEU21OpBXqWBgw HTTP/2.0
    :authority: translate.googleapis.com
    user-agent: Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/65.0.3325.162 Safari/537.36
    accept-encoding: gzip, deflate, br
 << 200  880b
    date: Tue, 20 Mar 2018 05:33:04 GMT
    expires: Tue, 20 Mar 2018 05:33:04 GMT
    cache-control: private, max-age=86400
    content-type: application/json; charset=UTF-8
    content-language: en
    x-content-type-options: nosniff
    content-disposition: attachment; filename="f.txt"
    content-encoding: gzip
    server: HTTP server (unknown)
    content-length: 880
    x-xss-protection: 1; mode=block
    alt-svc: hq=":443"; ma=2592000; quic=51303431; quic=51303339; quic=51303335,quic=":443"; ma=2592000; v="41,39,35"
I run mitmdump with:
mitmdump -v > log.log &
and then follow with:
google-chrome --proxy-server=localhost:8080 --ignore-certificate-errors --incognito https://github.com
I have a more complex docker container in production, but the above is enough to reproduce the error. Trusting the CA certificate enables me to drop the --ignore-certificate-errors flag but does not remove the problem.
System information
mitmdump --version
Mitmproxy: 3.0.3
Python:    3.6.3
OpenSSL:   OpenSSL 1.1.0g  2 Nov 2017
Platform:  Linux-4.13.0-37-generic-x86_64-with-debian-stretch-sid
In case it will help...
Massive Log
https://gist.github.com/mhils/05ec80e1f60e4525cbfdb3e61011e074
(edit by @mhils: happy to delete this at anytime, just moved it out of here to reduce length)
1