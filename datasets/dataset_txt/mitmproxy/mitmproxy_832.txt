ajxchapman commented on 14 Dec 2016
mitmproxy and mitmdump error with Errno 22 (EINVAL) when proxying connections if bound to the loopback address (127.0.0.1).
Steps to reproduce the problem:
Using mitmdump bound to 127.0.0.1
# mitmdump -b 127.0.0.1 -p 8000
Proxy server listening at http://127.0.0.1:8000
127.0.0.1:33764: clientconnect
127.0.0.1:33764: GET http://www.example.com/
 << Server connection to www.example.com:80 failed: Error connecting to "www.example.com": [Errno 22] Invalid argument
127.0.0.1:33764: clientdisconnect
Connecting with wget
# http_proxy=http://127.0.0.1:8000 wget http://www.example.com
--2016-12-14 08:29:09--  http://www.example.com/
Connecting to 127.0.0.1:8000... connected.
Proxy request sent, awaiting response... 502 Bad Gateway
2016-12-14 08:29:10 ERROR 502: Bad Gateway.
However, if you bind to 0.0.0.0 or a specific interface IP address it works as expected:
# mitmdump -b 0.0.0.0 -p 8000
Proxy server listening at http://0.0.0.0:8000
127.0.0.1:33766: clientconnect
127.0.0.1:33766: GET http://www.example.com/
              << 200 OK 1k
127.0.0.1:33766: clientdisconnect
# http_proxy=http://127.0.0.1:8000 wget http://www.example.com
--2016-12-14 08:31:36--  http://www.example.com/
Connecting to 127.0.0.1:8000... connected.
Proxy request sent, awaiting response... 200 OK
Length: 1270 (1.2K) [text/html]
Saving to: ‘index.html.5’

index.html.5                            100%[============================================================================>]   1.24K  --.-KB/s    in 0.001s

2016-12-14 08:31:37 (2.32 MB/s) - ‘index.html.5’ saved [1270/1270]
System information
Mitmproxy version: 0.18.2
Python version: 2.7.12
Platform: Linux-4.4.0-53-generic-x86_64-with-Ubuntu-16.04-xenial
SSL version: OpenSSL 1.0.2g 1 Mar 2016
Linux distro: Ubuntu 16.04 xenial