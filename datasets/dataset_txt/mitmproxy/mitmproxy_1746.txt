masrud commented on 14 Nov 2013
Hi there,
I'm using mitmproxy to rewrite javascript code of Gmail before being loaded into browser.
I'm running the following command: ./mitmproxy -s rewrite_js.py
The code for rewrite_js.py is as follows:

import subprocess
import jsbeautifier
def response(context, flow):
global GLOBAL_COUNTER
data = flow.response.getDecodedContent()
print ('HERE --- data= %s' % data)
if (data.find('function') >= 0 and
data.find('return') >= 0 and
data.find('var ') >= 0 and
data.find('!DOCTYPE html') < 0 and
data.find('<script') < 0):
res = jsbeautifier.beautify(data)
flow.response.replaceContentNewOne(res)
Also, I added this simple functions to flow.py:

def replaceContentNewOne(self, newData):
with decoded(self):
self.content = str(newData)
The problem is that Gmail stops loading the modified JS file to the browser and sends multiple request for the file, which are not successful. The file is just beautified. This seems to work for other pages such as facebook.
In addition, simple changes in Gmail shows no issue. For example, if I replace rewrite_js.py with the following

def response(context, flow):
flow.response.replaceContent('var ', 'var                          ')
The file will be loaded and there will be no problem.
Any help regarding this issue will be appreciated.