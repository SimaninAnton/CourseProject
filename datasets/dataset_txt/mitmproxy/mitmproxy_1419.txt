justincy commented on 13 Jun 2015
The docs are pretty good but they don't point out that setting up a transparent proxy on the same machine where the traffic originates is a bit different as noted here. More specifically, the iptables commands are different.
sudo iptables -t nat -A OUTPUT -p tcp -m owner ! --uid-owner root --dport 443 -j REDIRECT --to-port 8080
sudo iptables -t nat -A OUTPUT -p tcp -m owner ! --uid-owner root --dport 80 -j REDIRECT --to-port 8080
You have to run mitmproxy as a different user than the traffic you're trying to capture, otherwise that won't work. If you didn't have an expection for mitmproxy traffic then you'd end up with a loop (I ran out of open file descriptors when I did that). I'm not familiar enough with iptables to know whether there's any other match expression that could be used other than the process owner.
6