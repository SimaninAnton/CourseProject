bebef1987 commented on 12 Jun 2019
Steps to reproduce the problem:
Start mitmdump in record mode mitmdump-linux --set save_stream_file=websocket.mp
In browser open http://websocket.org/echo.html
Click Connect and Send message
Close proxy
Start mitmdump in replay mode mitmdump-linux --set server_replay=websocket.mp
In browser open http://websocket.org/echo.html
Click Connect and Send message
Check output
first we get addon error:
mitmdump-linux --set server_replay=/home/florinstrugariu/mozilla/raptor-studio/record/websocket.mp
Addon error: Traceback (most recent call last):
  File "mitmproxy/addons/serverplayback.py", line 174, in configure
  File "mitmproxy/command.py", line 275, in wrapper
  File "mitmproxy/addons/serverplayback.py", line 79, in load_flows
AttributeError: 'WebSocketFlow' object has no attribute 'response'
and when we click connect in replay mode we get
127.0.0.1:40402: GET http://websocket.org/img/favicon.ico
[replay]               << 200 OK 3.55k
127.0.0.1:40480: clientconnect
127.0.0.1:40480: GET http://echo.websocket.org/?encoding=text
[replay]               << 101 Web Socket Protocol Handshake 0b
WebSocket connection closed by client: 1000 (message missing), unknown status code
Traceback (most recent call last):
  File "mitmproxy/proxy/server.py", line 121, in handle
  File "mitmproxy/proxy/modes/http_proxy.py", line 9, in __call__
  File "mitmproxy/proxy/protocol/tls.py", line 286, in __call__
  File "mitmproxy/proxy/protocol/http1.py", line 83, in __call__
  File "mitmproxy/proxy/protocol/http.py", line 188, in __call__
  File "mitmproxy/proxy/protocol/http.py", line 260, in _process_flow
  File "mitmproxy/proxy/protocol/http.py", line 206, in handle_regular_connect
  File "mitmproxy/proxy/protocol/http1.py", line 83, in __call__
  File "mitmproxy/proxy/protocol/http.py", line 188, in __call__
  File "mitmproxy/proxy/protocol/http.py", line 447, in _process_flow
  File "mitmproxy/proxy/protocol/websocket.py", line 193, in __call__
  File "mitmproxy/net/tcp.py", line 227, in ssl_read_select
TypeError: argument must be an int, or have a fileno() method.

mitmproxy has crashed!
Please lodge a bug report at: https://github.com/mitmproxy/mitmproxy
127.0.0.1:40480: Traceback (most recent call last):
  File "mitmproxy/proxy/server.py", line 121, in handle
  File "mitmproxy/proxy/modes/http_proxy.py", line 9, in __call__
  File "mitmproxy/proxy/protocol/tls.py", line 286, in __call__
  File "mitmproxy/proxy/protocol/http1.py", line 83, in __call__
  File "mitmproxy/proxy/protocol/http.py", line 188, in __call__
  File "mitmproxy/proxy/protocol/http.py", line 260, in _process_flow
  File "mitmproxy/proxy/protocol/http.py", line 206, in handle_regular_connect
  File "mitmproxy/proxy/protocol/http1.py", line 83, in __call__
  File "mitmproxy/proxy/protocol/http.py", line 188, in __call__
  File "mitmproxy/proxy/protocol/http.py", line 447, in _process_flow
  File "mitmproxy/proxy/protocol/websocket.py", line 193, in __call__
  File "mitmproxy/net/tcp.py", line 227, in ssl_read_select
TypeError: argument must be an int, or have a fileno() method.

127.0.0.1:40480: clientdisconnect
Any other comments? What have you tried so far?
System information
Mitmproxy: 4.0.4 binary
Python: 3.6.3
OpenSSL: OpenSSL 1.1.0h 27 Mar 2018
Platform: Linux-4.15.0-50-generic-x86_64-with-debian-buster-sid