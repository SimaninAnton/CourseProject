Member
tomchristie commented on 11 Feb 2015
When using a custom auth scheme, if contrib.sessions is not installed then an error will be raised when calling client.force_authentication(None).
This is caused by the client additionally calling the superclass .logout. We could guard against this by only performing this behavior if contrib.sessions is in the installed apps, or by catching the OperationalError.
Traceback (most recent call last):
  File ".../test_auth.py", line 1267, in test_get_download_url
    self.client.force_authenticate(user=None, token=None)
  File ".../rest_framework/test.py", line 152, in force_authenticate
    self.logout()  # Also clear any possible session info if required
  File ".../rest_framework/test.py", line 161, in logout
    return super(APIClient, self).logout()
  File ".../django/test/client.py", line 599, in logout
    logout(request)
  File ".../django/contrib/auth/__init__.py", line 121, in logout
    request.session.flush()
  File ".../django/contrib/sessions/backends/base.py", line 271, in flush
    self.create()
  File ".../django/contrib/sessions/backends/db.py", line 37, in create
    self._session_key = self._get_new_session_key()
  File ".../django/contrib/sessions/backends/base.py", line 149, in _get_new_session_key
    if not self.exists(session_key):
  File ".../django/contrib/sessions/backends/db.py", line 33, in exists
    return Session.objects.filter(session_key=session_key).exists()
  File ".../django/db/models/query.py", line 606, in exists
    return self.query.has_results(using=self.db)
  File ".../django/db/models/sql/query.py", line 445, in has_results
    return compiler.has_results()
  File ".../django/db/models/sql/compiler.py", line 757, in has_results
    return bool(self.execute_sql(SINGLE))
  File ".../django/db/models/sql/compiler.py", line 786, in execute_sql
    cursor.execute(sql, params)
  File ".../django/db/backends/utils.py", line 65, in execute
    return self.cursor.execute(sql, params)
  File ".../django/db/utils.py", line 94, in __exit__
    six.reraise(dj_exc_type, dj_exc_value, traceback)
  File ".../django/db/backends/utils.py", line 65, in execute
    return .../django/db/backends/sqlite3/base.py", line 485, in execute
  File ".../django/db/backends/sqlite3/base.py", line 485, in execute
    return Database.Cursor.execute(self, query, params)
OperationalError: no such table: django_session