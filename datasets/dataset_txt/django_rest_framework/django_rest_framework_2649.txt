jmbarbier commented on 16 Dec 2013
Summary : on a system where django_oauth2_provider is available but not in settings.INSTALLED_APPS, provider.oauth2.models is called from compat.py during authtoken models init causing false reverse relation to be added to django user model...
Steps to reproduce :
virtualenv venv
source venv/bin/activate
pip install Django djangorestframework django-oauth2-provider
django-admin.py startproject bug
cd bug
# EDIT  bug/settings.py
# ADD  'rest_framework', 'rest_framework.authtoken' to INSTALLED_APPS
python manage.py syncdb --noinput
python manage.py shell
>>> from django.contrib.auth.models import User
>>> me = User.objects.create(username="me")
>>> me.delete()
>>> me.delete()
Traceback (most recent call last):
  File "<console>", line 1, in <module>
  File "/data/homes/jmbarbier/frtest/venv/local/lib/python2.7/site-packages/django/db/models/base.py", line 694, in delete
    collector.collect([self])
  File "/data/homes/jmbarbier/frtest/venv/local/lib/python2.7/site-packages/django/db/models/deletion.py", line 196, in collect
    elif sub_objs:
  File "/data/homes/jmbarbier/frtest/venv/local/lib/python2.7/site-packages/django/db/models/query.py", line 100, in __nonzero__
    self._fetch_all()
  File "/data/homes/jmbarbier/frtest/venv/local/lib/python2.7/site-packages/django/db/models/query.py", line 854, in _fetch_all
    self._result_cache = list(self.iterator())
  File "/data/homes/jmbarbier/frtest/venv/local/lib/python2.7/site-packages/django/db/models/query.py", line 220, in iterator
    for row in compiler.results_iter():
  File "/data/homes/jmbarbier/frtest/venv/local/lib/python2.7/site-packages/django/db/models/sql/compiler.py", line 710, in results_iter
    for rows in self.execute_sql(MULTI):
  File "/data/homes/jmbarbier/frtest/venv/local/lib/python2.7/site-packages/django/db/models/sql/compiler.py", line 781, in execute_sql
    cursor.execute(sql, params)
  File "/data/homes/jmbarbier/frtest/venv/local/lib/python2.7/site-packages/django/db/backends/util.py", line 69, in execute
    return super(CursorDebugWrapper, self).execute(sql, params)
  File "/data/homes/jmbarbier/frtest/venv/local/lib/python2.7/site-packages/django/db/backends/util.py", line 53, in execute
    return self.cursor.execute(sql, params)
  File "/data/homes/jmbarbier/frtest/venv/local/lib/python2.7/site-packages/django/db/utils.py", line 99, in __exit__
    six.reraise(dj_exc_type, dj_exc_value, traceback)
  File "/data/homes/jmbarbier/frtest/venv/local/lib/python2.7/site-packages/django/db/backends/util.py", line 53, in execute
    return self.cursor.execute(sql, params)
  File "/data/homes/jmbarbier/frtest/venv/local/lib/python2.7/site-packages/django/db/backends/sqlite3/base.py", line 450, in execute
    return Database.Cursor.execute(self, query, params)
OperationalError: no such table: oauth2_client
Adding a small traceback.print_stack() at the top of provider/oauth2/models.py shows that oauth2/models.py is called from authtoken models while importing compat.py
(venv)jmbarbier@rominet:/data/homes/jmbarbier/frtest/bug$ python manage.py runserver
Validating models...

  File "/data/homes/jmbarbier/frtest/venv/local/lib/python2.7/site-packages/django/utils/autoreload.py", line 93, in wrapper
    fn(*args, **kwargs)
  File "/data/homes/jmbarbier/frtest/venv/local/lib/python2.7/site-packages/django/core/management/commands/runserver.py", line 101, in inner_run
    self.validate(display_num_errors=True)
  File "/data/homes/jmbarbier/frtest/venv/local/lib/python2.7/site-packages/django/core/management/base.py", line 310, in validate
    num_errors = get_validation_errors(s, app)
  File "/data/homes/jmbarbier/frtest/venv/local/lib/python2.7/site-packages/django/core/management/validation.py", line 34, in get_validation_errors
    for (app_name, error) in get_app_errors().items():
  File "/data/homes/jmbarbier/frtest/venv/local/lib/python2.7/site-packages/django/db/models/loading.py", line 196, in get_app_errors
    self._populate()
  File "/data/homes/jmbarbier/frtest/venv/local/lib/python2.7/site-packages/django/db/models/loading.py", line 75, in _populate
    self.load_app(app_name, True)
  File "/data/homes/jmbarbier/frtest/venv/local/lib/python2.7/site-packages/django/db/models/loading.py", line 99, in load_app
    models = import_module('%s.models' % app_name)
  File "/data/homes/jmbarbier/frtest/venv/local/lib/python2.7/site-packages/django/utils/importlib.py", line 40, in import_module
    __import__(name)
  File "/data/homes/jmbarbier/frtest/venv/local/lib/python2.7/site-packages/rest_framework/authtoken/models.py", line 4, in <module>
    from rest_framework.compat import AUTH_USER_MODEL
  File "/data/homes/jmbarbier/frtest/venv/local/lib/python2.7/site-packages/rest_framework/compat.py", line 539, in <module>
    from provider.oauth2 import models as oauth2_provider_models
  File "/data/homes/jmbarbier/frtest/venv/local/lib/python2.7/site-packages/provider/oauth2/models.py", line 7, in <module>
    traceback.print_stack()
0 errors found
December 16, 2013 - 00:21:54
Workaround : do not install / uninstall django_oauth2_provider if you don't use it..