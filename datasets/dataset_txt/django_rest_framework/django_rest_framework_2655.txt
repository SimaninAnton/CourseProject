JoseTomasTocino commented on 12 Dec 2013
If the rest_framework.authtoken app is installed, South's convert_to_south command fails with:
ImproperlyConfigured: AUTH_USER_MODEL refers to model 'auth.User' that has not been installed
This happened while trying to use south in an existing project.
Steps to reproduce:
Build project
pip install django south djangorestframework
django-admin.py startproject test_project
cd test_project
django-admin.py startapp
Add test_app, rest_framework and rest_framework.authtoken to INSTALLED_APPS:
INSTALLED_APPS = (
    'django.contrib.admin',
    'django.contrib.auth',
    'django.contrib.contenttypes',
    'django.contrib.sessions',
    'django.contrib.messages',
    'django.contrib.staticfiles',
    'test_app',
    'rest_framework',
    'rest_framework.authtoken'
)
Add some basic models to test_app/models.py:
from django.db import models
from django.contrib.auth.models import User

class BaseModel(models.Model):
    owner = models.ForeignKey(User, null=True)
    title = models.TextField()

    class Meta:
        abstract = True

class ConcreteModel1(BaseModel):
    some_field = models.TextField()

class ConcreteModel2(BaseModel):
    some_other_field = models.TextField()
Initial syncdb. No south yet, because this happened in an existing project:
python manage.py syncdb
Add south to INSTALLED_APPS then syncdb again to create south's tables.
Convert project to south using:
python manage.py convert_to_south test_app
That's where it fails, this is the message:
Creating migrations directory at '/home/jose/test/test_project/test_app/migrations'...
Creating __init__.py in '/home/jose/test/test_project/test_app/migrations'...
 + Added model test_app.ConcreteModel1
 + Added model test_app.ConcreteModel2
Created 0001_initial.py. You can now apply this migration with: ./manage.py migrate test_app
Traceback (most recent call last):
  File "manage.py", line 10, in <module>
    execute_from_command_line(sys.argv)
  File "/home/jose/.virtualenvs/pfc/local/lib/python2.7/site-packages/django/core/management/__init__.py", line 399, in execute_from_command_line
    utility.execute()
  File "/home/jose/.virtualenvs/pfc/local/lib/python2.7/site-packages/django/core/management/__init__.py", line 392, in execute
    self.fetch_command(subcommand).run_from_argv(self.argv)
  File "/home/jose/.virtualenvs/pfc/local/lib/python2.7/site-packages/django/core/management/base.py", line 242, in run_from_argv
    self.execute(*args, **options.__dict__)
  File "/home/jose/.virtualenvs/pfc/local/lib/python2.7/site-packages/django/core/management/base.py", line 285, in execute
    output = self.handle(*args, **options)
  File "/home/jose/.virtualenvs/pfc/local/lib/python2.7/site-packages/south/management/commands/convert_to_south.py", line 89, in handle
    delete_ghosts=options.get("delete_ghosts", False),
  File "/home/jose/.virtualenvs/pfc/local/lib/python2.7/site-packages/django/core/management/__init__.py", line 159, in call_command
    return klass.execute(*args, **defaults)
  File "/home/jose/.virtualenvs/pfc/local/lib/python2.7/site-packages/django/core/management/base.py", line 285, in execute
    output = self.handle(*args, **options)
  File "/home/jose/.virtualenvs/pfc/local/lib/python2.7/site-packages/south/management/commands/migrate.py", line 111, in handle
    ignore_ghosts = ignore_ghosts,
  File "/home/jose/.virtualenvs/pfc/local/lib/python2.7/site-packages/south/migration/__init__.py", line 173, in migrate_app
    Migrations.calculate_dependencies()
  File "/home/jose/.virtualenvs/pfc/local/lib/python2.7/site-packages/south/migration/base.py", line 229, in calculate_dependencies
    migration.calculate_dependencies()
  File "/home/jose/.virtualenvs/pfc/local/lib/python2.7/site-packages/south/migration/base.py", line 363, in calculate_dependencies
    for migration in self._get_dependency_objects("depends_on"):
  File "/home/jose/.virtualenvs/pfc/local/lib/python2.7/site-packages/south/migration/base.py", line 343, in _get_dependency_objects
    for app, name in getattr(self.migration_class(), attrname, []):
  File "/home/jose/.virtualenvs/pfc/local/lib/python2.7/site-packages/south/migration/base.py", line 315, in migration_class
    return self.migration().Migration
  File "/home/jose/.virtualenvs/pfc/local/lib/python2.7/site-packages/south/utils/__init__.py", line 62, in method
    value = function(self)
  File "/home/jose/.virtualenvs/pfc/local/lib/python2.7/site-packages/south/migration/base.py", line 306, in migration
    raise exceptions.BrokenMigration(self, sys.exc_info())
south.exceptions.BrokenMigration: While loading migration 'authtoken:0001_initial':
Traceback (most recent call last):
  File "/home/jose/.virtualenvs/pfc/local/lib/python2.7/site-packages/south/migration/base.py", line 302, in migration
    migration = __import__(full_name, {}, {}, ['Migration'])
  File "/home/jose/.virtualenvs/pfc/local/lib/python2.7/site-packages/rest_framework/authtoken/migrations/0001_initial.py", line 15, in <module>
    User = get_user_model()
  File "/home/jose/.virtualenvs/pfc/local/lib/python2.7/site-packages/django/contrib/auth/__init__.py", line 122, in get_user_model
    raise ImproperlyConfigured("AUTH_USER_MODEL refers to model '%s' that has not been installed" % settings.AUTH_USER_MODEL)
ImproperlyConfigured: AUTH_USER_MODEL refers to model 'auth.User' that has not been installed
At first I didn't know whether to post this here or on South's bugtracker, but the thing is that if you remove rest_framework.authtoken from INSTALLED_APPS the error dissappears.