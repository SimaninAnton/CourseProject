holandes22 commented on 10 Sep 2014
Hi,
I have a custom user model defined as such:
class User(AbstractBaseUser, PermissionsMixin):                                                                                                                                                                    

    email = models.EmailField(primary_key=True)                                                                                                                                                                    
    full_name = models.CharField(max_length=200, default='')                                                                                                                                                       
    is_admin = models.BooleanField(default=False)                                                                                                                                                                  

    objects = UserManager()                                                                                                                                                                                        

    USERNAME_FIELD = 'email' 
When running the migrations, first I encountered an issue where it was failing since there is no id field (the pk is the email in this case)
Just to make it run I added an id field: id = models.EmailField(), this took care of that issue, but then failed with this error:
django.db.utils.ProgrammingError: there is no unique constraint matching given keys for referenced table "users_user"
Looking at the migration, I see this line
('user', models.OneToOneField(to=settings.AUTH_USER_MODEL, to_field='id')),
which fails since it is using "id" as the unique field, changing this to "email" solves this in my case.
I think that to solve this in a generic way, maybe the to_field in that migration line should be changed to USERNAME_FIELD, but not sure how to
get to this value from settings.AUTH_USER_MODEL