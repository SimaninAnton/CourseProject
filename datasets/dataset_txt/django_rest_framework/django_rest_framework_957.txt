fabien-michel commented on 30 Nov 2016 â€¢
edited
Checklist
I have verified that that issue exists against the master branch of Django REST framework.
I have searched for similar issues in both open and closed tickets and cannot find a duplicate.
This is not a usage question. (Those should be directed to the discussion group instead.)
This cannot be dealt with as a third party library. (We prefer new functionality to be in the form of third party libraries where possible.)
I have reduced the issue to the simplest possible case.
I have included a failing test as a pull request. (If you are unable to do so we can still accept the issue.)
Steps to reproduce
A ModelViewSet using DjangoModelPermissions or DjangoObjectPermissions permission class.
This model must override get_queryset method which must use self.request.user.something
DO NOT authenticate any user
Do a GET request on the ViewSet
Expected behavior
Check that the user is authenticated and has the permission to GET on the ViewSet
Actual behavior
Raise an AttributeError: 'AnonymousUser' object has no attribute 'something'
The problem is in DjangoModelPermissions.has_permission method
This method call the get_queryset method of the view if defined in order to fetch the model.
However as the user isn't authenticated, in the get_queryset method, self.request.user if an AnonymousUser object which don't implement "something" attribute
I think the has_permission method should check for user authentication before calling the get_queryset method.