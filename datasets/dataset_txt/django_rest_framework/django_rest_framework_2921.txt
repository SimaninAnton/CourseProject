Contributor
fernandogrd commented on 9 Feb 2013
When trying to retrieve a item from cache I get a attribute error, as follow, if using MemcachedCache backend. It works fine with pylibmc and file based cache. The same error occur with third party ultramemcached [0]
How to reproduce:
>>> from django.core.cache import cache
>>> from rest_framework.serializers import SortedDictWithMetadata
>>> cache.set(1, SortedDictWithMetadata({1:1}), 9999)
>>> cache.get(1)
Traceback:
Traceback (most recent call last):
  File "<console>", line 1, in <module>
  File "/home/fernandogrd/.virtualenvs/th/local/lib/python2.7/site-packages/django/utils/datastructures.py", line 249, in __repr__
    return '{%s}' % ', '.join(['%r: %r' % (k, v) for k, v in six.iteritems(self)])
  File "/home/fernandogrd/.virtualenvs/th/local/lib/python2.7/site-packages/django/utils/datastructures.py", line 176, in _iteritems
    for key in self.keyOrder:
AttributeError: 'SortedDictWithMetadata' object has no attribute 'keyOrder'
I've tested against today master: fd57978
Django==1.5c1
python-memcached==1.48
Python2.6 and 2.7
This affected me by trying to cache from an ModelSerializer, but I couldn't find a pattern with ModelSerializer. It happens with Centos + python 2.6 and 2.7 but not with python 2.7 on ubuntu . But I think if the core thing is solved, the others will be too. The above code fails on every combinations I tested.
By removing getstate [1] method from DictWithMetadata seems to solve it. So, the problem can be probably with it, but I didn't succeed to fix it.
[0] https://github.com/nicholasserra/django-ultramemcached-cache
[1] https://github.com/tomchristie/django-rest-framework/blob/master/rest_framework/serializers.py#L28