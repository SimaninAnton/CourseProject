prinsherbert commented on Jul 3, 2015
I'm not sure if this is related to
valueerror: Buffer dtype mismatch, expected 'int' but got 'long'
as described in #3307, #3235 and #4591. Nevertheless, my use case is significantly different.
I noticed that specifying a dtype in the TfidfVectorizer constructor, the fit fails:
from sklearn.feature_extraction.text import TfidfVectorizer
import numpy
model = TfidfVectorizer(dtype=numpy.float16)
model.fit(['foo', 'bar', 'yes', 'no go', 'move forward'])
This results in:
---------------------------------------------------------------------------
TypeError                                 Traceback (most recent call last)
<ipython-input-2-2373277846dd> in <module>()
      2 import numpy
      3 model = TfidfVectorizer(dtype=numpy.float16)
----> 4 model.fit(['foo', 'bar', 'yes', 'no go', 'move forward'])

/home/herbert.kruitbosch/venv3/lib/python3.4/site-packages/sklearn/feature_extraction/text.py in fit(self, raw_documents, y)
   1263         self : TfidfVectorizer
   1264         """
-> 1265         X = super(TfidfVectorizer, self).fit_transform(raw_documents)
   1266         self._tfidf.fit(X)
   1267         return self

/home/herbert.kruitbosch/venv3/lib/python3.4/site-packages/sklearn/feature_extraction/text.py in fit_transform(self, raw_documents, y)
    802 
    803         vocabulary, X = self._count_vocab(raw_documents,
--> 804                                           self.fixed_vocabulary_)
    805 
    806         if self.binary:

/home/herbert.kruitbosch/venv3/lib/python3.4/site-packages/sklearn/feature_extraction/text.py in _count_vocab(self, raw_documents, fixed_vocab)
    759                           shape=(len(indptr) - 1, len(vocabulary)),
    760                           dtype=self.dtype)
--> 761         X.sum_duplicates()
    762         return vocabulary, X
    763 

/usr/lib/python3/dist-packages/scipy/sparse/compressed.py in sum_duplicates(self)
    814         fn = sparsetools.csr_sum_duplicates
    815         M,N = self._swap(self.shape)
--> 816         fn(M, N, self.indptr, self.indices, self.data)
    817 
    818         self.prune()  # nnz may have changed

/usr/lib/python3/dist-packages/scipy/sparse/sparsetools/csr.py in csr_sum_duplicates(*args)
    642     csr_sum_duplicates(int const n_row, int const n_col, int [] Ap, int [] Aj, npy_clongdouble_wrapper [] Ax)
    643     """
--> 644   return _csr.csr_sum_duplicates(*args)
    645 
    646 def get_csr_submatrix(*args):

TypeError: Array of type 'float' required.  Array of type 'char' given
The documentation clearly states that dtype only affects the return type of fit (and transform):
dtype : type, optional
    Type of the matrix returned by fit_transform() or transform().
FYI:
In [7]: scipy.__version__
Out[7]: '0.13.3'
In [8]: sklearn.__version__
Out[8]: '0.16.1'
In [9]: numpy.__version__
Out[9]: '1.9.2'