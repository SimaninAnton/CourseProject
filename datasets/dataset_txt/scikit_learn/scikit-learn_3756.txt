Contributor
ngoix commented on Jun 23, 2015
The code:
In [1]: import joblib

In [2]: import os

In [3]: import numpy as np

In [4]: from gzip import GzipFile

In [5]: from io import BytesIO

In [6]: from urllib2 import urlopen

In [7]: from os.path import join

In [8]: from sklearn.datasets import get_data_home

In [9]: 

In [9]: URL10 = ('http://archive.ics.uci.edu/ml/'
   ...:          'machine-learning-databases/kddcup99-mld/kddcup.data_10_percent.gz')

In [10]: data_home = get_data_home()

In [11]: kddcup_dir = join(data_home, "test")

In [12]: samples_path = join(kddcup_dir, "samples")

In [13]: os.makedirs(kddcup_dir)

In [14]: f = BytesIO(urlopen(URL10).read())

In [15]: file = GzipFile(fileobj=f, mode='r')

In [16]: X = []

In [17]: for line in file.readlines():
   ....:         X.append(line.replace('\n', '').split(','))
   ....:     

In [18]: file.close()

In [19]: X = np.asarray(X, dtype=object)

In [20]: print X.shape
(494021, 42)

In [21]: print X
[['0' 'tcp' 'http' ..., '0.00' '0.00' 'normal.']
 ['0' 'tcp' 'http' ..., '0.00' '0.00' 'normal.']
 ['0' 'tcp' 'http' ..., '0.00' '0.00' 'normal.']
 ..., 
 ['0' 'tcp' 'http' ..., '0.00' '0.00' 'normal.']
 ['0' 'tcp' 'http' ..., '0.00' '0.00' 'normal.']
 ['0' 'tcp' 'http' ..., '0.00' '0.00' 'normal.']]

In [22]: joblib.dump(X, samples_path, compress=9)
Out[22]: 
['/home/nicolas/scikit_learn_data/test/samples',
 '/home/nicolas/scikit_learn_data/test/samples_01.npy.z']

In [23]: X = joblib.load(samples_path)
---------------------------------------------------------------------------
AssertionError                            Traceback (most recent call last)
<ipython-input-23-b2deef1a8c4e> in <module>()
----> 1 X = joblib.load(samples_path)

/usr/lib/python2.7/dist-packages/joblib/numpy_pickle.pyc in load(filename, mmap_mode)
    422 
    423         try:
--> 424             obj = unpickler.load()
    425         finally:
    426             if hasattr(unpickler, 'file_handle'):

/usr/lib/python2.7/pickle.pyc in load(self)
    856             while 1:
    857                 key = read(1)
--> 858                 dispatch[key](self)
    859         except _Stop, stopinst:
    860             return stopinst.value

/usr/lib/python2.7/dist-packages/joblib/numpy_pickle.pyc in load_build(self)
    288                         "but numpy didn't import correctly")
    289             nd_array_wrapper = self.stack.pop()
--> 290             array = nd_array_wrapper.read(self)
    291             self.stack.append(array)
    292 

/usr/lib/python2.7/dist-packages/joblib/numpy_pickle.pyc in read(self, unpickler)
    158         array = unpickler.np.core.multiarray._reconstruct(*self.init_args)
    159         with open(filename, 'rb') as f:
--> 160             data = read_zfile(f)
    161         state = self.state + (data,)
    162         array.__setstate__(state)

/usr/lib/python2.7/dist-packages/joblib/numpy_pickle.pyc in read_zfile(file_handle)
     69     assert len(data) == length, (
     70         "Incorrect data length while decompressing %s."
---> 71         "The file could be corrupted." % file_handle)
     72     return data
     73 

AssertionError: Incorrect data length while decompressing <open file '/home/nicolas/scikit_learn_data/test/samples_01.npy.z', mode 'rb' at 0x7efcea714930>.The file could be corrupted.
More precisely:
In [24]: Y = X[:300000,:]  # works

In [25]: joblib.dump(Y, samples_path, compress=9)
Out[25]: ['/home/nicolas/scikit_learn_data/test/samples']

In [26]: Y = joblib.load(samples_path)

In [27]: Y = X[:400000,:].astype(str)  #works

In [28]: joblib.dump(Y, samples_path, compress=9)
Out[28]: 
['/home/nicolas/scikit_learn_data/test/samples',
 '/home/nicolas/scikit_learn_data/test/samples_01.npy.z']

In [29]: Y = joblib.load(samples_path)

In [30]: Y = X[:400000,:]  # doesnt work

In [31]: joblib.dump(Y, samples_path, compress=9)
Out[31]: 
['/home/nicolas/scikit_learn_data/test/samples',
 '/home/nicolas/scikit_learn_data/test/samples_01.npy.z']

In [32]: Y = joblib.load(samples_path)
---------------------------------------------------------------------------
AssertionError                            Traceback (most recent call last)
<ipython-input-32-25fe17420f08> in <module>()
----> 1 Y = joblib.load(samples_path)

/usr/lib/python2.7/dist-packages/joblib/numpy_pickle.pyc in load(filename, mmap_mode)
    422 
    423         try:
--> 424             obj = unpickler.load()
    425         finally:
    426             if hasattr(unpickler, 'file_handle'):

/usr/lib/python2.7/pickle.pyc in load(self)
    856             while 1:
    857                 key = read(1)
--> 858                 dispatch[key](self)
    859         except _Stop, stopinst:
    860             return stopinst.value

/usr/lib/python2.7/dist-packages/joblib/numpy_pickle.pyc in load_build(self)
    288                         "but numpy didn't import correctly")
    289             nd_array_wrapper = self.stack.pop()
--> 290             array = nd_array_wrapper.read(self)
    291             self.stack.append(array)
    292 

/usr/lib/python2.7/dist-packages/joblib/numpy_pickle.pyc in read(self, unpickler)
    158         array = unpickler.np.core.multiarray._reconstruct(*self.init_args)
    159         with open(filename, 'rb') as f:
--> 160             data = read_zfile(f)
    161         state = self.state + (data,)
    162         array.__setstate__(state)

/usr/lib/python2.7/dist-packages/joblib/numpy_pickle.pyc in read_zfile(file_handle)
     69     assert len(data) == length, (
     70         "Incorrect data length while decompressing %s."
---> 71         "The file could be corrupted." % file_handle)
     72     return data
     73 

AssertionError: Incorrect data length while decompressing <open file '/home/nicolas/scikit_learn_data/test/samples_01.npy.z', mode 'rb' at 0x7efcea714db0>.The file could be corrupted.
Maybe I should put this issue on https://github.com/joblib/joblib/issues ?