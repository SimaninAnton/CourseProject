cynthia commented on Oct 18, 2019 â€¢
edited
Description
Precomputed distances are treated as "unsupported" by AgglomerativeClustering, regardless of the provenance. (e.g. sklearn.metrics.euclidean_distances)
This restriction makes it impossible to pass a off-memory (e.g. memory mapped) precomputed distance matrix, even if it is valid Euclidean distance.
Steps/Code to Reproduce
import numpy as np

from sklearn.metrics import euclidean_distances
from sklearn.cluster import AgglomerativeClustering

X = np.array([[1, 2], [1, 4], [1, 0],[4, 2], [4, 4], [4, 0]])
c = AgglomerativeClustering(affinity='precomputed')
c.fit(euclidean_distances(X))
Expected Results
This probably a bit complicated, as there is no reliable way to determine if the distance matrix actually contains Euclidean distances or is complete nonsense. As precomputed matrices are a somewhat advanced feature, simply relaxing the requirements and assuming users won't pass in invalid distances might be good enough, but that's a decision to be made by the maintainers.
If the matrix was generated from sklearn.metrics, it might be possible to mark a provenance hint somewhere in the object, while it does feel a bit hacky.
Actual Results
In [21]: c.fit(euclidean_distances(X))
---------------------------------------------------------------------------
ValueError                                Traceback (most recent call last)
<ipython-input-21-38e0d7bfcae1> in <module>
----> 1 c.fit(euclidean_distances(X))

~/anaconda3/lib/python3.7/site-packages/sklearn/cluster/hierarchical.py in fit(self, X, y)
    823             raise ValueError("%s was provided as affinity. Ward can only "
    824                              "work with euclidean distances." %
--> 825                              (self.affinity, ))
    826
    827         if self.linkage not in _TREE_BUILDERS:

ValueError: precomputed was provided as affinity. Ward can only work with euclidean distances.
Versions
System:
python: 3.7.3 (default, Mar 27 2019, 22:11:17) [GCC 7.3.0]
executable: /home/user/anaconda3/bin/python
machine: Linux-5.0.0-31-generic-x86_64-with-debian-buster-sid
Python deps:
pip: 19.1.1
setuptools: 41.4.0
sklearn: 0.21.3
numpy: 1.16.2
scipy: 1.2.1
Cython: 0.29.12
pandas: 0.24.2
This affects all platforms.