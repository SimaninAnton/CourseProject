Member
AlexanderFabisch commented on Apr 20, 2016
Description
AssertionError thrown when calling TSNE.fit on a specific subset of the MNIST data (reported on the mailing list)
Steps/Code to Reproduce
from sklearn.datasets import fetch_mldata
from sklearn.manifold import TSNE

mnist = fetch_mldata("mnist-original")
batch = mnist.data[47000:47500]
data = batch.reshape(batch.shape[0], -1)
tsne = TSNE(n_components=2, random_state=0, init='pca', verbose=0)
tsne.fit(data)
Expected Results
No error is thrown.
Actual Results
[t-SNE] Error: point (-5.793369751e+02) is above right edge of node (-5.793370361e+02)
[t-SNE] ERROR
---------------------------------------------------------------------------
AssertionError                            Traceback (most recent call last)
/home/dfki.uni-bremen.de/afabisch/tmp/tsne/test.py in <module>()
      7 data = batch.reshape(batch.shape[0], -1)
      8 tsne = TSNE(n_components=2, random_state=0, init='pca', verbose=0)
----> 9 tsne.fit(data)

/usr/local/lib/python2.7/dist-packages/sklearn/manifold/t_sne.pyc in fit(self, X, y)
    879             or 'coo'.
    880         """
--> 881         self.fit_transform(X)
    882         return self

/usr/local/lib/python2.7/dist-packages/sklearn/manifold/t_sne.pyc in fit_transform(self, X, y)
    864             Embedding of the training data in low-dimensional space.
    865         """
--> 866         embedding = self._fit(X)
    867         self.embedding_ = embedding
    868         return self.embedding_

/usr/local/lib/python2.7/dist-packages/sklearn/manifold/t_sne.pyc in _fit(self, X, skip_num_points)
    775                           X_embedded=X_embedded,
    776                           neighbors=neighbors_nn,
--> 777                           skip_num_points=skip_num_points)
    778 
    779     def _tsne(self, P, degrees_of_freedom, n_samples, random_state,

/usr/local/lib/python2.7/dist-packages/sklearn/manifold/t_sne.pyc in _tsne(self, P, degrees_of_freedom, n_samples, random_state, X_embedded, neighbors, skip_num_points)
    826         # Early exaggeration
    827         P *= self.early_exaggeration
--> 828         params, error, it = _gradient_descent(obj_func, params, **opt_args)
    829         opt_args['n_iter'] = 100
    830         opt_args['momentum'] = 0.8

/usr/local/lib/python2.7/dist-packages/sklearn/manifold/t_sne.pyc in _gradient_descent(objective, p0, it, n_iter, objective_error, n_iter_check, n_iter_without_progress, momentum, learning_rate, min_gain, min_grad_norm, min_error_diff, verbose, args, kwargs)
    384 
    385     for i in range(it, n_iter):
--> 386         new_error, grad = objective(p, *args, **kwargs)
    387         grad_norm = linalg.norm(grad)
    388 

/usr/local/lib/python2.7/dist-packages/sklearn/manifold/t_sne.pyc in _kl_divergence_bh(params, P, neighbors, degrees_of_freedom, n_samples, n_components, angle, skip_num_points, verbose)
    287     error = _barnes_hut_tsne.gradient(sP, X_embedded, neighbors,
    288                                       grad, angle, n_components, verbose,
--> 289                                       dof=degrees_of_freedom)
    290     c = 2.0 * (degrees_of_freedom + 1.0) / degrees_of_freedom
    291     grad = grad.ravel()

sklearn/manifold/_barnes_hut_tsne.pyx in sklearn.manifold._barnes_hut_tsne.gradient (sklearn/manifold/_barnes_hut_tsne.c:7142)()

AssertionError: [t-SNE] Insertion failed
Versions
In [10]: import platform; print(platform.platform())
Linux-3.13.0-85-generic-x86_64-with-Ubuntu-14.04-trusty

In [11]: import sys; print("Python", sys.version)
('Python', '2.7.6 (default, Jun 22 2015, 17:58:13) \n[GCC 4.8.2]')

In [12]: import numpy; print("NumPy", numpy.__version__)
('NumPy', '1.11.0')

In [13]: import scipy; print("SciPy", scipy.__version__)
('SciPy', '0.17.0')

In [14]: import sklearn; print("Scikit-Learn", sklearn.__version__)
('Scikit-Learn', '0.18.dev0')