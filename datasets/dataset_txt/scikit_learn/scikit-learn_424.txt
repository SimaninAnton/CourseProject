ammathis commented on Jul 6, 2019
Description
sklearn.inspection.plot_partial_dependence() fails when using a sklearn.tree.DecisionTreeRegressor as the estimator. The problem appears to be related to the presence of a classes_ attribute (with a value of None) on the estimator, despite it being a regressor and not a classifier. Deleting the classes_ attribute from the estimator allows plot_partial_dependence() to successfully run.
Steps/Code to Reproduce
from sklearn.inspection import plot_partial_dependence
from sklearn.tree import DecisionTreeRegressor
import numpy as np
X = np.array([[1.0, 2.0], [3.0, 4.0]])
y = np.array([[3.0], [7.0]])
learn = DecisionTreeRegressor().fit(X, y)
assert getattr(learn, 'classes_') is None
delete_classes_attribute = False
if delete_classes_attribute:
    # Deleting the 'classes_' attribute will allow plot_partial_dependence() to run
    delattr(learn, 'classes_')
plot_partial_dependence(learn, X, features=[0])
Expected Results
No error is thrown.
Actual Results
A TypeError is thrown:
Traceback (most recent call last):
  File "Partial Dependence Plot Bug Illustration.py", line 13, in <module>
    plot_partial_dependence(learn, X, features=[0])
  File "/anaconda3/envs/newsklearn/lib/python3.7/site-packages/sklearn/inspection/partial_dependence.py", line 561, in plot_partial_dependence
    for fxs in features)
  File "/anaconda3/envs/newsklearn/lib/python3.7/site-packages/joblib/parallel.py", line 921, in __call__
    if self.dispatch_one_batch(iterator):
  File "/anaconda3/envs/newsklearn/lib/python3.7/site-packages/joblib/parallel.py", line 759, in dispatch_one_batch
    self._dispatch(tasks)
  File "/anaconda3/envs/newsklearn/lib/python3.7/site-packages/joblib/parallel.py", line 716, in _dispatch
    job = self._backend.apply_async(batch, callback=cb)
  File "/anaconda3/envs/newsklearn/lib/python3.7/site-packages/joblib/_parallel_backends.py", line 182, in apply_async
    result = ImmediateResult(func)
  File "/anaconda3/envs/newsklearn/lib/python3.7/site-packages/joblib/_parallel_backends.py", line 549, in __init__
    self.results = batch()
  File "/anaconda3/envs/newsklearn/lib/python3.7/site-packages/joblib/parallel.py", line 225, in __call__
    for func, args, kwargs in self.items]
  File "/anaconda3/envs/newsklearn/lib/python3.7/site-packages/joblib/parallel.py", line 225, in <listcomp>
    for func, args, kwargs in self.items]
  File "/anaconda3/envs/newsklearn/lib/python3.7/site-packages/sklearn/inspection/partial_dependence.py", line 293, in partial_dependence
    isinstance(estimator.classes_[0], np.ndarray)):
TypeError: 'NoneType' object is not subscriptable
Versions
System:
    python: 3.7.3 (default, Mar 27 2019, 16:54:48)  [Clang 4.0.1 (tags/RELEASE_401/final)]
executable: /anaconda3/envs/newsklearn/bin/python
   machine: Darwin-18.5.0-x86_64-i386-64bit

BLAS:
    macros: SCIPY_MKL_H=None, HAVE_CBLAS=None
  lib_dirs: /anaconda3/envs/newsklearn/lib
cblas_libs: mkl_rt, pthread

Python deps:
       pip: 19.1.1
setuptools: 41.0.1
   sklearn: 0.21.2
     numpy: 1.16.4
     scipy: 1.2.1
    Cython: None
    pandas: 0.24.2
üëç 1