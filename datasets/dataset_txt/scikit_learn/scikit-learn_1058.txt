Contributor
tomMoral commented on Sep 26, 2018
Description
In python2.7, when forcing the joblib backend to use processes, it breaks KNeighborsMixin as the cython methods KDTree.query and BallTree.query are not picklable. This is due to the change in sklearn/neighbors/base.py which does not force the threading backend anymore. The backend should be forced to threading for python2.7 even with recent version of joblib.
Steps/Code to Reproduce
import numpy as np
from sklearn.externals.joblib import parallel_backend
from sklearn.neighbors import KNeighborsClassifier

with parallel_backend('multiprocessing'):
    nn = KNeighborsClassifier(2, n_jobs=2, algorithm="kd_tree")
    X = np.random.randn(50, 2)
    y = np.random.rand(50) > .5
    nn.fit(X, y).predict(X)
which outputs
PicklingError: Can't pickle <built-in method query of sklearn.neighbors.kd_tree.KDTree object at 0x55af02d21f40>: it's not found as __main__.query