nouiz commented on Nov 5, 2013
NumPy 1.6 introduced some new macro/inline fct and deprecated some other. Theano will very shortly use only the new API and define the macro NPY_NO_DEPRECATED_API=NPY_1_7_API_VERSION to have all the warning about using the old API removed.
This is needed as we compile 1000s of file and having the same warning 1000s of time is bad. User won't be able to see the warning they have that concern them.
There was a ticket about this: gh-1250
This ticket is about how Theano use only the new interface but stay compatible with older NumPy version. What we do is that if the version of NumPy is older then 1.7, we define those macro:
-D NPY_ARRAY_ENSURECOPY=NPY_ENSURECOPY
-D NPY_ARRAY_ALIGNED=NPY_ALIGNED
-D NPY_ARRAY_WRITEABLE=NPY_WRITEABLE
-D NPY_ARRAY_UPDATE_ALL=NPY_UPDATE_ALL
-D NPY_ARRAY_C_CONTIGUOUS=NPY_C_CONTIGUOUS
-D NPY_ARRAY_F_CONTIGUOUS=NPY_F_CONTIGUOUS
Another change is that the new API do not allow asignation to the BASE attribute of an ndarray. To do this, you must call a function. So we use this code for this:
if NPY_API_VERSION < 0x00000007
    PyArray_BASE(xview) = py_%(x)s;
else
    PyArray_SetBaseObject(xview, py_%(x)s);
endif
That way, it stay compatible with all version of NumPy.
The last change we needed, as that there is no way to modify the data ptr of an ndarray. The work around that we needed is to change our code such that we create the ndarray directly with the good data ptr. In the past, we created it with a temporary value, compute the one we want, and update it. Now we create the ndarray directly with the good data ptr. This was done in our subtensor code (a_ndarray[slice[,...]]) code.
Currently Theano have c code generated by cython. We modified manually this code to be compatible with the new NumPy API to don't generate error, as we disable the old NumPy interface.
Hoping that this will help you.