Contributor
oleksandr-pavlyk commented on May 29, 2019
Description
daal4py's estimator RandomForestRegressor, powered by Intel(R) DAAL fails check_fit_idempotent, see IntelPython/daal4py#102
The failure is small:
AssertionError:
Not equal to tolerance rtol=1e-07, atol=1e-09

Mismatch: 25%
Max absolute difference: 1.1920929e-07
Max relative difference: 3.2737175e-06
 x: array([ 0.504864,  0.239177, -0.960478, -0.204671,  0.731089,  0.262303,
       -0.675667, -0.779623,  0.362969, -2.344096,  0.38684 ,  0.104189,
       -0.363802, -0.199642, -0.482426,  0.326316,  0.003698, -0.714691,
       -0.858935,  0.370866], dtype=float32)
 y: array([ 0.504864,  0.239177, -0.960478, -0.204671,  0.731089,  0.262303,
       -0.675667, -0.779623,  0.362969, -2.344096,  0.38684 ,  0.104189,
       -0.363802, -0.199642, -0.482426,  0.326316,  0.003698, -0.714691,
       -0.858935,  0.370866], dtype=float32)
This issue questions the choice of atol default parameter value of 1e-7 in assert_allclose_dense_sparse, see sklearn/utils/testing.py#L404.
The default value is smaller than epsilon of single precision floating number:
In [2]: np.finfo(np.float32).eps
Out[2]: 1.1920929e-07
Any threaded execution, can not guarantee bit-wise reproducibility due to possible changes in the order of associative operations, such as adddition or multiplication.
If there are no objections, I would open a PR to increase it to a small multiple of np.finfo(np.float32).eps.