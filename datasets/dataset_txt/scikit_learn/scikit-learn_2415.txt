sharmasx commented on Feb 10, 2017
Description
pickle.py in scikit-learn (0.18.1) unable to unpickle a model that was saved from scikit-learn 0.17.1
Steps/Code to Reproduce
1. To store the model using scikit 0.17.1
import pandas
from sklearn import metrics
from sklearn.externals import joblib
from sklearn.cross_validation import train_test_split
from sklearn.tree import DecisionTreeClassifier
url = "https://archive.ics.uci.edu/ml/machine-learning-databases/pima-indians-diabetes/pima-indians-diabetes.data"
names = ['preg', 'plas', 'pres', 'skin', 'test', 'mass', 'pedi', 'age', 'class']
dataframe = pandas.read_csv(url, names=names)
array = dataframe.values
X = array[:, 0:8]
Y = array[:, 8]
clf = DecisionTreeClassifier(max_depth=8, max_leaf_nodes=None, min_samples_leaf=4,
min_samples_split=4, criterion="entropy")
X_train, X_test, y_train, y_test = train_test_split(X, Y,
train_size=0.75, test_size=0.25)
train_fit = clf.fit(X_train, y_train)
pred = clf.predict(X_test)
p, r, f1, s = metrics.precision_recall_fscore_support(y_test, pred)
joblib.dump(clf, "saved_dt_model.pkl")
print(p, r, f1, s)
clf2= joblib.load('saved_dt_model.pkl')
pred = clf2.predict(X_test)
p, r, f1, s = metrics.precision_recall_fscore_support(y_test, pred)
print(p, r, f1, s)
2. To unpickle the model using scikit-learn (0.18.1)
import pandas
from sklearn import metrics
from sklearn.externals import joblib
from sklearn.model_selection import train_test_split
url = "https://archive.ics.uci.edu/ml/machine-learning-databases/pima-indians-diabetes/pima-indians-diabetes.data"
names = ['preg', 'plas', 'pres', 'skin', 'test', 'mass', 'pedi', 'age', 'class']
dataframe = pandas.read_csv(url, names=names)
array = dataframe.values
X = array[:, 0:8]
Y = array[:, 8]
X_train, X_test, y_train, y_test = train_test_split(X, Y,
train_size=0.75, test_size=0.25)
clf2 = joblib.load('saved_dt_model.pkl')
pred = clf2.predict(X_test)
p, r, f1, s = metrics.precision_recall_fscore_support(y_test, pred)
print(p, r, f1, s)
Expected Results
No error is thrown and a result like follows (actual numbers may vary)
[ 0.72916667 0.625 ] [ 0.85365854 0.43478261] [ 0.78651685 0.51282051] [123 69]
Actual Results
Key_Error with the following log trace
clf2 = joblib.load('saved_dt_model.pkl')
File "/Users/jdoe/anaconda/lib/python3.6/site-packages/sklearn/externals/joblib/numpy_pickle.py", line 575, in load
obj = _unpickle(fobj, filename, mmap_mode)
File "/Users/jdoe/anaconda/lib/python3.6/site-packages/sklearn/externals/joblib/numpy_pickle.py", line 507, in _unpickle
obj = unpickler.load()
File "/Users/jdoe/anaconda/lib/python3.6/pickle.py", line 1050, in load
dispatchkey[0]
File "/Users/jdoe/anaconda/lib/python3.6/site-packages/sklearn/externals/joblib/numpy_pickle.py", line 327, in load_build
Unpickler.load_build(self)
File "/Users/jdoe/anaconda/lib/python3.6/pickle.py", line 1507, in load_build
setstate(state)
File "sklearn/tree/_tree.pyx", line 632, in sklearn.tree._tree.Tree.setstate (sklearn/tree/_tree.c:8137)
KeyError: 'max_depth'
Versions
Darwin-15.6.0-x86_64-i386-64bit
Python 3.6.0 |Anaconda 4.3.0 (x86_64)| (default, Dec 23 2016, 13:19:00)
[GCC 4.2.1 Compatible Apple LLVM 6.0 (clang-600.0.57)]
NumPy 1.11.3
SciPy 0.18.1
Scikit-Learn 0.18.1