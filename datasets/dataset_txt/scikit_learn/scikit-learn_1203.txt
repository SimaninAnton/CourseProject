mwharton3 commented on Jul 26, 2018
Description
Memory leak on some machines using query_radius() in neighbors/binary_tree.pxi
Removing lines 1525, 1532, and 1545 fixed the issue on our end. In the source file, assigning NULL to individual index arrays within the arrays (indices[] and distances[], specifically) prior to freeing causes issues when attempting to free the memory later (lines 1557 and 1558).
Steps/Code to Reproduce
from sklearn.neighbors import KDTree
import numpy as np

# Create sample dataset
x = np.random.random((750000, 1)) * 100
y = np.random.random((750000, 1)) * 100
z = np.random.random((750000, 1)) * 100
data = np.concatenate((x, y, z), axis=1)
del x, y, z

# Construct tree and perform neighbor search
tree = KDTree(data)
neighborInd = tree.query_radius(data, r=6.0)
Expected Results
Tree is constructed without issue, takes up <4GB memory
Actual Results
Memory leaks and results thereafter are erratic.
Versions
Issue did not occur on this machine:
Linux-3.10.0-862.3.3.el7.x86_64-x86_64-with-redhat-7.5-Maipo
('Python', '2.7.13 |Continuum Analytics, Inc.| (default, Dec 20 2016, 23:09:15) \n[GCC 4.4.7 20120313 (Red Hat 4.4.7-1)]')
('NumPy', '1.13.1')
('SciPy', '0.19.1')
('Scikit-Learn', '0.19.0')
Issue did not occur on this machine:
Linux-3.10.0-693.17.1.el7.x86_64-x86_64-with-redhat-7.5-Maipo
('Python', '2.7.5 (default, May 31 2018, 09:41:32) \n[GCC 4.8.5 20150623 (Red Hat 4.8.5-28)]')
('NumPy', '1.14.2')
('SciPy', '1.0.1')
('Scikit-Learn', '0.19.1')
Issue occurred on this machine:
Linux-3.10.0-862.3.3.el7.x86_64-x86_64-with-redhat-7.5-Maipo
('Python', '2.7.15 |Anaconda custom (64-bit)| (default, May 1 2018, 23:32:55) \n[GCC 7.2.0]')
('NumPy', '1.14.5')
('SciPy', '1.0.1')
('Scikit-Learn', '0.19.1')