tengerye commented on Feb 18, 2019
It happens for some input. I used NearestNeighbors with negative cosine similarity. It went wrong with method BallTree.kneighbors(X). The input X in my case is sparse but not zero vector.
My traceback as follows:
File "/home/ubuntu/vn_model/vn_algorithm_upgrade/crawler/faceVerif/util/read_dataset.py", line 202, in rank_hit_cos_dist
        dist, _ = self.val_data_feat.kneighbors(x1, self.top_k+1) # Result contains x1 itself.
      File "/home/ubuntu/anaconda3/envs/image_quality/lib/python3.6/site-packages/sklearn/neighbors/base.py", line 385, in kneighbors
        for s in gen_even_slices(X.shape[0], n_jobs)
      File "/home/ubuntu/anaconda3/envs/image_quality/lib/python3.6/site-packages/sklearn/externals/joblib/parallel.py", line 779, in __call__
        while self.dispatch_one_batch(iterator):
      File "/home/ubuntu/anaconda3/envs/image_quality/lib/python3.6/site-packages/sklearn/externals/joblib/parallel.py", line 625, in dispatch_one_batch
        self._dispatch(tasks)
      File "/home/ubuntu/anaconda3/envs/image_quality/lib/python3.6/site-packages/sklearn/externals/joblib/parallel.py", line 588, in _dispatch
        job = self._backend.apply_async(batch, callback=cb)
      File "/home/ubuntu/anaconda3/envs/image_quality/lib/python3.6/site-packages/sklearn/externals/joblib/_parallel_backends.py", line 111, in apply_async
        result = ImmediateResult(func)
      File "/home/ubuntu/anaconda3/envs/image_quality/lib/python3.6/site-packages/sklearn/externals/joblib/_parallel_backends.py", line 332, in __init__
        self.results = batch()
      File "/home/ubuntu/anaconda3/envs/image_quality/lib/python3.6/site-packages/sklearn/externals/joblib/parallel.py", line 131, in __call__
        return [func(*args, **kwargs) for func, args, kwargs in self.items]
      File "/home/ubuntu/anaconda3/envs/image_quality/lib/python3.6/site-packages/sklearn/externals/joblib/parallel.py", line 131, in <listcomp>
        return [func(*args, **kwargs) for func, args, kwargs in self.items]
    SystemError: <built-in method query of sklearn.neighbors.ball_tree.BallTree object at 0x55a513a87ca8> returned NULL without setting an error.
My scikit-learn has the version of 0.20.2. Since the error appears occasionally, I have no clue where to start from.
Thank you so much.