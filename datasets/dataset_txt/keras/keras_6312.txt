Contributor
EderSantana commented on 6 Dec 2015
To build a convolutional RNN, we need to run convolutions inside a for loop. It was working in the hand coded Theano, but now I'm getting an error I couldn't figure out. Can anybody help? It crashes under both backends with different messages.
The code is here: https://github.com/EderSantana/seya/blob/master/seya/layers/conv_rnn.py
Unit test is here: https://github.com/EderSantana/seya/blob/master/tests/test_conv_rnn.py
Here is the error message under Theano backend:
======================================================================
ERROR: test_basic (__main__.TestConvGRU)
Just check that the ConvGRU layer can compile and run
----------------------------------------------------------------------
Traceback (most recent call last):
  File "tests/test_conv_rnn.py", line 25, in test_basic
    model.compile('sgd', 'mse')
  File "/home/eders/python/keras/keras/models.py", line 372, in compile
    self.y_train = self.get_output(train=True)
  File "/home/eders/python/keras/keras/layers/containers.py", line 73, in get_output
    return self.layers[-1].get_output(train)
  File "/home/eders/python/keras/keras/layers/recurrent.py", line 80, in get_output
    masking=masking)
  File "/home/eders/python/keras/keras/backend/theano_backend.py", line 431, in rnn
    go_backwards=go_backwards)
  File "/home/eders/python/Theano/theano/scan_module/scan.py", line 745, in scan
    condition, outputs, updates = scan_utils.get_updates_and_outputs(fn(*args))
  File "/home/eders/python/keras/keras/backend/theano_backend.py", line 414, in _step
    output, new_states = step_function(input, states)
  File "/home/eders/python/seya/seya/sandbox/conv_rnn.py", line 96, in step
    z = self.inner_activation(xz_t + apply_layer(self.conv_z, h_tm1))
  File "/home/eders/python/seya/seya/utils.py", line 18, in apply_layer
    Y = layer.get_output(train=train)
  File "/home/eders/python/keras/keras/layers/convolutional.py", line 218, in get_output
    filter_shape=self.W_shape)
  File "/home/eders/python/keras/keras/backend/theano_backend.py", line 551, in conv2d
    border_mode=(pad_x, pad_y))
  File "/home/eders/python/Theano/theano/sandbox/cuda/dnn.py", line 1196, in dnn_conv
    out = gpu_alloc_empty(*out_shp)
  File "/home/eders/python/Theano/theano/gof/op.py", line 600, in __call__
    node = self.make_node(*inputs, **kwargs)
  File "/home/eders/python/Theano/theano/sandbox/cuda/basic_ops.py", line 3630, in make_node
    shape, output = self.validate_shape(shape)
  File "/home/eders/python/Theano/theano/sandbox/cuda/basic_ops.py", line 3621, in validate_shape
    const_shp = tensor.get_scalar_constant_value(s)
  File "/home/eders/python/Theano/theano/tensor/basic.py", line 660, in get_scalar_constant_value
    for i in v.owner.inputs]
  File "/home/eders/python/Theano/theano/tensor/basic.py", line 660, in get_scalar_constant_value
    for i in v.owner.inputs]
  File "/home/eders/python/Theano/theano/tensor/basic.py", line 660, in get_scalar_constant_value
    for i in v.owner.inputs]
  File "/home/eders/python/Theano/theano/tensor/basic.py", line 660, in get_scalar_constant_value
    for i in v.owner.inputs]
  File "/home/eders/python/Theano/theano/tensor/basic.py", line 772, in get_scalar_constant_value
    raise ValueError(msg)
ValueError: get_scalar_constant_value detected deterministic IndexError: x.shape[2] when x.ndim=2.x=Subtensor{int64}.0

----------------------------------------------------------------------
Ran 1 test in 3.011s