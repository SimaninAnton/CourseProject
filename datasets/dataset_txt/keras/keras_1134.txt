wenbotse commented on 30 Mar 2018
def generate_from_file(path, batch_size):
print('enter generate_arrays_from_file')
i = 0

while True:
    
    print('enter generate_arrays_from_file loop')
    with open(data_path) as f:
        for line in f:
            try:
                if len(line.split('=====')) != 2:
                    continue
                input_text, target_text = line.split('=====')
                #print('==1')
                for t, char in enumerate(input_text):
                    if char == '\n':
                        continue
                    encoder_input_data[i, t, input_token_index[char]] = 1.
                #print('==2')
                for t, char in enumerate(target_text):
                    if char == '\n':
                        continue
                    # decoder_target_data is ahead of decoder_input_data by one timestep
                    decoder_input_data[i, t, target_token_index[char]] = 1.
                    #print('==3')
                    if t > 0:
                        # decoder_target_data will be ahead by one timestep
                        # and will not include the start character.
                        decoder_target_data[i, t - 1, target_token_index[char]] = 1.
                        #print('==4')
                i+=1
                if i == batch_size:
                    print('generate_arrays_from_file size:',i)
                    print('getMemCpu=generate_arrays_from_file=',getMemCpu())
                    i = 0
                    yield ([encoder_input_data, decoder_input_data],decoder_target_data)
                    gc.collect()
            except:
                print("exception "+str(i)+" input_text="+input_text)
                #traceback.print_exc()
               # exit(0)
model.fit_generator(generate_from_file(data_path, batch_size),
epochs=epochs,
max_q_size=10,
steps_per_epoch=None,
samples_per_epoch=512,
nb_worker=1,
verbose=1,
callbacks=[predictEpochCallback])
I don't know why each call of generate_from_file while cause the memory increasing