QuiteAFoxtrot commented on 14 Aug 2018 â€¢
edited
In Keras/engine/saving.py about line 98 or so there is a check for the h5py.File type
if not isinstance(filepath, h5py.File):
If that were changed to check for an h5py.Group, then a Keras model could be saved as part of an HDF5 file containing other relevant information to the particular neural network application. At work we are using just such a format (saving things like model predictions and training data along side the actual model). I'm currently tricking Keras successfully into saving to an h5py Group instead of an h5py File by using the following:
save_group = my_h5py_file.create_group(some_name)
class Patch(h5py.File, h5py.Group):
    pass
save_group.__class__ = Patch
keras_model.save_model(save_group)
There is however, one downside to this method - the h5py library accidentally writes the Keras model attributes to the HDF5 root group instead of the sub group. I've opened an issue with the h5py github for this (h5py/h5py#1076), but for Keras changing this 1 line would fix the problem on this side.