chrisrb10 commented on 14 Mar 2018
I have some keras transfer learning and fine-tuning code which was working fine (and still works fine) with 2.1.4, but throws an error with 2.1.5.
Error is:
TypeError: unsupported operand type(s) for /=: 'JpegImageFile' and 'float'
The problematic line seems to be the following:
history_tl = model.fit_generator(
            train_generator,
            epochs=nb_epoch,
            steps_per_epoch=steps_per_epoch,
            validation_data=validation_generator,
            validation_steps=validation_steps,
            class_weight=None) 
steps_per_epoch and validation_steps are calculated as:
    steps_per_epoch = nb_train_samples / batch_size
    validation_steps = nb_val_samples / batch_size
and the train_generator & validation_generator are created with the following:
    # data prep
    print('Running data prep - train')
    train_datagen =  ImageDataGenerator(
        preprocessing_function=preprocess_input,
        rotation_range=30,
        width_shift_range=0.2,
        height_shift_range=0.2,
        shear_range=0.2,
        zoom_range=0.2,
        horizontal_flip=True
        )

    print('Running data prep - test')
    test_datagen = ImageDataGenerator(
        preprocessing_function=preprocess_input,
        rotation_range=30,
        width_shift_range=0.2,
        height_shift_range=0.2,
        shear_range=0.2,
        zoom_range=0.2,
        horizontal_flip=True
        )

    print('Running data gen - train')
    train_generator = train_datagen.flow_from_directory(
        train_dir,
        target_size=(IM_HEIGHT, IM_WIDTH),
        batch_size=batch_size
        )

    print('Running data gen - test')
    validation_generator = test_datagen.flow_from_directory(
        val_dir,
        target_size=(IM_HEIGHT, IM_WIDTH),
        batch_size=batch_size
        )
Can you shed any light on what has changed that will cause this code to cease working, and what I need to to do fix it?
Full traceback below.
Epoch 1/1
Traceback (most recent call last):
  File "/home/chris_r_brake/anaconda3/envs/keras_2/lib/python3.6/site-packages/keras/utils/data_utils.py", line 578, in get
    inputs = self.queue.get(block=True).get()
  File "/home/chris_r_brake/anaconda3/envs/keras_2/lib/python3.6/multiprocessing/pool.py", line 644, in get
    raise self._value
  File "/home/chris_r_brake/anaconda3/envs/keras_2/lib/python3.6/multiprocessing/pool.py", line 119, in worker
    result = (True, func(*args, **kwds))
  File "/home/chris_r_brake/anaconda3/envs/keras_2/lib/python3.6/site-packages/keras/utils/data_utils.py", line 401, in get_index
    return _SHARED_SEQUENCES[uid][i]
  File "/home/chris_r_brake/anaconda3/envs/keras_2/lib/python3.6/site-packages/keras/preprocessing/image.py", line 825, in __getitem__
    return self._get_batches_of_transformed_samples(index_array)
  File "/home/chris_r_brake/anaconda3/envs/keras_2/lib/python3.6/site-packages/keras/preprocessing/image.py", line 1233, in _get_batches_of_transformed_samples
    img = self.image_data_generator.preprocessing_function(img)
  File "/home/chris_r_brake/anaconda3/envs/keras_2/lib/python3.6/site-packages/keras/applications/inception_v3.py", line 407, in preprocess_input
    return imagenet_utils.preprocess_input(x, mode='tf')
  File "/home/chris_r_brake/anaconda3/envs/keras_2/lib/python3.6/site-packages/keras/applications/imagenet_utils.py", line 178, in preprocess_input
    mode=mode)
  File "/home/chris_r_brake/anaconda3/envs/keras_2/lib/python3.6/site-packages/keras/applications/imagenet_utils.py", line 115, in _preprocess_symbolic_input
    x /= 127.5
TypeError: unsupported operand type(s) for /=: 'JpegImageFile' and 'float'
The above exception was the direct cause of the following exception:
Traceback (most recent call last):
  File "nested_inception.py", line 183, in <module>
    train('./data/model_data/', nb_epoch=1)
  File "nested_inception.py", line 154, in train
    class_weight=None) 
  File "/home/chris_r_brake/anaconda3/envs/keras_2/lib/python3.6/site-packages/keras/legacy/interfaces.py", line 91, in wrapper
    return func(*args, **kwargs)
  File "/home/chris_r_brake/anaconda3/envs/keras_2/lib/python3.6/site-packages/keras/engine/training.py", line 2192, in fit_generator
    generator_output = next(output_generator)
  File "/home/chris_r_brake/anaconda3/envs/keras_2/lib/python3.6/site-packages/keras/utils/data_utils.py", line 584, in get
    six.raise_from(StopIteration(e), e)
  File "<string>", line 3, in raise_from
StopIteration: unsupported operand type(s) for /=: 'JpegImageFile' and 'float'
6