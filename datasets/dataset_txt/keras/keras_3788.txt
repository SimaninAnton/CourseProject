stefanthaler commented on 1 Dec 2016
When I create a model that contains an Embedding layer with masking and a backwards LSTM and using the Tensorflow backend, I get the following error:
ValueError: Shape must be rank 2 but is rank 3 for 'Reverse' (op: 'Reverse') with input shapes: [3,2,40], [2].
I've created a gist that reproduces the error.
I suspect it has something to do with these two lines in the tensorflow_backend.py, where one time ndim-1 is used and the other time ndim-2 is used.
https://github.com/fchollet/keras/blob/master/keras/backend/tensorflow_backend.py#L1248
https://github.com/fchollet/keras/blob/master/keras/backend/tensorflow_backend.py#L1273
The complete stacktrace is:
File "stateful_lstm_embedding_butg.py", line 18, in
model.add(LSTM(10, batch_input_shape=(batch_size,time_steps,embedding_size), return_sequences=False, go_backwards=True))
File "/usr/local/lib/python2.7/dist-packages/keras/models.py", line 324, in add
output_tensor = layer(self.outputs[0])
File "/usr/local/lib/python2.7/dist-packages/keras/engine/topology.py", line 517, in call
self.add_inbound_node(inbound_layers, node_indices, tensor_indices)
File "/usr/local/lib/python2.7/dist-packages/keras/engine/topology.py", line 571, in add_inbound_node
Node.create_node(self, inbound_layers, node_indices, tensor_indices)
File "/usr/local/lib/python2.7/dist-packages/keras/engine/topology.py", line 155, in create_node
output_tensors = to_list(outbound_layer.call(input_tensors[0], mask=input_masks[0]))
File "/usr/local/lib/python2.7/dist-packages/keras/layers/recurrent.py", line 227, in call
input_length=input_shape[1])
File "/usr/local/lib/python2.7/dist-packages/keras/backend/tensorflow_backend.py", line 1249, in rnn
inputs = tf.reverse(inputs, [True] + [False] * (ndim - 2))
File "/usr/local/lib/python2.7/dist-packages/tensorflow/python/ops/gen_array_ops.py", line 2513, in reverse
name=name)
File "/usr/local/lib/python2.7/dist-packages/tensorflow/python/framework/op_def_library.py", line 759, in apply_op
op_def=op_def)
File "/usr/local/lib/python2.7/dist-packages/tensorflow/python/framework/ops.py", line 2242, in create_op
set_shapes_for_outputs(ret)
File "/usr/local/lib/python2.7/dist-packages/tensorflow/python/framework/ops.py", line 1617, in set_shapes_for_outputs
shapes = shape_func(op)
File "/usr/local/lib/python2.7/dist-packages/tensorflow/python/framework/ops.py", line 1568, in call_with_requiring
return call_cpp_shape_fn(op, require_shape_fn=True)
File "/usr/local/lib/python2.7/dist-packages/tensorflow/python/framework/common_shapes.py", line 610, in call_cpp_shape_fn
debug_python_shape_fn, require_shape_fn)
File "/usr/local/lib/python2.7/dist-packages/tensorflow/python/framework/common_shapes.py", line 675, in _call_cpp_shape_fn_impl
raise ValueError(err.message)
ValueError: Shape must be rank 2 but is rank 3 for 'Reverse' (op: 'Reverse') with input shapes: [3,2,40], [2].