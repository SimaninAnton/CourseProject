rodriguel commented on 10 Jul 2018
Hi everyone. I'm having a really hard time trying to implement some loss function within the Keras framework. Here's the deal : my loss function is basically an L2 norm, except that this L2 norm is weighted at different position (see this loss function). The problem is, how are placed the different weights depends on the value of y_true. Therefore, in my loss function, prior to everything else, I need to take a peak at y_true value.
So far, this seems infeasible. I tried to use built-in method K.get_value(), but this doesn't work. I'm not going to give you my all code, but here is just a snippet of some random ConvNet I built to reproduce the error :
import numpy as np
import keras.backend as K

from keras.layers import Conv2D, MaxPooling2D, Dense, Flatten, LeakyReLU
from keras.models import Sequential

# Defining some random ConvNet. 
myNN = Sequential()
myNN.add(Conv2D(3, (3,3), padding = 'same', input_shape = (224,224,3)))
myNN.add(LeakyReLU(alpha = 0.1))
myNN.add(MaxPooling2D((2,2), padding = 'valid'))
myNN.add(Flatten())
myNN.add(Dense(3))

# Checking what it looks like
myNN.summary()

# Let us try some stuff

def my_loss(y_true, y_pred):
    yy = K.get_value(y_true) #this doesn't do anything, just to see if there is an error popping up
    return K.square(y_true - y_pred)

# Let us compile to see wat's up
    
myNN.compile(loss = my_loss, optimizer = 'adadelta')
I get some very long errors :
InvalidArgumentError: You must feed a value for placeholder tensor 'dense_5_target' with dtype float and shape [?,?]
[[Node: dense_5_target = Placeholderdtype=DT_FLOAT, shape=[?,?], _device="/job:localhost/replica:0/task:0/device:CPU:0"]]
Caused by op 'dense_5_target', defined at:
File "/anaconda3/lib/python3.6/site-packages/spyder/utils/ipython/start_kernel.py", line 269, in
main()
File "/anaconda3/lib/python3.6/site-packages/spyder/utils/ipython/start_kernel.py", line 265, in main
kernel.start()
File "/anaconda3/lib/python3.6/site-packages/ipykernel/kernelapp.py", line 486, in start
self.io_loop.start()
File "/anaconda3/lib/python3.6/site-packages/tornado/platform/asyncio.py", line 127, in start
self.asyncio_loop.run_forever()
File "/anaconda3/lib/python3.6/asyncio/base_events.py", line 422, in run_forever
self._run_once()
File "/anaconda3/lib/python3.6/asyncio/base_events.py", line 1432, in _run_once
handle._run()
File "/anaconda3/lib/python3.6/asyncio/events.py", line 145, in _run
self._callback(*self._args)
File "/anaconda3/lib/python3.6/site-packages/tornado/platform/asyncio.py", line 117, in _handle_events
handler_func(fileobj, events)
File "/anaconda3/lib/python3.6/site-packages/tornado/stack_context.py", line 276, in null_wrapper
return fn(*args, **kwargs)
File "/anaconda3/lib/python3.6/site-packages/zmq/eventloop/zmqstream.py", line 450, in _handle_events
self._handle_recv()
File "/anaconda3/lib/python3.6/site-packages/zmq/eventloop/zmqstream.py", line 480, in _handle_recv
self._run_callback(callback, msg)
File "/anaconda3/lib/python3.6/site-packages/zmq/eventloop/zmqstream.py", line 432, in _run_callback
callback(*args, **kwargs)
File "/anaconda3/lib/python3.6/site-packages/tornado/stack_context.py", line 276, in null_wrapper
return fn(*args, **kwargs)
File "/anaconda3/lib/python3.6/site-packages/ipykernel/kernelbase.py", line 283, in dispatcher
return self.dispatch_shell(stream, msg)
File "/anaconda3/lib/python3.6/site-packages/ipykernel/kernelbase.py", line 233, in dispatch_shell
handler(stream, idents, msg)
File "/anaconda3/lib/python3.6/site-packages/ipykernel/kernelbase.py", line 399, in execute_request
user_expressions, allow_stdin)
File "/anaconda3/lib/python3.6/site-packages/ipykernel/ipkernel.py", line 208, in do_execute
res = shell.run_cell(code, store_history=store_history, silent=silent)
File "/anaconda3/lib/python3.6/site-packages/ipykernel/zmqshell.py", line 537, in run_cell
return super(ZMQInteractiveShell, self).run_cell(*args, **kwargs)
File "/anaconda3/lib/python3.6/site-packages/IPython/core/interactiveshell.py", line 2662, in run_cell
raw_cell, store_history, silent, shell_futures)
File "/anaconda3/lib/python3.6/site-packages/IPython/core/interactiveshell.py", line 2785, in _run_cell
interactivity=interactivity, compiler=compiler, result=result)
File "/anaconda3/lib/python3.6/site-packages/IPython/core/interactiveshell.py", line 2909, in run_ast_nodes
if self.run_code(code, result):
File "/anaconda3/lib/python3.6/site-packages/IPython/core/interactiveshell.py", line 2963, in run_code
exec(code_obj, self.user_global_ns, self.user_ns)
File "", line 1, in
runfile('/Users/mfglabs/Documents/Object detection/test/test.py', wdir='/Users/mfglabs/Documents/Object detection/test')
File "/anaconda3/lib/python3.6/site-packages/spyder/utils/site/sitecustomize.py", line 705, in runfile
execfile(filename, namespace)
File "/anaconda3/lib/python3.6/site-packages/spyder/utils/site/sitecustomize.py", line 102, in execfile
exec(compile(f.read(), filename, 'exec'), namespace)
File "/Users/mfglabs/Documents/Object detection/test/test.py", line 34, in
myNN.compile(loss = my_loss, optimizer = 'adadelta')
File "/anaconda3/lib/python3.6/site-packages/keras/models.py", line 863, in compile
**kwargs)
File "/anaconda3/lib/python3.6/site-packages/keras/engine/training.py", line 725, in compile
dtype=K.dtype(self.outputs[i]))
File "/anaconda3/lib/python3.6/site-packages/keras/backend/tensorflow_backend.py", line 508, in placeholder
x = tf.placeholder(dtype, shape=shape, name=name)
File "/anaconda3/lib/python3.6/site-packages/tensorflow/python/ops/array_ops.py", line 1808, in placeholder
return gen_array_ops.placeholder(dtype=dtype, shape=shape, name=name)
File "/anaconda3/lib/python3.6/site-packages/tensorflow/python/ops/gen_array_ops.py", line 4848, in placeholder
"Placeholder", dtype=dtype, shape=shape, name=name)
File "/anaconda3/lib/python3.6/site-packages/tensorflow/python/framework/op_def_library.py", line 787, in _apply_op_helper
op_def=op_def)
File "/anaconda3/lib/python3.6/site-packages/tensorflow/python/framework/ops.py", line 3392, in create_op
op_def=op_def)
File "/anaconda3/lib/python3.6/site-packages/tensorflow/python/framework/ops.py", line 1718, in init
self._traceback = self._graph._extract_stack() # pylint: disable=protected-access
InvalidArgumentError (see above for traceback): You must feed a value for placeholder tensor 'dense_5_target' with dtype float and shape [?,?]
[[Node: dense_5_target = Placeholderdtype=DT_FLOAT, shape=[?,?], _device="/job:localhost/replica:0/task:0/device:CPU:0"]]
So my question really boils down to : is it possible to access the value of y_true within the loss function ? Thank you a LOT !