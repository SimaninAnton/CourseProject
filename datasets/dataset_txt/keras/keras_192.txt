sanderland commented on 4 Jun 2019 â€¢
edited
System information
Have I written custom code (as opposed to using example directory): yes
OS Platform and Distribution (e.g., Linux Ubuntu 16.04): Ubuntu 18.04
TensorFlow backend (yes / no): yes
TensorFlow version: 1.13
Keras version: 2.2.4
Python version: 3.7.3
CUDA/cuDNN version: no CUDA
Describe the current behavior
keras.backened.eval takes exponentially increasing time with every call
Describe the expected behavior
The same evaluation taking the same amount of time.
Code to reproduce the issue
import numpy as np
import keras
from keras.models import Sequential
from keras.layers import Dense
indim = 28
model = Sequential([Dense(8,input_shape=(indim,),activation='tanh'),Dense(4,activation='tanh'),Dense(1,activation='linear')])
model.compile(optimizer='adam',loss='mae')
def foo():
    for i in range(0,50):
        input = np.random.rand(32,28)
        Y     = np.random.rand(32,1)
        Ypred = model.predict(input)
        loss = model.loss_functions[0](Y,Ypred)
        loss = keras.backend.eval(loss)
this outputs 1 seconds, 2 seconds, 4 seconds as results for subsequent runs
%timeit foo()
profiler output below
%prun foo()
Other info / logs
Confirmed/replicated on another PC.
Profile output shows ExtendSession and TF_SessionRun_wrapper taking all the time.
        166454 function calls (162854 primitive calls) in 2.156 seconds

   Ordered by: internal time

   ncalls  tottime  percall  cumtime  percall filename:lineno(function)
       50    1.098    0.022    1.098    0.022 {built-in method _pywrap_tensorflow_internal.ExtendSession}
       50    0.896    0.018    0.896    0.018 {built-in method _pywrap_tensorflow_internal.TF_SessionRun_wrapper}
      200    0.015    0.000    0.016    0.000 tf_stack.py:31(extract_stack)
       50    0.011    0.000    0.011    0.000 {built-in method _pywrap_tensorflow_internal.TF_SessionRunCallable}
      100    0.005    0.000    0.076    0.001 op_def_library.py:339(_apply_op_helper)
      200    0.003    0.000    0.003    0.000 {built-in method _pywrap_tensorflow_internal.TF_FinishOperation}
      200    0.003    0.000    0.086    0.000 deprecation.py:473(new_func)
      200    0.003    0.000    0.049    0.000 ops.py:1688(__init__)
Maybe related to Issue #6620 but since that has no resolution and is years old.