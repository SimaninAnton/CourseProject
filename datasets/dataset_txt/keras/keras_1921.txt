mdmustafizurrahman commented on 14 Jul 2017 â€¢
edited
Hi,
I am trying to implement a custom loss function in keras where I need to compute the equation:
$ \sum_{i=1}^n \sum_{j=1}^n \omega_{i,j} * KLD( (y_pred_i) || (y_pred_j) ) $
so in Keras I am getting y_pred which have shape (n_data_points, n_dim)
According to the above equation, I first need compute the KLD = KL Divergence between all pairs of (i,j) in y_pred. That means if y_pred is of size 3, then I have to compute KL divergence between
(1,1), (1,2), (1,3),
(2,1),(2,2,), (2,3),
(3,1), (3,2), (3,3)
Which is basically a nested for loop:
for i in range (1,3):
for j in range(1,3):
compute KLD between (i,j)
Note KL Divergence return a scalar value
And I need to store all these scaler value in a tensor so that I can later make element wise product between these scalar tensor and the omega
Since I am new to Keras, I am trying to use the following nested theano scan
`initial_result = theano.tensor.alloc(np.array(0), num_classes)
    def second_step(y_pred, prev_result, y_pred1): # y_pred vector and y_pred1 is matrix
        result2, updates2 = theano.scan(
            lambda y_pred1, y_pred: (y_pred + eps) * (K.log(y_pred + eps) - K.log(y_pred1 + eps)),
            sequences=[y_pred1], non_sequences=y_pred)
        prev_result = result2

    # y_pred and y_pred1 both matrix, first scan take one instance of y_pred and pass the whole y_pred1 as non seqenece to the secodn scan
    result1, updates1 = theano.scan(
        second_step,
        sequences=[y_pred],
        outputs_info= [initial_result],
        non_sequences=[y_pred1]
    )
`
But I am always reciving the message:
'The return value of your scan lambda expression may only be '
ValueError: The return value of your scan lambda expression may only be made of lists, tuples, or dictionaries containing Theano variables (or theano.scan_module.until objects for conditions). In particular if you need to use constant values, you can use tensor.constant to turn them into Theano variables.
Can you help me to correctly implement the function under custom loss?