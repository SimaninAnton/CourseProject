volvador commented on 11 May 2017 â€¢
edited
I am trying to compute the Jacobian of my model (keras 1.2 with theano backend 0.8) with respect to its inputs.
I tried to define it as a theano function. But I am obtaining the following error
Traceback (most recent call last):
  File "test.py", line 27, in <module>
    model.layers[0].input), 
  File ".../lib/python2.7/site-packages/theano/gradient.py", line 1815, in jacobian
    ("Scan has returned a list of updates. This should not "
AssertionError: Scan has returned a list of updates. This should not happen! Report this to theano-
users (also include the script that generated the error)
This is my code for reproducibility. Can you please point to what I am doing wrong?
Strangely that error disappears if I do not use Dropout
from keras.models import Sequential
from keras.layers.core import Dense, Dropout
import theano

input_dim = 5
hidden_dim = 3
output_dim = 1
dropout = 0.3

model = Sequential()
model.add(Dropout(dropout, input_shape=(input_dim,)))
model.add(Dense(output_dim = hidden_dim,
                activation='tanh',
                init='he_normal', input_dim = input_dim))
model.add(Dropout(dropout))
model.add(Dense(output_dim = hidden_dim,
                activation='tanh',
                init='he_normal',
                input_dim = hidden_dim))

model.add(Dense(output_dim=output_dim, input_dim = hidden_dim,
                activation = 'linear'))
model.compile(loss='mse', optimizer='adam')

jac = theano.function( [model.layers[0].input], 
                      theano.tensor.jacobian(model.layers[-1].output.flatten(), 
                                             model.layers[0].input), 
                       allow_input_downcast=True)