how flattten is applied in this python file