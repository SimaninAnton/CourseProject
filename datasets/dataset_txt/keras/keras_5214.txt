RubenZazo commented on 9 May 2016 â€¢
edited
Hello,
I am new to Theano and Keras so maybe I am asking something silly but have been a few days trying to get this working and I can not.
I want to build a siamese architecture that takes 2 vectors as inputs and outputs wether they come from the same source or not. The code I have (mostly from keras examples) is something like this:
#Create common structure.
def create_base_network(input_dim):
    seq = Sequential()
    eq.add...
    return seq

#network definition
base_network = create_base_network(input_dim)

input_a = Input(shape=(input_dim,))
input_b = Input(shape=(input_dim,))
processed_a = base_network(input_a)
processed_b = base_network(input_b)
The problem comes when I want to do a cosine_distance between processed_a and processed_b, this is what I tried:
def cosine_distance(vests):
    x, y = vests
    return np.array([spatial.distance.cosine(x,y)], dtype='f') 
    #spatial.distance.cosine is from SciPy, it outputs a double from 0 to 1

def cos_dist_output_shape(shapes):
    return (1,)

distance = Lambda(cosine_distance, output_shape=cos_dist_output_shape)([processed_a, processed_b])

model = Model(input=[input_a, input_b], output=distance)
When I try to define distance = Lambda(...) I get:
Traceback (most recent call last):
File "", line 1, in
File "/home/rcandil/myPythonEnv/local/lib/python2.7/site-packages/keras/engine/topology.py", line 485, in call
self.add_inbound_node(inbound_layers, node_indices, tensor_indices)
File "/home/rcandil/myPythonEnv/local/lib/python2.7/site-packages/keras/engine/topology.py", line 543, in add_inbound_node
Node.create_node(self, inbound_layers, node_indices, tensor_indices)
File "/home/rcandil/myPythonEnv/local/lib/python2.7/site-packages/keras/engine/topology.py", line 153, in create_node
output_tensors = to_list(outbound_layer.call(input_tensors, mask=input_masks))
File "/home/rcandil/myPythonEnv/local/lib/python2.7/site-packages/keras/layers/core.py", line 446, in call
return self.function(x, **arguments)
File "", line 3, in cosine_distance
File "/home/rcandil/myPythonEnv/local/lib/python2.7/site-packages/scipy/spatial/distance.py", line 329, in cosine
dist = 1.0 - np.dot(u, v) / (norm(u) * norm(v))
File "/home/rcandil/myPythonEnv/local/lib/python2.7/site-packages/scipy/linalg/misc.py", line 166, in norm
return np.linalg.norm(a, ord=ord)
File "/home/rcandil/myPythonEnv/local/lib/python2.7/site-packages/numpy/linalg/linalg.py", line 2116, in norm
x = x.astype(float)
ValueError: setting an array element with a sequence.
What is what I am doing wrong? Thank you very much for your help.