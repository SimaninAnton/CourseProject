donkang75 commented on 24 Jul 2015
Is there any easy way to free GPU memory? I wanted to find the largest batch_size to fit GPU memory dynamically when it failed to allocate. However, the device memory seemed not being released. Code snippet below should have no memory problem for batch_size <= 500 but when I set it 1000 it didn't stop there but kept complaining out of memory as shown below. Any suggestions?
    while True:
        try:
            X, y = ...
            model.fit(X, y, batch_size=batch_size, nb_epoch=1) 
            break
        except (MemoryError, RuntimeError):
            print("[Warning!] Out of GPU memory. batch_size reduced from %d to %d" % (batch_size, batch_size - int(batch_size * .1)))
            import gc
            gc.collect()
            batch_size -= int(batch_size * .1)
Error allocating 204800000 bytes of device memory (out of memory). Driver report 83058688 bytes free and 4294770688 bytes total
[Warning!] Out of GPU memory. batch_size reduced from 1000 to 900
Error allocating 184320000 bytes of device memory (out of memory). Driver report 81223680 bytes free and 4294770688 bytes total
[Warning!] Out of GPU memory. batch_size reduced from 900 to 810
Error allocating 165888000 bytes of device memory (out of memory). Driver report 81354752 bytes free and 4294770688 bytes total
[Warning!] Out of GPU memory. batch_size reduced from 810 to 729
Error allocating 149299200 bytes of device memory (out of memory). Driver report 81485824 bytes free and 4294770688 bytes total
[Warning!] Out of GPU memory. batch_size reduced from 729 to 657
Error allocating 134553600 bytes of device memory (out of memory). Driver report 81616896 bytes free and 4294770688 bytes total
[Warning!] Out of GPU memory. batch_size reduced from 657 to 592
Error allocating 121241600 bytes of device memory (out of memory). Driver report 81747968 bytes free and 4294770688 bytes total
[Warning!] Out of GPU memory. batch_size reduced from 592 to 533
Error allocating 109158400 bytes of device memory (out of memory). Driver report 81879040 bytes free and 4294770688 bytes total
[Warning!] Out of GPU memory. batch_size reduced from 533 to 480
Error allocating 98304000 bytes of device memory (out of memory). Driver report 82010112 bytes free and 4294770688 bytes total
[Warning!] Out of GPU memory. batch_size reduced from 480 to 432
Error allocating 88473600 bytes of device memory (out of memory). Driver report 82010112 bytes free and 4294770688 bytes total
[Warning!] Out of GPU memory. batch_size reduced from 432 to 389
Error allocating 79667200 bytes of device memory (out of memory). Driver report 2318336 bytes free and 4294770688 bytes total
[Warning!] Out of GPU memory. batch_size reduced from 389 to 351
Error allocating 71884800 bytes of device memory (out of memory). Driver report 2318336 bytes free and 4294770688 bytes total
[Warning!] Out of GPU memory. batch_size reduced from 351 to 316
Error allocating 64716800 bytes of device memory (out of memory). Driver report 2318336 bytes free and 4294770688 bytes total
[Warning!] Out of GPU memory. batch_size reduced from 316 to 285
Error allocating 58368000 bytes of device memory (out of memory). Driver report 2318336 bytes free and 4294770688 bytes total
[Warning!] Out of GPU memory. batch_size reduced from 285 to 257
Error allocating 52633600 bytes of device memory (out of memory). Driver report 2318336 bytes free and 4294770688 bytes total
[Warning!] Out of GPU memory. batch_size reduced from 257 to 232
Error allocating 47513600 bytes of device memory (out of memory). Driver report 2318336 bytes free and 4294770688 bytes total
[Warning!] Out of GPU memory. batch_size reduced from 232 to 209
Error allocating 42803200 bytes of device memory (out of memory). Driver report 2318336 bytes free and 4294770688 bytes total
[Warning!] Out of GPU memory. batch_size reduced from 209 to 189
Error allocating 38707200 bytes of device memory (out of memory). Driver report 2318336 bytes free and 4294770688 bytes total
[Warning!] Out of GPU memory. batch_size reduced from 189 to 171
Error allocating 35020800 bytes of device memory (out of memory). Driver report 2318336 bytes free and 4294770688 bytes total
[Warning!] Out of GPU memory. batch_size reduced from 171 to 154
Error allocating 31539200 bytes of device memory (out of memory). Driver report 2318336 bytes free and 4294770688 bytes total
[Warning!] Out of GPU memory. batch_size reduced from 154 to 139
Error allocating 28467200 bytes of device memory (out of memory). Driver report 2318336 bytes free and 4294770688 bytes total
[Warning!] Out of GPU memory. batch_size reduced from 139 to 126
Error allocating 25804800 bytes of device memory (out of memory). Driver report 3366912 bytes free and 4294770688 bytes total
[Warning!] Out of GPU memory. batch_size reduced from 126 to 114
Error allocating 23347200 bytes of device memory (out of memory). Driver report 3366912 bytes free and 4294770688 bytes total
[Warning!] Out of GPU memory. batch_size reduced from 114 to 103
Error allocating 21094400 bytes of device memory (out of memory). Driver report 3366912 bytes free and 4294770688 bytes total
[Warning!] Out of GPU memory. batch_size reduced from 103 to 93
Error allocating 19046400 bytes of device memory (out of memory). Driver report 3366912 bytes free and 4294770688 bytes total
[Warning!] Out of GPU memory. batch_size reduced from 93 to 84
Error allocating 17203200 bytes of device memory (out of memory). Driver report 3366912 bytes free and 4294770688 bytes total
[Warning!] Out of GPU memory. batch_size reduced from 84 to 76
Error allocating 15564800 bytes of device memory (out of memory). Driver report 3366912 bytes free and 4294770688 bytes total
[Warning!] Out of GPU memory. batch_size reduced from 76 to 69
Error allocating 14131200 bytes of device memory (out of memory). Driver report 3366912 bytes free and 4294770688 bytes total
[Warning!] Out of GPU memory. batch_size reduced from 69 to 63
Error allocating 12902400 bytes of device memory (out of memory). Driver report 3366912 bytes free and 4294770688 bytes total
[Warning!] Out of GPU memory. batch_size reduced from 63 to 57
Error allocating 11673600 bytes of device memory (out of memory). Driver report 3366912 bytes free and 4294770688 bytes total
[Warning!] Out of GPU memory. batch_size reduced from 57 to 52
Error allocating 10649600 bytes of device memory (out of memory). Driver report 3366912 bytes free and 4294770688 bytes total
[Warning!] Out of GPU memory. batch_size reduced from 52 to 47
Error allocating 9625600 bytes of device memory (out of memory). Driver report 3366912 bytes free and 4294770688 bytes total
[Warning!] Out of GPU memory. batch_size reduced from 47 to 43
Error allocating 8806400 bytes of device memory (out of memory). Driver report 3366912 bytes free and 4294770688 bytes total
[Warning!] Out of GPU memory. batch_size reduced from 43 to 39