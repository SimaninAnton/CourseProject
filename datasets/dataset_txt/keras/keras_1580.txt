Contributor
noahstier commented on 21 Oct 2017 â€¢
edited
I think the ImageDataGenerator is doing sample-wise normalization wrong. The goal should be "subtracting the mean from each image, then rescaling it so that the standard deviation across its pixels is equal to some constant", quoted from Goodfellow et al's Deep Learning.
In other words it should uniformly normalize pixels by the image's mean/std across all pixels and channels.
Instead, it is normalizing each pixel separately by that pixel's own mean/std across channels.
https://github.com/fchollet/keras/blob/0ff700abccc71ceb0794ddc8e77945e178f10599/keras/preprocessing/image.py#L528-L532
Correct would be
img_row_axis = self.row_axis - 1
img_col_axis = self.col_axis - 1
img_channel_axis = self.channel_axis - 1
if self.samplewise_center: 
    x -= np.mean(x, axis=(img_channel_axis, img_row_axis, img_col_axis), keepdims=True)
if self.samplewise_std_normalization: 
    x /= (np.std(x, axis=(img_channel_axis, img_row_axis, img_col_axis), keepdims=True) + 1e-7)