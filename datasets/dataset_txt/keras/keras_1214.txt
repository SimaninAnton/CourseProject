alekseynp commented on 28 Feb 2018
Calling fit_generator with validation_data as a sequence works as expected for workers > 0 but fails for workers == 0.
I get:
Traceback (most recent call last):
  File "sequence_test.py", line 27, in <module>
    workers=0
  File "/home/aplotnicki/envs/tf/lib/python3.5/site-packages/keras/legacy/interfaces.py", line 87, in wrapper
    return func(*args, **kwargs)
  File "/home/aplotnicki/envs/tf/lib/python3.5/site-packages/keras/engine/training.py", line 2169, in fit_generator
    use_multiprocessing=use_multiprocessing)
  File "/home/aplotnicki/envs/tf/lib/python3.5/site-packages/keras/legacy/interfaces.py", line 87, in wrapper
    return func(*args, **kwargs)
  File "/home/aplotnicki/envs/tf/lib/python3.5/site-packages/keras/engine/training.py", line 2280, in evaluate_generator
    generator_output = next(output_generator)
TypeError: 'TestSequence' object is not an iterator
When running the following script. If workers > 0 there is no problem.
import keras.utils
from keras.models import Model, Input
import numpy as np

class TestSequence(keras.utils.Sequence):
    def __init__(self):
        pass
        
    def __len__(self):
        return 1
    
    def __getitem__(self, idx):
        return np.array([1.]), np.array([1.])
    
def TestGenerator():
    while True:
        yield np.array([1.]), np.array([1.])
        
input = Input((None,))
model = Model(input, input)
model.compile(optimizer='adam', loss='mse')

model.fit_generator(
    TestGenerator(),
    steps_per_epoch=10,
    validation_data=TestSequence(),
    workers=0
)
Why would I want to do this? Testing related to investigating thread safety of my generator and sequence implementations.
What probably causes this?
I expect that this line leads to code that handles sequences, but at the else clause, this line does not.
Checkboxes:
Check that you are up-to-date with the master branch of Keras. You can update with:
pip install git+git://github.com/keras-team/keras.git --upgrade --no-deps
Cloned and installed from github as at now. 6b2a04f
If running on TensorFlow, check that you are up-to-date with the latest version. The installation instructions can be found here.
tensorflow.version == 1.4.0
Don't believe this is significant.
Provide a link to a GitHub Gist of a Python script that can reproduce your issue (or just copy the script here if it is short).