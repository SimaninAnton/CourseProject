abhishekpatnia commented on 5 Mar 2017
Problem
I am unable to force Keras + Theano to use more than 1 thread using OpenBLAS. Script used:
import numpy as np
from keras.layers import Input, Dense
from keras.models import Model

# this returns a tensor
inputs = Input(shape=(1024000,))

# a layer instance is callable on a tensor, and returns a tensor
x = Dense(256, activation='relu')(inputs)
x = Dense(256, activation='relu')(x)
predictions = Dense(10000, activation='softmax')(x)

model = Model(input=inputs, output=predictions)
model.compile(optimizer='rmsprop',
              loss='categorical_crossentropy',
              metrics=['accuracy'])

for i in range(100000):
    print i
    model.predict(np.random.rand(1, 1024000))
Command used to run this script
THEANO_FLAGS='device=cpu,openmp=True,blas.ldflags=-lopenblas' OMP_NUM_THREADS=12 KERAS_BACKEND=theano python simple_model.py
Any help will be great. Thanks.
System setup
CPU with 12 cores
BLAS using OpenBLAS
Theano Bleeding Edge installation
Due Diligence
By using htop confirmed that OpenBLAS is using all cores by using Theano check_blas script.
By using htop Confirmed that Numpy is using OpenBLAS and all cores by using following script:
import numpy as np

def test_eigenvalue():
    i = 500
    data = np.random.rand(i, i)
    np.linalg.eig(data)

for i in range(100000):
    test_eigenvalue()