siavash9000 commented on 17 Jun 2016 â€¢
edited
Hello,
I encountered a problem, which I guess is a Bug. I do combine TimeDistributed with LSTM and run into a broadcast problem when I use the LSTM with parameter consume_less='cpu' :
ValueError: operands could not be broadcast together with shapes (50,64) (100,64) (50,64)
Using the LSTM with parameter consume_less='gpu' works.
Code in Github(link):
from keras.models import Model
from keras.utils import np_utils
from keras.layers import Dense, Embedding, Input, TimeDistributed, LSTM,  \
    Activation
import numpy as np


def main():
    DATA_SIZE = 1000
    BATCH_SIZE = 100
    WORD_COUNT = 20
    WORD_LENGTH = 10
    CHAR_VOCAB_SIZE = 50
    NB_CLASSES = 5
    CONSUME_LESS = 'cpu'

    X = np.random.randint(CHAR_VOCAB_SIZE, size=(DATA_SIZE, WORD_COUNT, WORD_LENGTH))
    Y = np.random.randint(NB_CLASSES, size=DATA_SIZE)
    Y = np_utils.to_categorical(Y, NB_CLASSES)

    input = Input(batch_shape=(BATCH_SIZE,WORD_COUNT, WORD_LENGTH, ),
                  dtype='int32')
    embedded = TimeDistributed(Embedding(CHAR_VOCAB_SIZE, 128,
                                         input_length=WORD_COUNT))(input)
    char_lstm = TimeDistributed(LSTM(64, consume_less=CONSUME_LESS))(embedded)
    lstm = LSTM(64,consume_less=CONSUME_LESS)(char_lstm)
    dense = Dense(NB_CLASSES, activation='sigmoid')(lstm)
    output = Activation('softmax')(dense)
    model = Model(input=input, output=output)
    model.compile(loss='categorical_crossentropy', optimizer='adam',
                  metrics=['accuracy'])
    model.fit(X, Y, batch_size=BATCH_SIZE, nb_epoch=5)


if __name__ == "__main__":
    main()
Please make sure that the boxes below are checked before you submit your issue. Thank you!
Check that you are up-to-date with the master branch of Keras. You can update with:
pip install git+git://github.com/fchollet/keras.git --upgrade --no-deps
If running on Theano, check that you are up-to-date with the master branch of Theano. You can update with:
pip install git+git://github.com/Theano/Theano.git --upgrade --no-deps
Provide a link to a GitHub Gist of a Python script that can reproduce your issue (or just copy the script here if it is short).