Extract progress stream logic into a separate library