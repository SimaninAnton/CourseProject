ARF1 commented on Dec 1, 2014
I am using requests to read redirection targets from 302 responses for a list of urls.
The core function is:
def getRedirect(url):
    print('requesting: %s' % url)
    request = reqsSess.head(url)
    print('done: %s' % url)
    request.raise_for_status()
    location = request.headers['location']
    request.close()
    return location
To avoid I/O lock, I am using gevent to spawn a separate getRedirect for all urls in my list (about 1000) and wanted to use requests' adapter rate limiting. Here I limited to one connection for testing purposes, but obviously the idea was to raise this once confirmed the it works. (Note, raising to 2 makes no difference to the issue.)
import requests
connection_limit = 1
adapter = requests.adapters.HTTPAdapter(pool_connections=connection_limit,
                                        max_retries=3,
                                        pool_block=True)
reqsSess = requests.session()
reqsSess.mount('http://www.mydomain.com', adapter)
The problem is, that I only see "requesting: url1", etc only eight times. Then the script blocks. Am I doing something wrong? I thought this might be related to #1967 but adding request.close() did not help.