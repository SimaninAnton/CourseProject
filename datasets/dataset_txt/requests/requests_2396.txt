Contributor
zigmonty commented on Aug 18, 2012
HTTPDigestAuth always tries to make a request first and only responds with an Authorization header when it receives a 401 (and then promptly forgets). This doesn't match my understanding of how it's supposed to work and doesn't match the behaviour of browsers eg Chrome.
The correct behaviour (I believe) is to store the credentials information the server gives you, and send Authorization on all subsequent requests. The old server nonce, etc is reused but the client creates a new cnonce and increments the nonce counter. If the server decides to change its nonce, it will send a new 401.
Draft fix is here: 5017aeb
I'm storing the state in the HTTPDigestAuth object itself, which made some sort of sense to me. This means you have to reuse the same HTTPDigestAuth in subsequent requests to reuse the credentials.