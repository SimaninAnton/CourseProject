berndschultze commented on Jan 14, 2015
I always get "401 unauthorized" when trying to log in to a server which writes qop="auth,auth-int" in its answer. The problem doesn't exist with Curl.
I debugged the requests code and probably found the problem in auth.py. The function build_digest_header in class HTTPDigestAuth calculates
noncebit = "%s:%s:%s:%s:%s" % (nonce, ncvalue, cnonce, qop, HA2)
and gives back
base += ', qop="auth", nc=%s, cnonce="%s"' % (ncvalue, cnonce)
to the server.
So in our client digest calculation we use qop="auth,auth-int", which we take from the server response, and make the server use qop="auth" in its calculation by giving back this header.
While debugging I can log in correctly if I change noncebit on the fly to
noncebit = "%s:%s:%s:%s:%s" % (nonce, ncvalue, cnonce, "auth", HA2)
This would be my suggestion for the solution. Theqop for the calculation should be the same as we give back in our header.