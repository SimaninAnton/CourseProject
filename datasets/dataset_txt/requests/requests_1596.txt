shichao-an commented on Oct 25, 2014
I got the following error when running my code in Python 3.4 (Python 2.7 and 3.3 are fine):
Exception ignored in: <bound method API.__del__ of <u115.api.API object at 0x109dadb00>>
Traceback (most recent call last):
  File "/Users/shichao/envs/115wangpan-dl3/lib/python3.4/site-packages/u115/api.py", line 148, in __del__
    if self.auto_logout and self.has_logged_in:
  File "/Users/shichao/envs/115wangpan-dl3/lib/python3.4/site-packages/u115/api.py", line 195, in has_logged_in
    r = self.http.get(self.passport.checkpoint_url, params=params)
  File "/Users/shichao/envs/115wangpan-dl3/lib/python3.4/site-packages/u115/api.py", line 36, in get
    r = self.session.get(url, params=params)
  File "/Users/shichao/envs/115wangpan-dl3/lib/python3.4/site-packages/requests/sessions.py", line 469, in get
    return self.request('GET', url, **kwargs)
  File "/Users/shichao/envs/115wangpan-dl3/lib/python3.4/site-packages/requests/sessions.py", line 457, in request
    resp = self.send(prep, **send_kwargs)
  File "/Users/shichao/envs/115wangpan-dl3/lib/python3.4/site-packages/requests/sessions.py", line 563, in send
    adapter = self.get_adapter(url=request.url)
  File "/Users/shichao/envs/115wangpan-dl3/lib/python3.4/site-packages/requests/sessions.py", line 636, in get_adapter
    for (prefix, adapter) in self.adapters.items():
  File "/Users/shichao/envs/115wangpan-dl3/lib/python3.4/_collections_abc.py", line 484, in __iter__
    for key in self._mapping:
  File "/Users/shichao/envs/115wangpan-dl3/lib/python3.4/collections/__init__.py", line 87, in __iter__
    curr = root.next
ReferenceError: weakly-referenced object no longer exists
The source code is here: https://github.com/shichao-an/115wangpan/blob/master/u115/api.py#L147
I think maybe it's related to the features change in 3.4 pertinent to __del__ and weakref:
https://docs.python.org/3/library/gc.html#gc.garbage
https://docs.python.org/3/library/weakref.html#comparing-finalizers-with-del-methods
I wonder if there is any workaround.