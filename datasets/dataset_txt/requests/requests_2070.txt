ahmedtalhakhan commented on Jul 9, 2013
The documentation for response hooks says "If the callback function returns a value, it is assumed that it is to replace the data that was passed in. If the function doesnâ€™t return anything, nothing else is effected"
Now i am trying to return a value(int in my case) from my hook function and it throws an exception. This will be valid in all the cases when the return value is an object that DOESNOT have the raw() method defined for it.
Here is some code
def hook(resp,**kwargs):
    print resp.url
    return 1

def main()
    s = requests.Session()
    s.hooks = {"response":hook}
    r = s.get("http://localhost/index.html")
And here is the exception:
http://localhost/index.html
Traceback (most recent call last):
 File "/home/talha/ws/test.py", line 85, in <module>
   main()
 File "/home/talha/ws/test.py", line 72, in main
   r = s.get("http://localhost/index.html")
 File "/usr/lib/python2.7/site-packages/requests/sessions.py", line 347, in get
   return self.request('GET', url, **kwargs)
 File "/usr/lib/python2.7/site-packages/requests/sessions.py", line 335, in request
   resp = self.send(prep, **send_kwargs)
 File "/usr/lib/python2.7/site-packages/requests/sessions.py", line 446, in send
   extract_cookies_to_jar(self.cookies, request, r.raw)
 AttributeError: 'int' object has no attribute 'raw'
The code in sessions.py @line 446 is trying to extract cookies after the dispatch_hook..From source
    # Response manipulation hooks
    r = dispatch_hook('response', hooks, r, **kwargs)

    # Persist cookies
    extract_cookies_to_jar(self.cookies, request, r.raw)
Either the documentation needs to change or the handling needs to be re-worked. What is the best way to handle this ?