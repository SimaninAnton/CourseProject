guewen commented on Nov 23, 2012
Hi,
When we need to POST a request containing a JSON-encoded body along with files, we get a cannot encode objects that are not 2-tuples error.
An example of such an API is https://www.pingen.com/en/developer/endpoints-documents.html, see in the upload tab.
File "/home/gbaconnier/buildout/eggs/requests-0.14.2-py2.7.egg/requests/api.py", line 98, in post
  return request('post', url, data=data, **kwargs)
File "/home/gbaconnier/buildout/eggs/requests-0.14.2-py2.7.egg/requests/safe_mode.py", line 31, in wrapped
  return function(method, url, **kwargs)
File "/home/gbaconnier/buildout/eggs/requests-0.14.2-py2.7.egg/requests/api.py", line 51, in request
  return session.request(method=method, url=url, **kwargs)
File "/home/gbaconnier/buildout/eggs/requests-0.14.2-py2.7.egg/requests/sessions.py", line 241, in request
  r.send(prefetch=prefetch)
File "/home/gbaconnier/buildout/eggs/requests-0.14.2-py2.7.egg/requests/models.py", line 532, in send
  (body, content_type) = self._encode_files(self.files)
File "/home/gbaconnier/buildout/eggs/requests-0.14.2-py2.7.egg/requests/models.py", line 358, in _encode_files
  fields = to_key_val_list(self.data)
File "/home/gbaconnier/buildout/eggs/requests-0.14.2-py2.7.egg/requests/utils.py", line 157, in to_key_val_list
  raise ValueError('cannot encode objects that are not 2-tuples')
ValueError: cannot encode objects that are not 2-tuples
So I have data as str (json-encoded) and files being a dict with a tuple.
That's because on line 532, self._encode_files is called when we have files and in this method, at line 358, data is expected to not be a str.