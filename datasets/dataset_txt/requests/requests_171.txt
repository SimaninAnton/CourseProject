lega911 commented on Oct 22, 2018
requests.post in loop creates new connection every time and doesn't close it, after 30sec it throw exception:
raise ConnectionError(e, request=request)
requests.exceptions.ConnectionError: HTTPConnectionPool(host='127.0.0.1', port=30100): Max retries exceeded with url: / (Caused by NewConnectionError('<urllib3.connection.HTTPConnection object at 0x7f4ee5
043c18>: Failed to establish a new connection: [Errno 99] Cannot assign requested address'))
Expected Result
I expect requests.post closes connection on finish (or at least reuse old connection), instead a server supports keep-alive, so server left connection and requests doesn't disconnect, it it's ok for session, but for 1 request connection should be close, anyway requests doesn't use that (old) opened connection.
Actual Result
requests.post throws exception
Reproduction Steps
Client (2.py):
import requests
for i in range(100000):
    r = requests.post('http://127.0.0.1:30100/', data=b'Hi')
Server:
import asyncio
from aiohttp import web

async def handle(request):
    return web.Response(text='OK', status=200)

app = web.Application()
app.router.add_route('*', '/{tail:.*}', handle)
web.run_app(app, host='0.0.0.0', port=30100)
I start a few copies: python3.7 2.py & python3.7 2.py & python3.7 2.py & python3.7 2.py &
Info
If I use headers={"Connection": "close"}, it works without problems
System Information
$ python -m requests.help
{
  "chardet": {
    "version": "3.0.4"
  },
  "cryptography": {
    "version": ""
  },
  "idna": {
    "version": "2.6"
  },
  "implementation": {
    "name": "CPython",
    "version": "3.7.0"
  },
  "platform": {
    "release": "4.15.0-36-generic",
    "system": "Linux"
  },
  "pyOpenSSL": {
    "openssl_version": "",
    "version": null
  },
  "requests": {
    "version": "2.20.0"
  },
  "system_ssl": {
    "version": "1000207f"
  },
  "urllib3": {
    "version": "1.22"
  },
  "using_pyopenssl": false
}
Traceback
    r = requests.post('http://127.0.0.1:30100/', data=b'Hi')
  File "/home/lega/.local/lib/python3.7/site-packages/requests/api.py", line 116, in post
    return request('post', url, data=data, json=json, **kwargs)
  File "/home/lega/.local/lib/python3.7/site-packages/requests/api.py", line 60, in request
    conn.request(method, url, **httplib_request_kw)
  File "/usr/local/lib/python3.7/http/client.py", line 1229, in request
    return session.request(method=method, url=url, **kwargs)
  File "/home/lega/.local/lib/python3.7/site-packages/requests/sessions.py", line 524, in request
    self._send_request(method, url, body, headers, encode_chunked)
  File "/usr/local/lib/python3.7/http/client.py", line 1275, in _send_request
    resp = self.send(prep, **send_kwargs)
  File "/home/lega/.local/lib/python3.7/site-packages/requests/sessions.py", line 637, in send
    self._send_request(method, url, body, headers, encode_chunked)
    r = adapter.send(request, **kwargs)
  File "/usr/local/lib/python3.7/http/client.py", line 1275, in _send_request
  File "/home/lega/.local/lib/python3.7/site-packages/requests/adapters.py", line 516, in send
    self.endheaders(body, encode_chunked=encode_chunked)
  File "/usr/local/lib/python3.7/http/client.py", line 1224, in endheaders
    raise ConnectionError(e, request=request)
requests.exceptions.ConnectionError: HTTPConnectionPool(host='127.0.0.1', port=30100): Max retries exceeded with url: / (Caused by NewConnectionError('<urllib3.connection.HTTPConnection object at 0x7f4ee5
043c18>: Failed to establish a new connection: [Errno 99] Cannot assign requested address'))
üëç 1