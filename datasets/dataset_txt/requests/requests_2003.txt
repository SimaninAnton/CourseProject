czardoz commented on Sep 3, 2013
This is a Wireshark capture of Firefox using an HTTPS proxy:
CONNECT ssl.gstatic.com:443 HTTP/1.1
User-Agent: Mozilla/5.0 (X11; Ubuntu; Linux x86_64; rv:23.0) Gecko/20100101 Firefox/23.0
Proxy-Connection: keep-alive
Connection: keep-alive
Host: ssl.gstatic.com

HTTP/1.1 200 Connection Established
Content-Length: 0

<cert exchange, and other stuff>
Same URL, using requests:
GET https://sni.velox.ch/ HTTP/1.1
Host: sni.velox.ch
Accept-Encoding: gzip, deflate, compress
Accept: */*
User-Agent: Mozilla/5.0
Here the proxy closed the connection, because the https:// scheme isn't recognized by the proxy. The expected behavior is that a "CONNECT" request is sent to the proxy.
Python code used:
import requests

proxies = {'https': 'http://127.0.0.1:8000/'}
user_agent = {'User-Agent': 'Mozilla/5.0'}

resp = requests.get("https://sni.velox.ch/", proxies=proxies, headers=user_agent)
print resp.status_code
print resp.content
Traceback:
Traceback (most recent call last):
  File "test_client.py", line 25, in <module>
    resp = requests.get("https://sni.velox.ch/", proxies=proxies, headers=user_agent)
  File "/home/aniket/venv/py2sni/local/lib/python2.7/site-packages/requests/api.py", line 55, in get
    return request('get', url, **kwargs)
  File "/home/aniket/venv/py2sni/local/lib/python2.7/site-packages/requests/api.py", line 44, in request
    return session.request(method=method, url=url, **kwargs)
  File "/home/aniket/venv/py2sni/local/lib/python2.7/site-packages/requests/sessions.py", line 360, in request
    resp = self.send(prep, **send_kwargs)
  File "/home/aniket/venv/py2sni/local/lib/python2.7/site-packages/requests/sessions.py", line 463, in send
    r = adapter.send(request, **kwargs)
  File "/home/aniket/venv/py2sni/local/lib/python2.7/site-packages/requests/adapters.py", line 327, in send
    raise ConnectionError(e)
requests.exceptions.ConnectionError: HTTPConnectionPool(host='127.0.0.1', port=8000): Max retries exceeded with url: https://sni.velox.ch/ (Caused by <class 'httplib.BadStatusLine'>: '')
Requests version: 1.2.3
Python version: 2.7.3