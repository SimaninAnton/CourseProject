tidoublemy commented on Jul 29, 2013
This issue appears to be specific to Python 3 (with requests 1.2.3), and I believe it only occurs with cookies that specify port numbers. It looks to me like the "MockRequest" object defined in cookies.py provides a get_host() method that would work here, but the code inside cookiejar.py tries to go directly to the host attribute, bypassing the mock. Below is a stack trace showing the issue:
Python 3.3.1 (v3.3.1:d9893d13c628, Apr 6 2013, 20:30:21) [MSC v.1600 64 bit (AMD64)] on win32
Type "help", "copyright", "credits" or "license" for more information.
import requests
request = requests.head('https://cloudsquid.redewt.net:2083/')
Traceback (most recent call last):
File "", line 1, in
File "C:\Python33\lib\site-packages\requests\api.py", line 77, in head
return request('head', url, *_kwargs)
File "C:\Python33\lib\site-packages\requests\api.py", line 44, in request
return session.request(method=method, url=url, *_kwargs)
File "C:\Python33\lib\site-packages\requests\sessions.py", line 335, in request
resp = self.send(prep, *_send_kwargs)
File "C:\Python33\lib\site-packages\requests\sessions.py", line 438, in send
r = adapter.send(request, *_kwargs)
File "C:\Python33\lib\site-packages\requests\adapters.py", line 337, in send
r = self.build_response(request, resp)
File "C:\Python33\lib\site-packages\requests\adapters.py", line 176, in build_response
extract_cookies_to_jar(response.cookies, req, resp)
File "C:\Python33\lib\site-packages\requests\cookies.py", line 109, in extract_cookies_to_jar
jar.extract_cookies(res, req)
File "C:\Python33\lib\http\cookiejar.py", line 1647, in extract_cookies
if self._policy.set_ok(cookie, request):
File "C:\Python33\lib\http\cookiejar.py", line 931, in set_ok
if not fn(cookie, request):
File "C:\Python33\lib\http\cookiejar.py", line 1044, in set_ok_port
req_port = request_port(request)
File "C:\Python33\lib\http\cookiejar.py", line 628, in request_port
host = request.host
AttributeError: 'MockRequest' object has no attribute 'host'