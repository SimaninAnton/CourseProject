hiranya911 commented on Aug 27, 2017
I have a server that is misbehaving slightly when sending 304 responses. It sends a 304 Not Modified response with an empty response body, but with Content-Length: 4 and Content-Type: application/json; charset=utf-8 in the header header. This seems to break the requests session:
session = requests.Session()
print 'Send req 1'
resp = session.request('get', url, headers={'if-none-match': etag, 'Authorization' : 'Bearer ' + token})
print resp.status_code, resp.headers

print 'Send req 2'
resp = session.request('get', url, headers={'if-none-match': etag, 'Authorization' : 'Bearer ' + token})
print resp.status_code, resp.headers
The call to second request simply hangs, and never returns.
Expected Result
Either both requests should complete normally, or an exception should be raised.
Actual Result
The first request leaves the session in some broken state, so any subsequent call will simply appear to be stuck.
Reproduction Steps
See above.
System Information
$ python -m requests.help
{
  "chardet": {
    "version": "3.0.4"
  }, 
  "cryptography": {
    "version": ""
  }, 
  "idna": {
    "version": "2.6"
  }, 
  "implementation": {
    "name": "CPython", 
    "version": "2.7.10"
  }, 
  "platform": {
    "release": "16.7.0", 
    "system": "Darwin"
  }, 
  "pyOpenSSL": {
    "openssl_version": "", 
    "version": null
  }, 
  "requests": {
    "version": "2.18.4"
  }, 
  "system_ssl": {
    "version": "9081df"
  }, 
  "urllib3": {
    "version": "1.22"
  }, 
  "using_pyopenssl": false
}