steelliberty commented on Apr 19, 2017
While using grequests I get the following error after running a program which repeatedly checks a batch of urls to determine if the sites are up.
For simplicity say I do this :
I have 50 urls.
I created an httpmonitor module that is handed the urls and then the module is sent to a background/thread-with-Queue.
The httpmonitor checks all the urls using standard grequests structure such as this :
max_workers = 10 now but I have tried from 50 down to 3
r = (grequests.head(url, callback=timeme, timeout=3, allow_redirects=False, stream = False) for url in urls)
results = grequests.map(r, size=max_workers, exception_handler=handle_errors)
I deal with the results, update a database and then the thread finishes and independently a new one is added to the Queue (for this example, with the same 50 urls) -- and this goes on and on..
Note. I explicitly close connections after each url is processed with either a Response.close() or a AsyncRequest.session.close() so I believe all connections are closed after each block of urls is processed.
Then I set it running and it runs until approximately 1500 requests are processed ( 30 blocks of 50 urls ) and then for a period of time all of the grequests fail with the error above Errno -11, System Error ( which I believe means OUT OF RESOURCES) .. Sometimes it will return to normal operation for a period, most of the time . it fails on all further attempts to access a connection.
Is there anymore information on this error that someone might share ?
Is there a way to ensure all resources are released outside of grequests?
Is there something else I have might have missed?
Note: I was able to increase the number times the blocks of urls could be checked by explicitly closing connections -- gaining an addition 400+ url checks -- but then the same error returned. It would seem some resource is not closing and accumulating over the batch runs..
Here is the exact error (url does not matter)
HTTPConnectionPool(host='www.yahoo.com', port=80): Max retries exceeded with url: / (Caused by NewConnectionError('<requests.packages.urllib3.connection.HTTPConnection object at 0x00007effa13b1ec0>: Failed to establish a new connection: [Errno -11] System error',))"
Any help or ideas would be appreciated, Thank you