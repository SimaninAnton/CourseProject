gawel commented on Sep 17, 2013
Headers are stored in a CaseInsensitiveDict but this class accept both bytes and str as key in python3. This result in duplicated headers when you want to provide Content-Type/Length by yourself.
When using python3 requests converts headers keys to bytes then set some headers with str as keys here https://github.com/kennethreitz/requests/blob/master/requests/models.py#L416 and here https://github.com/kennethreitz/requests/blob/master/requests/models.py#L422
This result in the fact that you can't provide those headers by yourself. Requests should always check if the header exist first (both with bytes and str key)
Or at least replace the existing key (bytes not str)
Example:
>>> from requests.structures import CaseInsensitiveDict
>>> d = CaseInsensitiveDict()
>>> d[b'Content-Type'] = 'text/html'
>>> 'Content-Type' in d
False
>>> d['Content-Type'] = 'application/json'
>>> d
CaseInsensitiveDict({b'Content-Type': 'text/html', 'Content-Type': 'application/json'})
>>> 