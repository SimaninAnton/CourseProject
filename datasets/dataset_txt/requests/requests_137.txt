dobey commented on Dec 11, 2018 â€¢
edited
When attempting to perform a chunked upload by passing a generator to put() as the data argument, while going through a proxy server (either unauthenticated or with basic auth), a ConnectionError is raised with the content of ("bad hanshake: Error([('SSL routines', 'ssl3_get_record', 'wrong version number')],)",). Connecting without proxy, and connecting via proxy with other libraries (pycurl), works as expected. I've verified the failure still occurs with the latest requests release. Proxy server in testing is Squid 3.5.20.
Expected Result
Successful connection.
Actual Result
ConnectionError
Reproduction Steps
import requests

def file_read(fileobj):
    while True:
        data = fileobj.read(1024 * 1024 * 4)
        if not data:
            break
        yield data


proxy_string = 'http://proxy.server:8080'
session = requests.Session()
session.proxies = {'http': proxy_string, 'https': proxy_string}
headers = {
    'Content-Type': 'application/octet-stream',
    'x-amz-acl': 'bucket-owner-full-control',
}
with open('/tmp/some-large-file', 'rb') as f:
    url = 'https://aws.bucket/path/to/some-large-file'
    requests.put(url, data=file_read(f), headers=headers)
System Information
Python 2.7.13 with requests 2.18.4 (though reproduced with 2.20.1 on same system), in virtualenv, connecting via Squid 3.5.20 proxy server with either basic auth, or no authentication.