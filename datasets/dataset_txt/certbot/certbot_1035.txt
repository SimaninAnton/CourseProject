ioquatix commented on 3 Aug 2017
My operating system is (include version):
Arch Linux.
I installed Certbot with (certbot-auto, OS package manager, pip, etc):
pacman.
I ran this command and it produced this output:
certbot --nginx
Obtaining a new certificate                    
Performing the following challenges:           
tls-sni-01 challenge for www.oriontransfer.co.nz                                               
2017/08/03 12:24:21 [notice] 16070#16070: signal process started                               
Waiting for verification...                    
Cleaning up challenges                         
2017/08/03 12:24:25 [notice] 16111#16111: signal process started                               
Failed authorization procedure. www.oriontransfer.co.nz (tls-sni-01): urn:acme:error:unauthorized :: The client lacks sufficient authorization :: Incorrect validation certificate for tls-sni-01 challenge. Requested a67b625d9d3d67593da870487bcdb148.018cfdb04ab0f722b5fd6efcc5985a82.acme.invalid from [2600:3c01::f03c:91ff:fe18:f29b]:443. Received 2 certificate(s), first certificate had names "www.codeotaku.com"                  

IMPORTANT NOTES:                               
 - The following errors were reported by the server:                                           

   Domain: www.oriontransfer.co.nz             
   Type:   unauthorized                        
   Detail: Incorrect validation certificate for tls-sni-01 challenge.                          
   Requested                                   
   a67b625d9d3d67593da870487bcdb148.018cfdb04ab0f722b5fd6efcc5985a82.acme.invalid              
   from [2600:3c01::f03c:91ff:fe18:f29b]:443. Received 2                                       
   certificate(s), first certificate had names "www.codeotaku.com"                             

   To fix these errors, please make sure that your domain name was                             
   entered correctly and the DNS A/AAAA record(s) for that domain                              
   contain(s) the right IP address.        
Certbot's behavior differed from what I expected because:
It failed to work.
% cat /etc/letsencrypt/le_tls_sni_01_cert_challenge.conf                                  
server{listen 443 ssl;listen [::]:80;listen 80;server_name a67b625d9d3d67593da870487bcdb148.018cfdb04ab0f722b5fd6efcc5985a82.acme.invalid;access_log /var/lib/letsencrypt/access.log;error_log /var/lib/letsencrypt/error.log;ssl_certificate /var/lib/letsencrypt/y-8MD6q138De16R5MsgiWYVMBUFjHj4up49XQoiEsMw.crt;ssl_certificate_key /var/lib/letsencrypt/y-8MD6q138De16R5MsgiWYVMBUFjHj4up49XQoiEsMw.pem;include /etc/letsencrypt/options-ssl-nginx.conf;location /{root /var/lib/letsencrypt/tls_sni_01_page;}}%      
The problem is, there is an existing host with listen [::]:443 ssl http2; and it appears the request is going via IPv6. Shouldn't that config also include listen [::]:443 ssl; at least?