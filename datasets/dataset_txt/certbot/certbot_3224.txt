turowicz commented on 21 Oct 2015
Problem Overview
Trying to generate a certificate on a Ubuntu box. My web app is running on a different server (Windows) but has been configured to serve the requested JSON with application/jose+json header.
Attempt to run
sudo docker run -it --rm -p 443:443 --name letsencrypt -v "/etc/letsencrypt:/etc/letsencrypt" -v "/var/lib/letsencrypt:/var/lib/letsencrypt" quay.io/letsencrypt/letsencrypt:latest auth
Agree
Manual
Entered a domain name
Copy the requested URL and make sure it is returning the correct JSON with correct headers. Encoding is UTF8.
Get message Self-verify of challenge failed, authorization abandoned.
Get message Incomplete authorizations
Example JSON requested by letsencrypt
{"header": {"alg": "RS256", "jwk": {"e": "AQAB", "kty": "RSA", "n": "uKTwp2GuJOUPG1H2WWaHN-_RNpn9JWQUvvHJYm5Ma9Zx1uh_SNSBiuB3KEYKr1TLcWR1hZjU9iM6ua3HIlFikAzR9Ntn_aAbiUSjVJM8_Koh5H-uXeJIusOeLAesYterpeNFay4t9XtylZYCFIVJhvyWOWOlgLbW-8LhirXu2L1i1HtbIQ7YiiaQr6sOfMPLV7bVL7pgKdmnbDg3mERkdXfwjzOEJPWk_FcVcLoG6Ra7HTtfoSQoQFApXBj4gyEvJLmlLtcFM1OT0WdiiUt_8IKnSzmAcN5oJLA0rgsvQ5gwz7fjUU5esy6Q2fnqpkJp3lxqFrJe7jUBIVpZdH-mXQ"}}, "payload": "eyJ0bHMiOiBmYWxzZSwgInRva2VuIjogImxnZ01ERHhpWjUweGRBMjBEZ1ktb1lwY3NLME1SaG85WlEzSGhqUUwybjgiLCAidHlwZSI6ICJzaW1wbGVIdHRwIn0", "signature": "drPBmcfe5iBxAmGVndxbRZpM6agBl-mU5yEEfB-gYhh1Bnt0bviTRgt6YQnF-GKHIegSXafLRWnpdnjme5OqsUgd03HZaNpq6M5VPsDTbe_c3g-d9BwKcdqBFpx_tmiLDBHKYgCKmOAIQ8PIuAZkA_hLbGbgXG-YmtLsvujqklQp3Pfc0dxnkbY7khOJZfaG-o-4eDU9F60gMeIhsVr6MPXXxe6An3lWf1Rn4HtKOyivjHisXxOl3TygKM4dC7IaZzJ-AhcSgowiDEhFv69hgUC097L9iNvU7HHVv3I6XgKh65l1Y7dwVuG6ZwYdF5cT6Yzw9mK4aH6t7HnKScsteQ"}
Example JSON result
{
  "header": {
    "jwk": {
      "n": "uKTwp2GuJOUPG1H2WWaHN-_RNpn9JWQUvvHJYm5Ma9Zx1uh_SNSBiuB3KEYKr1TLcWR1hZjU9iM6ua3HIlFikAzR9Ntn_aAbiUSjVJM8_Koh5H-uXeJIusOeLAesYterpeNFay4t9XtylZYCFIVJhvyWOWOlgLbW-8LhirXu2L1i1HtbIQ7YiiaQr6sOfMPLV7bVL7pgKdmnbDg3mERkdXfwjzOEJPWk_FcVcLoG6Ra7HTtfoSQoQFApXBj4gyEvJLmlLtcFM1OT0WdiiUt_8IKnSzmAcN5oJLA0rgsvQ5gwz7fjUU5esy6Q2fnqpkJp3lxqFrJe7jUBIVpZdH-mXQ",
      "kty": "RSA",
      "e": "AQAB"
    },
    "alg": "RS256"
  },
  "signature": "drPBmcfe5iBxAmGVndxbRZpM6agBl-mU5yEEfB-gYhh1Bnt0bviTRgt6YQnF-GKHIegSXafLRWnpdnjme5OqsUgd03HZaNpq6M5VPsDTbe_c3g-d9BwKcdqBFpx_tmiLDBHKYgCKmOAIQ8PIuAZkA_hLbGbgXG-YmtLsvujqklQp3Pfc0dxnkbY7khOJZfaG-o-4eDU9F60gMeIhsVr6MPXXxe6An3lWf1Rn4HtKOyivjHisXxOl3TygKM4dC7IaZzJ-AhcSgowiDEhFv69hgUC097L9iNvU7HHVv3I6XgKh65l1Y7dwVuG6ZwYdF5cT6Yzw9mK4aH6t7HnKScsteQ",
  "payload": "eyJ0bHMiOiBmYWxzZSwgInRva2VuIjogImxnZ01ERHhpWjUweGRBMjBEZ1ktb1lwY3NLME1SaG85WlEzSGhqUUwybjgiLCAidHlwZSI6ICJzaW1wbGVIdHRwIn0"
}
Verbose Log
2015-10-21 12:24:59,088:INFO:letsencrypt.cli:Saving debug log to /tmp/le/logs/letsencrypt.log
2015-10-21 12:24:59,128:INFO:requests.packages.urllib3.connectionpool:Starting new HTTPS connection (1): acme-staging.api.letsencrypt.org
2015-10-21 12:24:59,356:INFO:requests.packages.urllib3.connectionpool:Starting new HTTPS connection (1): acme-staging.api.letsencrypt.org
2015-10-21 12:24:59,561:INFO:requests.packages.urllib3.connectionpool:Starting new HTTPS connection (1): acme-staging.api.letsencrypt.org
2015-10-21 12:24:59,821:INFO:requests.packages.urllib3.connectionpool:Starting new HTTPS connection (1): acme-staging.api.letsencrypt.org
2015-10-21 12:25:00,073:INFO:letsencrypt.reporter:Reporting to user: Your account credentials have been saved in your Let's Encrypt configuration directory at /tmp/le/conf. You should make a secure backup of this folder now. This configuration directory will also contain certificates and private keys obtained by Let's Encrypt so making regular backups of this folder is ideal.
2015-10-21 12:25:00,073:INFO:letsencrypt.reporter:Reporting to user: If you lose your account credentials, you can recover through e-mails sent to wojtek@mailcloud.com.
2015-10-21 12:25:00,273:INFO:letsencrypt.crypto_util:Generating key (2048 bits): /tmp/le/conf/keys/0000_key-letsencrypt.pem
2015-10-21 12:25:00,275:INFO:letsencrypt.crypto_util:Creating CSR: /tmp/le/conf/csr/0000_csr-letsencrypt.pem
2015-10-21 12:25:00,279:INFO:requests.packages.urllib3.connectionpool:Starting new HTTPS connection (1): acme-staging.api.letsencrypt.org
2015-10-21 12:25:00,502:INFO:letsencrypt.auth_handler:Performing the following challenges:
2015-10-21 12:25:00,503:INFO:letsencrypt.auth_handler:simpleHttp challenge for swpr.me
Make sure your web server displays the following content at
http://swpr.me/.well-known/acme-challenge/url1M-ymI5Zr7LO2kPIH1_f2f0kFddfZFd7lrucErHY before continuing:

{"header": {"alg": "RS256", "jwk": {"e": "AQAB", "kty": "RSA", "n": "u4vCJUBHjYmKFzbMDAd1de7d3iUooTkEqbgYmMRLSJbXSX0W4Ec7yhqJlo2hRPC643CcvSVbAvgpr6BztDw4z17bWOrdsSNTL9ClwUnjF52z_e26qrAOwbS_gaxfGWBxRQNNuWXnW-GYpjuRR6jT_8N7qmqY-cnI2l2287aYk93fQlXQN5BDZwiQjoQuez4EzYOEEu4gmTxx0MRjqxCJ6A6k9iq9kD-4xvKSvYOf2-_DIWpI6y7jrqhQAYar_hXyqS_iJSJEZu1YQxn2BgSnF7X8nibCrxSgNM_wjECx0ddl849KGE_cALxMqcIk9-BAgIT0_f3meImnyQDnUE4yvw"}}, "payload": "eyJ0bHMiOiBmYWxzZSwgInRva2VuIjogInVybDFNLXltSTVacjdMTzJrUElIMV9mMmYwa0ZkZGZaRmQ3bHJ1Y0VySFkiLCAidHlwZSI6ICJzaW1wbGVIdHRwIn0", "signature": "ZkeC-KcN9uCqMcwNi6y1j9wFwUoPSDf1US5C2R3F8vIyb9W51X0x8ipOdOzwunf2xvwmSn6gp3VNBX3HsYdFWLWu7PX86iCP2G_loVdUJen5IlppgFlz8nK4fGXDDaVRwXLV3FfO6NBMV2cSWldKZLbpEqA9-NOaH95xQE-Y8NdoObHAd7C1tfTc1c538DvBs86dlDGiYBXn8k9gq0iuYYJHcKDUnKvUhwNrFy8yH6iVfJjqMVe4sV0xuQKUDqK15_Lv3y7bacadzFbyXeOcqPic_zEGQtLxquCK0jwJwu2eMN95D-0-39qGxxqVoMbpwAfQTLN8Xyn4EO6Bgzcb6A"}

Content-Type header MUST be set to application/jose+json.

If you don't have HTTP server configured, you can run the following
command on the target server (as root):

mkdir -p /tmp/letsencrypt/public_html/.well-known/acme-challenge
cd /tmp/letsencrypt/public_html
echo -n '{"header": {"alg": "RS256", "jwk": {"e": "AQAB", "kty": "RSA", "n": "u4vCJUBHjYmKFzbMDAd1de7d3iUooTkEqbgYmMRLSJbXSX0W4Ec7yhqJlo2hRPC643CcvSVbAvgpr6BztDw4z17bWOrdsSNTL9ClwUnjF52z_e26qrAOwbS_gaxfGWBxRQNNuWXnW-GYpjuRR6jT_8N7qmqY-cnI2l2287aYk93fQlXQN5BDZwiQjoQuez4EzYOEEu4gmTxx0MRjqxCJ6A6k9iq9kD-4xvKSvYOf2-_DIWpI6y7jrqhQAYar_hXyqS_iJSJEZu1YQxn2BgSnF7X8nibCrxSgNM_wjECx0ddl849KGE_cALxMqcIk9-BAgIT0_f3meImnyQDnUE4yvw"}}, "payload": "eyJ0bHMiOiBmYWxzZSwgInRva2VuIjogInVybDFNLXltSTVacjdMTzJrUElIMV9mMmYwa0ZkZGZaRmQ3bHJ1Y0VySFkiLCAidHlwZSI6ICJzaW1wbGVIdHRwIn0", "signature": "ZkeC-KcN9uCqMcwNi6y1j9wFwUoPSDf1US5C2R3F8vIyb9W51X0x8ipOdOzwunf2xvwmSn6gp3VNBX3HsYdFWLWu7PX86iCP2G_loVdUJen5IlppgFlz8nK4fGXDDaVRwXLV3FfO6NBMV2cSWldKZLbpEqA9-NOaH95xQE-Y8NdoObHAd7C1tfTc1c538DvBs86dlDGiYBXn8k9gq0iuYYJHcKDUnKvUhwNrFy8yH6iVfJjqMVe4sV0xuQKUDqK15_Lv3y7bacadzFbyXeOcqPic_zEGQtLxquCK0jwJwu2eMN95D-0-39qGxxqVoMbpwAfQTLN8Xyn4EO6Bgzcb6A"}' > .well-known/acme-challenge/url1M-ymI5Zr7LO2kPIH1_f2f0kFddfZFd7lrucErHY
# run only once per server:
$(command -v python2 || command -v python2.7 || command -v python2.6) -c \
"import BaseHTTPServer, SimpleHTTPServer; \
SimpleHTTPServer.SimpleHTTPRequestHandler.extensions_map = {'': 'application/jose+json'}; \
s = BaseHTTPServer.HTTPServer(('', 80), SimpleHTTPServer.SimpleHTTPRequestHandler); \
s.serve_forever()" 
Press ENTER to continue
2015-10-21 12:25:40,798:INFO:requests.packages.urllib3.connectionpool:Starting new HTTP connection (1): swpr.me
2015-10-21 12:25:41,511:ERROR:letsencrypt.plugins.manual:Self-verify of challenge failed, authorization abandoned.
2015-10-21 12:25:41,511:INFO:letsencrypt.auth_handler:Waiting for verification...
2015-10-21 12:25:41,511:INFO:letsencrypt.auth_handler:Cleaning up challenges
Traceback (most recent call last):
  File "/opt/letsencrypt/venv/bin/letsencrypt", line 9, in <module>
    load_entry_point('letsencrypt==0.1.0.dev0', 'console_scripts', 'letsencrypt')()
  File "/opt/letsencrypt/src/letsencrypt/cli.py", line 1087, in main
    return args.func(args, config, plugins)
  File "/opt/letsencrypt/src/letsencrypt/cli.py", line 463, in auth
    _auth_from_domains(le_client, config, domains, plugins)
  File "/opt/letsencrypt/src/letsencrypt/cli.py", line 303, in _auth_from_domains
    lineage = le_client.obtain_and_enroll_certificate(domains, plugins)
  File "/opt/letsencrypt/src/letsencrypt/client.py", line 229, in obtain_and_enroll_certificate
    certr, chain, key, _ = self.obtain_certificate(domains)
  File "/opt/letsencrypt/src/letsencrypt/client.py", line 212, in obtain_certificate
    return self._obtain_certificate(domains, csr) + (key, csr)
  File "/opt/letsencrypt/src/letsencrypt/client.py", line 170, in _obtain_certificate
    authzr = self.auth_handler.get_authorizations(domains)
  File "/opt/letsencrypt/src/letsencrypt/auth_handler.py", line 87, in get_authorizations
    self.verify_authzr_complete()
  File "/opt/letsencrypt/src/letsencrypt/auth_handler.py", line 298, in verify_authzr_complete
    raise errors.AuthorizationError("Incomplete authorizations")
AuthorizationError: Incomplete authorizations
Questions
a) Is it a known issue?
b) Does output JSON formatting matter? ie. new lines and attribute ordering