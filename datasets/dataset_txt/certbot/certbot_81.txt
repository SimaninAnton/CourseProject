evoyy commented on 19 Sep 2019
OS: Debian 9, running inside a docker container
Certbot version: 0.28.0
Certbot installed with: apt-get install certbot
I have a strange problem with certbot and cron, where the post hook is not being run consistently. I have the following line in /etc/crontab to run certbot renew once per day:
20 9 * * * root certbot renew --quiet --post-hook 'nginx -s reload'
The certs are being checked/renewed successfully, but my post hook to restart nginx often isn't called. This was puzzling me for months until I discovered the log directory. If I look at the log files, it seems that the arguments are inconsistent for each invocation. Sometimes they are correct, other times reduced to a single "-q".
# cd /var/log/letsencrypt/
# ls -t | xargs grep DEBUG:certbot.main:Arguments

letsencrypt.log:2019-09-17 21:27:24,294:DEBUG:certbot.main:Arguments: ['--force-renewal', '--post-hook', 'nginx -s reload']
letsencrypt.log.1:2019-09-17 21:26:06,739:DEBUG:certbot.main:Arguments: ['-q']
letsencrypt.log.2:2019-09-17 09:20:02,650:DEBUG:certbot.main:Arguments: ['--quiet', '--post-hook', 'nginx -s reload']
letsencrypt.log.3:2019-09-17 00:09:45,196:DEBUG:certbot.main:Arguments: ['-q']
letsencrypt.log.4:2019-09-16 21:13:20,640:DEBUG:certbot.main:Arguments: ['-q']
letsencrypt.log.5:2019-09-16 09:20:02,928:DEBUG:certbot.main:Arguments: ['--quiet', '--post-hook', 'nginx -s reload']
letsencrypt.log.6:2019-09-16 03:26:56,162:DEBUG:certbot.main:Arguments: ['-q']
letsencrypt.log.7:2019-09-15 22:34:28,612:DEBUG:certbot.main:Arguments: ['-q']
letsencrypt.log.8:2019-09-15 09:20:01,554:DEBUG:certbot.main:Arguments: ['--quiet', '--post-hook', 'nginx -s reload']
letsencrypt.log.9:2019-09-15 07:02:16,911:DEBUG:certbot.main:Arguments: ['-q']
letsencrypt.log.10:2019-09-14 19:28:39,732:DEBUG:certbot.main:Arguments: ['-q']
letsencrypt.log.11:2019-09-14 11:19:41,202:DEBUG:certbot.main:Arguments: ['-q']
letsencrypt.log.12:2019-09-14 09:20:02,130:DEBUG:certbot.main:Arguments: ['--quiet', '--post-hook', 'nginx -s reload']
letsencrypt.log.13:2019-09-13 21:09:28,594:DEBUG:certbot.main:Arguments: ['-q']
letsencrypt.log.14:2019-09-13 09:20:01,524:DEBUG:certbot.main:Arguments: ['--quiet', '--post-hook', 'nginx -s reload']
letsencrypt.log.15:2019-09-13 07:58:41,964:DEBUG:certbot.main:Arguments: ['-q']
letsencrypt.log.16:2019-09-12 16:24:15,641:DEBUG:certbot.main:Arguments: ['-q']
letsencrypt.log.17:2019-09-12 09:20:03,041:DEBUG:certbot.main:Arguments: ['--quiet', '--post-hook', 'nginx -s reload']
letsencrypt.log.18:2019-09-12 01:30:13,291:DEBUG:certbot.main:Arguments: ['-q']
letsencrypt.log.19:2019-09-11 17:53:51,675:DEBUG:certbot.main:Arguments: ['-q']
letsencrypt.log.20:2019-09-11 09:20:02,115:DEBUG:certbot.main:Arguments: ['--quiet', '--post-hook', 'nginx -s reload']
letsencrypt.log.21:2019-09-11 09:05:20,559:DEBUG:certbot.main:Arguments: ['-q']
letsencrypt.log.22:2019-09-10 23:28:07,168:DEBUG:certbot.main:Arguments: ['-q']
letsencrypt.log.23:2019-09-10 09:20:02,059:DEBUG:certbot.main:Arguments: ['--quiet', '--post-hook', 'nginx -s reload']
letsencrypt.log.24:2019-09-10 03:30:07,894:DEBUG:certbot.main:Arguments: ['-q']
letsencrypt.log.25:2019-09-09 13:38:26,596:DEBUG:certbot.main:Arguments: ['-q']
letsencrypt.log.26:2019-09-09 09:30:03,008:DEBUG:certbot.main:Arguments: ['-q']
letsencrypt.log.27:2019-09-09 09:20:02,553:DEBUG:certbot.main:Arguments: ['--quiet', '--post-hook', 'nginx -s reload']
letsencrypt.log.28:2019-09-08 23:35:16,401:DEBUG:certbot.main:Arguments: ['-q']
letsencrypt.log.29:2019-09-08 09:20:01,767:DEBUG:certbot.main:Arguments: ['--quiet', '--post-hook', 'nginx -s reload']

... and so on ...
I wonder if there is some kind of configuration conflict / race condition going on. Is this a known issue? Any ideas how I can troubleshoot this further?