Member
bmw commented on 7 Jan 2017 â€¢
edited
Steps to reproduce:
Take the default Apache config and change the default vhost from <VirtualHost *:80> to <VirtualHost *>.
Run certbot -d <domain> --apache for any domain name pointing at that server.
Domain validation fails. The vhost the Apache plugin makes is something like the following:
<IfModule mod_ssl.c>
<VirtualHost *>
    ServerName 996de558c87bf78211dfe71c0cfa7f33.8bfada933e08175738f69ac8321bf840.acme.invalid
    UseCanonicalName on
    SSLStrictSNIVHostCheck on

    LimitRequestBody 1048576

    Include /etc/letsencrypt/options-ssl-apache.conf
    SSLCertificateFile /var/lib/letsencrypt/_Ql9ONFhja57j8csu0ORv8MGshr_1dtCyNa8AuP4h1Q.crt
    SSLCertificateKeyFile /var/lib/letsencrypt/_Ql9ONFhja57j8csu0ORv8MGshr_1dtCyNa8AuP4h1Q.pem

    DocumentRoot /var/lib/letsencrypt/tls_sni_01_page/
</VirtualHost>

</IfModule>
Trying to connect to the server using openssl s_client for the above ServerName causes:
140246747047576:error:140770FC:SSL routines:SSL23_GET_SERVER_HELLO:unknown protocol
At first glance the generated vhost looks right to me. Perhaps the problem is having both HTTP and HTTPS vhosts using <VirtualHost *> and we should make the challenge vhost <VirtualHost *:443> in this case?
Any thoughts @joohoi?