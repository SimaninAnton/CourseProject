blacktav commented on 1 Aug 2017
My operating system is (include version):
OpenSuSE Leap 42.2
I installed Certbot with (certbot-auto, OS package manager, pip, etc):
certbot-auto
I ran this command and it produced this output:
certbot-auto --apache -d bavaria.domain.net
Saving debug log to /var/log/letsencrypt/letsencrypt.log
Cert not yet due for renewal
You have an existing certificate that has exactly the same domains or certificate name you requested and isn't close to expiry.
(ref: /etc/letsencrypt/renewal/bavaria.domain.net.conf)
What would you like to do?
1: Attempt to reinstall this existing certificate
2: Renew & replace the cert (limit ~5 per 7 days)
Select the appropriate number [1-2] then [enter] (press 'c' to cancel): 1
Keeping the existing certificate
Created an SSL vhost at /etc/apache2/vhosts.d/bavaria-le-ssl.conf
Cannot find a cert or key directive in /files/etc/apache2/vhosts.d/bavaria-le-ssl.conf/IfModule/VirtualHost. VirtualHost was not modified
Unable to find cert and/or key directives
IMPORTANT NOTES:
Unable to install the certificate
Congratulations! Your certificate and chain have been saved at
/etc/letsencrypt/live/bavaria.domain.net/fullchain.pem. Your
cert will expire on 2017-10-29. To obtain a new or tweaked version
of this certificate in the future, simply run certbot-auto again
with the "certonly" option. To non-interactively renew all of
your certificates, run "certbot-auto renew"
Certbot's behavior differed from what I expected because:
Here is a Certbot log showing the issue (if available):
Logs are stored in /var/log/letsencrypt by default. Feel free to redact domains, e-mail and IP addresses as you see fit.
2017-07-31 20:00:11,385:DEBUG:certbot.main:certbot version: 0.16.0
2017-07-31 20:00:11,386:DEBUG:certbot.main:Arguments: ['--apache', '-d', 'bavaria.domain.net']
2017-07-31 20:00:11,386:DEBUG:certbot.main:Discovered plugins: PluginsRegistry(PluginEntryPoint#apache,PluginEntryPoint#manual,PluginEntryPoint#nginx,PluginEntryPoint#null,PluginEntryPoint#standalone,PluginEntryPoint#webroot)
2017-07-31 20:00:11,399:DEBUG:certbot.log:Root logging level set at 20
2017-07-31 20:00:11,399:INFO:certbot.log:Saving debug log to /var/log/letsencrypt/letsencrypt.log
2017-07-31 20:00:11,400:DEBUG:certbot.plugins.selection:Requested authenticator apache and installer apache
2017-07-31 20:00:11,515:DEBUG:certbot_apache.configurator:Apache version is 2.4.23
2017-07-31 20:00:11,837:DEBUG:certbot.plugins.selection:Single candidate plugin: * apache
Description: Apache Web Server plugin - Beta
Interfaces: IAuthenticator, IInstaller, IPlugin
Entry point: apache = certbot_apache.configurator:ApacheConfigurator
Initialized: <certbot_apache.configurator.ApacheConfigurator object at 0x7f0dfefc6950>
Prep: True
2017-07-31 20:00:11,838:DEBUG:certbot.plugins.selection:Selected authenticator <certbot_apache.configurator.ApacheConfigurator object at 0x7f0dfefc6950> and installer <certbot_apache.configurator.ApacheConfigurator object at 0x7f0dfefc6950>
2017-07-31 20:00:11,840:DEBUG:certbot.main:Picked account: <Account(RegistrationResource(body=Registration(status=None, contact=(u'mailto:sysadmin@domain.com',), agreement=u'https://letsencrypt.org/documents/LE-SA-v1.1.1-August-1-2016.pdf', key=JWKRSA(key=<ComparableRSAKey(<cryptography.hazmat.backends.openssl.rsa._RSAPublicKey object at 0x7f0dfed78050>)>)), uri=u'https://acme-v01.api.letsencrypt.org/acme/reg/17810740', new_authzr_uri=u'https://acme-v01.api.letsencrypt.org/acme/new-authz', terms_of_service=u'https://letsencrypt.org/documents/LE-SA-v1.1.1-August-1-2016.pdf'), 3466a5930e32e327c44ed68af8db7553, Meta(creation_host=u'bavaria', creation_dt=datetime.datetime(2017, 6, 24, 22, 30, 44, tzinfo=)))>
2017-07-31 20:00:11,841:DEBUG:acme.client:Sending GET request to https://acme-v01.api.letsencrypt.org/directory.
2017-07-31 20:00:11,844:DEBUG:requests.packages.urllib3.connectionpool:Starting new HTTPS connection (1): acme-v01.api.letsencrypt.org
2017-07-31 20:00:12,062:DEBUG:requests.packages.urllib3.connectionpool:https://acme-v01.api.letsencrypt.org:443 "GET /directory HTTP/1.1" 200 352
2017-07-31 20:00:12,063:DEBUG:acme.client:Received response:
HTTP 200
Server: nginx
Content-Type: application/json
Content-Length: 352
Boulder-Request-Id: 32gXtZLq9EDbGBaTRykVhohlpAuEUS_jbOcrtIcJ8T8
Replay-Nonce: GXmAi1ZusTs6IBOo8zyFr0e9GwSgMToMqUENXvh4aUQ
X-Frame-Options: DENY
Strict-Transport-Security: max-age=604800
Expires: Mon, 31 Jul 2017 20:00:54 GMT
Cache-Control: max-age=0, no-cache, no-store
Pragma: no-cache
Date: Mon, 31 Jul 2017 20:00:54 GMT
Connection: keep-alive
{
"key-change": "https://acme-v01.api.letsencrypt.org/acme/key-change",
"new-authz": "https://acme-v01.api.letsencrypt.org/acme/new-authz",
"new-cert": "https://acme-v01.api.letsencrypt.org/acme/new-cert",
"new-reg": "https://acme-v01.api.letsencrypt.org/acme/new-reg",
"revoke-cert": "https://acme-v01.api.letsencrypt.org/acme/revoke-cert"
}
2017-07-31 20:00:12,089:INFO:certbot.renewal:Cert not yet due for renewal
2017-07-31 20:00:14,487:INFO:certbot.main:Keeping the existing certificate
2017-07-31 20:00:14,490:DEBUG:certbot.reporter:Reporting to user: Congratulations! Your certificate and chain have been saved at /etc/letsencrypt/live/bavaria.domain.net/fullchain.pem. Your cert will expire on 2017-10-29. To obtain a new or tweaked version of this certificate in the future, simply run certbot-auto again with the "certonly" option. To non-interactively renew all of your certificates, run "certbot-auto renew"
2017-07-31 20:00:14,602:DEBUG:certbot.reverter:Creating backup of /etc/apache2/vhosts.d/bavaria-le-ssl.conf
2017-07-31 20:00:14,652:INFO:certbot_apache.configurator:Created an SSL vhost at /etc/apache2/vhosts.d/bavaria-le-ssl.conf
2017-07-31 20:00:14,770:WARNING:certbot_apache.configurator:Cannot find a cert or key directive in /files/etc/apache2/vhosts.d/bavaria-le-ssl.conf/IfModule/VirtualHost. VirtualHost was not modified
2017-07-31 20:00:14,771:DEBUG:certbot.error_handler:Encountered exception:
Traceback (most recent call last):
File "/root/.local/share/letsencrypt/lib/python2.7/site-packages/certbot/client.py", line 451, in deploy_certificate
fullchain_path=fullchain_path)
File "/root/.local/share/letsencrypt/lib/python2.7/site-packages/certbot_apache/configurator.py", line 269, in deploy_cert
"Unable to find cert and/or key directives")
PluginError: Unable to find cert and/or key directives
2017-07-31 20:00:14,771:DEBUG:certbot.error_handler:Calling registered functions
2017-07-31 20:00:14,781:DEBUG:certbot.reporter:Reporting to user: Unable to install the certificate
2017-07-31 20:00:14,781:DEBUG:certbot.log:Exiting abnormally:
Traceback (most recent call last):
File "/root/.local/share/letsencrypt/bin/letsencrypt", line 11, in
sys.exit(main())
File "/root/.local/share/letsencrypt/lib/python2.7/site-packages/certbot/main.py", line 743, in main
return config.func(config, plugins)
File "/root/.local/share/letsencrypt/lib/python2.7/site-packages/certbot/main.py", line 604, in run
_install_cert(config, le_client, domains, new_lineage)
File "/root/.local/share/letsencrypt/lib/python2.7/site-packages/certbot/main.py", line 469, in _install_cert
path_provider.cert_path, path_provider.chain_path, path_provider.fullchain_path)
File "/root/.local/share/letsencrypt/lib/python2.7/site-packages/certbot/client.py", line 451, in deploy_certificate
fullchain_path=fullchain_path)
File "/root/.local/share/letsencrypt/lib/python2.7/site-packages/certbot_apache/configurator.py", line 269, in deploy_cert
"Unable to find cert and/or key directives")
PluginError: Unable to find cert and/or key directives
Here is the relevant nginx server block or Apache virtualhost for the domain I am configuring:
<VirtualHost *:80>
ServerName bavaria.domain.net
ServerAdmin sysadmin@domain.com
DocumentRoot /srv/www/htdocs/maintenancemode/
ServerSignature On