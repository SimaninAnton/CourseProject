alex4554 commented on 11 Mar 2019
My operating system is (include version): Ubuntu 18.04 LTS
I installed Certbot with (certbot-auto, OS package manager, pip, etc): OS package manager - https://certbot.eff.org/lets-encrypt/ubuntubionic-nginx
During installation I was asked if I want to auto redirect http to https, I answered "Yes" and the following config was inserted into my domain's nginx config:
server {
if ($host = www.example.com) {
return 301 https://$host$request_uri;
} # managed by Certbot
if ($host = example.com) {
return 301 https://$host$request_uri;
} # managed by Certbot
listen 80;
listen [::]:80;
server_name example.com www.example.com;
return 404; # managed by Certbot
}
According to the official nginx website, using "if" directive for checking the host is extremely inefficient.
Quote from https://www.nginx.com/resources/wiki/start/topics/tutorials/config_pitfalls/#server-name-if :
"When NGINX receives a request no matter what is the subdomain being requested, be it www.example.com or just the plain example.com this if directive is always evaluated. Since you’re requesting NGINX to check for the Host header for every request. It’s extremely inefficient. You should avoid it. Instead use two server directives..."
So what I did is that I split the above server directive into two ones without any ifs:
server {
listen 80;
listen [::]:80;
server_name example.com;
return 301 https://example.com$request_uri;
}
server {
listen 80;
listen [::]:80;
server_name www.example.com;
return 301 https://www.example.com$request_uri;
}
Maybe you should also consider removing the "if" directive and use more than one server directives.