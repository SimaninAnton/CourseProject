atp1122 commented on 28 Jun 2018
Hello,
Since upgrading Certbot from 0.22.2 to 0.25.0, the "certbot renew" command does not seem to be completely/immediately skipping domains not yet due for renewal.
My operating system is (include version):
Ubuntu 16.04.4 LTS
Certbot version: 0.25.0
Nginx version: 1.10.3
I installed Certbot with (certbot-auto, OS package manager, pip, etc):
apt-get
I ran this command and it produced this output:
certbot renew
Certbot's behavior differed from what I expected because:
The "certbot renew" command used to immediately skip domains not due for renewal. Instead, Certbot is still selecting the plugin (which is taking about 30 seconds per domain). During this time, the Certbot command is utilizing between 75%-100% of the CPU. We have a large number of domains so the renew command ends up taking a very long time (during which the CPU is near 100%).
NOTE: this behavior began after upgrading Certbot from version 0.22.2 to 0.25.0. Previously, the process would skip domains not due for renewal immediately and move to the next domain.
Here is a Certbot log showing the issue (if available):
2018-06-27 19:00:53,775:DEBUG:certbot.main:certbot version: 0.25.0
2018-06-27 19:00:53,775:DEBUG:certbot.main:Arguments: []
2018-06-27 19:00:53,776:DEBUG:certbot.main:Discovered plugins: PluginsRegistry(PluginEntryPoint#manual,PluginEntryPoint#nginx,PluginEntryPoint#null,PluginEntryPoint#standalone,PluginEntryPoint#webroot)
2018-06-27 19:00:53,787:DEBUG:certbot.log:Root logging level set at 20
2018-06-27 19:00:53,788:INFO:certbot.log:Saving debug log to /var/log/letsencrypt/letsencrypt.log
2018-06-27 19:00:53,801:DEBUG:certbot.plugins.selection:Requested authenticator <certbot.cli._Default object at 0x7f8417863470> and installer <certbot.cli._Default object at 0x7f8417863470>
2018-06-27 19:00:53,801:DEBUG:certbot.cli:Var rsa_key_size=4096 (set by user).
2018-06-27 19:00:53,809:INFO:certbot.renewal:Cert not yet due for renewal
2018-06-27 19:00:53,810:DEBUG:certbot.plugins.selection:Requested authenticator nginx and installer nginx
2018-06-27 19:01:23,944:DEBUG:certbot.plugins.selection:Single candidate plugin: * nginx
Description: Nginx Web Server plugin - Alpha
Interfaces: IAuthenticator, IInstaller, IPlugin
Entry point: nginx = certbot_nginx.configurator:NginxConfigurator
Initialized: <certbot_nginx.configurator.NginxConfigurator object at 0x7f8417863dd8>
Prep: True
2018-06-27 19:01:23,945:DEBUG:certbot.plugins.selection:Single candidate plugin: * nginx
Description: Nginx Web Server plugin - Alpha
Interfaces: IAuthenticator, IInstaller, IPlugin
Entry point: nginx = certbot_nginx.configurator:NginxConfigurator
Initialized: <certbot_nginx.configurator.NginxConfigurator object at 0x7f8417863dd8>
Prep: True
2018-06-27 19:01:23,945:DEBUG:certbot.plugins.selection:Selected authenticator <certbot_nginx.configurator.NginxConfigurator object at 0x7f8417863dd8> and installer <certbot_nginx.configurator.NginxConfigurator object at 0x7f8417863dd8>
2018-06-27 19:01:23,946:INFO:certbot.plugins.selection:Plugins selected: Authenticator nginx, Installer nginx
2018-06-27 19:01:23,947:DEBUG:certbot.cli:Var rsa_key_size=4096 (set by user).
2018-06-27 19:01:23,950:INFO:certbot.renewal:Cert not yet due for renewal
2018-06-27 19:01:23,951:DEBUG:certbot.plugins.selection:Requested authenticator nginx and installer nginx
2018-06-27 19:01:54,203:DEBUG:certbot.plugins.selection:Single candidate plugin: * nginx
Description: Nginx Web Server plugin - Alpha
Interfaces: IAuthenticator, IInstaller, IPlugin
Entry point: nginx = certbot_nginx.configurator:NginxConfigurator
Initialized: <certbot_nginx.configurator.NginxConfigurator object at 0x7f8416053978>
Prep: True
2018-06-27 19:01:54,203:DEBUG:certbot.plugins.selection:Single candidate plugin: * nginx
Description: Nginx Web Server plugin - Alpha
Interfaces: IAuthenticator, IInstaller, IPlugin
Entry point: nginx = certbot_nginx.configurator:NginxConfigurator
Initialized: <certbot_nginx.configurator.NginxConfigurator object at 0x7f8416053978>
Prep: True
2018-06-27 19:01:54,203:DEBUG:certbot.plugins.selection:Selected authenticator <certbot_nginx.configurator.NginxConfigurator object at 0x7f8416053978> and installer <certbot_nginx.configurator.NginxConfigurator object at 0x7f8416053978>
2018-06-27 19:01:54,204:INFO:certbot.plugins.selection:Plugins selected: Authenticator nginx, Installer nginx
2018-06-27 19:01:54,205:DEBUG:certbot.cli:Var rsa_key_size=4096 (set by user).
2018-06-27 19:01:54,208:INFO:certbot.renewal:Cert not yet due for renewal
2018-06-27 19:01:54,209:DEBUG:certbot.plugins.selection:Requested authenticator nginx and installer nginx
2018-06-27 19:02:24,492:DEBUG:certbot.plugins.selection:Single candidate plugin: * nginx
Description: Nginx Web Server plugin - Alpha
Interfaces: IAuthenticator, IInstaller, IPlugin
Entry point: nginx = certbot_nginx.configurator:NginxConfigurator
Initialized: <certbot_nginx.configurator.NginxConfigurator object at 0x7f84165eab70>
Prep: True
2018-06-27 19:02:24,493:DEBUG:certbot.plugins.selection:Single candidate plugin: * nginx
Description: Nginx Web Server plugin - Alpha
Interfaces: IAuthenticator, IInstaller, IPlugin
Entry point: nginx = certbot_nginx.configurator:NginxConfigurator
Initialized: <certbot_nginx.configurator.NginxConfigurator object at 0x7f84165eab70>
Prep: True
....
(Stopped command here)