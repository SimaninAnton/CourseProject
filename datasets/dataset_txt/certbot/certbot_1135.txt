cono commented on 1 Jun 2017
My operating system is (include version):
Gentoo Base System release 2.3
I installed Certbot with (certbot-auto, OS package manager, pip, etc):
emerge certbot
I ran this command and it produced this output:
certbot renew --config-dir /home/letsencrypt/conf --work-dir /home/letsencrypt/work --logs-dir /home/letsencrypt/logs
2017-06-01 13:54:22,816:DEBUG:acme.client:Received response:
HTTP 201
Server: nginx
Content-Type: application/json
Content-Length: 1013
Boulder-Request-Id: nQOOUL2NWk9uXtWGdRUjtuVXi-qRHEKhu9u7LXtPKjU
Boulder-Requester: 11102173
Link: <https://acme-v01.api.letsencrypt.org/acme/new-cert>;rel="next"
Location: https://acme-v01.api.letsencrypt.org/acme/authz/oZJEU12bBVoz7LqMHfzRVbvRmyJAacZqOQ1GcYuM4rg
Replay-Nonce: mpo7M-fSkdRESgrc2JOp5oqWJCAfDLAttBH_bbqs-K8
X-Frame-Options: DENY
Strict-Transport-Security: max-age=604800
Expires: Thu, 01 Jun 2017 13:54:22 GMT
Cache-Control: max-age=0, no-cache, no-store
Pragma: no-cache
Date: Thu, 01 Jun 2017 13:54:22 GMT
Connection: keep-alive

b'{\n  "identifier": {\n    "type": "dns",\n    "value": "wiki.betacoda.cono.org.ua"\n  },\n  "status": "pending",\n  "expires": "2017-06-08T13:54:22.629799195Z",\n  "challenges": [\n    {\n      "type": "http-01",\n      "status": "pending",\n      "uri": "https://acme-v01.api.letsencrypt.org/acme/challenge/oZJEU12bBVoz7LqMHfzRVbvRmyJAacZqOQ1GcYuM4rg/1262774281",\n      "token": "X85XhsCHUcVyJfppk2EtFk4swjKH1luJbIMmhy9hpKo"\n    },\n    {\n      "type": "dns-01",\n      "status": "pending",\n      "uri": "https://acme-v01.api.letsencrypt.org/acme/challenge/oZJEU12bBVoz7LqMHfzRVbvRmyJAacZqOQ1GcYuM4rg/1262774282",\n      "token": "kUKmhY84Fzj5EflSypKmXZt-pkAm68pHHIH4-d-6l1s"\n    },\n    {\n      "type": "tls-sni-01",\n      "status": "pending",\n      "uri": "https://acme-v01.api.letsencrypt.org/acme/challenge/oZJEU12bBVoz7LqMHfzRVbvRmyJAacZqOQ1GcYuM4rg/1262774283",\n      "token": "hS_5weD37OPUkvyuxjpxnlicS3ShXLqLvOOm_CRglLo"\n    }\n  ],\n  "combinations": [\n    [\n      1\n    ],\n    [\n      0\n    ],\n    [\n      2\n    ]\n  ]\n}'
And after that I'm getting:
b'{\n  "identifier": {\n    "type": "dns",\n    "value": "wiki.betacoda.cono.org.ua"\n  },\n  "status": "invalid",\n  "expires": "2017-06-08T13:54:22Z",\n  "challenges": [\n    {\n      "type": "http-01",\n      "status": "invalid",\n      "error": {\n        "type": "urn:acme:error:unauthorized",\n        "detail": "Invalid response from http://wiki.betacoda.cono.org.ua/.well-known/acme-challenge/X85XhsCHUcVyJfppk2EtFk4swjKH1luJbIMmhy9hpKo: \\"\\u003chtml\\u003e\\r\\n\\u003chead\\u003e\\u003ctitle\\u003e404 Not Found\\u003c/title\\u003e\\u003c/head\\u003e\\r\\n\\u003cbody bgcolor=\\"white\\"\\u003e\\r\\n\\u003ccenter\\u003e\\u003ch1\\u003e404 Not Found\\u003c/h1\\u003e\\u003c/center\\u003e\\r\\n\\u003chr\\u003e\\u003ccenter\\u003e\\"",\n        "status": 403\n      },\n ....
I also checked nginx logs and I don't even see request to my server. Soo looks like a request timeout or it connects to the different host.
Certbot's behavior differed from what I expected because:
It works fine for my:
cono.org.ua
mx.cono.org.ua
www.cono.org.ua
but fails only on:
wiki.betacoda.cono.org.ua.
Here is a Certbot log showing the issue (if available):
Logs are stored in /var/log/letsencrypt by default. Feel free to redact domains, e-mail and IP addresses as you see fit.
2017-06-01 13:54:28,504:DEBUG:acme.client:Received response:
HTTP 200
Server: nginx
Content-Type: application/json
Boulder-Request-Id: 5gTGb3JsoGfEB-io1GKUzkZKw1Gn4jw4b3oXdOub0RY
Link: <https://acme-v01.api.letsencrypt.org/acme/new-cert>;rel="next"
Replay-Nonce: z5lcgizZ8AIr6-izNI0rHnYuv2HG5HDpOaxaFPEaM-o
X-Frame-Options: DENY
Strict-Transport-Security: max-age=604800
Content-Length: 2070
Expires: Thu, 01 Jun 2017 13:54:28 GMT
Cache-Control: max-age=0, no-cache, no-store
Pragma: no-cache
Date: Thu, 01 Jun 2017 13:54:28 GMT
Connection: keep-alive

b'{\n  "identifier": {\n    "type": "dns",\n    "value": "wiki.betacoda.cono.org.ua"\n  },\n  "status": "invalid",\n  "expires": "2017-06-08T13:54:22Z",\n  "challenges": [\n    {\n      "type": "http-01",\n      "status": "invalid",\n      "error": {\n        "type": "urn:acme:error:unauthorized",\n        "detail": "Invalid response from http://wiki.betacoda.cono.org.ua/.well-known/acme-challenge/X85XhsCHUcVyJfppk2EtFk4swjKH1luJbIMmhy9hpKo: \\"\\u003chtml\\u003e\\r\\n\\u003chead\\u003e\\u003ctitle\\u003e404 Not Found\\u003c/title\\u003e\\u003c/head\\u003e\\r\\n\\u003cbody bgcolor=\\"white\\"\\u003e\\r\\n\\u003ccenter\\u003e\\u003ch1\\u003e404 Not Found\\u003c/h1\\u003e\\u003c/center\\u003e\\r\\n\\u003chr\\u003e\\u003ccenter\\u003e\\"",\n        "status": 403\n      },\n      "uri": "https://acme-v01.api.letsencrypt.org/acme/challenge/oZJEU12bBVoz7LqMHfzRVbvRmyJAacZqOQ1GcYuM4rg/1262774281",\n      "token": "X85XhsCHUcVyJfppk2EtFk4swjKH1luJbIMmhy9hpKo",\n      "keyAuthorization": "X85XhsCHUcVyJfppk2EtFk4swjKH1luJbIMmhy9hpKo.YenjGPLqbaV1_oIt7So-OCyNVOuJLB90W-MdaL7d43k",\n      "validationRecord": [\n        {\n          "url": "http://wiki.betacoda.cono.org.ua/.well-known/acme-challenge/X85XhsCHUcVyJfppk2EtFk4swjKH1luJbIMmhy9hpKo",\n          "hostname": "wiki.betacoda.cono.org.ua",\n          "port": "80",\n          "addressesResolved": [\n            "5.9.137.201",\n            "2a01:4f8:190:11cc::2"\n          ],\n          "addressUsed": "2a01:4f8:190:11cc::2",\n          "addressesTried": []\n        }\n      ]\n    },\n    {\n      "type": "dns-01",\n      "status": "pending",\n      "uri": "https://acme-v01.api.letsencrypt.org/acme/challenge/oZJEU12bBVoz7LqMHfzRVbvRmyJAacZqOQ1GcYuM4rg/1262774282",\n      "token": "kUKmhY84Fzj5EflSypKmXZt-pkAm68pHHIH4-d-6l1s"\n    },\n    {\n      "type": "tls-sni-01",\n      "status": "pending",\n      "uri": "https://acme-v01.api.letsencrypt.org/acme/challenge/oZJEU12bBVoz7LqMHfzRVbvRmyJAacZqOQ1GcYuM4rg/1262774283",\n      "token": "hS_5weD37OPUkvyuxjpxnlicS3ShXLqLvOOm_CRglLo"\n    }\n  ],\n  "combinations": [\n    [\n      1\n    ],\n    [\n      0\n    ],\n    [\n      2\n    ]\n  ]\n}'
Here is the relevant nginx server block or Apache virtualhost for the domain I am configuring:
server {
        listen 80;
        server_name wiki.betacoda.cono.org.ua;

        location /.well-known {
                allow all;
                root /home/letsencrypt/htdocs;
        }

        location / {
            return 301 https://wiki.betacoda.cono.org.ua$request_uri;
        }
}
Manual attempt:
letsencrypt@betacoda ~ $ echo "bug for github" > /home/letsencrypt/htdocs/.well-known/certbot

% wget -qSO- http://wiki.betacoda.cono.org.ua/.well-known/certbot
  HTTP/1.1 200 OK
  Server: nginx/1.11.3
  Date: Thu, 01 Jun 2017 14:36:37 GMT
  Content-Type: application/octet-stream
  Content-Length: 15
  Last-Modified: Thu, 01 Jun 2017 14:36:02 GMT
  Connection: keep-alive
  ETag: "59302652-f"
  Accept-Ranges: bytes
bug for github