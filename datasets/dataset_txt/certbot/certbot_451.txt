Member
bmw commented on 24 Jul 2018
If you do this with boulder, you get:
  File "/Users/bmw/Development/certbot/certbot/acme/acme/client.py", line 130, in query_registration
    return self._send_recv_regr(regr, messages.UpdateRegistration())
  File "/Users/bmw/Development/certbot/certbot/acme/acme/client.py", line 75, in _send_recv_regr
    response = self._post(regr.uri, body)
  File "/Users/bmw/Development/certbot/certbot/acme/acme/client.py", line 92, in _post
    return self.net.post(*args, **kwargs)
  File "/Users/bmw/Development/certbot/certbot/acme/acme/client.py", line 1109, in post
    return self._post_once(*args, **kwargs)
  File "/Users/bmw/Development/certbot/certbot/acme/acme/client.py", line 1123, in _post_once
    return self._check_response(response, content_type=content_type)
  File "/Users/bmw/Development/certbot/certbot/acme/acme/client.py", line 983, in _check_response
    raise messages.Error.from_json(jobj)
acme.messages.Error: urn:ietf:params:acme:error:malformed :: The request message was malformed :: No Key ID in JWS header
This is because querying an account requires kid to be set, but if self.net.account isn't set, kid isn't included.
An easy fix for this would be to set self.net.account = regr in the beginning of query_registration, at least for ACMEv2. Doing it at the end of query_registration to store the account as given by the ACME server isn't a bad idea either.
This is useful for the scenario in #6246.