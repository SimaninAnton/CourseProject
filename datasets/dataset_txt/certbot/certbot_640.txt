Contributor
ohemorange commented on 27 Mar 2018
Particularly post http-01 but also just generally post-release, we now know more about what people need from IPv6 support in Nginx.
From #5438:
The final case is when searching the config to see if there any IPv6 listens, we ignore (to different degrees) the address and port. We completely ignore the address and for the port, we're only looking for ipv6only. Even if nginx isn't listening with IPv6 on that port, we'll still use IPv6 here because it's listening on IPv6 for some address/port combination.
This is not likely to be a problem for (m)any Certbot users, but some people with valid setups have specific requirements for what addresses and ports a services should be listening to. For example, they may have multiple IP addresses allocated to a box with different services running on each. Certbot configuring nginx to use additional addresses/ports beyond what is currently in the nginx config or specified by the user can cause the challenge to fail. (It also will likely make the challenge succeed in other cases it wouldn't previously.)
I think we should do something like what we do for ssl for detection -- on get_hosts, update ipv6 info based on what we now know from parsed ipv6only=on parameters.