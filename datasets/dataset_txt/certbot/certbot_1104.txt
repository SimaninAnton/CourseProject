Member
bmw commented on 15 Jun 2017
My operating system is (include version):
Ubuntu 16.04
I installed Certbot with (certbot-auto, OS package manager, pip, etc):
Dev instructions
I ran this command and it produced this output:
Starting with the default Apache config on this system, I removed the SSLCertificateFile and SSLCertificateKeyFile directives from /etc/apache2/sites-available/default-ssl.conf and put them in /etc/apache2/apache2.conf. Then I ran:
sudo rm /etc/apache2/sites-*/000-default.conf
sudo a2enmod ssl
sudo a2ensite default-ssl.conf
sudo certbot -d example.com --apache
Certbot's behavior differed from what I expected because:
This configuration is technically valid so we should ideally support it. The problem is we mark the vhost as SSL and assume cert and key directives exist in the file when they technically could be in the top level configuration.
Here is a Certbot log showing the issue (if available):
Logs are stored in /var/log/letsencrypt by default. Feel free to redact domains, e-mail and IP addresses as you see fit.
The relevant log output is:
Cannot find a cert or key directive in /files/etc/apache2/sites-available/default-ssl.conf/IfModule/VirtualHost. VirtualHost was not modified
Encountered exception:
Traceback (most recent call last):
  File "/home/bmw/src/certbot/certbot/client.py", line 439, in deploy_certificate
    fullchain_path=fullchain_path)
  File "/home/bmw/src/certbot/certbot-apache/certbot_apache/configurator.py", line 269, in deploy_cert
    "Unable to find cert and/or key directives")
PluginError: Unable to find cert and/or key directives

Calling registered functions
Reporting to user: Unable to install the certificate
Exiting abnormally:
Traceback (most recent call last):
  File "/usr/local/bin/certbot", line 11, in <module>
    load_entry_point('certbot', 'console_scripts', 'certbot')()
  File "/home/bmw/src/certbot/certbot/main.py", line 743, in main
    return config.func(config, plugins)
  File "/home/bmw/src/certbot/certbot/main.py", line 604, in run
    _install_cert(config, le_client, domains, new_lineage)
  File "/home/bmw/src/certbot/certbot/main.py", line 469, in _install_cert
    path_provider.cert_path, path_provider.chain_path, path_provider.fullchain_path)
  File "/home/bmw/src/certbot/certbot/client.py", line 439, in deploy_certificate
    fullchain_path=fullchain_path)
  File "/home/bmw/src/certbot/certbot-apache/certbot_apache/configurator.py", line 269, in deploy_cert
    "Unable to find cert and/or key directives")
PluginError: Unable to find cert and/or key directives