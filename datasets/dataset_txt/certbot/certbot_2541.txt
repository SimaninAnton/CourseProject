Contributor
osirisinferi commented on 18 Jan 2016
Hi,
For some reason, my Apache plugin broke since I updated everything to the latest Git versions (ACME, letsencrypt and letsencrypt-apache), commit 10214e2.
I already had a certificate for the domain, but when I say "Attempt to reinstall" when asked, I get the following error:
Select the appropriate number [1-3] then [enter] (press 'c' to cancel): 1
2016-01-18 01:17:25,897:INFO:letsencrypt_apache.configurator:Created an SSL vhost at /etc/apache2/vhosts.d/vhosts/le-test-05.example.com-le-ssl.conf
2016-01-18 01:17:25,979:DEBUG:letsencrypt.reverter:Creating backup of /etc/apache2/vhosts.d/vhosts/le-test-05.example.com-le-ssl.conf
2016-01-18 01:17:26,135:WARNING:letsencrypt_apache.configurator:Cannot find a cert or key directive in /files/etc/apache2/vhosts.d/vhosts/le-test-05.example.com-le-ssl.conf/IfModule/VirtualHost. VirtualHost was not modified
2016-01-18 01:17:26,136:DEBUG:letsencrypt.error_handler:Encountered exception:
Traceback (most recent call last):
  File "/usr/lib64/python2.7/site-packages/letsencrypt/client.py", line 375, in deploy_certificate
    fullchain_path=fullchain_path)
  File "/usr/lib64/python2.7/site-packages/letsencrypt_apache/configurator.py", line 236, in deploy_cert
    "Unable to find cert and/or key directives")
PluginError: Unable to find cert and/or key directives

2016-01-18 01:17:26,137:DEBUG:letsencrypt.error_handler:Calling registered functions
2016-01-18 01:17:26,139:DEBUG:letsencrypt.cli:Exiting abnormally:
Traceback (most recent call last):
  File "/usr/lib/python-exec/python2.7/letsencrypt", line 9, in <module>
    load_entry_point('letsencrypt==0.2.0.dev0', 'console_scripts', 'letsencrypt')()
  File "/usr/lib64/python2.7/site-packages/letsencrypt/cli.py", line 1398, in main
    return args.func(args, config, plugins)
  File "/usr/lib64/python2.7/site-packages/letsencrypt/cli.py", line 563, in run
    lineage.chain, lineage.fullchain)
  File "/usr/lib64/python2.7/site-packages/letsencrypt/client.py", line 375, in deploy_certificate
    fullchain_path=fullchain_path)
  File "/usr/lib64/python2.7/site-packages/letsencrypt_apache/configurator.py", line 236, in deploy_cert
    "Unable to find cert and/or key directives")
PluginError: Unable to find cert and/or key directives

Unable to find cert and/or key directives
I find this very strange, as the content of the original .conf is just this:
<VirtualHost *:80>
Servername le-test-05.example.com
DocumentRoot /var/www/vhosts/le-test-05.example.com/htdocs/
</VirtualHost>
I've put many debug messages extra in letsencrypt_apache/configurator.py, letsencrypt_apache/parser.py and I think even in the Augeas python files, but to no succes.
The client successfully transforms the .conf file to the -le-ssl.conf file, i.e., add an <IfModule>, transform *:80 into *:443 and add the SSLCertificateFile, SSLCertificateKey (set to the temporary insert_cert_file_path and insert_key_file_path values resp.) and the Include to the basic LE option file.
Unfortunately, even with the mock directives added by _add_dummy_ssl_directives(), for some reason the self.parser.find_dir("SSLCertificateFile", None, vhost.path) command in deploy_cert() fails.. And I have no clue why. It is there.. It should be found by find_dir(). Augeas just added them!
Any clue/hints how I could debug this any further?