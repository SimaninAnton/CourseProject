davejamesmiller commented on 4 Mar 2018
My operating system is (include version):
Ubuntu 16.04
I installed Certbot with (certbot-auto, OS package manager, pip, etc):
Git - commit 31805c5
I ran this command and it produced this output:
$ certbot --noninteractive --manual --manual-public-ip-logging-ok --preferred-challenges dns --manual-auth-hook "/srv/letsencrypt-lexicon.sh auth" --manual-cleanup-hook "/srv/letsencrypt-lexicon.sh cleanup" --server https://acme-staging-v02.api.letsencrypt.org/directory --cert-name xenial.alberon.co.uk -d xenial.alberon.co.uk,*.xenial.alberon.co.uk -m dave@davejamesmiller.com --agree-tos
...
Traceback (most recent call last):
  File "/srv/certbot/venv/bin/certbot", line 11, in <module>
    load_entry_point('certbot', 'console_scripts', 'certbot')()
  File "/srv/certbot/certbot/main.py", line 1266, in main
    return config.func(config, plugins)
  File "/srv/certbot/certbot/main.py", line 1157, in certonly
    lineage = _get_and_save_cert(le_client, config, domains, certname, lineage)
  File "/srv/certbot/certbot/main.py", line 118, in _get_and_save_cert
    lineage = le_client.obtain_and_enroll_certificate(domains, certname)
  File "/srv/certbot/certbot/client.py", line 349, in obtain_and_enroll_certificate
    cert, chain, key, _ = self.obtain_certificate(domains)
  File "/srv/certbot/certbot/client.py", line 293, in obtain_certificate
    orderr = self._get_order_and_authorizations(csr.data, self.config.allow_subset_of_names)
  File "/srv/certbot/certbot/client.py", line 329, in _get_order_and_authorizations
    authzr = self.auth_handler.handle_authorizations(orderr, best_effort)
  File "/srv/certbot/certbot/auth_handler.py", line 82, in handle_authorizations
    self._respond(resp, best_effort)
  File "/srv/certbot/certbot/auth_handler.py", line 159, in _respond
    self._cleanup_challenges(active_achalls)
  File "/srv/certbot/certbot/auth_handler.py", line 304, in _cleanup_challenges
    self.auth.cleanup(achalls)
  File "/srv/certbot/certbot/plugins/manual.py", line 218, in cleanup
    env = self.env.pop(achall.domain)
KeyError: u'xenial.alberon.co.uk'
Certbot's behavior differed from what I expected because:
It crashed.
This only seems to happen when using --manual-cleanup-hook and including both xenial.alberon.co.uk and *.xenial.alberon.co.uk.
I think self.env.pop(achall.domain) gets called twice, both times with achall.domain = 'xenial.alberon.co.uk', and the second time it's already been removed. I would guess the key needs to be changed to something else now that one domain may require two separate challenges.
Here is a Certbot log showing the issue (if available):
https://gist.github.com/davejamesmiller/2a8c2f7a03cac9edd573c767a8fbedec
Here is the relevant nginx server block or Apache virtualhost for the domain I am configuring:
N/A