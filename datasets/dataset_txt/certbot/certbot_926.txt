zenny commented on 28 Oct 2017 •
edited
[This is a repeat of the same issue that was earlier posted at #4307 which keeps on happening every three months during renewal. @bmw was kind enough to offer to sort out this issue, but it remained outstading. The acme server response seems to be unpredictable!]
Hi,
1§ certbot v0.10.2-1~bpo8+1 was installed in debian jessie in which nginx is running
2§ The DNS records points to the right IP for the domains, but acme reports DNS problem as quoted below. This issue has been a long outstanding with many other domains running in debian jessie.
3§ Tried even by stopping any server running in port 80 (nginx in my case) as well as disabling http to https redirection (https://tools.ietf.org/html/draft-ietf-acme-acme-07#section-8.3), but ended up with the same 'Connection refused/Timeout' error due to so-called 'DNS error'!
4§ To check whether the server is serving files, I also tried with creating:
mkdir -p /usr/local/ispconfig/interface/acme/.well-known/acme-challenge
echo "I am serving." > /usr/local/ispconfig/interface/acme/.well-known/acme-challenge/servertest
And I do get "I am serving" when browsed to http://DOMAIN.TLD/.wellknown/acme-challenge/servertest.
5§ I have no ipv6 enabled in any of the servers including in the related nginx.configuration (no 'listen [::]:80;' line in the related nginx config file). Therefore, the reason specified at https://superuser.com/questions/1251521/letsencrypt-timeout-reasons#comment1838790_1251866 does not apply to my case.
How come acme servers could not resolve the DNS entries which is globally accessible?
Thanks for inputs. details below.
# /usr/bin/letsencrypt certonly -n --text --agree-tos --expand --authenticator webroot --server https://acme-v01.api.letsencrypt.org/directory --rsa-key-size 4096 --email postmaster@reinvent-your-career.org  --domains reinvent-your-career.org --domains www.reinvent-your-career.org --domains reinventyourcareer.org --domains www.reinventyourcareer.org --domains career-checkup-clinic.com --domains www.career-checkup-clinic.com --domains careercheckupclinic.com --domains www.careercheckupclinic.com --webroot-path /usr/local/ispconfig/interface/acme
Saving debug log to /var/log/letsencrypt/letsencrypt.log
Starting new HTTPS connection (1): acme-v01.api.letsencrypt.org
Cert is due for renewal, auto-renewing...
Renewing an existing certificate
Performing the following challenges:
http-01 challenge for reinvent-your-career.org
http-01 challenge for www.reinvent-your-career.org
http-01 challenge for reinventyourcareer.org
http-01 challenge for www.reinventyourcareer.org
http-01 challenge for career-checkup-clinic.com
http-01 challenge for www.career-checkup-clinic.com
http-01 challenge for careercheckupclinic.com
http-01 challenge for www.careercheckupclinic.com
Using the webroot path /usr/local/ispconfig/interface/acme for all unmatched domains.
Waiting for verification...
Cleaning up challenges
Unable to clean up challenge directory /usr/local/ispconfig/interface/acme/.well-known/acme-challenge
Failed authorization procedure. career-checkup-clinic.com (http-01): urn:acme:error:connection :: The server could not connect to the client to verify the domain :: Fetching http://www.career-checkup-clinic.com/.well-known/acme-challenge/SPH_cciw3pL77l9EFHDBke-GN8C1lgYPxbt3SJV5jE0: Timeout

IMPORTANT NOTES:
 - The following errors were reported by the server:

   Domain: career-checkup-clinic.com
   Type:   connection
   Detail: Fetching
   http://www.career-checkup-clinic.com/.well-known/acme-challenge/SPH_cciw3pL77l9EFHDBke-GN8C1lgYPxbt3SJV5jE0:
   Timeout

   To fix these errors, please make sure that your domain name was
   entered correctly and the DNS A record(s) for that domain
   contain(s) the right IP address. Additionally, please check that
   your computer has a publicly routable IP address and that no
   firewalls are preventing the server from communicating with the
   client. If you're using the webroot plugin, you should also verify
   that you are serving files from the webroot path you provided.
dig outputs the domains pointed to the right IP where they are hosted while tested with two different nameserves including the one from google:
$ dig @8.8.8.8 www.career-checkup-clinic.com

; <<>> DiG 9.9.5-3ubuntu0.16-Ubuntu <<>> @8.8.8.8 www.career-checkup-clinic.com
; (1 server found)
;; global options: +cmd
;; Got answer:
;; ->>HEADER<<- opcode: QUERY, status: NOERROR, id: 33619
;; flags: qr rd ra; QUERY: 1, ANSWER: 1, AUTHORITY: 0, ADDITIONAL: 1

;; OPT PSEUDOSECTION:
; EDNS: version: 0, flags:; udp: 4096
;; QUESTION SECTION:
;www.career-checkup-clinic.com. IN A

;; ANSWER SECTION:
www.career-checkup-clinic.com. 924 IN A 81.216.202.218

;; Query time: 6 msec
;; SERVER: 8.8.8.8#53(8.8.8.8)
;; WHEN: Sat Oct 28 10:36:06 CEST 2017
;; MSG SIZE  rcvd: 74


$ dig @8.8.8.8 career-checkup-clinic.com

; <<>> DiG 9.9.5-3ubuntu0.16-Ubuntu <<>> @8.8.8.8 career-checkup-clinic.com
; (1 server found)
;; global options: +cmd
;; Got answer:
;; ->>HEADER<<- opcode: QUERY, status: NOERROR, id: 46406
;; flags: qr rd ra; QUERY: 1, ANSWER: 1, AUTHORITY: 0, ADDITIONAL: 1

;; OPT PSEUDOSECTION:
; EDNS: version: 0, flags:; udp: 4096
;; QUESTION SECTION:
;career-checkup-clinic.com. IN A

;; ANSWER SECTION:
career-checkup-clinic.com. 1152 IN A 81.216.202.218

;; Query time: 6 msec
;; SERVER: 8.8.8.8#53(8.8.8.8)
;; WHEN: Sat Oct 28 10:32:03 CEST 2017
;; MSG SIZE  rcvd: 70
The acme versions installed are:
# dpkg -l | grep certbot
ii  certbot                           0.10.2-1~bpo8+1                  all          automatically configure HTTPS using Let's Encrypt
ii  python-certbot                    0.10.2-1~bpo8+1                  all          main library for certbot
Another similar situation:
#  /usr/bin/letsencrypt certonly -n --text --agree-tos --expand --authenticator webroot --server https://acme-v01.api.letsencrypt.org/directory --rsa-key-size 4096 --email postmaster@internationaluniversityofsweden.org  --domains internationaluniversityofsweden.org --domains www.internationaluniversityofsweden.org --domains internationaluniversityofsweden.com --domains www.internationaluniversityofsweden.com --domains internationaluniversityofsweden.net --domains www.internationaluniversityofsweden.net --domains ius-siu.se --domains www.ius-siu.se --domains iunis.se --domains www.iunis.se --domains iuni.se --domains www.iuni.se --webroot-path /usr/local/ispconfig/interface/acme
Saving debug log to /var/log/letsencrypt/letsencrypt.log
Starting new HTTPS connection (1): acme-v01.api.letsencrypt.org
Cert is due for renewal, auto-renewing...
Renewing an existing certificate
Performing the following challenges:
http-01 challenge for internationaluniversityofsweden.org
http-01 challenge for www.internationaluniversityofsweden.org
http-01 challenge for internationaluniversityofsweden.com
http-01 challenge for www.internationaluniversityofsweden.com
http-01 challenge for internationaluniversityofsweden.net
http-01 challenge for www.internationaluniversityofsweden.net
http-01 challenge for ius-siu.se
http-01 challenge for www.ius-siu.se
http-01 challenge for iunis.se
http-01 challenge for www.iunis.se
http-01 challenge for iuni.se
http-01 challenge for www.iuni.se
Using the webroot path /usr/local/ispconfig/interface/acme for all unmatched domains.
Waiting for verification...
Cleaning up challenges
Unable to clean up challenge directory /usr/local/ispconfig/interface/acme/.well-known/acme-challenge
Failed authorization procedure. iuni.se (http-01): urn:acme:error:connection :: The server could not connect to the client to verify the domain :: Fetching http://www.iuni.se/.well-known/acme-challenge/s86X-aH0T23BGa2SN7a2DCwf7c6za9WcaGanGLOEmik: Timeout

IMPORTANT NOTES:
 - The following errors were reported by the server:

   Domain: iuni.se
   Type:   connection
   Detail: Fetching
   http://www.iuni.se/.well-known/acme-challenge/s86X-aH0T23BGa2SN7a2DCwf7c6za9WcaGanGLOEmik:
   Timeout

   To fix these errors, please make sure that your domain name was
   entered correctly and the DNS A record(s) for that domain
   contain(s) the right IP address. Additionally, please check that
   your computer has a publicly routable IP address and that no
   firewalls are preventing the server from communicating with the
   client. If you're using the webroot plugin, you should also verify
   that you are serving files from the webroot path you provided.
dig points to the right IP:
$ dig @8.8.8.8 www.iuni.se

; <<>> DiG 9.9.5-3ubuntu0.16-Ubuntu <<>> @8.8.8.8 www.iuni.se
; (1 server found)
;; global options: +cmd
;; Got answer:
;; ->>HEADER<<- opcode: QUERY, status: NOERROR, id: 11353
;; flags: qr rd ra; QUERY: 1, ANSWER: 1, AUTHORITY: 2, ADDITIONAL: 3

;; OPT PSEUDOSECTION:
; EDNS: version: 0, flags:; udp: 4096
;; QUESTION SECTION:
;www.iuni.se.   IN A

;; ANSWER SECTION:
www.iuni.se.  3600 IN A 81.216.202.218

;; AUTHORITY SECTION:
iuni.se.  3600 IN NS ns1.iuni.se.
iuni.se.  3600 IN NS ns2.iuni.se.

;; ADDITIONAL SECTION:
ns1.iuni.se.  3578 IN A 81.216.202.218
ns2.iuni.se.  3578 IN A 81.216.166.172

;; Query time: 1687 msec
;; SERVER: 8.8.8.8#53(8.8.8.8)
;; WHEN: Sat Oct 28 11:50:39 CEST 2017
;; MSG SIZE  rcvd: 124
Cheers,
/z
1