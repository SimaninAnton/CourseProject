t-eichmann commented on 13 Aug 2018
My operating system is (include version):
Ubuntu 18.04
I installed Certbot with (certbot-auto, OS package manager, pip, etc):
package manager
I ran this command and it produced this output:
When running certbot with the renew command it ends its works with telling me that it is starting the Apache server again, but instead it shuts down Apache. The Apache logs tell me that Apache received a SIGTERM and is shutting down. The Apache logs also tell me that Apache is restarted during the renewal process several times, I think this is because we have some HTTP-challenge certificates and some of the older tls-sni-challenge certificates.
Even specifying a "systemctl start apache2" post-hook doesn't help.
Certbot's behavior differed from what I expected because:
Apache should be started or at least restarted, but is shut down.
Here is the relevant part from the Apache logs:
[Mon Aug 13 09:59:28 2018] [notice] [pid 12062] AH00171: Graceful restart requested, doing restart
AH00558: apache2: Could not reliably determine the server's fully qualified domain name, using 2a01:4f8:212:16a6::2. Set the 'ServerName' directive globally to suppress this message
[Mon Aug 13 09:59:28 2018] [notice] [pid 12062] AH00163: Apache/2.4.29 (Ubuntu) OpenSSL/1.1.0g configured -- resuming normal operations
[Mon Aug 13 09:59:28 2018] [notice] [pid 12062] AH00094: Command line: '/usr/sbin/apache2'
[Mon Aug 13 09:59:28 2018] [notice] [pid 12062] AH00169: caught SIGTERM, shutting down
Please ignore the warning about the FQDN, this Apache is merely running as a TLS termination proxy and doesn't need a FQDN.
The only relevant part from the certbot logs seems to be this at the end of the renewal process:
2018-08-13 09:59:28,058:INFO:certbot.hooks:Running post-hook command: systemctl start apache2
There is nothing else regarding starting/stopping/restarting Apache in there.
I am out of clues how to handle this and am now down to manually starting certbot renew once a day.