dertin commented on 7 Feb 2019 â€¢
edited
Update 2:
I do not know if it was to go from OpenSSL 1.1.1 to 1.1.1a, but now it is necessary to configure these two environment variables (SSL_CERT_FILE, SSL_CERT_DIR) in my system. See: dertin/lemp-stack-debian@b5016a5
I added these two lines to the beginning of the script (/opt/letsencrypt/certbot-auto):
export SSL_CERT_FILE=/etc/ssl/certs/ca-certificates.crt
export SSL_CERT_DIR=/etc/ssl/certs/
New ERROR:
Creating virtual environment...
Installing Python packages...
Command "/opt/eff.org/certbot/venv/bin/python2.7 -u -c "import setuptools, tokenize;__file__='/tmp/pip-RE1ESP-build/setup.py';f=getattr(tokenize, 'open', open)(__file__);code=f.read().replace('\r\n', '\n');f.close();exec(compile(code, __file__, 'exec'))" install --record /tmp/pip-qCVZg9-record/install-record.txt --single-version-externally-managed --compile --install-headers /opt/eff.org/certbot/venv/include/site/python2.7/pip" failed with error code 1 in /tmp/pip-RE1ESP-build/
Traceback (most recent call last):
  File "/tmp/tmp.PextSJPIZT/pipstrap.py", line 177, in <module>
    exit(main())
  File "/tmp/tmp.PextSJPIZT/pipstrap.py", line 164, in main
    shell=True)
  File "/usr/local/lib/python2.7/subprocess.py", line 223, in check_output
    raise CalledProcessError(retcode, cmd, output=output)
subprocess.CalledProcessError: Command 'pip install --no-index --no-deps -U --no-cache-dir /tmp/pipstrap-vURwiv/pip-9.0.1.tar.gz /tmp/pipstrap-vURwiv/setuptools-40.6.3.zip /tmp/pipstrap-vURwiv/wheel-0.29.0.tar.gz' returned non-zero exit status 1
Update 1:
Python 2.7.15 - OpenSSL 1.1.1a
NOT WORK:
import urllib2
response = urllib2.urlopen('https://www.python.org/')
print response.read(100)
WORK:
import urllib2, ssl
request = urllib2.Request('https://www.python.org')
response = urllib2.urlopen(request, context=ssl._create_unverified_context())
print response.read(100)
My operating system is (include version):
Debian GNU/Linux 9.7 (stretch)
Installation script for LAMP server: https://github.com/dertin/lemp-stack-debian
(see list software version)
I installed Certbot with (certbot-auto, OS package manager, pip, etc):
git clone https://github.com/certbot/certbot /opt/letsencrypt
or
git clone -b 'v0.30.2' --single-branch https://github.com/certbot/certbot /opt/letsencrypt
I ran this command and it produced this output:
sudo /opt/letsencrypt/certbot-auto --config /etc/letsencrypt/configs/example.com.conf --debug --verbose certonly
Bootstrapping dependencies for Debian-based OSes... (you can skip this with --no-bootstrap)
Hit:1 http://security.debian.org/debian-security stretch/updates InRelease
Ign:2 http://cdn-aws.deb.debian.org/debian stretch InRelease                                                  
Hit:3 http://cdn-aws.deb.debian.org/debian stretch-updates InRelease                                          
Hit:4 http://cdn-aws.deb.debian.org/debian stretch Release                                              
Hit:6 http://espejito.fder.edu.uy/mariadb/repo/10.4/debian stretch InRelease      
Reading package lists... Done
Reading package lists... Done
Building dependency tree       
Reading state information... Done
augeas-lenses is already the newest version (1.8.0-1+deb9u1).
libaugeas0 is already the newest version (1.8.0-1+deb9u1).
ca-certificates is already the newest version (20161130+nmu1+deb9u1).
gcc is already the newest version (4:6.3.0-4).
libffi-dev is already the newest version (3.2.1-6).
python is already the newest version (2.7.13-2).
python-dev is already the newest version (2.7.13-2).
python-virtualenv is already the newest version (15.1.0+ds-1).
virtualenv is already the newest version (15.1.0+ds-1).
libssl-dev is already the newest version (1.1.0j-1~deb9u1).
openssl is already the newest version (1.1.0j-1~deb9u1).
0 upgraded, 0 newly installed, 0 to remove and 1 not upgraded.
WARNING: unable to check for updates.
Creating virtual environment...
Running virtualenv with interpreter /usr/local/bin/python2.7
New python executable in /opt/eff.org/certbot/venv/bin/python2.7
Also creating executable in /opt/eff.org/certbot/venv/bin/python
Installing setuptools, pkg_resources, pip, wheel...done.
Installing Python packages...
Traceback (most recent call last):
  File "/tmp/tmp.Llp7l4a80x/pipstrap.py", line 177, in <module>
    exit(main())
  File "/tmp/tmp.Llp7l4a80x/pipstrap.py", line 158, in main
    for path, digest in PACKAGES]
  File "/tmp/tmp.Llp7l4a80x/pipstrap.py", line 118, in hashed_download
    response = opener(using_https=parsed_url.scheme == 'https').open(url)
  File "/usr/local/lib/python2.7/urllib2.py", line 429, in open
    response = self._open(req, data)
  File "/usr/local/lib/python2.7/urllib2.py", line 447, in _open
    '_open', req)
  File "/usr/local/lib/python2.7/urllib2.py", line 407, in _call_chain
    result = func(*args)
  File "/usr/local/lib/python2.7/urllib2.py", line 1241, in https_open
    context=self._context)
  File "/usr/local/lib/python2.7/urllib2.py", line 1198, in do_open
    raise URLError(err)
urllib2.URLError: <urlopen error [SSL: CERTIFICATE_VERIFY_FAILED] certificate verify failed (_ssl.c:726)>
Certbot's behavior differed from what I expected because:
The program must be able to connect through HTTPs to download the dependencies.
I am using the latest version of Python 2.7, pip and OpenSSL. But in the Python environment that it creates, something would not be working.
My certificates are installed in "/etc/ssl/certs".
Not work:
export PYTHONHTTPSVERIFY=0
export REQUESTS_CA_BUNDLE=/etc/ssl/certs/ca-certificates.crt
See:
https://github.com/mozilla/pipstrap/blob/master/pipstrap.py#L103
Here is the relevant nginx server block or Apache virtualhost for the domain I am configuring:
server {
   listen 80;
   listen [::]:80;
   server_name example.com www.example.com;

   charset utf-8;
  
   ....
  
  location /.well-known/acme-challenge {
    default_type "text/plain";
    root /var/www/example.com/letsencrypt;
  }
  
   ...
}