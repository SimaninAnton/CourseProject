c0mm0n commented on 5 Oct 2017 â€¢
edited
Hi,
i've installed LE a couple of weeks ago, everything was fine.
Today I wanted to add a subdomain, and the problems started.
I've then tried to force renew but doesn't get better.
I don't understand why the conf file is setup with webroot and it tries with Nginx Auth.
In any case, the well know folder is working.
My operating system is (include version):
Debian 7 Wheezy
I installed Certbot with (certbot-auto, OS package manager, pip, etc):
certbot-auto
I ran this command and it produced this output:
./certbot-auto --force-renewal
Saving debug log to /var/log/letsencrypt/letsencrypt.log
Failed to find executable apache2ctl in PATH: /usr/lib/git-core:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin
Plugins selected: Authenticator nginx, Installer nginx
Which names would you like to activate HTTPS for?
1: mydomain.com
2: beta.mydomain.com
3: www.mydomain.com
4: anotherdomain.com
Select the appropriate numbers separated by commas and/or spaces, or leave input
blank to select all options shown (Enter 'c' to cancel): 1,3
Renewing an existing certificate
Performing the following challenges:
tls-sni-01 challenge for mydomain.com
tls-sni-01 challenge for www.mydomain.com
Waiting for verification...
Cleaning up challenges
Failed authorization procedure. www.mydomain.com (tls-sni-01): urn:acme:error:unauthorized :: The client lacks sufficient authorization :: Incorrect validation certificate for tls-sni-01 challenge. Requested 598c512170d6c8fd61bd2ab7f9d07ba3.cae1de2a355837a8fd686546c0a6109a.acme.invalid from MYIP:443. Received 2 certificate(s), first certificate had names "mydomain.com, www.mydomain.com", mydomain.com (tls-sni-01): urn:acme:error:unauthorized :: The client lacks sufficient authorization :: Incorrect validation certificate for tls-sni-01 challenge. Requested 7e5bdb06b81443cccb700f752fd9ba61.c8d9bc2a13a2511edd4ad3ed91014e9a.acme.invalid from MYIP:443. Received 2 certificate(s), first certificate had names "mydomain.com, www.mydomain.com"
IMPORTANT NOTES:
The following errors were reported by the server:
Domain: www.mydomain.com
Type: unauthorized
Detail: Incorrect validation certificate for tls-sni-01 challenge.
Requested
598c512170d6c8fd61bd2ab7f9d07ba3.cae1de2a355837a8fd686546c0a6109a.acme.invalid
from MYIP:443. Received 2 certificate(s), first
certificate had names "mydomain.com, www.mydomain.com"
Domain: mydomain.com
Type: unauthorized
Detail: Incorrect validation certificate for tls-sni-01 challenge.
Requested
7e5bdb06b81443cccb700f752fd9ba61.c8d9bc2a13a2511edd4ad3ed91014e9a.acme.invalid
from MYIP:443. Received 2 certificate(s), first
certificate had names "mydomain.com, www.mydomain.com"
To fix these errors, please make sure that your domain name was
entered correctly and the DNS A/AAAA record(s) for that domain
contain(s) the right IP address.
Certbot's behavior differed from what I expected because:
Why does it fails with nginx auth ?
Why does it use nginx auth while webroot is specified in the conf ?
`
renew_before_expiry = 30 days
version = 0.17.0
cert = /etc/letsencrypt/live/mydomain.com/cert.pem
privkey = /etc/letsencrypt/live/mydomain.com/privkey.pem
chain = /etc/letsencrypt/live/mydomain.com/chain.pem
fullchain = /etc/letsencrypt/live/mydomain.com/fullchain.pem
archive_dir = /etc/letsencrypt/archive/mydomain.com
Options used in the renewal process
[renewalparams]
authenticator = webroot
installer = None
account = 44ff257c11ed115915a4fef184edc2c0
[[webroot_map]]
www.mydomain.com = /var/www
mydomain.com = /var/www
Here is a Certbot log showing the issue (if available):
Logs are stored in /var/log/letsencrypt by default. Feel free to redact domains, e-mail and IP addresses as you see fit.
2017-10-05 11:05:47,601:DEBUG:certbot.main:certbot version: 0.19.0
2017-10-05 11:05:47,601:DEBUG:certbot.main:Arguments: ['--force-renewal']
2017-10-05 11:05:47,601:DEBUG:certbot.main:Discovered plugins: PluginsRegistry(PluginEntryPoint#apache,PluginEntryPoint#manual,PluginEntryPoint#nginx,PluginEntryPoint#null,PluginEntryPoint#standalone,PluginEntryPoint#webroot)
2017-10-05 11:05:47,617:DEBUG:certbot.log:Root logging level set at 20
2017-10-05 11:05:47,617:INFO:certbot.log:Saving debug log to /var/log/letsencrypt/letsencrypt.log
2017-10-05 11:05:47,618:DEBUG:certbot.plugins.selection:Requested authenticator None and installer None
2017-10-05 11:05:47,629:WARNING:certbot.plugins.util:Failed to find executable apache2ctl in PATH: /usr/lib/git-core:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin
2017-10-05 11:05:47,629:DEBUG:certbot.plugins.disco:No installation (PluginEntryPoint#apache): Cannot find Apache control command apache2ctl
Traceback (most recent call last):
File "/opt/eff.org/certbot/venv/local/lib/python2.7/site-packages/certbot/plugins/disco.py", line 130, in prepare
self._initialized.prepare()
File "/opt/eff.org/certbot/venv/local/lib/python2.7/site-packages/certbot_apache/configurator.py", line 173, in prepare
'Cannot find Apache control command {0}'.format(restart_cmd))
NoInstallationError: Cannot find Apache control command apache2ctl
2017-10-05 11:05:47,890:DEBUG:certbot.plugins.selection:Single candidate plugin: * nginx
Description: Nginx Web Server plugin - Alpha
Interfaces: IAuthenticator, IInstaller, IPlugin
Entry point: nginx = certbot_nginx.configurator:NginxConfigurator
Initialized: <certbot_nginx.configurator.NginxConfigurator object at 0x396b4d0>
Prep: True
2017-10-05 11:05:47,890:DEBUG:certbot.plugins.selection:Selected authenticator <certbot_nginx.configurator.NginxConfigurator object at 0x396b4d0> and installer <certbot_nginx.configurator.NginxConfigurator object at 0x396b4d0>
2017-10-05 11:05:47,890:INFO:certbot.plugins.selection:Plugins selected: Authenticator nginx, Installer nginx
2017-10-05 11:05:47,894:DEBUG:certbot.main:Picked account: <Account(RegistrationResource(body=Registration(status=None, contact=(u'mailto:mydomain@gmail.com',), agreement=u'https://letsencrypt.org/documents/LE-SA-v1.1.1-August-1-2016.pdf', key=JWKRSA(key=<ComparableRSAKey(<cryptography.hazmat.backends.openssl.rsa._RSAPublicKey object at 0x380dad0>)>)), uri=u'https://acme-v01.api.letsencrypt.org/acme/reg/7020847', new_authzr_uri=u'https://acme-v01.api.letsencrypt.org/acme/new-authz', terms_of_service=u'https://letsencrypt.org/documents/LE-SA-v1.1.1-August-1-2016.pdf'), 44ff257c11ed115915a4fef184edc2c0, Meta(creation_host=u'mydomain.com', creation_dt=datetime.datetime(2016, 12, 7, 14, 0, 42, tzinfo=)))>
2017-10-05 11:05:47,894:DEBUG:acme.client:Sending GET request to https://acme-v01.api.letsencrypt.org/directory.
2017-10-05 11:05:47,898:DEBUG:requests.packages.urllib3.connectionpool:Starting new HTTPS connection (1): acme-v01.api.letsencrypt.org
2017-10-05 11:05:48,168:DEBUG:requests.packages.urllib3.connectionpool:https://acme-v01.api.letsencrypt.org:443 "GET /directory HTTP/1.1" 200 561
2017-10-05 11:05:48,168:DEBUG:acme.client:Received response:
HTTP 200
Server: nginx
Content-Type: application/json
Content-Length: 561
Replay-Nonce: 76VOGtf5U0M_dftt4n7rQ9IfPsdrpxDgek9J1vS8qoc
X-Frame-Options: DENY
Strict-Transport-Security: max-age=604800
Expires: Thu, 05 Oct 2017 11:05:48 GMT
Cache-Control: max-age=0, no-cache, no-store
Pragma: no-cache
Date: Thu, 05 Oct 2017 11:05:48 GMT
Connection: keep-alive
{
"TAiBgz0UlOY": "https://community.letsencrypt.org/t/adding-random-entries-to-the-directory/33417",
"key-change": "https://acme-v01.api.letsencrypt.org/acme/key-change",
"meta": {
"terms-of-service": "https://letsencrypt.org/documents/LE-SA-v1.1.1-August-1-2016.pdf"
},
"new-authz": "https://acme-v01.api.letsencrypt.org/acme/new-authz",
"new-cert": "https://acme-v01.api.letsencrypt.org/acme/new-cert",
"new-reg": "https://acme-v01.api.letsencrypt.org/acme/new-reg",
"revoke-cert": "https://acme-v01.api.letsencrypt.org/acme/revoke-cert"
}
2017-10-05 11:05:48,197:DEBUG:certbot.util:Not suggesting name "*.anotherdomain.com"
2017-10-05 11:05:48,197:DEBUG:certbot.util:Wildcard domains are not supported: *.anotherdomain.com
2017-10-05 11:05:48,197:DEBUG:certbot.util:Not suggesting name ""
2017-10-05 11:05:48,197:DEBUG:certbot.util: contains an invalid character. Valid characters are A-Z, a-z, 0-9, ., and -.
2017-10-05 11:05:51,082:DEBUG:certbot.renewal:Auto-renewal forced with --force-renewal...
2017-10-05 11:05:51,082:INFO:certbot.main:Renewing an existing certificate
2017-10-05 11:05:51,083:DEBUG:acme.client:Requesting fresh nonce
2017-10-05 11:05:51,083:DEBUG:acme.client:Sending HEAD request to https://acme-v01.api.letsencrypt.org/acme/new-authz.
2017-10-05 11:05:51,267:DEBUG:requests.packages.urllib3.connectionpool:https://acme-v01.api.letsencrypt.org:443 "HEAD /acme/new-authz HTTP/1.1" 405 0
2017-10-05 11:05:51,268:DEBUG:acme.client:Received response:
HTTP 405
Server: nginx
Content-Type: application/problem+json
Content-Length: 91
Allow: POST
Replay-Nonce: tIijrIctcLo1y1xkXUCAEbeOzAq1IMQ9Vr3irz8WD_w
Expires: Thu, 05 Oct 2017 11:05:51 GMT
Cache-Control: max-age=0, no-cache, no-store
Pragma: no-cache
Date: Thu, 05 Oct 2017 11:05:51 GMT
Connection: keep-alive
2017-10-05 11:05:51,268:DEBUG:acme.client:Storing nonce: tIijrIctcLo1y1xkXUCAEbeOzAq1IMQ9Vr3irz8WD_w
2017-10-05 11:05:51,268:DEBUG:acme.client:JWS payload:
{
"identifier": {
"type": "dns",
"value": "mydomain.com"
},
"resource": "new-authz"
}
2017-10-05 11:05:51,270:DEBUG:acme.client:Sending POST request to https://acme-v01.api.letsencrypt.org/acme/new-authz:
{
"protected": "eyJub25jZSI6ICJ0SWlqckljdGNMbzF5MXhrWFVDQUViZU96QXExSU1ROVZyM2lyejhXRF93IiwgImFsZyI6ICJSUzI1NiIsICJqd2siOiB7ImUiOiAiQVFBQiIsICJrdHkiOiAiUlNBIiwgIm4iOiAidEFubmlCNnJZYWI3NTR5T2RYZHc0STg1NUNfY3F5RGltRjBEMi1PWWdsbFVvTTI0eVBraVhkbnZrWkxpeE9MbklJX3RKVjZjTERaSlZtaFJBV2ZsNGpHMkwta0h2NHNmcTlTWWRrcTNkeVVLUEZuc0hBY0dHbnJrVzVKYTBWWWxFZkJiWXFaOTRkdDdEeDFHbklFbGMtZHdvekFyLTBVVndETWtUMjFtS3NNbEQwYXQ2ZVcyYnBsTTdhTmJmY2NZTmFSTHpSSVZGb1d3US11ZmoxcEswa1pYZGs1V25UVWtTVWdlVmdMbFg2eWh0NjluVjlWcFEyWEJVYnZ2dko2ZmRWaHhWUUhXZF9ReGliZWxhWDIwM0hhNXY2WC1fTGZPMGlrR2JUa2lFS3NwNEVyem1TRjFFaGFibkg0Z3pCUkd1eVlaUHNTOHVYeHpRcDNSUWIzbk9RIn19",
"payload": "ewogICJpZGVudGlmaWVyIjogewogICAgInR5cGUiOiAiZG5zIiwgCiAgICAidmFsdWUiOiAiaXN0b2Nrbm93LmNvbSIKICB9LCAKICAicmVzb3VyY2UiOiAibmV3LWF1dGh6Igp9",
"signature": "hVnZAtMJrHBxvujfTbjq44BWnQfJ_lhv53ueWoI2caGRaBRQW3xQy8ULTkb72MSYiOadem7HeuwOKKNvydUfu9mA2r4jGT6IpDhoRQqdAyqEc-H5M2AfXHZGelQWvS8JrKYMC96XFPgXPzCZxD8eD7OCx681sla8m_1_KEtuamLAUL4_XYP_P0uI_-2tvbY-xW36Sj7nqXPdoU-6j0Vy7H2JQFw3CgsyiSiylezkccBzARL8S7eqPMekqykw9NbQDTcj_kudvE3u6wOZGVaAA8qO9-TSLkJot6luKKULIFJ34sQ0rvI0vJH3SuUXdQcwYybBUiqBPcfouMHCIxpHjg"
}
2017-10-05 11:05:51,486:DEBUG:requests.packages.urllib3.connectionpool:https://acme-v01.api.letsencrypt.org:443 "POST /acme/new-authz HTTP/1.1" 201 1001
2017-10-05 11:05:51,486:DEBUG:acme.client:Received response:
HTTP 201
Server: nginx
Content-Type: application/json
Content-Length: 1001
Boulder-Requester: 7020847
Link: https://acme-v01.api.letsencrypt.org/acme/new-cert;rel="next"
Location: https://acme-v01.api.letsencrypt.org/acme/authz/S7b8ozolXNoY8lebDDpgwCukKym6pBE4jUfQLUoLfdg
Replay-Nonce: 1JyJ19mOcLKe6VStrbr2qNJCwb-X7lK8QzC2rgPtfbk
X-Frame-Options: DENY
Strict-Transport-Security: max-age=604800
Expires: Thu, 05 Oct 2017 11:05:51 GMT
Cache-Control: max-age=0, no-cache, no-store
Pragma: no-cache
Date: Thu, 05 Oct 2017 11:05:51 GMT
Connection: keep-alive
{
"identifier": {
"type": "dns",
"value": "mydomain.com"
},
"status": "pending",
"expires": "2017-10-12T11:05:51.367891876Z",
"challenges": [
{
"type": "http-01",
"status": "pending",
"uri": "https://acme-v01.api.letsencrypt.org/acme/challenge/S7b8ozolXNoY8lebDDpgwCukKym6pBE4jUfQLUoLfdg/2135204869",
"token": "0MQ3ArV5U3LnXTENa95-6EG8AXEZlshBf3EdY7QfrRM"
},
{
"type": "dns-01",
"status": "pending",
"uri": "https://acme-v01.api.letsencrypt.org/acme/challenge/S7b8ozolXNoY8lebDDpgwCukKym6pBE4jUfQLUoLfdg/2135204870",
"token": "aW7nTHS1V38PicfJYuayGWGPnoOeEB2XyI__3uOGxL4"
},
{
"type": "tls-sni-01",
"status": "pending",
"uri": "https://acme-v01.api.letsencrypt.org/acme/challenge/S7b8ozolXNoY8lebDDpgwCukKym6pBE4jUfQLUoLfdg/2135204871",
"token": "Ne9jJ3yGMiJGg0rmDB-edc0OZHYofvJCho5oCufnsco"
}
],
"combinations": [
[
2
],
[
0
],
[
1
]
]
}
2017-10-05 11:05:51,486:DEBUG:acme.client:Storing nonce: 1JyJ19mOcLKe6VStrbr2qNJCwb-X7lK8QzC2rgPtfbk
2017-10-05 11:05:51,488:DEBUG:acme.client:JWS payload:
{
"identifier": {
"type": "dns",
"value": "www.mydomain.com"
},
"resource": "new-authz"
}
2017-10-05 11:05:51,490:DEBUG:acme.client:Sending POST request to https://acme-v01.api.letsencrypt.org/acme/new-authz:
{
"protected": "eyJub25jZSI6ICIxSnlKMTltT2NMS2U2VlN0cmJyMnFOSkN3Yi1YN2xLOFF6QzJyZ1B0ZmJrIiwgImFsZyI6ICJSUzI1NiIsICJqd2siOiB7ImUiOiAiQVFBQiIsICJrdHkiOiAiUlNBIiwgIm4iOiAidEFubmlCNnJZYWI3NTR5T2RYZHc0STg1NUNfY3F5RGltRjBEMi1PWWdsbFVvTTI0eVBraVhkbnZrWkxpeE9MbklJX3RKVjZjTERaSlZtaFJBV2ZsNGpHMkwta0h2NHNmcTlTWWRrcTNkeVVLUEZuc0hBY0dHbnJrVzVKYTBWWWxFZkJiWXFaOTRkdDdEeDFHbklFbGMtZHdvekFyLTBVVndETWtUMjFtS3NNbEQwYXQ2ZVcyYnBsTTdhTmJmY2NZTmFSTHpSSVZGb1d3US11ZmoxcEswa1pYZGs1V25UVWtTVWdlVmdMbFg2eWh0NjluVjlWcFEyWEJVYnZ2dko2ZmRWaHhWUUhXZF9ReGliZWxhWDIwM0hhNXY2WC1fTGZPMGlrR2JUa2lFS3NwNEVyem1TRjFFaGFibkg0Z3pCUkd1eVlaUHNTOHVYeHpRcDNSUWIzbk9RIn19",
"payload": "ewogICJpZGVudGlmaWVyIjogewogICAgInR5cGUiOiAiZG5zIiwgCiAgICAidmFsdWUiOiAid3d3LmlzdG9ja25vdy5jb20iCiAgfSwgCiAgInJlc291cmNlIjogIm5ldy1hdXRoeiIKfQ",
"signature": "O2jLfD-7z5cxSk-oc2EgbVQ9Sld9hOHBIK-nZTBesyF-lGYXn-Ezu8lL4lgtj3XMtL6U6-zgEop3cb7-pZgW8TM5QCchw1DzfRbDdfWJNH20RjA1bI9ghJzP04kIt6t0HyGZYK3mLV2ysgqCujoEM7XOSxHkPBxEVFw4msofLr0HW0F1sO9eLd4OktGGTERX84sW0NrOGl1EYqKNtJiYa08lsJoIqECgxTRjz5XC8QDb4I3E8cYzYwwhW3hkSh69c_Fq7RfkGEkVHuBHpSSQOIeXuSP5TWe9QsQvR6zzP2utxogKQQGDsT6dRG2wv8igNHSCtQN4l6dAOBG8xYlzLA"
}
2017-10-05 11:05:51,713:DEBUG:requests.packages.urllib3.connectionpool:https://acme-v01.api.letsencrypt.org:443 "POST /acme/new-authz HTTP/1.1" 201 1005
2017-10-05 11:05:51,714:DEBUG:acme.client:Received response:
HTTP 201
Server: nginx
Content-Type: application/json
Content-Length: 1005
Boulder-Requester: 7020847
Link: https://acme-v01.api.letsencrypt.org/acme/new-cert;rel="next"
Location: https://acme-v01.api.letsencrypt.org/acme/authz/A8Aq7OHfCI-KMGgCE6SORE3flvblF6bViAi2A_Ct5tM
Replay-Nonce: xYu7UPRlqt0C4mgbO640smaOS1jON77X04Dl4wYom_Y
X-Frame-Options: DENY
Strict-Transport-Security: max-age=604800
Expires: Thu, 05 Oct 2017 11:05:51 GMT
Cache-Control: max-age=0, no-cache, no-store
Pragma: no-cache
Date: Thu, 05 Oct 2017 11:05:51 GMT
Connection: keep-alive
{
"identifier": {
"type": "dns",
"value": "www.mydomain.com"
},
"status": "pending",
"expires": "2017-10-12T11:05:51.597989589Z",
"challenges": [
{
"type": "dns-01",
"status": "pending",
"uri": "https://acme-v01.api.letsencrypt.org/acme/challenge/A8Aq7OHfCI-KMGgCE6SORE3flvblF6bViAi2A_Ct5tM/2135204887",
"token": "zwRNo1eA7OhXXO39jUl9ojwDMEjeAxozek0mDm2GqFY"
},
{
"type": "http-01",
"status": "pending",
"uri": "https://acme-v01.api.letsencrypt.org/acme/challenge/A8Aq7OHfCI-KMGgCE6SORE3flvblF6bViAi2A_Ct5tM/2135204888",
"token": "LQ4t5bvXlSqrYNtfb_Crb3ebfIzZf2oQeLsI1s6ZBC8"
},
{
"type": "tls-sni-01",
"status": "pending",
"uri": "https://acme-v01.api.letsencrypt.org/acme/challenge/A8Aq7OHfCI-KMGgCE6SORE3flvblF6bViAi2A_Ct5tM/2135204889",
"token": "dyLVEbd6Lv8buMoUlxpHsGmx5wkyvLA4olfk4pX2vjM"
}
],
"combinations": [
[
2
],
[
1
],
[
0
]
]
}
2017-10-05 11:05:51,714:DEBUG:acme.client:Storing nonce: xYu7UPRlqt0C4mgbO640smaOS1jON77X04Dl4wYom_Y
2017-10-05 11:05:51,715:INFO:certbot.auth_handler:Performing the following challenges:
2017-10-05 11:05:51,715:INFO:certbot.auth_handler:tls-sni-01 challenge for mydomain.com
2017-10-05 11:05:51,715:INFO:certbot.auth_handler:tls-sni-01 challenge for www.mydomain.com
2017-10-05 11:05:51,769:DEBUG:certbot.crypto_util:Generating key (1024 bits): /var/lib/letsencrypt/snakeoil/0007_key.pem
2017-10-05 11:05:51,983:DEBUG:certbot.reverter:Creating backup of /etc/nginx/include/php
2017-10-05 11:05:51,983:DEBUG:certbot.reverter:Creating backup of /etc/nginx/include/ssl
2017-10-05 11:05:51,983:DEBUG:certbot.reverter:Creating backup of /etc/nginx/include/404
2017-10-05 11:05:51,983:DEBUG:certbot.reverter:Creating backup of /etc/nginx/fastcgi_params
2017-10-05 11:05:51,983:DEBUG:certbot.reverter:Creating backup of /etc/nginx/mime.types
2017-10-05 11:05:51,983:DEBUG:certbot.reverter:Creating backup of /etc/nginx/sites-enabled/phpmyadmin
2017-10-05 11:05:51,983:DEBUG:certbot.reverter:Creating backup of /etc/nginx/nginx.conf
2017-10-05 11:05:51,984:DEBUG:certbot.reverter:Creating backup of /etc/nginx/sites-enabled/default
2017-10-05 11:05:51,985:DEBUG:certbot_nginx.parser:Writing nginx conf tree to /etc/nginx/nginx.conf:
user www-data;
worker_processes 8;
worker_rlimit_nofile 10000;
pid /var/run/nginx.pid;
events {
#worker_connections 1024;
worker_connections 4000;
# multi_accept on;
}
http {
include /etc/letsencrypt/le_tls_sni_01_cert_challenge.conf;
server_names_hash_bucket_size 128;
##
# Basic Settings
##

sendfile on;
tcp_nopush on;
tcp_nodelay on;
keepalive_timeout 65;
types_hash_max_size 2048;
server_tokens off;


# server_names_hash_bucket_size 64;
# server_name_in_redirect off;

include /etc/nginx/mime.types;
default_type application/octet-stream;

##
# Logging Settings
##

access_log /var/log/nginx/access.log;
error_log /var/log/nginx/error.log;

##
# Gzip Settings
##

gzip on;
gzip_disable "msie6";

gzip_vary on;
gzip_proxied any;
gzip_comp_level 6;
gzip_buffers 16 8k;
gzip_http_version 1.1;
gzip_types application/javascript text/plain text/css application/json application/x-javascript text/xml application/xml application/xml+rss text/javascript;

##
# nginx-naxsi config
##
# Uncomment it if you installed nginx-naxsi
##

#include /etc/nginx/naxsi_core.rules;

##
# nginx-passenger config
##
# Uncomment it if you installed nginx-passenger
##

#passenger_root /usr;
#passenger_ruby /usr/bin/ruby;

##
# Virtual Host Configs
##

proxy_cache_path /var/www/cache levels=1:2 keys_zone=imgcache:10m max_size=1000m inactive=720m;
proxy_temp_path /var/www/cache/tmp;

include /etc/nginx/conf.d/*.conf;
include /etc/nginx/sites-enabled/*;
}
#mail {
# See sample authentication script at:
# http://wiki.nginx.org/ImapAuthenticateWithApachePhpScript
# auth_http localhost/auth.php;
# pop3_capabilities "TOP" "USER";
# imap_capabilities "IMAP4rev1" "UIDPLUS";
server {
listen localhost:110;
protocol pop3;
proxy on;
}
server {
listen localhost:143;
protocol imap;
proxy on;
}
#}
2017-10-05 11:05:51,988:DEBUG:certbot_nginx.parser:Writing nginx conf tree to /etc/nginx/sites-enabled/default:
server {
listen MYIP:80 default_server;
server_name _;
return 301 https://$host$request_uri;
}
server{
listen MYIP:80;
server_name mydomain.com ;
rewrite ^ http://www.mydomain.com$request_uri? permanent;
access_log off;
error_log /dev/null crit;
listen 443 ssl; # managed by Certbot
ssl_certificate /var/lib/letsencrypt/snakeoil/0007_cert.pem; # managed by Certbot
ssl_certificate_key /var/lib/letsencrypt/snakeoil/0007_key.pem; # managed by Certbot
include /etc/letsencrypt/options-ssl-nginx.conf; # managed by Certbot
ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem; # managed by Certbot
}
server{
listen MYIP:80;
server_name *.anotherdomain.com anotherdomain.com ;
rewrite ^ http://www.mydomain.com$request_uri? permanent;
access_log off;
error_log /dev/null crit;
}
server {
listen MYIP:80;
root /var/beta/;
server_name beta.mydomain.com ;
index index.php index.html index.htm;
access_log off;
error_log /var/log/nginx/error.log crit;
error_page 404 /404.html;
rewrite ^/watch/(.*)$ /product/watch/$1 permanent;
rewrite ^/watch(.*)$ /product/watch/$1 permanent;
if (!-d $request_filename) {
rewrite ^/(.*)/$ /$1 permanent;
}
location = / {
rewrite ^/$ /inc/myhome.php last;
}
location = /browser {
rewrite ^/browser$ /inc/mybrowser.php last;
}
location ~ "^/([a-zA-Z]{2})$" {
rewrite "^/([a-zA-Z]{2})$" /inc/mycountry.php?country=$1 last;
}
location ~* .(?:ico|css|js|gif|jpe?g|png)$ {
expires 30d;
add_header Pragma public;
add_header Cache-Control "public";
}
location /news {
try_files $uri $uri/ /news/index.php?$args;
}
location ~* /store/ {
rewrite ^/.*/store/([0-9]+)- /inc/mystore.php?store=$1 last;
}
location /product/ {
#rewrite ^/product/([0-9]+)-./([0-9]+)-. /inc/myproduct.php?id_device=$1&id_sub_device=$2 last;
#rewrite ^/product/([0-9]+)-.* /inc/myproduct.php?id_device=$1 last;
rewrite ^/product/(.)/(.) /inc/myproduct.php?device=$1&sub_device=$2 last;
rewrite ^/product/(.*) /inc/myproduct.php?device=$1 last;
}
location ~ /.git {
return 404;
#deny all;
}
include /etc/nginx/include/php;
}
server {
listen MYIP:80;
root /var/www/;
server_name www.mydomain.com ;
index index.php index.html index.htm;
access_log off;
error_log /var/log/nginx/error.log crit;
error_page 404 /404.html;
include /etc/nginx/include/404;
if (!-d $request_filename) {
rewrite ^/(.*)/$ /$1 permanent;
}
location ~ "^/([a-zA-Z]{2})$" {
rewrite "^/([a-zA-Z]{2})$" /inc/mycountry.php?country=$1 last;
}
location ~* .(?:ico|css|js|gif|jpe?g|png)$ {
expires 30d;
add_header Pragma public;
add_header Cache-Control "public";
}
location /news {
try_files $uri $uri/ /news/index.php?$args;
}
location /feedback {
rewrite ^/feedback$ /inc/myfeedback.php last;
}
location ~* /store/ {
rewrite ^/.*/store/([0-9]+)- /inc/mystore.php?store=$1 last;
}
location /product/ {
#rewrite ^/product/([0-9]+)-./([0-9]+)-. /inc/myproduct.php?id_device=$1&id_sub_device=$2 last;
#rewrite ^/product/([0-9]+)-.* /inc/myproduct.php?id_device=$1 last;
rewrite ^/product/(.)/(.) /inc/myproduct.php?device=$1&sub_device=$2 last;
rewrite ^/product/(.*) /inc/myproduct.php?device=$1 last;
}
location = / {
rewrite ^/$ /inc/myhome.php last;
}
location = /browser {
rewrite ^/browser$ /inc/mybrowser.php last;
}
location = /privacy {
rewrite ^/privacy$ /inc/myprivacy.php last;
}
location = /about {
rewrite ^/about$ /inc/myprivacy.php last;
}
location ~ /.git {
return 404;
#deny all;
}
include /etc/nginx/include/php;
}
server {
listen 443 ssl;
server_name _;
rewrite ^ http://www.mydomain.com$request_uri? permanent;
}
server {
listen 0.0.0.0:443;
root /var/www/;
index index.html index.php;
fastcgi_param HTTPS on;
include /etc/nginx/include/ssl;
include /etc/nginx/include/php;
}
server {
listen 443 ssl;
root /var/www/;
error_log /dev/null crit;
rewrite ^ http://www.mydomain.com$request_uri? permanent;
server_name www.mydomain.com ;
index index.php index.html index.htm;
include /etc/nginx/include/ssl;
include /etc/nginx/include/php2;
}
server {
listen MYIP:443 ssl http2;
root /var/www/;
server_name www.mydomain.com ;
index index.php index.html index.htm;
access_log off;
error_log /var/log/nginx/error.log crit;
error_page 404 /404.html;

include /etc/nginx/include/404;

if (!-d $request_filename) {
    rewrite ^/(.*)/$ /$1 permanent;
}    


location ~ "^/([a-zA-Z]{2})$" {
    rewrite "^/([a-zA-Z]{2})$" /inc/mycountry.php?country=$1 last;
}      

location ~* \.(?:ico|css|js|gif|jpe?g|png)$ {
    expires 30d;
    add_header Pragma public;
    add_header Cache-Control "public";
}    


location /news {
    try_files $uri $uri/ /news/index.php?$args;
}
location /feedback {
    rewrite ^/feedback$ /inc/myfeedback.php last;
}    

location ~* /store/ {
    rewrite ^/.*/store/([0-9]+)- /inc/mystore.php?store=$1 last;
}    


location /product/ {
    #rewrite ^/product/([0-9]+)-.*/([0-9]+)-.* /inc/myproduct.php?id_device=$1&id_sub_device=$2 last;
    #rewrite ^/product/([0-9]+)-.* /inc/myproduct.php?id_device=$1 last;
    rewrite ^/product/(.*)/(.*) /inc/myproduct.php?device=$1&sub_device=$2 last;
    rewrite ^/product/(.*) /inc/myproduct.php?device=$1 last;
}    

location = / {
    rewrite ^/$ /inc/myhome.php last;
}    

location = /browser {
    rewrite ^/browser$ /inc/mybrowser.php last;
}   
location = /privacy {
    rewrite ^/privacy$ /inc/myprivacy.php last;
}   
location = /about {
    rewrite ^/about$ /inc/myprivacy.php last;
}              

location ~ /\.git {
  return 404;
  #deny all;
}

include /etc/nginx/include/php;
include /etc/nginx/include/ssl;
}
server {
listen MYIP:443 ssl http2;
root /var/www/etherdelta.github.io/;
server_name beta.mydomain.com ;
index index.php index.html index.htm;
access_log off;
error_log /var/log/nginx/error.log crit;
error_page 404 /404.html;

include /etc/nginx/include/404;

if (!-d $request_filename) {
    rewrite ^/(.*)/$ /$1 permanent;
}    


location ~ "^/([a-zA-Z]{2})$" {
    rewrite "^/([a-zA-Z]{2})$" /inc/mycountry.php?country=$1 last;
}      

location ~* \.(?:ico|css|js|gif|jpe?g|png)$ {
    expires 30d;
    add_header Pragma public;
    add_header Cache-Control "public";
}    


location /news {
    try_files $uri $uri/ /news/index.php?$args;
}
location /feedback {
    rewrite ^/feedback$ /inc/myfeedback.php last;
}    

location ~* /store/ {
    rewrite ^/.*/store/([0-9]+)- /inc/mystore.php?store=$1 last;
}    


location /product/ {
    #rewrite ^/product/([0-9]+)-.*/([0-9]+)-.* /inc/myproduct.php?id_device=$1&id_sub_device=$2 last;
    #rewrite ^/product/([0-9]+)-.* /inc/myproduct.php?id_device=$1 last;
    rewrite ^/product/(.*)/(.*) /inc/myproduct.php?device=$1&sub_device=$2 last;
    rewrite ^/product/(.*) /inc/myproduct.php?device=$1 last;
}    

location = / {
    rewrite ^/$ /inc/myhome.php last;
}    

location = /browser {
    rewrite ^/browser$ /inc/mybrowser.php last;
}   
location = /privacy {
    rewrite ^/privacy$ /inc/myprivacy.php last;
}   
location = /about {
    rewrite ^/about$ /inc/myprivacy.php last;
}              

location ~ /\.git {
  return 404;
  #deny all;
}

include /etc/nginx/include/php;
include /etc/nginx/include/ssl;
}
2017-10-05 11:05:53,001:INFO:certbot.auth_handler:Waiting for verification...
2017-10-05 11:05:53,001:DEBUG:acme.client:JWS payload:
{
"keyAuthorization": "Ne9jJ3yGMiJGg0rmDB-edc0OZHYofvJCho5oCufnsco.EgA-nGnraEiYeYSp0nh0YrPskDvGJktPGRk7gR7dOSA",
"type": "tls-sni-01",
"resource": "challenge"
}
2017-10-05 11:05:53,004:DEBUG:acme.client:Sending POST request to https://acme-v01.api.letsencrypt.org/acme/challenge/S7b8ozolXNoY8lebDDpgwCukKym6pBE4jUfQLUoLfdg/2135204871:
{
"protected": "eyJub25jZSI6ICJ4WXU3VVBSbHF0MEM0bWdiTzY0MHNtYU9TMWpPTjc3WDA0RGw0d1lvbV9ZIiwgImFsZyI6ICJSUzI1NiIsICJqd2siOiB7ImUiOiAiQVFBQiIsICJrdHkiOiAiUlNBIiwgIm4iOiAidEFubmlCNnJZYWI3NTR5T2RYZHc0STg1NUNfY3F5RGltRjBEMi1PWWdsbFVvTTI0eVBraVhkbnZrWkxpeE9MbklJX3RKVjZjTERaSlZtaFJBV2ZsNGpHMkwta0h2NHNmcTlTWWRrcTNkeVVLUEZuc0hBY0dHbnJrVzVKYTBWWWxFZkJiWXFaOTRkdDdEeDFHbklFbGMtZHdvekFyLTBVVndETWtUMjFtS3NNbEQwYXQ2ZVcyYnBsTTdhTmJmY2NZTmFSTHpSSVZGb1d3US11ZmoxcEswa1pYZGs1V25UVWtTVWdlVmdMbFg2eWh0NjluVjlWcFEyWEJVYnZ2dko2ZmRWaHhWUUhXZF9ReGliZWxhWDIwM0hhNXY2WC1fTGZPMGlrR2JUa2lFS3NwNEVyem1TRjFFaGFibkg0Z3pCUkd1eVlaUHNTOHVYeHpRcDNSUWIzbk9RIn19",
"payload": "ewogICJrZXlBdXRob3JpemF0aW9uIjogIk5lOWpKM3lHTWlKR2cwcm1EQi1lZGMwT1pIWW9mdkpDaG81b0N1Zm5zY28uRWdBLW5HbnJhRWlZZVlTcDBuaDBZclBza0R2R0prdFBHUms3Z1I3ZE9TQSIsIAogICJ0eXBlIjogInRscy1zbmktMDEiLCAKICAicmVzb3VyY2UiOiAiY2hhbGxlbmdlIgp9",
"signature": "pZlkKinZTX6IAOGlme2WQNcmDDbrpgf7eWhNVf9DqMQBZ32Pmd4FybhYkt2YpYy8vJqkSy66xOo5bAhCC7ij05x1pePluwyJepS_231m8j2aRvx3EmZgEZPTC3L8zWD6QzWT0R2rzzXeVmcqxh9sFWIGUUVtt1vMUZ5Y9EeqZpgiid6duREYdM3hH34TN8iI26TfyGpBDupGzTTR3rFG6X8ukuIJS4Ej6WnNbaucb1OeDv3Xz9AjC2Oit2Vx6OYtNTrI9rQKFXjotg65gU3y0yM2cAX0rqKnYl2IF-dzYL5x-b-SIII9CxiGeqbvZ3O2nt7z6yH8lxXxcUsXxtMSzA"
}
2017-10-05 11:05:53,208:DEBUG:requests.packages.urllib3.connectionpool:https://acme-v01.api.letsencrypt.org:443 "POST /acme/challenge/S7b8ozolXNoY8lebDDpgwCukKym6pBE4jUfQLUoLfdg/2135204871 HTTP/1.1" 202 339
2017-10-05 11:05:53,209:DEBUG:acme.client:Received response:
HTTP 202
Server: nginx
Content-Type: application/json
Content-Length: 339
Boulder-Requester: 7020847
Link: https://acme-v01.api.letsencrypt.org/acme/authz/S7b8ozolXNoY8lebDDpgwCukKym6pBE4jUfQLUoLfdg;rel="up"
Location: https://acme-v01.api.letsencrypt.org/acme/challenge/S7b8ozolXNoY8lebDDpgwCukKym6pBE4jUfQLUoLfdg/2135204871
Replay-Nonce: 7LT0Oa9rZrkRMe4VdOUnzrDzGRf-uvvrYsiX63OoHN8
Expires: Thu, 05 Oct 2017 11:05:53 GMT
Cache-Control: max-age=0, no-cache, no-store
Pragma: no-cache
Date: Thu, 05 Oct 2017 11:05:53 GMT
Connection: keep-alive
{
"type": "tls-sni-01",
"status": "pending",
"uri": "https://acme-v01.api.letsencrypt.org/acme/challenge/S7b8ozolXNoY8lebDDpgwCukKym6pBE4jUfQLUoLfdg/2135204871",
"token": "Ne9jJ3yGMiJGg0rmDB-edc0OZHYofvJCho5oCufnsco",
"keyAuthorization": "Ne9jJ3yGMiJGg0rmDB-edc0OZHYofvJCho5oCufnsco.EgA-nGnraEiYeYSp0nh0YrPskDvGJktPGRk7gR7dOSA"
}
2017-10-05 11:05:53,209:DEBUG:acme.client:Storing nonce: 7LT0Oa9rZrkRMe4VdOUnzrDzGRf-uvvrYsiX63OoHN8
2017-10-05 11:05:53,210:DEBUG:acme.client:JWS payload:
{
"keyAuthorization": "dyLVEbd6Lv8buMoUlxpHsGmx5wkyvLA4olfk4pX2vjM.EgA-nGnraEiYeYSp0nh0YrPskDvGJktPGRk7gR7dOSA",
"type": "tls-sni-01",
"resource": "challenge"
}
2017-10-05 11:05:53,212:DEBUG:acme.client:Sending POST request to https://acme-v01.api.letsencrypt.org/acme/challenge/A8Aq7OHfCI-KMGgCE6SORE3flvblF6bViAi2A_Ct5tM/2135204889:
{
"protected": "eyJub25jZSI6ICI3TFQwT2E5clpya1JNZTRWZE9VbnpyRHpHUmYtdXZ2cllzaVg2M09vSE44IiwgImFsZyI6ICJSUzI1NiIsICJqd2siOiB7ImUiOiAiQVFBQiIsICJrdHkiOiAiUlNBIiwgIm4iOiAidEFubmlCNnJZYWI3NTR5T2RYZHc0STg1NUNfY3F5RGltRjBEMi1PWWdsbFVvTTI0eVBraVhkbnZrWkxpeE9MbklJX3RKVjZjTERaSlZtaFJBV2ZsNGpHMkwta0h2NHNmcTlTWWRrcTNkeVVLUEZuc0hBY0dHbnJrVzVKYTBWWWxFZkJiWXFaOTRkdDdEeDFHbklFbGMtZHdvekFyLTBVVndETWtUMjFtS3NNbEQwYXQ2ZVcyYnBsTTdhTmJmY2NZTmFSTHpSSVZGb1d3US11ZmoxcEswa1pYZGs1V25UVWtTVWdlVmdMbFg2eWh0NjluVjlWcFEyWEJVYnZ2dko2ZmRWaHhWUUhXZF9ReGliZWxhWDIwM0hhNXY2WC1fTGZPMGlrR2JUa2lFS3NwNEVyem1TRjFFaGFibkg0Z3pCUkd1eVlaUHNTOHVYeHpRcDNSUWIzbk9RIn19",
"payload": "ewogICJrZXlBdXRob3JpemF0aW9uIjogImR5TFZFYmQ2THY4YnVNb1VseHBIc0dteDV3a3l2TEE0b2xmazRwWDJ2ak0uRWdBLW5HbnJhRWlZZVlTcDBuaDBZclBza0R2R0prdFBHUms3Z1I3ZE9TQSIsIAogICJ0eXBlIjogInRscy1zbmktMDEiLCAKICAicmVzb3VyY2UiOiAiY2hhbGxlbmdlIgp9",
"signature": "eflDbQ8ggZ1JuRZDzWWhuwfc6B4WTNRJ7KEE2bibhTVnRClkInt-mf8PneFDxxbAx31oMHd91HX-bLQ1hIrwQI04FleZgKRdn3QIwBIagJlF0l6skU8dGJx4yV3xgwpCc5jhqXGA_ZC3p-QhalUpqbZMFC2FRNWI_hVxQg9IB2Agv1nRHGZOx_ZeD3sL8ow1FGS2CNAze4yaa3Pk-Y3TkaQOhmVxKLWxV6iPPpkV_hI4rAArF0y0pl3-Kp94fkwYxXqdbG6M9tGr51x6DjSg8UjXlw3rHH4VUHcl4_4g57xLSn9v--bElhAx4PfEYhzfFvFW0xBGI6oiWh6rgKmC7A"
}
2017-10-05 11:05:53,436:DEBUG:requests.packages.urllib3.connectionpool:https://acme-v01.api.letsencrypt.org:443 "POST /acme/challenge/A8Aq7OHfCI-KMGgCE6SORE3flvblF6bViAi2A_Ct5tM/2135204889 HTTP/1.1" 202 339
2017-10-05 11:05:53,436:DEBUG:acme.client:Received response:
HTTP 202
Server: nginx
Content-Type: application/json
Content-Length: 339
Boulder-Requester: 7020847
Link: https://acme-v01.api.letsencrypt.org/acme/authz/A8Aq7OHfCI-KMGgCE6SORE3flvblF6bViAi2A_Ct5tM;rel="up"
Location: https://acme-v01.api.letsencrypt.org/acme/challenge/A8Aq7OHfCI-KMGgCE6SORE3flvblF6bViAi2A_Ct5tM/2135204889
Replay-Nonce: TU6eabK4WRroOO-VvwjaKJ0VhXggh_bEdpdYVez_xDU
Expires: Thu, 05 Oct 2017 11:05:53 GMT
Cache-Control: max-age=0, no-cache, no-store
Pragma: no-cache
Date: Thu, 05 Oct 2017 11:05:53 GMT
Connection: keep-alive
{
"type": "tls-sni-01",
"status": "pending",
"uri": "https://acme-v01.api.letsencrypt.org/acme/challenge/A8Aq7OHfCI-KMGgCE6SORE3flvblF6bViAi2A_Ct5tM/2135204889",
"token": "dyLVEbd6Lv8buMoUlxpHsGmx5wkyvLA4olfk4pX2vjM",
"keyAuthorization": "dyLVEbd6Lv8buMoUlxpHsGmx5wkyvLA4olfk4pX2vjM.EgA-nGnraEiYeYSp0nh0YrPskDvGJktPGRk7gR7dOSA"
}
2017-10-05 11:05:53,437:DEBUG:acme.client:Storing nonce: TU6eabK4WRroOO-VvwjaKJ0VhXggh_bEdpdYVez_xDU
2017-10-05 11:05:56,439:DEBUG:acme.client:Sending GET request to https://acme-v01.api.letsencrypt.org/acme/authz/A8Aq7OHfCI-KMGgCE6SORE3flvblF6bViAi2A_Ct5tM.
2017-10-05 11:05:56,625:DEBUG:requests.packages.urllib3.connectionpool:https://acme-v01.api.letsencrypt.org:443 "GET /acme/authz/A8Aq7OHfCI-KMGgCE6SORE3flvblF6bViAi2A_Ct5tM HTTP/1.1" 200 1764
2017-10-05 11:05:56,626:DEBUG:acme.client:Received response:
HTTP 200
Server: nginx
Content-Type: application/json
Content-Length: 1764
Link: https://acme-v01.api.letsencrypt.org/acme/new-cert;rel="next"
Replay-Nonce: nHAiLsW2Bm1QVt9JWIpUj-HQy5xqvvR2eSapmtoJ8Wc
X-Frame-Options: DENY
Strict-Transport-Security: max-age=604800
Expires: Thu, 05 Oct 2017 11:05:56 GMT
Cache-Control: max-age=0, no-cache, no-store
Pragma: no-cache
Date: Thu, 05 Oct 2017 11:05:56 GMT
Connection: keep-alive
{
"identifier": {
"type": "dns",
"value": "www.mydomain.com"
},
"status": "invalid",
"expires": "2017-10-12T11:05:51Z",
"challenges": [
{
"type": "dns-01",
"status": "pending",
"uri": "https://acme-v01.api.letsencrypt.org/acme/challenge/A8Aq7OHfCI-KMGgCE6SORE3flvblF6bViAi2A_Ct5tM/2135204887",
"token": "zwRNo1eA7OhXXO39jUl9ojwDMEjeAxozek0mDm2GqFY"
},
{
"type": "http-01",
"status": "pending",
"uri": "https://acme-v01.api.letsencrypt.org/acme/challenge/A8Aq7OHfCI-KMGgCE6SORE3flvblF6bViAi2A_Ct5tM/2135204888",
"token": "LQ4t5bvXlSqrYNtfb_Crb3ebfIzZf2oQeLsI1s6ZBC8"
},
{
"type": "tls-sni-01",
"status": "invalid",
"error": {
"type": "urn:acme:error:unauthorized",
"detail": "Incorrect validation certificate for tls-sni-01 challenge. Requested dcbb08e43b73d8d2d391668df0a4d2b1.6e13b1d5322ae0f692ed121d65e733d5.acme.invalid from MYIP:443. Received 2 certificate(s), first certificate had names "mydomain.com, www.mydomain.com"",
"status": 403
},
"uri": "https://acme-v01.api.letsencrypt.org/acme/challenge/A8Aq7OHfCI-KMGgCE6SORE3flvblF6bViAi2A_Ct5tM/2135204889",
"token": "dyLVEbd6Lv8buMoUlxpHsGmx5wkyvLA4olfk4pX2vjM",
"keyAuthorization": "dyLVEbd6Lv8buMoUlxpHsGmx5wkyvLA4olfk4pX2vjM.EgA-nGnraEiYeYSp0nh0YrPskDvGJktPGRk7gR7dOSA",
"validationRecord": [
{
"hostname": "www.mydomain.com",
"port": "443",
"addressesResolved": [
"MYIP"
],
"addressUsed": "MYIP",
"addressesTried": []
}
]
}
],
"combinations": [
[
2
],
[
1
],
[
0
]
]
}
2017-10-05 11:05:56,627:DEBUG:acme.client:Sending GET request to https://acme-v01.api.letsencrypt.org/acme/authz/S7b8ozolXNoY8lebDDpgwCukKym6pBE4jUfQLUoLfdg.
2017-10-05 11:05:57,015:DEBUG:requests.packages.urllib3.connectionpool:https://acme-v01.api.letsencrypt.org:443 "GET /acme/authz/S7b8ozolXNoY8lebDDpgwCukKym6pBE4jUfQLUoLfdg HTTP/1.1" 200 1756
2017-10-05 11:05:57,015:DEBUG:acme.client:Received response:
HTTP 200
Server: nginx
Content-Type: application/json
Content-Length: 1756
Link: https://acme-v01.api.letsencrypt.org/acme/new-cert;rel="next"
Replay-Nonce: HNI8YeJxQf7s-37CTbZKRWESDYQa36lVk5RUbmkCjNQ
X-Frame-Options: DENY
Strict-Transport-Security: max-age=604800
Expires: Thu, 05 Oct 2017 11:05:57 GMT
Cache-Control: max-age=0, no-cache, no-store
Pragma: no-cache
Date: Thu, 05 Oct 2017 11:05:57 GMT
Connection: keep-alive
{
"identifier": {
"type": "dns",
"value": "mydomain.com"
},
"status": "invalid",
"expires": "2017-10-12T11:05:51Z",
"challenges": [
{
"type": "http-01",
"status": "pending",
"uri": "https://acme-v01.api.letsencrypt.org/acme/challenge/S7b8ozolXNoY8lebDDpgwCukKym6pBE4jUfQLUoLfdg/2135204869",
"token": "0MQ3ArV5U3LnXTENa95-6EG8AXEZlshBf3EdY7QfrRM"
},
{
"type": "dns-01",
"status": "pending",
"uri": "https://acme-v01.api.letsencrypt.org/acme/challenge/S7b8ozolXNoY8lebDDpgwCukKym6pBE4jUfQLUoLfdg/2135204870",
"token": "aW7nTHS1V38PicfJYuayGWGPnoOeEB2XyI__3uOGxL4"
},
{
"type": "tls-sni-01",
"status": "invalid",
"error": {
"type": "urn:acme:error:unauthorized",
"detail": "Incorrect validation certificate for tls-sni-01 challenge. Requested 7e84da6422e76a58ded17fad01157c01.6b903861dbc793756e64747de1c92ed8.acme.invalid from MYIP:443. Received 2 certificate(s), first certificate had names "mydomain.com, www.mydomain.com"",
"status": 403
},
"uri": "https://acme-v01.api.letsencrypt.org/acme/challenge/S7b8ozolXNoY8lebDDpgwCukKym6pBE4jUfQLUoLfdg/2135204871",
"token": "Ne9jJ3yGMiJGg0rmDB-edc0OZHYofvJCho5oCufnsco",
"keyAuthorization": "Ne9jJ3yGMiJGg0rmDB-edc0OZHYofvJCho5oCufnsco.EgA-nGnraEiYeYSp0nh0YrPskDvGJktPGRk7gR7dOSA",
"validationRecord": [
{
"hostname": "mydomain.com",
"port": "443",
"addressesResolved": [
"MYIP"
],
"addressUsed": "MYIP",
"addressesTried": []
}
]
}
],
"combinations": [
[
2
],
[
0
],
[
1
]
]
}
2017-10-05 11:05:57,016:DEBUG:certbot.reporter:Reporting to user: The following errors were reported by the server:
Domain: www.mydomain.com
Type: unauthorized
Detail: Incorrect validation certificate for tls-sni-01 challenge. Requested dcbb08e43b73d8d2d391668df0a4d2b1.6e13b1d5322ae0f692ed121d65e733d5.acme.invalid from MYIP:443. Received 2 certificate(s), first certificate had names "mydomain.com, www.mydomain.com"
Domain: mydomain.com
Type: unauthorized
Detail: Incorrect validation certificate for tls-sni-01 challenge. Requested 7e84da6422e76a58ded17fad01157c01.6b903861dbc793756e64747de1c92ed8.acme.invalid from MYIP:443. Received 2 certificate(s), first certificate had names "mydomain.com, www.mydomain.com"
To fix these errors, please make sure that your domain name was entered correctly and the DNS A/AAAA record(s) for that domain contain(s) the right IP address.
2017-10-05 11:05:57,016:INFO:certbot.auth_handler:Cleaning up challenges
2017-10-05 11:05:58,285:DEBUG:certbot.log:Exiting abnormally:
Traceback (most recent call last):
File "/opt/eff.org/certbot/venv/bin/letsencrypt", line 11, in
sys.exit(main())
File "/opt/eff.org/certbot/venv/local/lib/python2.7/site-packages/certbot/main.py", line 861, in main
return config.func(config, plugins)
File "/opt/eff.org/certbot/venv/local/lib/python2.7/site-packages/certbot/main.py", line 698, in run
certname, lineage)
File "/opt/eff.org/certbot/venv/local/lib/python2.7/site-packages/certbot/main.py", line 80, in _get_and_save_cert
renewal.renew_cert(config, domains, le_client, lineage)
File "/opt/eff.org/certbot/venv/local/lib/python2.7/site-packages/certbot/renewal.py", line 297, in renew_cert
new_certr, new_chain, new_key, _ = le_client.obtain_certificate(domains)
File "/opt/eff.org/certbot/venv/local/lib/python2.7/site-packages/certbot/client.py", line 318, in obtain_certificate
self.config.allow_subset_of_names)
File "/opt/eff.org/certbot/venv/local/lib/python2.7/site-packages/certbot/auth_handler.py", line 81, in get_authorizations
self._respond(resp, best_effort)
File "/opt/eff.org/certbot/venv/local/lib/python2.7/site-packages/certbot/auth_handler.py", line 138, in _respond
self._poll_challenges(chall_update, best_effort)
File "/opt/eff.org/certbot/venv/local/lib/python2.7/site-packages/certbot/auth_handler.py", line 202, in _poll_challenges
raise errors.FailedChallenges(all_failed_achalls)
FailedChallenges: Failed authorization procedure. www.mydomain.com (tls-sni-01): urn:acme:error:unauthorized :: The client lacks sufficient authorization :: Incorrect validation certificate for tls-sni-01 challenge. Requested dcbb08e43b73d8d2d391668df0a4d2b1.6e13b1d5322ae0f692ed121d65e733d5.acme.invalid from MYIP:443. Received 2 certificate(s), first certificate had names "mydomain.com, www.mydomain.com", mydomain.com (tls-sni-01): urn:acme:error:unauthorized :: The client lacks sufficient authorization :: Incorrect validation certificate for tls-sni-01 challenge. Requested 7e84da6422e76a58ded17fad01157c01.6b903861dbc793756e64747de1c92ed8.acme.invalid from MYIP:443. Received 2 certificate(s), first certificate had names "mydomain.com, www.mydomain.com"