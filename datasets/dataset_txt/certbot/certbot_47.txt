Contributor
sorz commented on 5 Nov 2019 â€¢
edited
certbot_dns_rfc2136 authenticator is not robust on a losing network.
During authenticating, the plugin have to send several SOA queries directly to the authoritative nameserver. The number of queries is depended on the specific configuration. In my case, it sends out 21 queries for a single certification with 6 dns-alt names.
Currently, it sends them out using UDP without timeout and without retry mechanism. Thus, any single packet lost on these queries will cause the certbot stuck forever.
certbot/certbot-dns-rfc2136/certbot_dns_rfc2136/dns_rfc2136.py
Lines 209 to 210 in 3c24ff8
 response = dns.query.udp(request, self.server, port=self.port) 
 rcode = response.rcode() 
In my case, the network between my webserver and the nameserver regularly get a ~20% packet loss rate (since one of them is in China). The chance I pass the authentication is around 0.8 ^ 21 < 1%.
Proposed solution
Add a timeout with proper retry mechanism; or
Simply use TCP and let the OS handle it for us.