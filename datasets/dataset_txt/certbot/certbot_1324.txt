linko22 commented on 17 Mar 2017
Centos 7.3 x64
I installed Certbot with yum package manager from epel-testing repo
python2-certbot-0.12.0-4.el7.noarch
certbot-0.12.0-4.el7.noarch
I ran this command and it produced this output:
[root@letsencrypt bin]# /usr/bin/letsencrypt certonly -a webroot --webroot-path=/usr/share/nginx/html --renew-with-new-domains -n --expand --agree-tos -d ochko.travel -d www.ochko.travel -d ua.ochko.travel

Saving debug log to /var/log/letsencrypt/letsencrypt.log
Starting new HTTPS connection (1): acme-v01.api.letsencrypt.org
Renewing an existing certificate
Performing the following challenges:
http-01 challenge for ochko.travel
http-01 challenge for www.ochko.travel
http-01 challenge for ua.ochko.travel
Using the webroot path /usr/share/nginx/html for all unmatched domains.
Waiting for verification...
Cleaning up challenges
An unexpected error occurred:
UnicodeEncodeError: 'ascii' codec can't encode character u'\u2605' in position 239: ordinal not in range(128)
Please see the logfiles in /var/log/letsencrypt for more details.
Certbot's behavior differed from what I expected because:
Because i think it's a logic mistake somethere
My virtual domain with www has missing .well-known location, and it contents unicode symbol u'\u2605', as known as STAR. So, maybe, i think, need some code refactoring to don't exit abnormally?
Here is a Certbot log showing the issue (if available):
Logs are stored in /var/log/letsencrypt by default. Feel free to redact domains, e-mail and IP addresses as you see fit.
Part of log
    {
      "type": "http-01",
      "status": "invalid",
      "error": {
        "type": "urn:acme:error:unauthorized",
        "detail": "Invalid response from http://www.ochko.travel/.well-known/acme-challenge/DAYQOXEXFFDf3tC0Iuj4cDAIzAUOTh3fKGdUd3rYEz0: \"\u003c!DOCTYPE html\u003e\n\u003chtml lang=\"ru\"\u003e\n\u003chead\u003e\n\u003c!--\n★ Заглянул сюда? Захотелось сделать эту стра�\"",
        "status": 403
      },
      "uri": "https://acme-v01.api.letsencrypt.org/acme/challenge/HWWp0bE6rUplQEmLPKbo7Ll1A6NvrQOa022yb5YgFyg/816507019",
      "token": "DAYQOXEXFFDf3tC0Iuj4cDAIzAUOTh3fKGdUd3rYEz0",
...
bla-bla-bla
...
2017-03-17 08:24:57,433:INFO:certbot.auth_handler:Cleaning up challenges
2017-03-17 08:24:57,434:DEBUG:certbot.plugins.webroot:Removing /usr/share/nginx/html/.well-known/acme-challenge/-y4Ohb4zps9-EZTP83hIWKz6ok9-Q83A_flpzv4zpwk
2017-03-17 08:24:57,434:DEBUG:certbot.plugins.webroot:Removing /usr/share/nginx/html/.well-known/acme-challenge/DAYQOXEXFFDf3tC0Iuj4cDAIzAUOTh3fKGdUd3rYEz0
2017-03-17 08:24:57,435:DEBUG:certbot.plugins.webroot:Removing /usr/share/nginx/html/.well-known/acme-challenge/yc1ihZka3Kq10UzRgdpmnMYVEzhqYvMUW8tfwuBIL2Q
2017-03-17 08:24:57,435:DEBUG:certbot.plugins.webroot:All challenges cleaned up, removing /usr/share/nginx/html/.well-known/acme-challenge
2017-03-17 08:24:57,437:DEBUG:certbot.main:Exiting abnormally:
Traceback (most recent call last):
  File "/usr/bin/letsencrypt", line 9, in <module>
    load_entry_point('certbot==0.12.0', 'console_scripts', 'certbot')()
  File "/usr/lib/python2.7/site-packages/certbot/main.py", line 896, in main
    return config.func(config, plugins)
  File "/usr/lib/python2.7/site-packages/certbot/main.py", line 692, in certonly
    lineage = _get_and_save_cert(le_client, config, domains, certname, lineage)
  File "/usr/lib/python2.7/site-packages/certbot/main.py", line 87, in _get_and_save_cert
    renewal.renew_cert(config, domains, le_client, lineage)
  File "/usr/lib/python2.7/site-packages/certbot/renewal.py", line 296, in renew_cert
    new_certr, new_chain, new_key, _ = le_client.obtain_certificate(domains)
  File "/usr/lib/python2.7/site-packages/certbot/client.py", line 265, in obtain_certificate
    self.config.allow_subset_of_names)
  File "/usr/lib/python2.7/site-packages/certbot/auth_handler.py", line 77, in get_authorizations
    self._respond(resp, best_effort)
  File "/usr/lib/python2.7/site-packages/certbot/auth_handler.py", line 134, in _respond
    self._poll_challenges(chall_update, best_effort)
  File "/usr/lib/python2.7/site-packages/certbot/auth_handler.py", line 197, in _poll_challenges
    _report_failed_challs(all_failed_achalls)
  File "/usr/lib/python2.7/site-packages/certbot/auth_handler.py", line 488, in _report_failed_challs
    _generate_failed_chall_msg(achalls), reporter.MEDIUM_PRIORITY)
  File "/usr/lib/python2.7/site-packages/certbot/auth_handler.py", line 504, in _generate_failed_chall_msg
    if messages.is_acme_error(error):
  File "/usr/lib/python2.7/site-packages/acme/messages.py", line 39, in is_acme_error
    return (ERROR_PREFIX in str(err)) or (OLD_ERROR_PREFIX in str(err))
UnicodeEncodeError: 'ascii' codec can't encode character u'\u2605' in position 239: ordinal not in range(128)