Member
cpu commented on 30 Nov 2018 â€¢
edited
Hi folks,
I think 0b5468e from #6522 introduced a regression that causes the retry logic for badNonce errors in the acme module to fail.
Pebble uses Certbot master for its acme module in CI:
https://github.com/letsencrypt/pebble/blob/dadfdf1571ab506718a5ac7face55778c3e2ee31/.travis.yml#L15-L20
It uses our small ACME test client (chisel2.py) to test issuance against a pebble instance that by default rejects 15% of all valid nonces as invalid so that client retries are exercised.
Prior to 0b5468e Certbot and the acme module handled this as-expected and would retry requests that failed from a badNonce error. After this commit the badNonce errors seem to consistently cause an overall failure. Here's an example build of Pebble master with a log.
To confirm this was a regression I pushed 10 builds of Pebble master using Certbot master (named test-certbot-regression-1 .. test-certbot-regression-10) and 10 builds of Pebble master using Certbot pinned one commit before tip of master at 8b5ac9e (named test-certbot-regression-bisect-1 .. test-certbot-regression-bisect-10). The results are visible here. All 10/10 of the builds using acme from Certbot master failed and all 10/10 of the builds pinned a commit before passed.