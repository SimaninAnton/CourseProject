Contributor
jsha commented on 3 Nov 2017
Steps to reproduce:
Set up Certbot with a single certificate containing two names. Remove one of the names from the config. Sixty days later, run certbot -q renew. Output:
Attempting to renew cert (metrics.crud.net) from /etc/letsencrypt/renewal/metrics.crud.net.conf produced an unexpected error: Cannot find a VirtualHost matching domain metrics.crud.net. In order for Certbot to correctly perform the challenge please add a corresponding server_name directive to your nginx configuration: https://nginx.org/en/docs/http/server_names.html. Skipping.
All renewal attempts failed. The following certs could not be renewed:
  /etc/letsencrypt/live/metrics.crud.net/fullchain.pem (failure)
I also ran certbot certificates:
-------------------------------------------------------------------------------
Found the following certs:
  Certificate Name: metrics.crud.net
    Domains: grafana.crud.net metrics.crud.net
    Expiry Date: 2017-11-02 23:41:00+00:00 (INVALID: EXPIRED)
    Certificate Path: /etc/letsencrypt/live/metrics.crud.net/fullchain.pem
    Private Key Path: /etc/letsencrypt/live/metrics.crud.net/privkey.pem
-------------------------------------------------------------------------------
In my opinion, both of these places should include instructions on how to delete a name from a certificate so that it can be renewed. For instance "If you no longer need a certificate for X, run Y. If you still need a certificate for X, edit your (Nginx|Apache) configs to add a server_name directive for it."
I believe the right option here is --allow-subset-of-names. However, running certbot renew --allow-subset-of-names produces the same error above. Any advice on how best to remove a name from a certificate?