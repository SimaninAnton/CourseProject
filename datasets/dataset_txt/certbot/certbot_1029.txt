smarek commented on 5 Aug 2017
Follow-up from #3295
My operating system is (include version):
Debian 9 Stretch
I installed Certbot with (certbot-auto, OS package manager, pip, etc):
Both certbot-auto from Debian aptitude (0.10.2-1) and Letsencrypt-auto from https://github.com/letsencrypt/letsencrypt
I ran this command and it produced this output:
certbot-auto renew or letsencrypt-auto renew
./letsencrypt-auto renew
Upgrading certbot-auto 0.16.0 to 0.17.0...
Replacing certbot-auto...
Error: couldn't get currently installed version for /root/.local/share/letsencrypt/bin/letsencrypt: 
Traceback (most recent call last):
  File "/root/.local/share/letsencrypt/bin/letsencrypt", line 7, in <module>
    from certbot.main import main
  File "/root/.local/share/letsencrypt/local/lib/python2.7/site-packages/certbot/main.py", line 9, in <module>
    from acme import jose
  File "/root/.local/share/letsencrypt/local/lib/python2.7/site-packages/acme/jose/__init__.py", line 37, in <module>
    from acme.jose.interfaces import JSONDeSerializable
  File "/root/.local/share/letsencrypt/local/lib/python2.7/site-packages/acme/jose/interfaces.py", line 9, in <module>
    from acme.jose import util
  File "/root/.local/share/letsencrypt/local/lib/python2.7/site-packages/acme/jose/util.py", line 5, in <module>
    import OpenSSL
  File "/root/.local/share/letsencrypt/local/lib/python2.7/site-packages/OpenSSL/__init__.py", line 8, in <module>
    from OpenSSL import rand, crypto, SSL
  File "/root/.local/share/letsencrypt/local/lib/python2.7/site-packages/OpenSSL/rand.py", line 12, in <module>
    from OpenSSL._util import (
  File "/root/.local/share/letsencrypt/local/lib/python2.7/site-packages/OpenSSL/_util.py", line 6, in <module>
    from cryptography.hazmat.bindings.openssl.binding import Binding
  File "/root/.local/share/letsencrypt/local/lib/python2.7/site-packages/cryptography/hazmat/bindings/openssl/binding.py", line 13, in <module>
    from cryptography.hazmat.bindings._openssl import ffi, lib
ImportError: /root/.local/share/letsencrypt/local/lib/python2.7/site-packages/cryptography/hazmat/bindings/_openssl.so: cannot change memory protections: Permission denied
Certbot's behavior differed from what I expected because:
Running grsec kernel (4.9.0-2-grsec-amd64)
First running with certbot-auto would upgrade the local sandbox and start failing due to _openssl.so library, then letsencrypt-auto did the same.
Problem was solved by completely removing the sandbox (/root/.local/share/letsencrypt)
and running current letsencrypt-auto again (re-initialized sandbox does not suffer from this issue)