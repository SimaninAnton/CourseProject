laran commented on 21 Mar 2017
My operating system is (include version):
OSX
I installed Certbot with (certbot-auto, OS package manager, pip, etc):
From source (github 0.11 branch)
I ran this command and it produced this output:
(venv) ➜  certbot git:(0.11.x) sudo certbot certonly --server http://localhost:8080/acme/975717a0-0a9d-11e7-b694-959dec08e8ae --standalone -d localhost
Password:
Saving debug log to /Users/laran.evans/.certbot/dev/logs/letsencrypt.log
Obtaining a new certificate
Performing the following challenges:
http-01 challenge for localhost
Waiting for verification...
Cleaning up challenges
Generating key (2048 bits): /Users/laran.evans/.certbot/dev/config/keys/0038_key-certbot.pem
Creating CSR: /Users/laran.evans/.certbot/dev/config/csr/0038_csr-certbot.pem
An unexpected error occurred:
Error: [('asn1 encoding routines', 'ASN1_get_object', 'header too long')]
Please see the logfiles in /Users/laran.evans/.certbot/dev/logs for more details.
(venv) ➜  certbot git:(0.11.x)
Certbot's behavior differed from what I expected because:
The spec says that when a certificate cannot be issued at the time of the new-cert request, an empty response should be sent.
https://github.com/letsencrypt/acme-spec/blob/e20e28aad7048e62f2927044c6b84c42fee490a3/draft-barnes-acme.md#certificate-issuance
My local acme server returns a response with a 201 status and an empty body. But certbot blows up on it because the response is empty. It seems that certbot does not support asynchronous certificate generation.
I've attached screenshots which show the response from my server with the relevant bits selected.
Here is a Certbot log showing the issue (if available):
Logs are stored in /var/log/letsencrypt by default. Feel free to redact domains, e-mail and IP addresses as you see fit.
2017-03-20 22:46:48,715:DEBUG:requests.packages.urllib3.connectionpool:http://localhost:8080 "POST /acme/975717a0-0a9d-11e7-b694-959dec08e8ae/new-cert HTTP/1.1" 201 0
2017-03-20 22:46:48,717:DEBUG:acme.client:Received response:
HTTP 201
Date: Mon, 20 Mar 2017 22:46:48 GMT
X-XSS-Protection: 1; mode=block
X-Frame-Options: sameorigin
X-Content-Type-Options: nosniff
Access-Control-Allow-Headers: origin, content-type, accept, authorization, x-applicationurl, x-requested-with
Access-Control-Expose-Headers: authorization, x-auth-token
Access-Control-Allow-Methods: GET,POST,PUT,DELETE,HEAD
Access-Control-Allow-Credentials: true
Location: http://localhost:8080/acme/975717a0-0a9d-11e7-b694-959dec08e8ae/cert/1a2a1690-0dbf-11e7-8d30-5ba23700a27f
Link: <http://localhost:8080/acme/975717a0-0a9d-11e7-b694-959dec08e8ae/cert/1a2a1690-0dbf-11e7-8d30-5ba23700a27f>; rel="up"
Content-Type: application/json
Replay-Nonce: OTc1NzE3YTAtMGE5ZC0xMWU3LWI2OTQtOTU5ZGVjMDhlOGFlXzRhNTlmNTYxLWFlNDMtNDE0OS1hZjQ0LWNmNGNlZWUxMGY4Nw
Content-Length: 0
Server: Jetty(9.3.3.v20150827)


2017-03-20 22:46:48,718:DEBUG:acme.client:Storing nonce: OTc1NzE3YTAtMGE5ZC0xMWU3LWI2OTQtOTU5ZGVjMDhlOGFlXzRhNTlmNTYxLWFlNDMtNDE0OS1hZjQ0LWNmNGNlZWUxMGY4Nw
2017-03-20 22:47:29,789:DEBUG:certbot.main:Exiting abnormally:
Traceback (most recent call last):
  File "/Users/laran.evans/workspace/certbot/venv/bin/certbot", line 17, in <module>
    load_entry_point('certbot', 'console_scripts', 'certbot')()
  File "/Users/laran.evans/workspace/certbot/certbot/main.py", line 882, in main
    return config.func(config, plugins)
  File "/Users/laran.evans/workspace/certbot/certbot/main.py", line 659, in obtain_cert
    action, _ = _auth_from_available(le_client, config, domains, certname, lineage)
  File "/Users/laran.evans/workspace/certbot/certbot/main.py", line 108, in _auth_from_available
    lineage = le_client.obtain_and_enroll_certificate(domains, certname)
  File "/Users/laran.evans/workspace/certbot/certbot/client.py", line 294, in obtain_and_enroll_certificate
    certr, chain, key, _ = self.obtain_certificate(domains)
  File "/Users/laran.evans/workspace/certbot/certbot/client.py", line 275, in obtain_certificate
    return (self.obtain_certificate_from_csr(domains, csr, authzr=authzr)
  File "/Users/laran.evans/workspace/certbot/certbot/client.py", line 246, in obtain_certificate_from_csr
    authzr)
  File "/Users/laran.evans/workspace/certbot/acme/acme/client.py", line 342, in request_issuance
    OpenSSL.crypto.FILETYPE_ASN1, response.content)))
  File "/Users/laran.evans/workspace/certbot/venv/lib/python2.7/site-packages/OpenSSL/crypto.py", line 1661, in load_certificate
    _raise_current_error()
  File "/Users/laran.evans/workspace/certbot/venv/lib/python2.7/site-packages/OpenSSL/_util.py", line 48, in exception_from_error_queue
    raise exception_type(errors)
Error: [('asn1 encoding routines', 'ASN1_get_object', 'header too long')]
![crypto py](https://cloud.githubusercontent.com/assets/8204/24125335/6e1e87fc-0d85-11e7-8568-3df2e9288025.png)
![client py](https://cloud.githubusercontent.com/assets/8204/24125336/6e21ff36-0d85-11e7-8f98-903d34dadf39.png)