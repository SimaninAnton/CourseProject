tr1ck3r commented on 11 Jul 2017
My operating system is (include version):
CentOS 6 and CentOS 7
I installed Certbot with (certbot-auto, OS package manager, pip, etc):
For CentOS6 (certbot-auto): https://certbot.eff.org/all-instructions/#centos-6-none-of-the-above
For CentOS7 (yum): https://certbot.eff.org/all-instructions/#centos-rhel-7-none-of-the-above
Currently using certbot 0.14.1 on CentOS 7 and certbot-auto 0.16.0 on CentOS 6.
I ran this command and it produced this output:
certbot certonly --manual--cert-name cubs --domains chicago-cubs.venafi.example,cubs.venafi.example
(note: non-Let's Encrypt ACME server specified in /etc/letsencrypt/cli.ini)
Saving debug log to /var/log/letsencrypt/letsencrypt.log
Starting new HTTPS connection (1): tpp.venafi.example

-------------------------------------------------------------------------------
Confirm that you intend to update certificate cubs to include domains
[u'chicago-cubs.venafi.example', u'cubs.venafi.example']. Note that it
previously contained domains [].
-------------------------------------------------------------------------------
Certbot's behavior differed from what I expected because:
It appears that certbot is unable to parse domains from the previous certificate when it has no CN and the DNS SANs are a critical extension. Symptom is the unexpected prompt shown above (applicable previous_cert_pem.txt).
Background
Venafi has introduced an ACME server interface in Trust Protection Platform 17.2 and the common application involves using certbot to obtain certificates from an enterprise PKI. Microsoft's Active Directory Certifiate Services (ADCS) is a very popular enterprise PKI and when it enrolls a certificate request that lacks a Subject DN (has only SANs) the subjectAltName (2.5.29.17) extension is always critical. This behavior is consistent with Section 4.2.1.6 of RFC 5280 which states "If the subject field contains an empty sequence, then the issuing CA MUST include a subjectAltName extension that is marked as critical."