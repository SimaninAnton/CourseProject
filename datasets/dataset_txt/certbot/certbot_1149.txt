runephilosof commented on 24 May 2017
My operating system is (include version):
ubuntu 14.04
I installed Certbot with (certbot-auto, OS package manager, pip, etc):
certbot-auto 0.14.0
I ran this command and it produced this output:
In cron PATH=$PATH:/usr/sbin /root/certbot-auto renew --apache --quiet --no-self-upgrade --post-hook "service apache2 reload"
Encountered vhost ambiguity but unable to ask for user guidance in non-interactive mode. Currently Certbot needs each vhost to be in its own conf file, and may need vhosts to be explicitly labelled with ServerName or ServerAlias directories.
Falling back to default vhost *:443...
Encountered vhost ambiguity but unable to ask for user guidance in non-interactive mode. Currently Certbot needs each vhost to be in its own conf file, and may need vhosts to be explicitly labelled with ServerName or ServerAlias directories.
Falling back to default vhost *:443...
...
Also, after this ran apache was not running.
Certbot's behavior differed from what I expected because:
If the config files are OK before running certbot renew: Renewing certificates should not cause Apache to stop, no matter whether successful or not.
Also, I don't have any apache config files with multiple virtualhost directives. So I don't see why it would complain.
Here is a Certbot log showing the issue (if available):
Logs are stored in /var/log/letsencrypt by default. Feel free to redact domains, e-mail and IP addresses as you see fit.
2017-05-24 10:53:03,765:DEBUG:certbot.main:certbot version: 0.14.0
2017-05-24 10:53:03,765:DEBUG:certbot.main:Arguments: ['--apache', '--quiet', '--no-self-upgrade', '--post-hook', 'service apache2 reload']
2017-05-24 10:53:03,765:DEBUG:certbot.main:Discovered plugins: PluginsRegistry(PluginEntryPoint#apache,PluginEntryPoint#manual,PluginEntryPoint#nginx,PluginEntryPoint#null,PluginEntryPoint#standalone,PluginEntryPoint#webroot)
2017-05-24 10:53:03,813:DEBUG:certbot.plugins.selection:Requested authenticator apache and installer apache
2017-05-24 10:53:03,813:DEBUG:certbot.cli:Default Detector is Namespace(account=<certbot.cli._Default object at 0x7f80dbb16910>, agree_dev_preview=None, allow_subset_of_names=<certbot.cli._Default object at 0x7f80dbb166d0>, apache=True, apache_challenge_location=<certbot.cli._Default object at 0x7f80dbb1e7d0>, apache_ctl=<certbot.cli._Default object at 0x7f80dbb1ebd0>, apache_dismod=<certbot.cli._Default object at 0x7f80dbb1e210>, apache_enmod=<certbot.cli._Default object at 0x7f80dbb1e110>, apache_handle_modules=<certbot.cli._Default object at 0x7f80dbb1e950>, apache_handle_sites=<certbot.cli._Default object at 0x7f80dbb1ead0>, apache_init_script=<certbot.cli._Default object at 0x7f80dbb1ed10>, apache_le_vhost_ext=<certbot.cli._Default object at 0x7f80dbb1e350>, apache_logs_root=<certbot.cli._Default object at 0x7f80dbb1e690>, apache_server_root=<certbot.cli._Default object at 0x7f80dbb1e490>, apache_vhost_root=<certbot.cli._Default object at 0x7f80dbb1e590>, authenticator='apache', break_my_certs=<certbot.cli._Default object at 0x7f80dbb16fd0>, cert_path=<certbot.cli._Default object at 0x7f80dbb19090>, certname=<certbot.cli._Default object at 0x7f80dbb61350>, chain_path=<certbot.cli._Default object at 0x7f80dbb19390>, checkpoints=<certbot.cli._Default object at 0x7f80dbb17b50>, config_dir=<certbot.cli._Default object at 0x7f80dbb19490>, config_file=None, configurator=<certbot.cli._Default object at 0x7f80dbb19890>, csr=<certbot.cli._Default object at 0x7f80dbb17950>, debug=<certbot.cli._Default object at 0x7f80dbb17050>, debug_challenges=<certbot.cli._Default object at 0x7f80dbb17150>, dialog=None, domains=<certbot.cli._Default object at 0x7f80dbb61110>, dry_run=<certbot.cli._Default object at 0x7f80dbb61590>, duplicate=<certbot.cli._Default object at 0x7f80dbb16a10>, eff_email=<certbot.cli._Default object at 0x7f80dbb61ed0>, email=<certbot.cli._Default object at 0x7f80dbb61c50>, expand=<certbot.cli._Default object at 0x7f80dbb16310>, force_interactive=<certbot.cli._Default object at 0x7f80dbbcc910>, fullchain_path=<certbot.cli._Default object at 0x7f80dbb19290>, func=<function renew at 0x7f80dbfd8ed8>, hsts=<certbot.cli._Default object at 0x7f80dbb16590>, http01_port=<certbot.cli._Default object at 0x7f80dbb17450>, ifaces=<certbot.cli._Default object at 0x7f80dbb17e50>, init=<certbot.cli._Default object at 0x7f80dbb17c50>, installer='apache', key_path=<certbot.cli._Default object at 0x7f80dbb19190>, logs_dir=<certbot.cli._Default object at 0x7f80dbb19690>, manual=<certbot.cli._Default object at 0x7f80dbb19e90>, manual_auth_hook=<certbot.cli._Default object at 0x7f80dbb1e0d0>, manual_cleanup_hook=<certbot.cli._Default object at 0x7f80dbb1ef50>, manual_public_ip_logging_ok=<certbot.cli._Default object at 0x7f80dbb23090>, must_staple=<certbot.cli._Default object at 0x7f80dbb16bd0>, nginx=<certbot.cli._Default object at 0x7f80dbb19c90>, nginx_ctl=<certbot.cli._Default object at 0x7f80dbb232d0>, nginx_server_root=<certbot.cli._Default object at 0x7f80dbb1ee10>, no_bootstrap=<certbot.cli._Default object at 0x7f80dbb16d10>, no_self_upgrade=True, no_verify_ssl=<certbot.cli._Default object at 0x7f80dbb17250>, noninteractive_mode=<certbot.cli._Default object at 0x7f80dbb62810>, num=<certbot.cli._Default object at 0x7f80dbb17750>, os_packages_only=<certbot.cli._Default object at 0x7f80dbb16b10>, post_hook='service apache2 reload', pre_hook=<certbot.cli._Default object at 0x7f80dbb62490>, pref_challs=<certbot.cli._Default object at 0x7f80dbb62910>, prepare=<certbot.cli._Default object at 0x7f80dbb17d50>, quiet=True, reason=<certbot.cli._Default object at 0x7f80dbb17a50>, redirect=<certbot.cli._Default object at 0x7f80dbb169d0>, register_unsafely_without_email=<certbot.cli._Default object at 0x7f80dbb617d0>, reinstall=<certbot.cli._Default object at 0x7f80dbb16210>, renew_by_default=<certbot.cli._Default object at 0x7f80dbb164d0>, renew_hook=<certbot.cli._Default object at 0x7f80dbb171d0>, renew_with_new_domains=<certbot.cli._Default object at 0x7f80dbb165d0>, rsa_key_size=<certbot.cli._Default object at 0x7f80dbb16dd0>, server=<certbot.cli._Default object at 0x7f80dbb19790>, staging=<certbot.cli._Default object at 0x7f80dbb16f10>, standalone=<certbot.cli._Default object at 0x7f80dbb19d90>, standalone_supported_challenges=<certbot.cli._Default object at 0x7f80dbb233d0>, staple=<certbot.cli._Default object at 0x7f80dbb61b10>, strict_permissions=<certbot.cli._Default object at 0x7f80dbb61210>, text_mode=<certbot.cli._Default object at 0x7f80dbb625d0>, tls_sni_01_port=<certbot.cli._Default object at 0x7f80dbb17350>, tos=<certbot.cli._Default object at 0x7f80dbb16810>, uir=<certbot.cli._Default object at 0x7f80dbb161d0>, update_registration=<certbot.cli._Default object at 0x7f80dbb61a10>, user_agent=<certbot.cli._Default object at 0x7f80dbb17850>, validate_hooks=<certbot.cli._Default object at 0x7f80dbb17550>, verb='renew', verbose_count=<certbot.cli._Default object at 0x7f80dbb62390>, webroot=<certbot.cli._Default object at 0x7f80dbb19f90>, webroot_map=<certbot.cli._Default object at 0x7f80dbb235d0>, webroot_path=<certbot.cli._Default object at 0x7f80dbb231d0>, work_dir=<certbot.cli._Default object at 0x7f80dbb19590>)
2017-05-24 10:53:03,849:DEBUG:certbot.log:Root logging level set at 30
2017-05-24 10:53:03,849:INFO:certbot.log:Saving debug log to /var/log/letsencrypt/letsencrypt.log
2017-05-24 10:53:03,861:INFO:certbot.renewal:Cert not yet due for renewal
2017-05-24 10:53:03,869:INFO:certbot.renewal:Cert not yet due for renewal
2017-05-24 10:53:03,872:INFO:certbot.renewal:Cert not yet due for renewal
2017-05-24 10:53:03,876:INFO:certbot.renewal:Cert not yet due for renewal
2017-05-24 10:53:03,879:DEBUG:certbot.storage:Should renew, less than 30 days before certificate expiry 2017-06-23 10:53:00 UTC.
2017-05-24 10:53:03,879:INFO:certbot.renewal:Cert is due for renewal, auto-renewing...
2017-05-24 10:53:03,907:DEBUG:certbot.plugins.selection:Requested authenticator apache and installer apache
2017-05-24 10:53:04,034:DEBUG:certbot_apache.configurator:Apache version is 2.4.7
2017-05-24 10:53:10,724:DEBUG:certbot.plugins.selection:Single candidate plugin: * apache
Description: Apache Web Server plugin - Beta
Interfaces: IAuthenticator, IInstaller, IPlugin
Entry point: apache = certbot_apache.configurator:ApacheConfigurator
Initialized: <certbot_apache.configurator.ApacheConfigurator object at 0x7f80dbb1e550>
Prep: True
2017-05-24 10:53:10,724:DEBUG:certbot.plugins.selection:Single candidate plugin: * apache
Description: Apache Web Server plugin - Beta
Interfaces: IAuthenticator, IInstaller, IPlugin
Entry point: apache = certbot_apache.configurator:ApacheConfigurator
Initialized: <certbot_apache.configurator.ApacheConfigurator object at 0x7f80dbb1e550>
Prep: True
2017-05-24 10:53:10,724:DEBUG:certbot.plugins.selection:Selected authenticator <certbot_apache.configurator.ApacheConfigurator object at 0x7f80dbb1e550> and installer <certbot_apache.configurator.ApacheConfigurator object at 0x7f80dbb1e550>
2017-05-24 10:53:10,729:DEBUG:certbot.main:Picked account: <Account(RegistrationResource(body=Registration(status=None, contact=(u'mailto:XXX@XXXXXXXX',), agreement=u'https://letsencrypt.org/documents/LE-SA-v1.0.1-July-27-2015.pdf', key=JWKRSA(key=<ComparableRSAKey(<cryptography.hazmat.backends.openssl.rsa._RSAPublicKey object at 0x7f80de403450>)>)), uri=u'https://acme-v01.api.letsencrypt.org/acme/reg/89100', new_authzr_uri=u'https://acme-v01.api.letsencrypt.org/acme/new-authz', terms_of_service=u'https://letsencrypt.org/documents/LE-SA-v1.0.1-July-27-2015.pdf'), xxxxxxxxxxxxxx, Meta(creation_host=u'xxxxxxxxxxxxxxxx', creation_dt=datetime.datetime(2015, 12, 16, 10, 12, tzinfo=<UTC>)))>
2017-05-24 10:53:10,729:DEBUG:acme.client:Sending GET request to https://acme-v01.api.letsencrypt.org/directory.
2017-05-24 10:53:10,735:DEBUG:requests.packages.urllib3.connectionpool:Starting new HTTPS connection (1): acme-v01.api.letsencrypt.org
... requesting nonces ...
2017-05-24 10:53:12,888:INFO:certbot.auth_handler:Performing the following challenges:
2017-05-24 10:53:12,888:INFO:certbot.auth_handler:tls-sni-01 challenge for xxxxxxxxxx
2017-05-24 10:53:12,888:INFO:certbot.auth_handler:tls-sni-01 challenge for xxxxxxxxx
2017-05-24 10:53:12,888:INFO:certbot.auth_handler:tls-sni-01 challenge for xxxxxxxxxxx
2017-05-24 10:53:12,888:INFO:certbot.auth_handler:tls-sni-01 challenge for xxxxxxxxxxxx
2017-05-24 10:53:12,888:INFO:certbot.auth_handler:tls-sni-01 challenge for xxxxxxxxxxxxx
2017-05-24 10:53:12,888:INFO:certbot.auth_handler:tls-sni-01 challenge for www.xxxxxxxxxx
2017-05-24 10:53:14,370:WARNING:certbot_apache.display_ops:Encountered vhost ambiguity but unable to ask for user guidance in non-interactive mode. Currently Certbot needs each vhost to be in its own conf file, and may need vhosts to be explicitly labelled with ServerName or ServerAlias directories.
2017-05-24 10:53:14,371:WARNING:certbot_apache.tls_sni_01:Falling back to default vhost *:443...
2017-05-24 10:53:14,436:WARNING:certbot_apache.display_ops:Encountered vhost ambiguity but unable to ask for user guidance in non-interactive mode. Currently Certbot needs each vhost to be in its own conf file, and may need vhosts to be explicitly labelled with ServerName or ServerAlias directories.
2017-05-24 10:53:14,436:WARNING:certbot_apache.tls_sni_01:Falling back to default vhost *:443...
2017-05-24 10:53:14,482:WARNING:certbot_apache.display_ops:Encountered vhost ambiguity but unable to ask for user guidance in non-interactive mode. Currently Certbot needs each vhost to be in its own conf file, and may need vhosts to be explicitly labelled with ServerName or ServerAlias directories.
2017-05-24 10:53:14,482:WARNING:certbot_apache.tls_sni_01:Falling back to default vhost *:443...
2017-05-24 10:53:14,519:WARNING:certbot_apache.display_ops:Encountered vhost ambiguity but unable to ask for user guidance in non-interactive mode. Currently Certbot needs each vhost to be in its own conf file, and may need vhosts to be explicitly labelled with ServerName or ServerAlias directories.
2017-05-24 10:53:14,519:WARNING:certbot_apache.tls_sni_01:Falling back to default vhost *:443...
2017-05-24 10:53:14,556:WARNING:certbot_apache.display_ops:Encountered vhost ambiguity but unable to ask for user guidance in non-interactive mode. Currently Certbot needs each vhost to be in its own conf file, and may need vhosts to be explicitly labelled with ServerName or ServerAlias directories.
2017-05-24 10:53:14,556:WARNING:certbot_apache.tls_sni_01:Falling back to default vhost *:443...
2017-05-24 10:53:14,593:WARNING:certbot_apache.display_ops:Encountered vhost ambiguity but unable to ask for user guidance in non-interactive mode. Currently Certbot needs each vhost to be in its own conf file, and may need vhosts to be explicitly labelled with ServerName or ServerAlias directories.
2017-05-24 10:53:14,593:WARNING:certbot_apache.tls_sni_01:Falling back to default vhost *:443...
2017-05-24 10:53:15,233:DEBUG:certbot_apache.tls_sni_01:Adding Include /etc/apache2/le_tls_sni_01_cert_challenge.conf to /files/etc/apache2/apache2.conf
2017-05-24 10:53:15,234:DEBUG:certbot_apache.tls_sni_01:writing a config file with text:
... Requesting and storing new certificates
2017-05-24 10:53:29,861:DEBUG:certbot.renewal:no renewal failures
2017-05-24 10:53:29,861:INFO:certbot.hooks:Running post-hook command: service apache2 reload