atreloar commented on 30 Jul 2018
If you're having trouble using Certbot and aren't sure you've found a bug or
request for a new feature, please first try asking for help at
https://community.letsencrypt.org/. There is a much larger community there of
people familiar with the project who will be able to more quickly answer your
questions.
My operating system is (include version):
Ubuntu 16.04 (provided through Linode)
I installed Certbot with (certbot-auto, OS package manager, pip, etc):
Using the package manager as documented at https://certbot.eff.org/lets-encrypt/ubuntuxenial-apache
I ran this command and it produced this output:
sudo certbot --apache
Saving debug log to /var/log/letsencrypt/letsencrypt.log
The apache plugin is not working; there may be problems with your existing configuration.
The error was: PluginError('There has been an error in parsing the file /etc/apache2/sites-enabled/andrew.treloar.net.conf on line 63: Syntax error',)
Certbot's behavior differed from what I expected because:
I expected it to work.
Line 63 in andrew.treloar.net.conf is
#.
Line 62 in andrew.treloar.net.conf (which might be more useful) is
I am assuming that the reported error line is actually the line number in the concatenated conf file, but I can't work out how to see what that "virtual" line number is. I've scanned the files that should be getting included and can't see anything obviously wrong.
If I run:
sudo apachectl configtest
I get:
Syntax OK
Here is a Certbot log showing the issue (if available):
Logs are stored in /var/log/letsencrypt by default. Feel free to redact domains, e-mail and IP addresses as you see fit.
2018-07-30 13:10:27,590:DEBUG:certbot.plugins.selection:Requested authenticator apache and installer apache
2018-07-30 13:10:27,663:DEBUG:certbot_apache.configurator:Apache version is 2.4.18
2018-07-30 13:10:27,975:DEBUG:certbot.plugins.disco:Other error:(PluginEntryPoint#apache): There has been an error in parsing the file /etc/apache2/sites-enabled/andrew.treloar.net.conf on line 63: Syntax error
Traceback (most recent call last):
File "/usr/lib/python3/dist-packages/certbot/plugins/disco.py", line 132, in prepare
self._initialized.prepare()
File "/usr/lib/python3/dist-packages/certbot_apache/configurator.py", line 234, in prepare
self.check_parsing_errors("httpd.aug")
File "/usr/lib/python3/dist-packages/certbot_apache/augeas_configurator.py", line 77, in check_parsing_errors
raise errors.PluginError(msg)
certbot.errors.PluginError: There has been an error in parsing the file /etc/apache2/sites-enabled/andrew.treloar.net.conf on line 63: Syntax error
2018-07-30 13:10:27,977:DEBUG:certbot.plugins.selection:No candidate plugin
2018-07-30 13:10:27,977:DEBUG:certbot.plugins.selection:Selected authenticator None and installer None
Here is the relevant nginx server block or Apache virtualhost for the domain I am configuring:
domain: andrew.treloar.net
public: /var/www/html/treloar.net/public_html/
<VirtualHost *:80>
Admin email, Server Name (domain name), and any aliases
ServerAdmin andrew.treloar@gmail.com
ServerName andrew.treloar.net
Index file and Document Root (where the public files are located)
DirectoryIndex index.html index.php
DocumentRoot /var/www/html/treloar.net/public_html/andrew
Log file locations
LogLevel warn
ErrorLog /var/www/html/treloar.net/log/error.log
CustomLog /var/www/html/treloar.net/log/access.log combined
<Directory /var/www/>
Options Indexes FollowSymLinks MultiViews Includes
AllowOverride None
Order allow,deny
allow from all
DirectoryIndex index.html # # Redirect: Allows you to tell clients about documents that used to # exist in your server's namespace, but do not anymore. The client # will make a new request for the document at its new location. # Example: # Redirect permanent /foo http://www.example.com/bar
# Set up permanent redirect from .shtml files to .html files
RedirectMatch permanent (.*)\.shtml$ $1.html

#
# Alias: Maps web paths into filesystem paths and is used to
# access content that does not live under the DocumentRoot.
# Example:
# Alias /webpath /full/filesystem/path
#
# If you include a trailing / on /webpath then the server will
# require it to be present in the URL.  You will also likely
# need to provide a <Directory> section to allow access to
# the filesystem path.

# 
# ScriptAlias: This controls which directories contain server scripts.
# ScriptAliases are essentially the same as Aliases, except that
# documents in the target directory are treated as applications and
# run by the server when requested rather than as documents sent to the
# client.  The same rules about trailing "/" apply to ScriptAlias
# directives as to Alias.
#
# ScriptAliasMatch ^/cgi-bin/((?!(?i:webobjects)).*$) "/Library/WebServer/CGI$
# # TypesConfig points to the file containing the list of mappings from # filename extension to MIME-type. # TypesConfig /private/etc/apache2/mime.types # TypesConfig /private/etc/apache2/mime.types
#
# AddType allows you to add to or override the MIME configuration
# file specified in TypesConfig for specific file types.
#
#AddType application/x-gzip .tgz
#
# AddEncoding allows you to have certain browsers uncompress
# information on the fly. Note: Not all browsers support this.
#
#AddEncoding x-compress .Z
#AddEncoding x-gzip .gz .tgz
#
# If the AddEncoding directives above are commented-out, then you
# probably should define those extensions to indicate media types:
# 
AddType application/x-compress .Z
AddType application/x-gzip .gz .tgz

#
# AddHandler allows you to map certain file extensions to "handlers":
# actions unrelated to filetype. These can be either built into the server
# or added with the Action directive (see below)
#
# To use CGI scripts outside of ScriptAliased directories:
# (You will also need to add "ExecCGI" to the "Options" directive.)
# 
#AddHandler cgi-script .cgi

# For type maps (negotiated resources):
#AddHandler type-map var

# 
# Filters allow you to process content before it is sent to the client.
# 
# To parse .shtml files for server-side includes (SSI):
# (You will also need to add "Includes" to the "Options" directive.)
#
AddType text/html .shtml
AddType text/html .html
AddOutputFilter INCLUDES .shtml
AddOutputFilter INCLUDES .html