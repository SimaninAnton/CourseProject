ghost commented on 28 Aug 2016 â€¢
edited by ghost
Today I wanted to test if the renewal for my both certificates will work.
The site is definitely reachable over the domain + IP address
example.de shares its IP address, example.net has an own IP address
But I got the following error:
root@srv17:~# certbot renew --dry-run

-------------------------------------------------------------------------------
Processing /etc/letsencrypt/renewal/www.example.de.conf
-------------------------------------------------------------------------------

-------------------------------------------------------------------------------
Processing /etc/letsencrypt/renewal/www.example.net.conf
-------------------------------------------------------------------------------
2016-08-27 22:01:54,233:WARNING:certbot.renewal:Attempting to renew cert from
/etc/letsencrypt/renewal/www.example.net.conf produced an unexpected error: Failed authorization
procedure. www.example.net (tls-sni-01): urn:acme:error:unauthorized :: The client lacks sufficient
authorization :: Incorrect validation certificate for TLS-SNI-01 challenge. Requested
7ba2671d0****************************549101eb0c675e1fb91f0acb.acme.invalid from
84.XXX.XXX.168:443. Received certificate containing 'www.example.net'. Skipping.
** DRY RUN: simulating 'certbot renew' close to cert expiry
**          (The test certificates below have not been saved.)

The following certs were successfully renewed:
  /etc/letsencrypt/live/www.example.de/fullchain.pem (success)

The following certs could not be renewed:
  /etc/letsencrypt/live/www.example.net/fullchain.pem (failure)
** DRY RUN: simulating 'certbot renew' close to cert expiry
**          (The test certificates above have not been saved.)
1 renew failure(s), 0 parse failure(s)

IMPORTANT NOTES:
 - The following errors were reported by the server:

   Domain: www.example.net
   Type:   unauthorized
   Detail: Incorrect validation certificate for TLS-SNI-01 challenge.
   Requested
   7ba2671d0****************************549101eb0c675e1fb91f0acb.acme.invalid
   from 84.XXX.XXX.168:443. Received certificate containing
   'www.example.net'

   To fix these errors, please make sure that your domain name was
   entered correctly and the DNS A record(s) for that domain
   contain(s) the right IP address.
After that I tried to re-create the certificate with following commands
root@srv17:~# certbot --apache certonly --domains www.example.net
root@srv17:~# certbot --apache certonly --domains example.net
but then I get following errors:
We were unable to find a vhost with a ServerName or Address of
www.example.net.
Which virtual host would you like to choose? [...]
We were unable to find a vhost with a ServerName or Address of
example.net.
Which virtual host would you like to choose? [...]
But the vhost definitely exists:
root@srv17:~# ls /etc/apache2/sites-available
000-default.conf  site1.de.conf      sub.site1.de.conf   site2.de.conf  site3.de.conf    example.de.conf   default-ssl.conf        site4.org.conf     site5.at.conf  example.net.conf  site6.at.conf
And the content of example.net.conf is:
<VirtualHost 84.XXX.XXX.168:80>
    ServerName www.example.net
    ServerAlias example.net
    DocumentRoot /var/www/vhosts/example.net
</VirtualHost>

<VirtualHost 84.XXX.XXX.168:443>

    SSLEngine on

    SSLCertificateFile /etc/letsencrypt/live/www.example.net/fullchain.pem
    SSLCertificateKeyFile /etc/letsencrypt/live/www.example.net/privkey.pem

    SSLProtocol all -SSLv2 -SSLv3

    SSLCipherSuite ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-AES256-GCM-SHA384:DHE-RSA-AES128-GCM-SHA256:DHE-DSS-AES128-GCM-SHA256:kEDH+AESGCM:ECDHE-RSA-AES128-SHA256:ECDHE-ECDSA-AES128-SHA256:ECDHE-RSA-AES128-SHA:ECDHE-ECDSA-AES128-SHA:ECDHE-RSA-AES256-SHA384:ECDHE-ECDSA-AES256-SHA384:ECDHE-RSA-AES256-SHA:ECDHE-ECDSA-AES256-SHA:DHE-RSA-AES128-SHA256:DHE-RSA-AES128-SHA:DHE-DSS-AES128-SHA256:DHE-RSA-AES256-SHA256:DHE-DSS-AES256-SHA:DHE-RSA-AES256-SHA:AES128-GCM-SHA256:AES256-GCM-SHA384:AES128-SHA256:AES256-SHA256:AES128-SHA:AES256-SHA:AES:CAMELLIA:DES-CBC3-SHA:!aNULL:!eNULL:!EXPORT:!DES:!RC4:!MD5:!PSK:!aECDH:!EDH-DSS-DES-CBC3-SHA:!EDH-RSA-DES-CBC3-SHA:!KRB5-DES-CBC3-SHA

    SSLHonorCipherOrder On
    SSLCompression Off

    ServerName www.example.net
    ServerAlias example.net
    DocumentRoot /var/www/vhosts/example.net

</VirtualHost>