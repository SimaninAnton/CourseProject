jamiek23 commented on 20 Aug 2019
Error is from a server that was previously working fine, using the DNS challenge via the Route53 plugin. Renews started failing, probably after an apt update - but I don't know when/what changed.
Removed the Ubuntu repository version of certbot, installed the PPA, and got exactly the same error. Using a similar setup (DNS challenge with Route53) on other servers running Debian 9, and they are working fine.
Happy to run any commands to help debug this!
My operating system is (include version):
Ubuntu 18.04.3
I installed Certbot with (certbot-auto, OS package manager, pip, etc):
apt - certbot PPA
I ran this command and it produced this output:
root@netbox:~# certbot certonly --dns-route53 -d test.ipcortex.com -v
Root logging level set at 10
Saving debug log to /var/log/letsencrypt/letsencrypt.log
Requested authenticator dns-route53 and installer None
Loading variable profile from defaults.
Loading variable config_file from defaults.
Loading variable credentials_file from defaults.
Loading variable data_path from defaults.
Loading variable profile from defaults.
Loading variable region from defaults.
Loading variable profile from defaults.
Loading variable ca_bundle from defaults.
Loading variable profile from defaults.
Loading variable api_versions from defaults.
Loading variable profile from defaults.
Loading variable credentials_file from defaults.
Loading variable config_file from defaults.
Loading variable profile from defaults.
Loading variable metadata_service_timeout from defaults.
Loading variable profile from defaults.
Loading variable metadata_service_num_attempts from defaults.
Loading variable profile from defaults.
Looking for credentials via: env
Looking for credentials via: assume-role
Looking for credentials via: shared-credentials-file
Looking for credentials via: custom-process
Looking for credentials via: config-file
Credentials found in config file: ~/.aws/config
Loading JSON file: /usr/lib/python3/dist-packages/botocore/data/endpoints.json
Loading variable profile from defaults.
Event choose-service-name: calling handler <function handle_service_name_alias at 0x7fb5ad3d70d0>
Loading JSON file: /usr/lib/python3/dist-packages/botocore/data/route53/2013-04-01/service-2.json
Event creating-client-class.route53: calling handler <function add_generate_presigned_url at 0x7fb5ad3acd90>
The s3 config key is not a dictionary type, ignoring its value of: None
Setting route53 timeout as (60, 60)
Loading JSON file: /usr/lib/python3/dist-packages/botocore/data/_retry.json
Registering retry handlers for service: route53
Single candidate plugin: * dns-route53
Description: Obtain certificates using a DNS TXT record (if you are using AWS Route53 for DNS).
Interfaces: IAuthenticator, IPlugin
Entry point: dns-route53 = certbot_dns_route53.dns_route53:Authenticator
Initialized: <certbot_dns_route53.dns_route53.Authenticator object at 0x7fb5adcef470>
Prep: True
Selected authenticator <certbot_dns_route53.dns_route53.Authenticator object at 0x7fb5adcef470> and installer None
Plugins selected: Authenticator dns-route53, Installer None
Enter email address (used for urgent renewal and security notices) (Enter 'c' to
cancel): <REDACTED>
Sending GET request to https://acme-v02.api.letsencrypt.org/directory.
Starting new HTTPS connection (1): acme-v02.api.letsencrypt.org:443
Exiting abnormally:
Traceback (most recent call last):
  File "/usr/bin/certbot", line 11, in <module>
    load_entry_point('certbot==0.31.0', 'console_scripts', 'certbot')()
  File "/usr/lib/python3/dist-packages/certbot/main.py", line 1365, in main
    return config.func(config, plugins)
  File "/usr/lib/python3/dist-packages/certbot/main.py", line 1234, in certonly
    le_client = _init_le_client(config, auth, installer)
  File "/usr/lib/python3/dist-packages/certbot/main.py", line 605, in _init_le_client
    acc, acme = _determine_account(config)
  File "/usr/lib/python3/dist-packages/certbot/main.py", line 521, in _determine_account
    config, account_storage, tos_cb=_tos_cb)
  File "/usr/lib/python3/dist-packages/certbot/client.py", line 181, in register
    acme = acme_from_config_key(config, key)
  File "/usr/lib/python3/dist-packages/certbot/client.py", line 51, in acme_from_config_key
    return acme_client.BackwardsCompatibleClientV2(net, key, config.server)
  File "/usr/lib/python3/dist-packages/acme/client.py", line 814, in __init__
    directory = messages.Directory.from_json(net.get(server).json())
  File "/usr/lib/python3/dist-packages/acme/client.py", line 1152, in get
    self._send_request('GET', url, **kwargs), content_type=content_type)
  File "/usr/lib/python3/dist-packages/acme/client.py", line 1101, in _send_request
    response = self.session.request(method, url, *args, **kwargs)
  File "/usr/local/lib/python3.6/dist-packages/requests/sessions.py", line 533, in request
    resp = self.send(prep, **send_kwargs)
  File "/usr/local/lib/python3.6/dist-packages/requests/sessions.py", line 646, in send
    r = adapter.send(request, **kwargs)
  File "/usr/local/lib/python3.6/dist-packages/requests/adapters.py", line 449, in send
    timeout=timeout
  File "/usr/local/lib/python3.6/dist-packages/urllib3/connectionpool.py", line 591, in urlopen
    conn = self._get_conn(timeout=pool_timeout)
  File "/usr/local/lib/python3.6/dist-packages/urllib3/connectionpool.py", line 249, in _get_conn
    return conn or self._new_conn()
  File "/usr/local/lib/python3.6/dist-packages/urllib3/connectionpool.py", line 831, in _new_conn
    **self.conn_kw)
  File "/usr/lib/python3/dist-packages/botocore/awsrequest.py", line 70, in __init__
    HTTPConnection.__init__(self, *args, **kwargs)
  File "/usr/local/lib/python3.6/dist-packages/urllib3/connection.py", line 115, in __init__
    _HTTPConnection.__init__(self, *args, **kw)
TypeError: __init__() got an unexpected keyword argument 'cert_file'
An unexpected error occurred:
TypeError: __init__() got an unexpected keyword argument 'cert_file'
Please see the logfiles in /var/log/letsencrypt for more details.
Certbot's behavior differed from what I expected because:
It probably shouldn't give an unexpected error, unless something is very broken on this server. (Pretty sure nothing is broken configuration wise, but happy to be corrected.)
Here is the relevant nginx server block or Apache virtualhost for the domain I am configuring:
(Not applicable - running in certonly mode and it doesn't get that far!)