pnomolos commented on 11 Oct 2016 â€¢
edited
We have our sites set up with two server blocks per site, as so:
server {
    listen 80;
    server_name domain.name;
    return 301 https://$http_host$request_uri;
}

server {
    listen 443;
    server_name domain.name;
    # ...
}
(See https://www.nginx.com/resources/wiki/start/topics/tutorials/config_pitfalls/#using-if - it's explicitly recommend to set things up this way rather than using an if block).
The nginx plugin currently doesn't deal very well with this set up. I had to manually disable my SSL directives in the SSL server block for the certbot auth to succeed, then it created all the directives in the non-SSL server block, resulting in a redirect loop :)
/cc @ohemorange @bmw
(In reference to: https://community.letsencrypt.org/t/seeking-feedback-on-new-certbot-nginx-plugin/20693/7?u=pnomolos)